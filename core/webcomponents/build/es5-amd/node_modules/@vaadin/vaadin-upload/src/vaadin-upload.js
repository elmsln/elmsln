define(["exports","../../../@polymer/polymer/polymer-element.js","../../../@polymer/polymer/lib/utils/gestures.js","../../../@polymer/polymer/lib/elements/dom-repeat.js","../../vaadin-themable-mixin/vaadin-themable-mixin.js","../../vaadin-button/src/vaadin-button.js","./vaadin-upload-icons.js","./vaadin-upload-file.js","../../vaadin-element-mixin/vaadin-element-mixin.js","../../../@polymer/polymer/lib/utils/html-tag.js"],function(_exports,_polymerElement,_gestures,_domRepeat,_vaadinThemableMixin,_vaadinButton,_vaadinUploadIcons,_vaadinUploadFile,_vaadinElementMixin,_htmlTag){"use strict";Object.defineProperty(_exports,"__esModule",{value:!0});_exports.UploadElement=void 0;function _templateObject_872fead0499511e9a5428ba375554590(){var data=babelHelpers.taggedTemplateLiteral(["\n    <style>\n      :host {\n        display: block;\n        position: relative;\n      }\n\n      :host([hidden]) {\n        display: none !important;\n      }\n\n      [hidden] {\n        display: none !important;\n      }\n    </style>\n\n    <div part=\"primary-buttons\">\n      <div id=\"addFiles\" on-touchend=\"_onAddFilesTouchEnd\" on-click=\"_onAddFilesClick\">\n        <slot name=\"add-button\">\n          <vaadin-button part=\"upload-button\" id=\"addButton\" disabled=\"[[maxFilesReached]]\">\n            [[_i18nPlural(maxFiles, i18n.addFiles, i18n.addFiles.*)]]\n          </vaadin-button>\n        </slot>\n      </div>\n      <div part=\"drop-label\" hidden$=\"[[nodrop]]\" id=\"dropLabelContainer\">\n        <slot name=\"drop-label-icon\">\n          <div part=\"drop-label-icon\"></div>\n        </slot>\n        <slot name=\"drop-label\" id=\"dropLabel\">\n          [[_i18nPlural(maxFiles, i18n.dropFiles, i18n.dropFiles.*)]]\n        </slot>\n      </div>\n    </div>\n    <slot name=\"file-list\">\n      <div id=\"fileList\" part=\"file-list\">\n        <template is=\"dom-repeat\" items=\"[[files]]\" as=\"file\">\n          <vaadin-upload-file file=\"[[file]]\"></vaadin-upload-file>\n        </template>\n      </div>\n    </slot>\n    <slot></slot>\n    <input type=\"file\" id=\"fileInput\" on-change=\"_onFileInputChange\" hidden=\"\" accept$=\"{{accept}}\" multiple$=\"[[_isMultiple(maxFiles)]]\" capture$=\"[[capture]]\">\n"],["\n    <style>\n      :host {\n        display: block;\n        position: relative;\n      }\n\n      :host([hidden]) {\n        display: none !important;\n      }\n\n      [hidden] {\n        display: none !important;\n      }\n    </style>\n\n    <div part=\"primary-buttons\">\n      <div id=\"addFiles\" on-touchend=\"_onAddFilesTouchEnd\" on-click=\"_onAddFilesClick\">\n        <slot name=\"add-button\">\n          <vaadin-button part=\"upload-button\" id=\"addButton\" disabled=\"[[maxFilesReached]]\">\n            [[_i18nPlural(maxFiles, i18n.addFiles, i18n.addFiles.*)]]\n          </vaadin-button>\n        </slot>\n      </div>\n      <div part=\"drop-label\" hidden\\$=\"[[nodrop]]\" id=\"dropLabelContainer\">\n        <slot name=\"drop-label-icon\">\n          <div part=\"drop-label-icon\"></div>\n        </slot>\n        <slot name=\"drop-label\" id=\"dropLabel\">\n          [[_i18nPlural(maxFiles, i18n.dropFiles, i18n.dropFiles.*)]]\n        </slot>\n      </div>\n    </div>\n    <slot name=\"file-list\">\n      <div id=\"fileList\" part=\"file-list\">\n        <template is=\"dom-repeat\" items=\"[[files]]\" as=\"file\">\n          <vaadin-upload-file file=\"[[file]]\"></vaadin-upload-file>\n        </template>\n      </div>\n    </slot>\n    <slot></slot>\n    <input type=\"file\" id=\"fileInput\" on-change=\"_onFileInputChange\" hidden=\"\" accept\\$=\"{{accept}}\" multiple\\$=\"[[_isMultiple(maxFiles)]]\" capture\\$=\"[[capture]]\">\n"]);_templateObject_872fead0499511e9a5428ba375554590=function(){return data};return data}var UploadElement=function(_ElementMixin){babelHelpers.inherits(UploadElement,_ElementMixin);function UploadElement(){babelHelpers.classCallCheck(this,UploadElement);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(UploadElement).apply(this,arguments))}babelHelpers.createClass(UploadElement,[{key:"ready",value:function ready(){babelHelpers.get(babelHelpers.getPrototypeOf(UploadElement.prototype),"ready",this).call(this);this.addEventListener("dragover",this._onDragover.bind(this));this.addEventListener("dragleave",this._onDragleave.bind(this));this.addEventListener("drop",this._onDrop.bind(this));this.addEventListener("file-retry",this._onFileRetry.bind(this));this.addEventListener("file-abort",this._onFileAbort.bind(this));this.addEventListener("file-remove",this._onFileRemove.bind(this));this.addEventListener("file-start",this._onFileStart.bind(this))}},{key:"_formatSize",value:function _formatSize(bytes){var _Mathlog=Math.log;if("function"===typeof this.i18n.formatSize){return this.i18n.formatSize(bytes)}var base=this.i18n.units.sizeBase||1e3,unit=~~(_Mathlog(bytes)/_Mathlog(base)),dec=Math.max(0,Math.min(3,unit-1)),size=parseFloat((bytes/Math.pow(base,unit)).toFixed(dec));return size+" "+this.i18n.units.size[unit]}},{key:"_splitTimeByUnits",value:function _splitTimeByUnits(time){for(var unitSizes=[60,60,24,1/0],timeValues=[0],i=0;i<unitSizes.length&&0<time;i++){timeValues[i]=time%unitSizes[i];time=Math.floor(time/unitSizes[i])}return timeValues}},{key:"_formatTime",value:function _formatTime(seconds,split){if("function"===typeof this.i18n.formatTime){return this.i18n.formatTime(seconds,split)}while(3>split.length){split.push(0)}return split.reverse().map(function(number){return(10>number?"0":"")+number}).join(":")}},{key:"_formatFileProgress",value:function _formatFileProgress(file){return file.totalStr+": "+file.progress+"% ("+(0<file.loaded?this.i18n.uploading.remainingTime.prefix+file.remainingStr:this.i18n.uploading.remainingTime.unknown)+")"}},{key:"_maxFilesAdded",value:function _maxFilesAdded(maxFiles,numFiles){return 0<=maxFiles&&numFiles>=maxFiles}},{key:"_onDragover",value:function _onDragover(event){event.preventDefault();if(!this.nodrop&&!this._dragover){this._dragoverValid=!this.maxFilesReached;this._dragover=!0}event.dataTransfer.dropEffect=!this._dragoverValid||this.nodrop?"none":"copy"}},{key:"_onDragleave",value:function _onDragleave(event){event.preventDefault();if(this._dragover&&!this.nodrop){this._dragover=this._dragoverValid=!1}}},{key:"_onDrop",value:function _onDrop(event){if(!this.nodrop){event.preventDefault();this._dragover=this._dragoverValid=!1;this._addFiles(event.dataTransfer.files)}}},{key:"_createXhr",value:function _createXhr(){return new XMLHttpRequest}},{key:"_configureXhr",value:function _configureXhr(xhr){if("string"==typeof this.headers){try{this.headers=JSON.parse(this.headers)}catch(e){this.headers=void 0}}for(var key in this.headers){xhr.setRequestHeader(key,this.headers[key])}if(this.timeout){xhr.timeout=this.timeout}xhr.withCredentials=this.withCredentials}},{key:"_setStatus",value:function _setStatus(file,total,loaded,elapsed){file.elapsed=elapsed;file.elapsedStr=this._formatTime(file.elapsed,this._splitTimeByUnits(file.elapsed));file.remaining=Math.ceil(elapsed*(total/loaded-1));file.remainingStr=this._formatTime(file.remaining,this._splitTimeByUnits(file.remaining));file.speed=~~(total/elapsed/1024);file.totalStr=this._formatSize(total);file.loadedStr=this._formatSize(loaded);file.status=this._formatFileProgress(file)}},{key:"uploadFiles",value:function uploadFiles(files){files=files||this.files;files=files.filter(function(file){return!file.complete});Array.prototype.forEach.call(files,this._uploadFile.bind(this))}},{key:"_uploadFile",value:function _uploadFile(file){var _this=this;if(file.uploading){return}var ini=Date.now(),xhr=file.xhr=this._createXhr(file),stalledId,last;xhr.upload.onprogress=function(e){clearTimeout(stalledId);last=Date.now();var elapsed=(last-ini)/1e3,loaded=e.loaded,total=e.total,progress=~~(100*(loaded/total));file.loaded=loaded;file.progress=progress;file.indeterminate=0>=loaded||loaded>=total;if(file.error){file.indeterminate=file.status=void 0}else if(!file.abort){if(100>progress){_this._setStatus(file,total,loaded,elapsed);stalledId=setTimeout(function(){file.status=_this.i18n.uploading.status.stalled;_this._notifyFileChanges(file)},2e3)}else{file.loadedStr=file.totalStr;file.status=_this.i18n.uploading.status.processing;file.uploading=!1}}_this._notifyFileChanges(file);_this.dispatchEvent(new CustomEvent("upload-progress",{detail:{file:file,xhr:xhr}}))};xhr.onreadystatechange=function(){if(4==xhr.readyState){clearTimeout(stalledId);file.indeterminate=file.uploading=!1;if(file.abort){_this._notifyFileChanges(file);return}file.status="";var _evt=_this.dispatchEvent(new CustomEvent("upload-response",{detail:{file:file,xhr:xhr},cancelable:!0}));if(!_evt){return}if(0===xhr.status){file.error=_this.i18n.uploading.error.serverUnavailable}else if(500<=xhr.status){file.error=_this.i18n.uploading.error.unexpectedServerError}else if(400<=xhr.status){file.error=_this.i18n.uploading.error.forbidden}file.complete=!file.error;_this.dispatchEvent(new CustomEvent("upload-".concat(file.error?"error":"success"),{detail:{file:file,xhr:xhr}}));_this._notifyFileChanges(file)}};var formData=new FormData;file.uploadTarget=this.target||"";file.formDataName=this.formDataName;var evt=this.dispatchEvent(new CustomEvent("upload-before",{detail:{file:file,xhr:xhr},cancelable:!0}));if(!evt){return}formData.append(file.formDataName,file,file.name);xhr.open(this.method,file.uploadTarget,!0);this._configureXhr(xhr);file.status=this.i18n.uploading.status.connecting;file.uploading=file.indeterminate=!0;file.complete=file.abort=file.error=file.held=!1;xhr.upload.onloadstart=function(){_this.dispatchEvent(new CustomEvent("upload-start",{detail:{file:file,xhr:xhr}}));_this._notifyFileChanges(file)};var uploadEvt=this.dispatchEvent(new CustomEvent("upload-request",{detail:{file:file,xhr:xhr,formData:formData},cancelable:!0}));if(uploadEvt){xhr.send(formData)}}},{key:"_retryFileUpload",value:function _retryFileUpload(file){var evt=this.dispatchEvent(new CustomEvent("upload-retry",{detail:{file:file,xhr:file.xhr},cancelable:!0}));if(evt){this._uploadFile(file)}}},{key:"_abortFileUpload",value:function _abortFileUpload(file){var evt=this.dispatchEvent(new CustomEvent("upload-abort",{detail:{file:file,xhr:file.xhr},cancelable:!0}));if(evt){file.abort=!0;if(file.xhr){file.xhr.abort()}this._notifyFileChanges(file)}}},{key:"_notifyFileChanges",value:function _notifyFileChanges(file){var p="files."+this.files.indexOf(file)+".";for(var i in file){if(file.hasOwnProperty(i)){this.notifyPath(p+i,file[i])}}}},{key:"_addFiles",value:function _addFiles(files){Array.prototype.forEach.call(files,this._addFile.bind(this))}},{key:"_addFile",value:function _addFile(file){if(this.maxFilesReached){this.dispatchEvent(new CustomEvent("file-reject",{detail:{file:file,error:this.i18n.error.tooManyFiles}}));return}if(0<=this.maxFileSize&&file.size>this.maxFileSize){this.dispatchEvent(new CustomEvent("file-reject",{detail:{file:file,error:this.i18n.error.fileIsTooBig}}));return}var fileExt=file.name.match(/\.[^\.]*$|$/)[0],re=new RegExp("^("+this.accept.replace(/[, ]+/g,"|").replace(/\/\*/g,"/.*")+")$","i");if(this.accept&&!(re.test(file.type)||re.test(fileExt))){this.dispatchEvent(new CustomEvent("file-reject",{detail:{file:file,error:this.i18n.error.incorrectFileType}}));return}file.loaded=0;file.held=!0;file.status=this.i18n.uploading.status.held;this.unshift("files",file);if(!this.noAuto){this._uploadFile(file)}}},{key:"_removeFile",value:function _removeFile(file){if(-1<this.files.indexOf(file)){this.splice("files",this.files.indexOf(file),1)}}},{key:"_onAddFilesTouchEnd",value:function _onAddFilesTouchEnd(e){e.preventDefault();this.__resetMouseCanceller();this._onAddFilesClick()}},{key:"__resetMouseCanceller",value:function __resetMouseCanceller(){(0,_gestures.resetMouseCanceller)()}},{key:"_onAddFilesClick",value:function _onAddFilesClick(){if(this.maxFilesReached){return}this.$.fileInput.value="";this.$.fileInput.click()}},{key:"_onFileInputChange",value:function _onFileInputChange(event){this._addFiles(event.target.files)}},{key:"_onFileStart",value:function _onFileStart(event){this._uploadFile(event.detail.file)}},{key:"_onFileRetry",value:function _onFileRetry(event){this._retryFileUpload(event.detail.file)}},{key:"_onFileAbort",value:function _onFileAbort(event){this._abortFileUpload(event.detail.file)}},{key:"_onFileRemove",value:function _onFileRemove(event){event.stopPropagation();this._removeFile(event.detail.file)}},{key:"_dragoverChanged",value:function _dragoverChanged(dragover){dragover?this.setAttribute("dragover",dragover):this.removeAttribute("dragover")}},{key:"_dragoverValidChanged",value:function _dragoverValidChanged(dragoverValid){dragoverValid?this.setAttribute("dragover-valid",dragoverValid):this.removeAttribute("dragover-valid")}},{key:"_i18nPlural",value:function _i18nPlural(value,plural){return 1==value?plural.one:plural.many}},{key:"_isMultiple",value:function _isMultiple(){return 1!=this.maxFiles}}],[{key:"template",get:function get(){return(0,_htmlTag.html)(_templateObject_872fead0499511e9a5428ba375554590())}},{key:"is",get:function get(){return"vaadin-upload"}},{key:"version",get:function get(){return"4.2.1"}},{key:"properties",get:function get(){return{nodrop:{type:Boolean,reflectToAttribute:!0,value:function value(){try{return!!document.createEvent("TouchEvent")}catch(e){return!1}}},target:{type:String,value:""},method:{type:String,value:"POST"},headers:{type:Object,value:{}},timeout:{type:Number,value:0},_dragover:{type:Boolean,value:!1,observer:"_dragoverChanged"},files:{type:Array,notify:!0,value:function value(){return[]}},maxFiles:{type:Number,value:1/0},maxFilesReached:{type:Boolean,value:!1,notify:!0,readOnly:!0,computed:"_maxFilesAdded(maxFiles, files.length)"},accept:{type:String,value:""},maxFileSize:{type:Number,value:1/0},_dragoverValid:{type:Boolean,value:!1,observer:"_dragoverValidChanged"},formDataName:{type:String,value:"file"},noAuto:{type:Boolean,value:!1},withCredentials:{type:Boolean,value:!1},capture:String,i18n:{type:Object,value:function value(){return{dropFiles:{one:"Drop file here",many:"Drop files here"},addFiles:{one:"Upload File...",many:"Upload Files..."},cancel:"Cancel",error:{tooManyFiles:"Too Many Files.",fileIsTooBig:"File is Too Big.",incorrectFileType:"Incorrect File Type."},uploading:{status:{connecting:"Connecting...",stalled:"Stalled.",processing:"Processing File...",held:"Queued"},remainingTime:{prefix:"remaining time: ",unknown:"unknown remaining time"},error:{serverUnavailable:"Server Unavailable",unexpectedServerError:"Unexpected Server Error",forbidden:"Forbidden"}},units:{size:["B","kB","MB","GB","TB","PB","EB","ZB","YB"]}}}}}}}]);return UploadElement}((0,_vaadinElementMixin.ElementMixin)((0,_vaadinThemableMixin.ThemableMixin)(_polymerElement.PolymerElement)));_exports.UploadElement=UploadElement;customElements.define(UploadElement.is,UploadElement)});