<link rel="import" href="../polymer/polymer.html">

<!--
`a11y-media-youtube-utility`
Utility to insert, init and control YouTube iframe embeds with a11y-media-player.

@demo demo/index.html

@microcopy - the mental model for this element

-->

<dom-module id="a11y-media-youtube-utility">
  <template>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      function onYouTubeIframeAPIReady() {
        console.log('youtube-api-ready');
        var event = new CustomEvent('youtube-api-ready');
        document.dispatchEvent(event);
      }
    </script>
  </template>
  <script>
    (function() {
      'use strict';
  
      Polymer.A11yMediaYoutubeUtility = Polymer({

        is: 'a11y-media-youtube-utility',
        
        /**
         * Makes sure there is a utility ready and listening for elements.
         */
        created: function() {
          let root = Polymer.A11yMediaYoutubeUtility;
          root.ytapi = function(e) {
            root.apiReady = true;
            document.removeEventListener('youtube-api-ready',root.ytapi);
          };
          root.counter = 0; //counter for unique id each youtube iframe
          document.addEventListener('youtube-api-ready', root.ytapi);
        },
        
        /**
         * Cleanup.
         */
        detached: function() {
          document.removeEventListener('youtube-api-ready',root.ytapi);
        },
      });

      Polymer.A11yMediaYoutubeUtility.instance = null;

      Polymer.A11yMediaYoutubeUtility.apiReady = false;

      Polymer.A11yMediaYoutubeUtility.players = [];

      /**
       * Checks to see if there is an instance available, and if not appends one
       */
      Polymer.A11yMediaYoutubeUtility.requestAvailability = function() {
        if (!Polymer.A11yMediaYoutubeUtility.instance) {
          Polymer.A11yMediaYoutubeUtility.instance = document.createElement('a11y-media-youtube-utility');
          document.body.appendChild(Polymer.A11yMediaYoutubeUtility.instance);
        }
      };

      Polymer.A11yMediaYoutubeUtility.initYoutubePlayer = function(elem,options,attached){
        this.counter++;
        //get unique id for each youtube iframe
        let root = this, div = document.createElement('div'), id = "a11y-media-yt-"+this.counter;
        div.setAttribute('id',id);
        elem.appendChild(div);

        // function to create and init iframe
        let iframe = new YT.Player(id, {
          width: options.width, 
          height: options.height, 
          videoId: options.videoId, 
          playerVars: {
            color: 'white',
            controls: 0,
            autoplay: options.autoplay,
            disablekb: 1,
            enablejsapi: 1,
            iv_load_policy: 3,
            modestbranding: 1,
            showinfo: 0, 
            rel: 0
          }
        });

        // add methods and properties to api so that it matches HTML5 video
        iframe.tracks = [];
        iframe.duration = 0;
        iframe.play = function(){
          iframe.playVideo();
        };
        iframe.pause = function(){
          iframe.pauseVideo();
        };
        iframe.seek = function(time){
          iframe.seekTo(time);
          iframe.pauseVideo();
        };
        iframe.setMute = function(mode){
          mode ? iframe.mute() : iframe.unMute();
        };
        iframe.seekable = {
          "length": 1,
          "start": function(index){ return 0 },
          "end": function(index){ return iframe.duration }
        };
        // return the iframe so that a11y-media-player can control it
        return iframe;
      };
    })();
  </script>
</dom-module>
