define(["exports","../../../@polymer/polymer/polymer-element.js","../../../@polymer/iron-ajax/iron-ajax.js","../../../@polymer/iron-form-element-behavior/iron-form-element-behavior.js","../../../@polymer/app-layout/app-layout.js","../../../@polymer/app-layout/app-toolbar/app-toolbar.js","../../simple-toast/simple-toast.js","../../simple-modal/simple-modal.js","../../../@polymer/paper-input/paper-input.js","../../../@polymer/paper-button/paper-button.js","../../../@polymer/paper-listbox/paper-listbox.js","../../lrnsys-button/lrnsys-button.js","../../grafitto-filter/grafitto-filter.js","../../simple-fields/lib/simple-fields-container.js","../lrnsys-comment.js"],(function(e,t,o,s,n,a,i,l,m,r,d,c,p,h,u){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.LrnsysCommentList=void 0;class LrnsysCommentList extends t.PolymerElement{static get template(){return t.html`
      <style>
        :host {
          display: block;
        }
        app-toolbar {
          padding: 0;
        }
        app-toolbar > *:not(:last-child) {
          margin-right: 10px;
        }
        lrnsys-button {
          font-size: 12px;
        }
        .comment-button {
          min-width: 125px;
        }
      </style>
      <!-- Load all comments on load of element -->
      <iron-ajax
        auto
        url="[[sourcePath]]"
        handle-as="json"
        method="[[opsRequestMethod.list]]"
        last-response="{{comments}}"
      ></iron-ajax>
      <!-- Create stub-comment -->
      <iron-ajax
        id="ajaxcreatestub"
        url="[[createStubUrl]]"
        method="[[opsRequestMethod.create]]"
        body="[[activeComment.id]]"
        on-response="_updateReply"
        handle-as="json"
        last-response="{{newComment}}"
      ></iron-ajax>
      <!-- Update comment -->
      <iron-ajax
        id="ajaxupdaterequest"
        url="[[reqUrl]]"
        method="[[opsRequestMethod.update]]"
        body="[[activeComment]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleUpdateResponse"
      ></iron-ajax>
      <!-- Delete comment -->
      <iron-ajax
        id="ajaxdeleterequest"
        url="[[reqUrl]]"
        method="[[opsRequestMethod.delete]]"
        body="[[activeComment]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleDeleteResponse"
      ></iron-ajax>
      <!-- Like comment -->
      <iron-ajax
        id="ajaxlikerequest"
        url="[[reqUrl]]"
        method="[[opsRequestMethod.like]]"
        body="[[activeComment]]"
        content-type="application/json"
        handle-as="json"
        on-response="_handleLikeResponse"
      ></iron-ajax>
      <app-toolbar>
        <lrnsys-button
          class="comment-button"
          raised
          on-click="handleTopReply"
          id="leavecomment"
          hover-class="blue white-text"
          label="Add Comment"
        ></lrnsys-button>
        <simple-fields-container
          id="filtertype"
          label="Filter Comments by"
          value="attributes.body"
        >
          <select>
            <option value="attributes.body">Body</option>
            <option value="relationships.author.data.name">User Name</option>
          </select>
        </simple-fields-container>
        <paper-input
          label="Filter Text"
          id="filtercomments"
          aria-controls="filteredcomments"
          value=""
          always-float-label=""
        ></paper-input>
      </app-toolbar>
      <grafitto-filter
        id="filteredcomments"
        items\$="[[_toArray(comments.data)]]"
        where=""
        as="filtered"
        like=""
      >
        <template>
          <template
            is="dom-repeat"
            id="commentlist"
            items="[[filtered]]"
            as="item"
          >
            <lrnsys-comment
              comment="{{item}}"
              hover-class="blue white-text"
            ></lrnsys-comment>
          </template>
        </template>
      </grafitto-filter>
    `}static get tag(){return"lrnsys-comment-list"}static get properties(){return{csrfToken:{type:String},opsRequestMethod:{type:Object,value:{list:"GET",create:"POST",update:"PUT",delete:"DELETE",like:"PATCH"}},activeComment:{type:Object,notify:!0},newComment:{type:Object,notify:!0},comments:{type:Object,notify:!0},sourcePath:{type:String,notify:!0},commentOpsBase:{type:String,notify:!0},createStubUrl:{type:String,notify:!0},reqUrl:{type:String,notify:!0,computed:"_computeCommentOpsUrl(activeComment, commentOpsBase, csrfToken)"}}}connectedCallback(){super.connectedCallback(),this.shadowRoot.querySelector("#filtercomments").addEventListener("value-changed",e=>{this.shadowRoot.querySelector("#filteredcomments").like=e.target.value}),this.shadowRoot.querySelector("#filtertype").addEventListener("change",e=>{this.shadowRoot.querySelector("#filtercomments").value="",this.shadowRoot.querySelector("#filteredcomments").where=e.detail.value,this.shadowRoot.querySelector("#filteredcomments").like=""})}disconnectedCallback(){this.shadowRoot.querySelector("#filtercomments").removeEventListener("value-changed",e=>{this.shadowRoot.querySelector("#filteredcomments").like=e.target.value}),this.shadowRoot.querySelector("#filtertype").removeEventListener("change",e=>{this.shadowRoot.querySelector("#filtercomments").value="",this.shadowRoot.querySelector("#filteredcomments").where=e.detail.value,this.shadowRoot.querySelector("#filteredcomments").like=""}),super.disconnectedCallback()}_computeCommentOpsUrl(e,t,o){if(void 0!==e)return t+"/"+e.id+"?token="+o}handleLike(e){this.activeComment=e.detail.comment,this.shadowRoot.querySelector("#ajaxlikerequest").generateRequest()}constructor(){super(),window.SimpleModal.requestAvailability(),setTimeout(()=>{this.addEventListener("comment-save",this.handleSave.bind(this)),this.addEventListener("comment-editing",this.handleEditing.bind(this)),this.addEventListener("comment-reply",this.handleReply.bind(this)),this.addEventListener("comment-like",this.handleLike.bind(this)),this.addEventListener("comment-delete-dialog",this.handleDeleteDialog.bind(this))},0)}_handleLikeResponse(e){}handleDeleteDialog(e){this.activeComment=e.detail.comment;let t=document.createElement("p"),o=document.createTextNode("Are you sure you want to delete your comment?");t.appendChild(o);let s=document.createElement("div");s.classList.add("buttons");let n=document.createElement("paper-button");n.setAttribute("dialog-dismiss","dialog-dismiss"),o=document.createTextNode("Decline"),n.appendChild(o),s.appendChild(n);let a=document.createElement("paper-button");a.setAttribute("dialog-confirm","dialog-confirm"),a.setAttribute("autofocus","autofocus"),a.addEventListener("click",this._handleDeleteConfirm.bind(this)),o=document.createTextNode("Accept"),a.appendChild(o),s.appendChild(a);const i=new CustomEvent("simple-modal-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{title:"Delete comment",elements:{content:t,buttons:s},invokedBy:e.detail.target,clone:!1}});this.dispatchEvent(i)}handleEditing(e){const t=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Be awesome to each other",duration:4e3}});this.dispatchEvent(t)}handleTopReply(e){this.set("newComment",[]),this.set("activeComment",[]),this.shadowRoot.querySelector("#ajaxcreatestub").generateRequest()}handleReply(e){this.set("newComment",[]),this.activeComment=e.detail.comment,this.shadowRoot.querySelector("#ajaxcreatestub").generateRequest()}_updateReply(e){var t=this.activeComment,o=this.comments.data;if(this.newComment=this.newComment.data,0==o.length)o.push(this.newComment);else if(void 0===t.id)o.push(this.newComment);else for(var s=0;s<o.length;s++)o[s].id==t.id&&o.splice(s+1,0,this.newComment);this.activeComment=this.newComment,this.set("comments.data",[]),this.set("comments.data",o),this.notifyPath("comments.data")}_handleDeleteConfirm(e){this.shadowRoot.querySelector("#ajaxdeleterequest").generateRequest()}_handleDeleteResponse(e){for(var t=this.activeComment,o=this.comments.data,s=0;s<o.length;s++)if(o[s].id==t.id){o.splice(s,1),this.set("activeComment",[]),this.set("comments.data",[]),this.set("comments.data",o),this.notifyPath("comments.data");const e=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Comment deleted",duration:4e3}});return this.dispatchEvent(e),!0}}handleSave(e){this.activeComment=e.detail.comment,this.shadowRoot.querySelector("#ajaxupdaterequest").generateRequest()}_handleUpdateResponse(e){const t=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"Comment saved!",duration:4e3}});this.dispatchEvent(t)}_toArray(e){return null==e?[]:Object.keys(e).map((function(t){return e[t]}))}}e.LrnsysCommentList=LrnsysCommentList,window.customElements.define(LrnsysCommentList.tag,LrnsysCommentList)}));