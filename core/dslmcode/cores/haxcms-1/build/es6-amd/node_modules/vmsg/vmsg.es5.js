"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function pad2(e){return(e|=0)<10?"0".concat(e):"".concat(Math.min(e,99))}function inlineWorker(){function fetchAndInstantiateFallback(e,t){return new Promise((function(r,n){var i=new XMLHttpRequest;i.open("GET",e),i.responseType="arraybuffer",i.onload=function(){r(WebAssembly.instantiate(i.response,t))},i.onerror=n,i.send()}))}var e=null,t=5242880;function sbrk(e){var r=t;return t+=e,r}function exit(e){postMessage({type:"internal-error",data:e})}var r=null,n=null,i=null;onmessage=function onmessage(t){var a=t.data;switch(a.type){case"init":var s=a.data,o=s.wasmURL,c=s.shimURL;Promise.resolve().then((function(){return self.WebAssembly&&!function testSafariWebAssemblyBug(){var e=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),t=new WebAssembly.Module(e);return 0!==new WebAssembly.Instance(t,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(c),{memory:e=new WebAssembly.Memory({initial:256,maximum:256}),pow:Math.pow,exit:exit,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:sbrk}})).then((function(e){return function fetchAndInstantiate(e,t){if(!WebAssembly.instantiateStreaming)return fetchAndInstantiateFallback(e,t);var r=fetch(e,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(r,t).catch((function(r){if(r.message&&r.message.indexOf("Argument 0 must be provided and must be a Response")>0)return fetchAndInstantiateFallback(e,t);throw r}))}(o,{env:e})})).then((function(e){r=e.instance.exports,postMessage({type:"init",data:null})})).catch((function(e){postMessage({type:"init-error",data:e.toString()})}));break;case"start":if(!function vmsg_init(t){if(!(n=r.vmsg_init(t)))return!1;var a=new Uint32Array(e.buffer,n,1)[0];return i=new Float32Array(e.buffer,a),!0}(a.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(!function vmsg_encode(e){return i.set(e),r.vmsg_encode(n,e.length)>=0}(a.data))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":var l=function vmsg_flush(){if(r.vmsg_flush(n)<0)return null;var t=new Uint32Array(e.buffer,n+4,1)[0],a=new Uint32Array(e.buffer,n+8,1)[0],s=new Uint8Array(e.buffer,t,a),o=new Blob([s],{type:"audio/mpeg"});return r.vmsg_free(n),n=null,i=null,o}();if(!l)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:l})}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.record=record,exports.default=exports.Form=exports.Recorder=void 0;var Recorder=function(){function Recorder(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,Recorder),this.wasmURL=new URL(e.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(e.shimURL||"/static/js/wasm-polyfill.js",location).href,this.onStop=t,this.pitch=e.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}return _createClass(Recorder,[{key:"close",value:function close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&this.worker.terminate(),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}},{key:"initAudio",value:function initAudio(){var e=this;return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(e){return navigator.mediaDevices.getUserMedia(e)}:function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(r,n){t.call(navigator,e,r,n)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then((function(t){e.stream=t;var r=e.audioCtx=new(window.AudioContext||window.webkitAudioContext),n=r.createMediaStreamSource(t),i=e.gainNode=(r.createGain||r.createGainNode).call(r);i.gain.value=1,n.connect(i);var a=e.pitchFX=new Jungle(r);a.setPitchOffset(e.pitch);var s=e.encNode=(r.createScriptProcessor||r.createJavaScriptNode).call(r,0,1,1);a.output.connect(s),i.connect(0===e.pitch?s:a.input)}))}},{key:"initWorker",value:function initWorker(){var e=this;if(!this.stream)throw new Error("missing audio initialization");var t=new Blob(["(",inlineWorker.toString(),")()"],{type:"application/javascript"}),r=this.workerURL=URL.createObjectURL(t),n=this.worker=new Worker(r),i=this.wasmURL,a=this.shimURL;return n.postMessage({type:"init",data:{wasmURL:i,shimURL:a}}),new Promise((function(t,r){n.onmessage=function(n){var i=n.data;switch(i.type){case"init":t();break;case"init-error":r(new Error(i.data));break;case"error":case"internal-error":console.error("Worker error:",i.data),e.reject&&e.reject(i.data);break;case"stop":e.blob=i.data,e.blobURL=URL.createObjectURL(i.data),e.onStop&&e.onStop(),e.resolve&&e.resolve(e.blob)}}}))}},{key:"init",value:function init(){return this.initAudio().then(this.initWorker.bind(this))}},{key:"startRecording",value:function startRecording(){var e=this;if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=function(t){var r=t.inputBuffer.getChannelData(0);e.worker.postMessage({type:"data",data:r})},this.encNode.connect(this.audioCtx.destination)}},{key:"stopRecording",value:function stopRecording(){var e=this;if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.stopTracks(),this.worker.postMessage({type:"stop",data:null}),new Promise((function(t,r){e.resolve=t,e.reject=r}))}},{key:"stopTracks",value:function stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach((function(e){return e.stop()}))}}]),Recorder}();exports.Recorder=Recorder;var Form=function(){function Form(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;_classCallCheck(this,Form),this.recorder=new Recorder(t,this.onStop.bind(this)),this.resolve=r,this.reject=n,this.backdrop=null,this.popup=null,this.recordBtn=null,this.stopBtn=null,this.timer=null,this.audio=null,this.saveBtn=null,this.tid=0,this.start=0,Object.seal(this),this.recorder.initAudio().then((function(){return e.drawInit()})).then((function(){return e.recorder.initWorker()})).then((function(){return e.drawAll()})).catch((function(t){return e.drawError(t)}))}return _createClass(Form,[{key:"drawInit",value:function drawInit(){var e=this;if(!this.backdrop){var t=this.backdrop=document.createElement("div");t.className="vmsg-backdrop",t.addEventListener("click",(function(){return e.close(null)}));var r=this.popup=document.createElement("div");r.className="vmsg-popup",r.addEventListener("click",(function(e){return e.stopPropagation()}));var n=document.createElement("div");n.className="vmsg-progress";for(var i=0;i<3;i++){var a=document.createElement("div");a.className="vmsg-progress-dot",n.appendChild(a)}r.appendChild(n),t.appendChild(r),document.body.appendChild(t)}}},{key:"drawTime",value:function drawTime(e){var t=Math.round(e/1e3);this.timer.textContent=pad2(t/60)+":"+pad2(t%60)}},{key:"drawAll",value:function drawAll(){var e=this;this.drawInit(),this.clearAll();var t=document.createElement("div");t.className="vmsg-record-row",this.popup.appendChild(t);var r=this.recordBtn=document.createElement("button");r.className="vmsg-button vmsg-record-button",r.textContent="●",r.addEventListener("click",(function(){return e.startRecording()})),t.appendChild(r);var n=this.stopBtn=document.createElement("button");n.className="vmsg-button vmsg-stop-button",n.style.display="none",n.textContent="■",n.addEventListener("click",(function(){return e.stopRecording()})),t.appendChild(n);var i=this.audio=new Audio;i.autoplay=!0;var a=this.timer=document.createElement("span");a.className="vmsg-timer",a.addEventListener("click",(function(){i.paused?e.recorder.blobURL&&(i.src=e.recorder.blobURL):i.pause()})),this.drawTime(0),t.appendChild(a);var s=this.saveBtn=document.createElement("button");s.className="vmsg-button vmsg-save-button",s.textContent="✓",s.disabled=!0,s.addEventListener("click",(function(){return e.close(e.recorder.blob)})),t.appendChild(s);var o=document.createElement("div");o.className="vmsg-slider-wrapper vmsg-gain-slider-wrapper";var c=document.createElement("input");c.className="vmsg-slider vmsg-gain-slider",c.setAttribute("type","range"),c.min=0,c.max=2,c.step=.2,c.value=1,c.onchange=function(){var t=+c.value;e.recorder.gainNode.gain.value=t},o.appendChild(c),this.popup.appendChild(o);var l=document.createElement("div");l.className="vmsg-slider-wrapper vmsg-pitch-slider-wrapper";var d=document.createElement("input");d.className="vmsg-slider vmsg-pitch-slider",d.setAttribute("type","range"),d.min=-1,d.max=1,d.step=.2,d.value=this.recorder.pitch,d.onchange=function(){var t=+d.value;e.recorder.pitchFX.setPitchOffset(t),e.recorder.gainNode.disconnect(),e.recorder.gainNode.connect(0===t?e.recorder.encNode:e.recorder.pitchFX.input)},l.appendChild(d),this.popup.appendChild(l)}},{key:"drawError",value:function drawError(e){console.error(e),this.drawInit(),this.clearAll();var t=document.createElement("div");t.className="vmsg-error",t.textContent=e.toString(),this.popup.appendChild(t)}},{key:"clearAll",value:function clearAll(){this.popup&&(this.popup.innerHTML="")}},{key:"close",value:function close(e){this.audio&&this.audio.pause(),this.tid&&clearTimeout(this.tid),this.recorder.close(),this.backdrop.remove(),e?this.resolve(e):this.reject(new Error("No record made"))}},{key:"onStop",value:function onStop(){this.recordBtn.style.display="",this.stopBtn.style.display="none",this.stopBtn.disabled=!1,this.saveBtn.disabled=!1}},{key:"startRecording",value:function startRecording(){this.audio.pause(),this.start=Date.now(),this.updateTime(),this.recordBtn.style.display="none",this.stopBtn.style.display="",this.saveBtn.disabled=!0,this.recorder.startRecording()}},{key:"stopRecording",value:function stopRecording(){clearTimeout(this.tid),this.tid=0,this.stopBtn.disabled=!0,this.recorder.stopRecording()}},{key:"updateTime",value:function updateTime(){var e=this;this.drawTime(Date.now()-this.start),this.tid=setTimeout((function(){return e.updateTime()}),300)}}]),Form}();exports.Form=Form;var shown=!1;function record(e){return new Promise((function(t,r){if(shown)throw new Error("Record form is already opened");shown=!0,new Form(e,t,r)})).then((function(e){return shown=!1,e}),(function(e){throw shown=!1,e}))}var _default={Recorder:Recorder,Form:Form,record:record};exports.default=_default;var delayTime=.1,fadeTime=.05,bufferTime=.1;function createFadeBuffer(e,t,r){for(var n=t*e.sampleRate,i=n+(t-2*r)*e.sampleRate,a=e.createBuffer(1,i,e.sampleRate),s=a.getChannelData(0),o=r*e.sampleRate,c=o,l=n-o,d=0;d<n;++d){var u;u=d<c?Math.sqrt(d/o):d>=l?Math.sqrt(1-(d-l)/o):1,s[d]=u}for(d=n;d<i;++d)s[d]=0;return a}function createDelayTimeBuffer(e,t,r,n){for(var i=t*e.sampleRate,a=i+(t-2*r)*e.sampleRate,s=e.createBuffer(1,a,e.sampleRate),o=s.getChannelData(0),c=0;c<i;++c)o[c]=n?(i-c)/a:c/i;for(c=i;c<a;++c)o[c]=0;return s}function Jungle(e){this.context=e;var t=(e.createGain||e.createGainNode).call(e),r=(e.createGain||e.createGainNode).call(e);this.input=t,this.output=r;var n=e.createBufferSource(),i=e.createBufferSource(),a=e.createBufferSource(),s=e.createBufferSource();this.shiftDownBuffer=createDelayTimeBuffer(e,bufferTime,fadeTime,!1),this.shiftUpBuffer=createDelayTimeBuffer(e,bufferTime,fadeTime,!0),n.buffer=this.shiftDownBuffer,i.buffer=this.shiftDownBuffer,a.buffer=this.shiftUpBuffer,s.buffer=this.shiftUpBuffer,n.loop=!0,i.loop=!0,a.loop=!0,s.loop=!0;var o=(e.createGain||e.createGainNode).call(e),c=(e.createGain||e.createGainNode).call(e),l=(e.createGain||e.createGainNode).call(e);l.gain.value=0;var d=(e.createGain||e.createGainNode).call(e);d.gain.value=0,n.connect(o),i.connect(c),a.connect(l),s.connect(d);var u=(e.createGain||e.createGainNode).call(e),h=(e.createGain||e.createGainNode).call(e),p=(e.createDelay||e.createDelayNode).call(e),m=(e.createDelay||e.createDelayNode).call(e);o.connect(u),c.connect(h),l.connect(u),d.connect(h),u.connect(p.delayTime),h.connect(m.delayTime);var f=e.createBufferSource(),v=e.createBufferSource(),g=createFadeBuffer(e,bufferTime,fadeTime);f.buffer=g,v.buffer=g,f.loop=!0,v.loop=!0;var b=(e.createGain||e.createGainNode).call(e),w=(e.createGain||e.createGainNode).call(e);b.gain.value=0,w.gain.value=0,f.connect(b.gain),v.connect(w.gain),t.connect(p),t.connect(m),p.connect(b),m.connect(w),b.connect(r),w.connect(r);var y=e.currentTime+.05,k=y+bufferTime-fadeTime;n.start(y),i.start(k),a.start(y),s.start(k),f.start(y),v.start(k),this.mod1=n,this.mod2=i,this.mod1Gain=o,this.mod2Gain=c,this.mod3Gain=l,this.mod4Gain=d,this.modGain1=u,this.modGain2=h,this.fade1=f,this.fade2=v,this.mix1=b,this.mix2=w,this.delay1=p,this.delay2=m,this.setDelay(delayTime)}Jungle.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},Jungle.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(delayTime*Math.abs(e))};