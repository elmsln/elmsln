define(["exports", "../../../../lit/index.js", "../buttons/rich-text-editor-button.js", "../../../simple-popover/simple-popover.js", "../../../simple-fields/simple-fields.js", "./rich-text-editor-highlight.js", "./rich-text-editor-range-behaviors.js"], function (_exports, _index, _richTextEditorButton, _simplePopover, _simpleFields, _richTextEditorHighlight, _richTextEditorRangeBehaviors) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.RichTextEditorPrompt = void 0;

  var _templateObject_e9c724c08e0011ed99ce491205e67b1d, _templateObject2_e9c724c08e0011ed99ce491205e67b1d;

  function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

  function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { babelHelpers.defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

  function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = babelHelpers.getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = babelHelpers.getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return babelHelpers.possibleConstructorReturn(this, result); }; }

  function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

  /**
   * `rich-text-editor-prompt`
   * `A utility that manages state of multiple rich-text-prompts on one page.`
   *
   * @customElement
   * @lit-html
   * @lit-element
   * @element rich-text-editor-prompt
   */
  var RichTextEditorPrompt = /*#__PURE__*/function (_RichTextEditorRangeB) {
    babelHelpers.inherits(RichTextEditorPrompt, _RichTextEditorRangeB);

    var _super = _createSuper(RichTextEditorPrompt);

    /**
     * Makes sure there is a utility ready and listening for elements.
     */
    function RichTextEditorPrompt() {
      var _this;

      babelHelpers.classCallCheck(this, RichTextEditorPrompt);
      _this = _super.call(this);
      window.addEventListener("rich-text-editor-prompt-open", _this.open.bind(babelHelpers.assertThisInitialized(_this))); // sets instance to current instance

      if (!window.RichTextEditorPrompt.instance) {
        window.RichTextEditorPrompt.instance = babelHelpers.assertThisInitialized(_this);
        return babelHelpers.possibleConstructorReturn(_this, babelHelpers.assertThisInitialized(_this));
      }

      return _this;
    }
    /**
     * hides prompt when not open
     *
     * @readonly
     * @memberof RichTextEditorPrompt
     */


    babelHelpers.createClass(RichTextEditorPrompt, [{
      key: "render",
      value: function render() {
        return (0, _index.html)(_templateObject_e9c724c08e0011ed99ce491205e67b1d || (_templateObject_e9c724c08e0011ed99ce491205e67b1d = babelHelpers.taggedTemplateLiteral(["\n      <simple-popover\n        id=\"prompt\"\n        ?auto=\"", "\"\n        for=\"", "\"\n        ?hidden=\"", "\"\n        position=\"bottom\"\n        position-align=\"center\"\n        .target=\"", "\"\n      >\n        <form\n          id=\"form\"\n          @blur=\"", "\"\n          @focus=\"", "\"\n        >\n          <simple-fields\n            id=\"formfields\"\n            hide-line-numbers\n            .fields=\"", "\"\n            @fields-ready=\"", "\"\n            .value=\"", "\"\n          ></simple-fields>\n          <div class=\"actions\">\n            <simple-toolbar-button\n              id=\"cancel\"\n              controls=\"", "\"\n              label=\"Cancel\"\n              icon=\"clear\"\n              @click=\"", "\"\n            >\n            </simple-toolbar-button>\n            <simple-toolbar-button\n              id=\"confirm\"\n              controls=\"", "\"\n              @click=\"", "\"\n              icon=\"check\"\n              label=\"OK\"\n            >\n            </simple-toolbar-button>\n          </div>\n        </form>\n      </simple-popover>\n    "])), !this.hidden || !this.__highlight.hidden, this.__highlight ? this.__highlight.id : "", this.hidden || this.__highlight.hidden, this.__highlight, this._handleBlur, this._handleFocus, this.fields, this._handleReady, this.value, this.__highlight ? this.__highlight.id : "", this._cancel, this.__highlight ? this.__highlight.id : "", this._confirm);
      }
      /**
       * Store tag name to make it easier to obtain directly.
       */

    }, {
      key: "hidden",
      get: function get() {
        return !this.__opened;
      }
    }, {
      key: "firstUpdated",
      value: function firstUpdated(changedProperties) {
        var _this2 = this;

        if (babelHelpers.get(babelHelpers.getPrototypeOf(RichTextEditorPrompt.prototype), "firstUpdated", this)) babelHelpers.get(babelHelpers.getPrototypeOf(RichTextEditorPrompt.prototype), "firstUpdated", this).call(this, changedProperties);

        this.__highlight.addEventListener("change", function (e) {
          return setTimeout(_this2._handleChange(e), 300);
        });

        this.addEventListener("mousedown", function (e) {
          return _this2.__retainFocus = true;
        });
        this.addEventListener("mouseup", function (e) {
          return _this2.__retainFocus = false;
        });
        this.addEventListener("focusin", function (e) {
          return _this2.__retainFocusIn = true;
        });
        this.addEventListener("focusout", function (e) {
          return _this2.__retainFocusIn = false;
        });
        this.addEventListener("focus", this._handleFocus);
        this.addEventListener("blur", this._handleBlur);
      }
    }, {
      key: "updated",
      value: function updated(changedProperties) {
        var _this3 = this;

        if (babelHelpers.get(babelHelpers.getPrototypeOf(RichTextEditorPrompt.prototype), "updated", this)) babelHelpers.get(babelHelpers.getPrototypeOf(RichTextEditorPrompt.prototype), "updated", this).call(this, changedProperties);
        changedProperties.forEach(function (oldValue, propName) {
          if (["__focused", "__hovered", "__opened"].includes(propName)) setTimeout(_this3._handleChange.bind(_this3), 300);
        });
      }
      /**
       * sets focus when prompt is ready
       *
       * @param {event} e
       * @memberof RichTextEditorPrompt
       */

    }, {
      key: "_handleReady",
      value: function _handleReady(e) {
        e.detail.focus();
      }
      /**
       * handles focus so that RichTextEditorSelection
       * can track whether prompt has focus
       *
       * @param {event} e
       * @memberof RichTextEditorPrompt
       */

    }, {
      key: "_handleFocus",
      value: function _handleFocus(e) {
        this.__focused = true;
      }
      /**
       * handles blur so that RichTextEditorSelection
       * can track whether prompt has focus
       *
       * @param {event} e
       * @memberof RichTextEditorPrompt
       */

    }, {
      key: "_handleBlur",
      value: function _handleBlur(e) {
        if (this.__retainFocus || this.__retainFocusIn) return;
        this.__focused = false;
      }
      /**
       * handles changes in open, focus, or hover status
       * to cancel prompt if needed
       *
       * @param {event} e
       * @memberof RichTextEditorPrompt
       */

    }, {
      key: "_handleChange",
      value: function _handleChange(e) {
        var _this4 = this;

        setTimeout(function () {
          if (_this4.__opened && !_this4.__focused && !_this4.__hovered) _this4._cancel();
        }, 500);
      }
      /**
       * opens prompt and generates for fields
       *
       * @param {event} e event that opens the prompt
       * @memberof RichTextEditorPrompt
       */

    }, {
      key: "open",
      value: function open(e) {
        if (e && e.detail) {
          this.__opened = true;
          this.__focused = true;
          this.button = e.detail;
          this.fields = babelHelpers.toConsumableArray(e.detail.fields);
          this.value = _objectSpread({}, e.detail.value);
          if (this.shadowRoot.querySelector("#formfields") && this.shadowRoot.querySelector("#formfields").rebuildForm) this.shadowRoot.querySelector("#formfields").rebuildForm();
          if (this.shadowRoot.querySelector("#cancel")) this.shadowRoot.querySelector("#cancel").focus();
        }
      }
      /**
       * closes prompt
       *
       * @memberof RichTextEditorPrompt
       */

    }, {
      key: "close",
      value: function close() {
        this.__opened = false;
        this.__focused = false;
        this.button = undefined;
        this.fields = [];
        this.value = {};
      }
      /**
       * handles cancel button
       * @param {event} e event
       * @returns {void}
       */

    }, {
      key: "_cancel",
      value: function _cancel(e) {
        if (e) e.preventDefault();
        if (this.button) this.button.cancel();
        this.close();
      }
      /**
       * Handles confirm button
       * @param {event} e event
       * @returns {void}
       */

    }, {
      key: "_confirm",
      value: function _confirm(e) {
        e.preventDefault();
        this.button.confirm(this.value);
        this.close();
      }
    }], [{
      key: "styles",
      get: function get() {
        return [].concat(babelHelpers.toConsumableArray(_richTextEditorButton.RichTextToolbarStyles), [(0, _index.css)(_templateObject2_e9c724c08e0011ed99ce491205e67b1d || (_templateObject2_e9c724c08e0011ed99ce491205e67b1d = babelHelpers.taggedTemplateLiteral(["\n        #prompt {\n          display: block;\n          width: 300px;\n          max-width: 300px;\n          --simple-popover-padding: 0px;\n          z-index: 2;\n        }\n        #prompt[hidden] {\n          display: none;\n        }\n        #prompt #form {\n          display: flex;\n          flex-direction: column;\n          align-items: center;\n          justify-content: space-between;\n          z-index: 2;\n        }\n        #formfields {\n          width: calc(100% - 20px);\n          padding: 10px 10px 0;\n          overflow: visible;\n        }\n        #prompt simple-fields-field {\n          padding: 0;\n        }\n        #confirm,\n        #cancel {\n          min-width: unset;\n        }\n        #cancel {\n          color: var(--rich-text-editor-button-color);\n          background-color: var(--rich-text-editor-button-bg);\n        }\n        #cancel:focus,\n        #cancel:hover {\n          color: var(--rich-text-editor-button-hover-color);\n          background-color: var(--rich-text-editor-button-hover-bg);\n        }\n        #confirm {\n          color: var(--rich-text-editor-button-color);\n          background-color: var(--rich-text-editor-button-bg);\n        }\n        #confirm:focus,\n        #confirm:hover {\n          color: var(--rich-text-editor-button-hover-color);\n          background-color: var(--rich-text-editor-button-hover-bg);\n        }\n        .actions {\n          width: calc(100% - 20px);\n          padding: 0 10px 3px;\n          display: flex;\n          align-items: center;\n          justify-content: flex-end;\n        }\n        .confirm-or-cancel {\n          min-width: 40px;\n        }\n      "])))]);
      }
    }, {
      key: "tag",
      get: function get() {
        return "rich-text-editor-prompt";
      } // properties available to custom element for data binding

    }, {
      key: "properties",
      get: function get() {
        return {
          /**
           * fields for prompt popover.
           */
          fields: {
            type: Array
          },

          /**
           * selected text.
           */
          range: {
            type: Object
          },

          /**
           * prefilled value of prompt
           */
          value: {
            type: Object
          },

          /**
           * whether prompt has focus
           */
          __focused: {
            type: Boolean
          },

          /**
           * whether prompt is hovered
           */
          __hovered: {
            type: Boolean
          },

          /**
           * whether prompt isopen
           */
          __opened: {
            type: Boolean
          }
        };
      }
    }]);
    return RichTextEditorPrompt;
  }((0, _richTextEditorRangeBehaviors.RichTextEditorRangeBehaviors)(_index.LitElement));

  _exports.RichTextEditorPrompt = RichTextEditorPrompt;
  customElements.define(RichTextEditorPrompt.tag, RichTextEditorPrompt);
  // register globally so we can make sure there is only one
  window.RichTextEditorPrompt = window.RichTextEditorPrompt || {}; // request if this exists. This helps invoke element existing in dom
  // as well as that there is only one of them. That way we can ensure everything
  // is rendered through same modal

  window.RichTextEditorPrompt.requestAvailability = function () {
    if (!window.RichTextEditorPrompt.instance) {
      window.RichTextEditorPrompt.instance = document.createElement("rich-text-editor-prompt");
      document.body.appendChild(window.RichTextEditorPrompt.instance);
    }

    return window.RichTextEditorPrompt.instance;
  };
});