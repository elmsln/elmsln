const e=!1,t="attachShadow"in Element.prototype&&"getRootNode"in Element.prototype,n=!(!t||!document.createElement("div").attachShadow({mode:"open"}).getSelection),o=window.ShadyDOM&&window.ShadyDOM.inUse,i=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)||/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,r=!t||o||!n&&!i,a=/^(area|base|br|col|command|embed|hr|img|input|keygen|link|meta|param|script|source|style|template|track|wbr)$/;export const eventName="-shadow-selectionchange";const c=[Node.ELEMENT_NODE,Node.TEXT_NODE,Node.DOCUMENT_FRAGMENT_NODE];export function findCaretFocus(e,t){const n=[],pushAll=e=>{for(let t=0;t<e.length;++t)e[t].shadowRoot&&n.push(e[t].shadowRoot)};for(t.shadowRoot&&n.push(t.shadowRoot),pushAll(t.childNodes);n.length;){const t=n.shift();for(let n=0;n<t.childNodes.length;++n)if(e.containsNode(t.childNodes[n],!0))return t;pushAll(t.querySelectorAll("*"))}return null}function findNode(t,n,o){const i=n.childNodes||n.children;if(!i)return n;for(let d=0;d<i.length;++d){const l=i[o?d:i.length-1-d];if(r=l,c.includes(r.nodeType)){if(e&&console.debug("checking child",l,"IsLeft",o),t.containsNode(l,!0)){if(t.containsNode(l,!1))return e&&console.info("found child",l),l;if(!a.exec(l.localName||""))return e&&console.info("descending child",l),findNode(t,l,o)}e&&console.info(n,"does NOT contain",l)}}var r;return n}let d={node:null,offset:-1};function containsNextElement(e,t,n){const o=t;for(;(t=walkFromNode(t,n))&&t.contains(o););return!!t&&(t instanceof Element&&e.containsNode(t,!0))}function walkFromNode(e,t){if(!t)return e.previousSibling||e.parentNode||null;for(;e;){if(e.nextSibling)return e.nextSibling;e=e.parentNode}return null}!function(){if(n||r)return document.addEventListener("selectionchange",(e=>{document.dispatchEvent(new CustomEvent(eventName))})),()=>{};let e=!1;document.addEventListener("selectionchange",(t=>{if(e)return;e=!0;const n=window.getSelection();if("Caret"===n.type){const e=findCaretFocus(n,n.anchorNode);if(e instanceof window.ShadowRoot){const t=getRange(e);if(t){const e=t.startContainer,n=t.startOffset;d={node:e,offset:n}}}}document.dispatchEvent(new CustomEvent("-shadow-selectionchange")),window.requestAnimationFrame((()=>{e=!1}))}))}();const l=new Map;export function getRange(t){if(r){const e=document.getSelection();return e.containsNode(t,!0)?e.getRangeAt(0):null}if(n){const e=t.getSelection();return e.rangeCount?e.getRangeAt(0):null}const o=l.get(t);if(o)return o;const i=function internalGetShadowSelection(t){const n=window.getSelection();if("None"===n.type)return{range:null,type:"none"};if("Caret"!==n.type&&"Range"!==n.type)throw new TypeError("unexpected type: "+n.type);const o=findNode(n,t,!0);if(o===t)return{range:null,mode:"none"};const i=document.createRange();let r,a=null;if("Range"===n.type&&(a=findNode(n,t,!1),r=function getSelectionDirection(t,n,o){if("Range"!==t.type)return;const measure=()=>t.toString().length,i=measure();let r;return e&&console.info(`initial selection: "${t.toString()}"`),t.modify("extend","forward","character"),r=measure(),e&&console.info(`forward selection: "${t.toString()}"`),r>i||containsNextElement(t,o,!0)?(e&&console.info("got forward >, moving right"),t.modify("extend","backward","character"),!0):r<i||!t.containsNode(n)?(e&&console.info("got forward <, moving left"),t.modify("extend","backward","character"),!1):(t.modify("extend","backward","character"),r=measure(),e&&console.info(`backward selection: "${t.toString()}"`),r>i||containsNextElement(t,n,!1)?(e&&console.info("got backwards >, moving left"),t.modify("extend","forward","character"),!1):r<i||!t.containsNode(o)?(e&&console.info("got backwards <, moving right"),t.modify("extend","forward","character"),!0):void 0)}(n,o,a),void 0===r))return i.setStart(o,0),i.setEnd(a,a.length),{range:i,mode:"all"};const c=n.toString().length;let l=0,s=0;if(null===a);else if(a.nodeType===Node.TEXT_NODE){const e=a.textContent,t=a.nextSibling;for(let t=e.length-1;t>=0;--t){a.splitText(t);if(n.toString().length!==c){s=t+1;break}}for(a.insertData(a.length,e.substr(a.length));a.nextSibling!==t;)a.nextSibling.remove()}if(o.nodeType===Node.TEXT_NODE){o!==a&&(o.appendData("?"),n.collapseToStart(),n.modify("extend","right","character"));const e=o.textContent,t=o.nextSibling;for(let t=o===a?s:e.length-1;t>=0;--t)if(o.splitText(t),""===n.toString()){l=t;break}for(o.insertData(o.length,e.substr(o.length));o.nextSibling!==t;)o.nextSibling.remove();o!==a&&o.deleteData(o.length-1,1),null===a&&(a=o,s=l)}else null===a&&(a=o);1===c&&d&&d.node===o&&d.offset>l&&r&&(r=!1);!0===r?(n.collapse(o,l),n.extend(a,s)):!1===r?(n.collapse(a,s),n.extend(o,l)):n.setPosition(o,l);return i.setStart(o,l),i.setEnd(a,s),{range:i,mode:"normal"}}(t);return l.set(t,i.range),window.setTimeout((()=>{l.delete(t)}),0),e&&console.debug("getRange got",i),i.range}