Object.defineProperty(exports,"__esModule",{value:!0}),exports.RichTextEditorSelection=void 0;var e=require("lit");require("@lrnwebcomponents/utils/utils.js");function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(e){return typeof e}:function _typeof(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _templateObject2_9c696bc0942811ecb1937969798b231a(){var e=_taggedTemplateLiteral(["\n        :host {\n  background-color: var(--rich-text-editor-selection-bg, rgb(146, 197, 255));\n          margin: 0;\n          padding: 0;\n          display: inline-block;\n        }\n        :host([hidden]) {\n          display: none;\n        }\n        :host([collapsed]):after {\n          content: '|';\n          color: var(--simple-toolbar-selection-bg);\n          background-color: transparent;\n        }\n        :host + *,\n        ::slotted(*) {\n  background-color: var(--rich-text-editor-selection-bg, rgb(146, 197, 255));\n        }\n      "]);return _templateObject2_9c696bc0942811ecb1937969798b231a=function _templateObject2_9c696bc0942811ecb1937969798b231a(){return e},e}function _templateObject_9c696bc0942811ecb1937969798b231a(){var e=_taggedTemplateLiteral(["<slot></slot>"]);return _templateObject_9c696bc0942811ecb1937969798b231a=function _templateObject_9c696bc0942811ecb1937969798b231a(){return e},e}function _taggedTemplateLiteral(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _get(e,t,n){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function _get(e,t,n){var o=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(o){var i=Object.getOwnPropertyDescriptor(o,t);return i.get?i.get.call(n):i.value}},_get(e,t,n||e)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}var t=function(t){function RichTextEditorSelection(){var e;!function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,RichTextEditorSelection),e=function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}(this,_getPrototypeOf(RichTextEditorSelection).call(this));var t=_assertThisInitialized(e);return e.hidden=!0,e.__toolbars=[],e.__clipboard=document.createElement("textarea"),e.__clipboard.setAttribute("aria-hidden",!0),e.__clipboard.style.position="absolute",e.__clipboard.style.left="-9999px",e.__clipboard.style.top="0px",e.__clipboard.style.width="0px",e.__clipboard.style.height="0px",e.id=e._generateUUID(),document.body.appendChild(e.__clipboard),window.addEventListener("register",e._handleRegistration.bind(t)),e}return function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}(RichTextEditorSelection,e.LitElement),_createClass(RichTextEditorSelection,[{key:"validCommands",get:function get(){return["backColor","bold","copy","createLink","cut","decreaseFontSize","defaultParagraphSeparator","delete","fontName","fontSize","foreColor","formatBlock","forwardDelete","hiliteColor","increaseFontSize","indent","insertBrOnReturn","insertHorizontalRule","insertHTML","insertImage","insertLineBreak","insertOrderedList","insertUnorderedList","insertParagraph","insertText","italic","justifyCenter","justifyFull","justifyLeft","justifyRight","outdent","paste","redo","removeFormat","selectAll","strikethrough","styleWithCss","subscript","superscript","undo","unlink","useCSS"]}}]),_createClass(RichTextEditorSelection,[{key:"render",value:function render(){return(0,e.html)(_templateObject_9c696bc0942811ecb1937969798b231a())}},{key:"updated",value:function updated(e){_get(_getPrototypeOf(RichTextEditorSelection.prototype),"updated",this).call(this,e),e.forEach((function(e,t){}))}},{key:"disconnectedCallback",value:function disconnectedCallback(){_get(_getPrototypeOf(RichTextEditorSelection.prototype),"disconnectedCallback",this).call(this)}},{key:"cancelEdits",value:function cancelEdits(e){e.revert(),this.edit(e,!1)}},{key:"closeToolbar",value:function closeToolbar(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.editor;t&&this.disableEditing(t),e.editor=void 0,document.body.append(e)}},{key:"disableEditing",value:function disableEditing(e){e&&(this.getRoot(e).onselectionchange=void 0,e.viewSource=!1,e.disableEditing(),e.makeSticky(!1))}},{key:"edit",value:function edit(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e){var n=e?this.getConnectedToolbar(e):void 0,o=t?n.editor:void 0;this.highlight(n,!1),n&&o!==e&&(o&&this.disableEditing(o),n.editor=e,this.enableEditing(e,n))}}},{key:"enableEditing",value:function enableEditing(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getConnectedToolbar(e);e&&(e.makeSticky(n.sticky),e.parentNode.insertBefore(n,e),e.enableEditing(),this.updateRange(e),this.getRoot(e).onselectionchange=function(o){n.__promptOpen||t.updateRange(e)})}},{key:"expandRangeTo",value:function expandRangeTo(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1?arguments[1]:void 0,n=t?this.getRangeNode(t):void 0,o=n&&n.tagName?n.tagName.toLowerCase():void 0,i=e.toLowerCase().replace(/\s*/g,"").split(",");return i.includes(o)?n:n.closest(e)?(t.selectNode(n.closest(e)),t):void 0}},{key:"getRangeNode",value:function getRangeNode(e){var t=e?e.commonAncestorContainer:void 0,n=e?e.startContainer:void 0,o=e?e.startOffset:void 0,i=e?e.endContainer:void 0,r=e?e.endOffset:void 0,a=n&&n.children?n.children[o-1]:void 0;return n===i&&r-o==1?a:t}},{key:"getRoot",value:function getRoot(e){return e&&e!==document?e.parentNode?this.getRoot(e.parentNode):e:document}},{key:"getConnectedToolbar",value:function getConnectedToolbar(e){if(e.id||(e.id=this._generateUUID()),!e.__connectedToolbar){var t,n=e.toolbar?(this.__toolbars||[]).filter((function(t){return e.toolbar&&t.id===e.toolbar})):[];0===n.length&&(n=e.type?(this.__toolbars||[]).filter((function(t){return e.type&&t.type===e.type})):[]),0===n.length&&(n=this.__toolbars),n[0]?t=n[0]:0===n.length&&(t=document.createElement(e.type||"rich-text-editor-toolbar"),e.parentNode.insertBefore(t,e)),t.id=t.id||e.toolbar||this._generateUUID(),e.__connectedToolbar=t}return e.__connectedToolbar}},{key:"highlight",value:function highlight(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;this.toolbar=e;var o=e?e.editor:void 0;o&&(!1!==t?e.range&&(this.hidden=!1,e.range.insertNode(this),n&&this.append(n),e.range.setStartAfter(this),this.range=e.range):(this.updateRange(e.editor,e.range),this.hidden=!0,this.toolbar=void 0,this.range=void 0,document.body.appendChild(this)),this.dispatchEvent(new CustomEvent("change",{bubbles:!0,cancelable:!0,composed:!0,detail:t})))}},{key:"highlightNode",value:function highlightNode(e,t){this.selectNode(e,t.range,t.editor),this.highlight(t)}},{key:"pasteFromClipboard",value:function pasteFromClipboard(e){var t=this;setTimeout((function _callee(){var n,o,i;return regeneratorRuntime.async((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return n=window.getSelection(),o=e.range,r.next=4,regeneratorRuntime.awrap(navigator.clipboard.readText());case 4:i=r.sent,t.__clipboard.value=i,t.__clipboard.focus(),t.__clipboard.select(),document.execCommand("paste"),n.removeAllRanges(),n.addRange(o),t.pasteIntoEditor(e,t.__clipboard.value);case 12:case"end":return r.stop()}}))}),2e3)}},{key:"pasteIntoEditor",value:function pasteIntoEditor(e,t){if(e){var n=e.range,o=document.createElement("div");if(e=n.commonAncestorContainer.parentNode.closest("[editing=true]:not([disabled]),input:not([disabled]),textarea:not([disabled])")){for(o.innerHTML=e.sanitizeHTML(t),n&&n.extractContents&&n.extractContents(),n.insertNode(o);o.firstChild;)o.parentNode.insertBefore(o.firstChild,o);o.parentNode.removeChild(o)}}}},{key:"registerEditor",value:function registerEditor(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=e?this.getConnectedToolbar(e):void 0,i={click:function click(n){return t._handleEditorClick(e,n)},focus:function focus(n){o.__promptOpen||e.disabled||t.edit(e)},getrange:function getrange(n){o.__promptOpen||(t.toolbar=o,t.updateRange(e,e.range))},keydown:function keydown(n){return t._handleShortcutKeys(e,n)},pastefromclipboard:function pastefromclipboard(e){return t.pasteFromClipboard(e.detail)},pastecontent:function pastecontent(e){return t._handlePaste(e)}};return n?Object.keys(i).forEach((function(t){return e.removeEventListener(t,i[t])})):Object.keys(i).forEach((function(t){return e.addEventListener(t,i[t])})),(e.__connectedToolbar.show=!e.__connectedToolbar.editor)&&this.edit(e),e.__connectedToolbar}},{key:"registerToolbar",value:function registerToolbar(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o={command:function command(n){n.stopImmediatePropagation();var o=n.detail||{};t._handleCommand(e,o.command,o.commandVal,o.range),o.button&&o.button.commandCallback&&o.button.commandCallback(e.editor,e,t)},disableediting:function disableediting(e){return t.disableEditing((e.detail||{}).editor)},highlight:function highlight(n){t.highlight(e,n.detail)},highlightnode:function highlightnode(n){t.highlightNode(n.detail,e)},pastefromclipboard:function pastefromclipboard(e){e.stopImmediatePropagation(),t.pasteFromClipboard(e.detail)},"rich-text-editor-prompt-closed":function richTextEditorPromptClosed(t){e.__promptOpen=!1},"rich-text-editor-prompt-open":function richTextEditorPromptOpen(t){e.__promptOpen=!0},setrange:function setrange(e){t.range=(e.detail||{}).range,t.updateRange((e.detail||{}).editor,t.range),t.selectRange(t.range,(e.detail||{}).editor)},selectnode:function selectnode(n){t.selectNode(n.detail,e.range,e.editor)},selectnodecontents:function selectnodecontents(n){t.selectNodeContents(n.detail,e.range,e.editor)},selectrange:function selectrange(n){t.selectRange(n.detail,e.editor)},wrapselection:function wrapselection(n){t.surroundRange(n.detail,e.range)}};n||e.registered?(e.registered=!1,Object.keys(o).forEach((function(t){return e.removeEventListener(t,o[t])}))):(this.__toolbars.push(e),Object.keys(o).forEach((function(t){return e.addEventListener(t,o[t])})),e.registered=!0)}},{key:"selectNode",value:function selectNode(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.toolbar.editor;if(!t){var o=window.getSelection();t=document.createRange(),o.removeAllRanges(),o.addRange(t)}t&&(t.selectNode(e),n&&this.updateRange(n,t))}},{key:"selectNodeContents",value:function selectNodeContents(e,t,n){if(e){if(!t){var o=window.getSelection();t=document.createRange(),o.removeAllRanges(),o.addRange(t)}t&&(t.selectNodeContents(e),n&&this.updateRange(n,t))}}},{key:"selectRange",value:function selectRange(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;if(e){if(t){var o=window.getSelection();o.removeAllRanges(),o.addRange(e)}else e.isCollapsed||e.collapse();n&&this.updateRange(n)}return e}},{key:"surroundRange",value:function surroundRange(e,t){return t&&(t.surroundContents(e),editor&&this.updateRange(editor)),t}},{key:"updateRange",value:function updateRange(e,t){if(e){var n=this.getConnectedToolbar(e);this.toolbar=n,t||(t=e.range),e.range=t,n&&(n.selectedNode=e.selectedNode,n.selectionAncestors=e.selectionAncestors,n.range=t)}}},{key:"_generateUUID",value:function _generateUUID(){var e=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return"rte-"+"ss-s-s-s-sss".replace(/s/g,e)}},{key:"_handleBlur",value:function _handleBlur(e,t){null===t.relatedTarget||"rich-text-editor"===!t.relatedTarget.startsWith?this.edit(e,!0):e&&this.highlight(e.toolbar)}},{key:"_handleCommand",value:function _handleCommand(e,t,n,o){var i=e.editor;this.validCommands.includes(t)?(n=i?i.sanitizeHTML(n):n,this.range=i.range,this.updateRange(i,o),this.selectRange(o,i),"paste"!=t?document.execCommand(t,!1,n):navigator.clipboard&&this.pasteFromClipboard(i),this.highlight(e,!1)):"cancel"===t?(i&&i.revert(),e.close(i)):"close"===t&&e.close(i)}},{key:"_handleEditorClick",value:function _handleEditorClick(e,t){if(e&&!e.disabled){var n=this.getConnectedToolbar(e),o=e.__focused;if(n&&n.editor===e||this.edit(e),e.focus(),o){var i=n?Object.keys(n.clickableElements||{}):[],r=t.target||t.srcElement||{tagName:""},a={detail:r},l=(r.tagName||"").toLowerCase();l&&i.includes(l)&&(console.log(r),t.preventDefault(),n.clickableElements[l](a))}}}},{key:"_handleRegistration",value:function _handleRegistration(e){e.detail&&(e.detail.toolbar&&this.registerToolbar(e.detail.toolbar,e.detail.remove),e.detail.editor&&this.registerEditor(e.detail.editor,e.detail.remove))}},{key:"_handleShortcutKeys",value:function _handleShortcutKeys(e,t){var n=e?this.getConnectedToolbar(e):void 0;e.editing&&n._handleShortcutKeys(t)}}],[{key:"tag",get:function get(){return"rich-text-editor-selection"}},{key:"properties",get:function get(){return{editor:{type:Object},collapsed:{type:Boolean,reflect:!0,attribute:"collapsed"},hidden:{type:Boolean,reflect:!0,attribute:"hidden"},id:{type:String,reflect:!0,attribute:"id"},observer:{type:Object},range:{type:Object},toolbar:{type:Object},__toolbars:{type:Array}}}},{key:"styles",get:function get(){return[(0,e.css)(_templateObject2_9c696bc0942811ecb1937969798b231a())]}}]),RichTextEditorSelection}();exports.RichTextEditorSelection=t,window.customElements.define(t.tag,t),window.RichTextEditorSelection={},window.RichTextEditorSelection.instance=null,window.RichTextEditorSelection.requestAvailability=function(){return null==window.RichTextEditorSelection.instance&&(window.RichTextEditorSelection.instance=document.createElement(t.tag),document.body.appendChild(window.RichTextEditorSelection.instance)),window.RichTextEditorSelection.instance};