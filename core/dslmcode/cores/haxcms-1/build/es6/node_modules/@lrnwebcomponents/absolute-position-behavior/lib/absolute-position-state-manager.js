/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../../lit/index.js";window.AbsolutePositionStateManager=window.AbsolutePositionStateManager||{},window.AbsolutePositionStateManager.requestAvailability=()=>{if(!window.AbsolutePositionStateManager.instance){window.AbsolutePositionStateManager.instance=document.createElement("absolute-position-state-manager");let t=window.AbsolutePositionStateManager.instance;document.body.appendChild(t)}return window.AbsolutePositionStateManager.instance};class AbsolutePositionStateManager extends t{static get tag(){return"absolute-position-state-manager"}static get properties(){return{scrollTarget:{type:Object},elements:{type:Array},__observer:{type:Object},__timeout:{type:Object},__timeout2:{type:Object}}}constructor(){super(),this.windowControllers=new AbortController,this.elements=[],this.__timeout=!1,this.__observer=new MutationObserver((t=>this.checkMutations(t)))}loadElement(t){this.elements.length<1&&(this.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.updateElements(),this.windowControllers=new AbortController,document.addEventListener("load",this.updateElements.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("resize",this._handleResize.bind(this),{signal:this.windowControllers.signal})),this.elements.filter((e=>e===t)).length<1&&(this.elements.push(t),t.style.top=0,t.style.left=0),this.positionElement(t)}unloadElement(t){this.elements=this.elements.filter((e=>e!==t)),this.elements.length<1&&this.removeEventListeners()}_handleScroll(){this.__timeout2&&clearTimeout(this.__timeout2),this.__timeout2=setTimeout(window.AbsolutePositionStateManager.instance.updateStickyElements(),1e3)}_handleResize(){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(window.AbsolutePositionStateManager.instance.updateElements(),250)}checkMutations(t){let e=!1;t.forEach((t=>{e||(e=e||!("attributes"===t.type&&"style"===t.attributeName&&this.elements.includes(t.target)))})),e&&(this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(window.AbsolutePositionStateManager.instance.updateElements(),250))}findTarget(t){let e="#"+t.for,i=t.target,o=t;for(;t.for&&!i&&o&&o.parentNode&&o!==document;)o=o.parentNode,i=o?o.querySelector(e):void 0,11===o.nodeType&&(o=o.host),i=!i&&o?o.querySelector(e):i;return i}removeEventListeners(){this.__observer&&this.__observer.disconnect&&this.__observer.disconnect(),this.windowControllers.abort(),this.__watchSticky&&this.scrollTarget&&this.scrollTarget.removeEventListener("scroll",this._handleScroll)}updateElements(){this.elements.forEach((t=>this.positionElement(t))),this.loadSticky()}updateStickyElements(){this.elements.forEach((t=>{t.sticky&&this.positionElement(t)}))}loadSticky(){!this.__watchSticky&&this.elements.filter((t=>t.sticky)).length>0&&this.scrollTarget?(this.__watchSticky=!0,this.scrollTarget.addEventListener("scroll",this._handleScroll,{passive:!0})):this.__watchSticky&&this.elements.filter((t=>t.sticky)).length<1&&this.scrollTarget&&(this.scrollTarget.removeEventListener("scroll",this._handleScroll,{passive:!0}),this.__watchSticky=!1)}_getParentNode(t){let e=t.parentNode;return null!=e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(e=e.host),e}positionElement(t){t.position||(t.position="bottom"),t.style.position="absolute",t.style.top||(t.style.top="0px"),t.style.left||(t.style.left="0px");let e=this.findTarget(t),i=t.offsetParent,o=e&&e.getBoundingClientRect?e.getBoundingClientRect():{};if(!e||!i)return;t.justify&&(t.style.width=`${o.width}px`);let s=document.body.getBoundingClientRect(),n=i.getBoundingClientRect(),l=t.getBoundingClientRect(),r=parseFloat(t.offset),pxToNum=t=>parseFloat(t.replace("px","")),vertical=(e=t.position)=>"left"!==e&&"right"!==e,setAlign=(e=vertical(t.position))=>{let i,n=e?pxToNum(t.style.left)-l.left:pxToNum(t.style.top)-l.top,r=e?"left":"top",distance=t=>e?t.width:t.height,a=n+distance(s)-distance(l),h=n;return"end"===t.positionAlign?h+=o[r]-distance(l)+distance(o):"start"===t.positionAlign?h+=o[r]:h+=o[r]-distance(l)/2+distance(o)/2,i=t.fitToVisibleBounds?Math.max(n,Math.min(a,h)):h,i},getCoord=(e=t.position)=>{let i,s=vertical(e)?pxToNum(t.style.top)-l.top:pxToNum(t.style.left)-l.left,n=t.allowOverlap||"visible"!=window.getComputedStyle(t,null).overflowY?l.height:Math.max(l.height,t.scrollHeight),a=t.allowOverlap||"visible"!=window.getComputedStyle(t,null).overflowX?l.width:Math.max(l.width,t.scrollWidth);return i="top"===e?o.top+s-n-r:"left"===e?o.left+s-a-r:o[e]+s+r,i},isFit=(e=t.position)=>{let distance=t=>vertical(e)?l.height+r:l.width+r;return((e=t.position)=>"left"===e||"top"===e)(e)?o[e]-s[e]>distance:s[e]-o[e]>distance},a=!1!==t.fitToVisibleBounds&&!isFit(t.position),h={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};a&&isFit(h[t.position][0])?t.position=h[t.position][0]:a&&isFit(h[t.position][1])?t.position=h[t.position][1]:a&&isFit(h[t.position][2])&&(t.position=h[t.position][2]);let d=vertical(t.position)?getCoord():setAlign(),p=vertical(t.position)?setAlign():getCoord();if(t.sticky){let e=window.pageYOffset||(document.documentElement||document.body.parentNode||document.body).scrollTop,s=window.innerHeight,n=0===l.height&&t.children&&t.children[0]?t.children[0].offsetHeight:l.height,r=o.top-l.height<0&&o.top+o.height>20+n,a=o.top+o.height+l.height>s&&o.top<s-n;"top"===t.position&&r&&(d=e-i.offsetTop+(n-l.height)),"bottom"===t.position&&a&&(d=e+s-i.offsetTop-n)}t.style.top=d+"px",t.style.left=p+"px",t.__positions={self:l,parent:n,target:o}}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};