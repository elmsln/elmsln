import{html as t,css as e,unsafeCSS as s}from"../../../../lit/index.js";import{SimpleColors as i}from"../../../simple-colors/simple-colors.js";import{autorun as a,toJS as o}from"../../../../mobx/dist/mobx.esm.js";import{store as p}from"./AppHaxStore.js";import{localStorageSet as n}from"../../../utils/utils.js";import"../../../../scrollable-component/index.js";import"../../../simple-icon/lib/simple-icon-lite.js";import{MicroFrontendRegistry as r}from"../../../micro-frontend-registry/micro-frontend-registry.js";import{enableServices as l}from"../../../micro-frontend-registry/lib/microServices.js";import"./app-hax-site-button.js";import"./app-hax-hat-progress.js";import"./app-hax-button.js";const h=new URL("../assets/images/Home.svg",import.meta.url).href,c=new URL("../assets/images/DisabledCircle.svg",import.meta.url).href,d=new URL("../assets/images/TransparentCircle.svg",import.meta.url).href,m=new URL("../assets/images/EnabledCircle.svg",import.meta.url).href,u={portfolio:["haxor-slevin","bootstrap-theme"],course:["clean-one","clean-two","learn-two-theme"],website:["bootstrap-theme","outline-player","haxor-slevin"]};export class AppHaxSteps extends i{static get tag(){return"app-hax-steps"}constructor(){super(),this.nameTyped="",this.stepRoutes=[],this._progressReady=!1,this.step=null,this.loaded=!1,this.themeNames=[],this.appSettings={},a((()=>{this.appSettings=o(p.appSettings);const t=o(p.site.structure);this.themeNames=Object.keys(this.appSettings.themes).filter((e=>t&&u[t]&&u[t].includes(e)))})),a((()=>{this.dark=o(p.darkMode)})),a((()=>{n("app-hax-step",o(p.step))})),a((()=>{n("app-hax-site",o(p.site)),this.step=p.stepTest(this.step)})),a((()=>{o(p.createSiteSteps)&&o(p.location)&&(this.step=p.stepTest(this.step))})),a((()=>{const t=o(p.routes);this.stepRoutes=t.filter((t=>t.step))}))}static get properties(){return{...super.properties,step:{type:Number,reflect:!0},stepRoutes:{type:Array},themeNames:{type:Array},loaded:{type:Boolean,reflect:!0},appSettings:{type:Object},nameTyped:{type:String}}}chooseStructure(t){if(!t.target.comingSoon){const{value:e}=t.target;p.site.structure=e,p.appEl.playSound("click2")}}chooseType(t){if(!t.target.comingSoon){const{type:e}=t.target;p.site.type=e,p.appEl.playSound("click2")}}async docxImport(t){if(!t.target.comingSoon){const{type:e}=t.target;import("../../../file-system-broker/lib/docx-file-system-broker.js").then((async t=>{l(["haxcms"]);const s=window.FileSystemBroker.requestAvailability(),i=await s.loadFile("docx"),a=new FormData;a.append("method","site"),a.append("type",o(p.site.structure)),a.append("upload",i);const n=await r.call("@haxcms/docxToSite",a);200==n.status&&n.data&&""!=n.data.contents?(p.items=n.data.items,this.nameTyped=n.data.filename.replace(".docx","").replace("outline","").replace(/\s/g,"").replace(/-/g,"").toLowerCase(),setTimeout((()=>{this.shadowRoot.querySelector("#sitename").value=this.nameTyped,this.shadowRoot.querySelector("#sitename").select()}),800),p.site.type=e,p.site.theme="clean-one",p.appEl.playSound("click2")):(p.appEl.playSound("error"),p.toast("File did not return valid HTML"),t.preventDefault())}))}}chooseTheme(t){if(!t.target.comingSoon){const{value:e}=t.target;p.site.theme=e,p.appEl.playSound("click2")}}chooseName(){if(""!==this.nameTyped){const t=this.shadowRoot.querySelector("#sitename").value;p.site.name=t,p.appEl.playSound("click2")}}progressReady(t){t.detail&&(this._progressReady=!0,5===this.step&&setTimeout((()=>{this.shadowRoot.querySelector("app-hax-hat-progress").process()}),300))}updated(t){super.updated&&super.updated(t),t.forEach(((t,e)=>{4===this.step&&"step"===e&&this.shadowRoot&&(this.shadowRoot.querySelector("#sitename").value=o(p.site.name)),5===this.step&&"step"===e&&this.shadowRoot&&this._progressReady&&setTimeout((()=>{this.shadowRoot.querySelector("app-hax-hat-progress").process()}),600),"step"===e&&(p.step=this.step)}))}connectedCallback(){super.connectedCallback(),window.addEventListener("resize",this.maintainScroll.bind(this)),window.addEventListener("popstate",this.popstateListener.bind(this))}disconnectedCallback(){window.removeEventListener("resize",this.maintainScroll.bind(this)),window.removeEventListener("popstate",this.popstateListener.bind(this)),super.disconnectedCallback()}popstateListener(t){if("popstate"===t.type&&null===t.state)try{setTimeout((()=>{const e=t.target.document.location.pathname.split("/").pop();if(e.includes("createSite")){const t=parseInt(e.replace("createSite-step-",""));t<p.stepTest(t)?this.shadowRoot.querySelector("#link-step-"+t).click():t>p.stepTest(t)&&(p.toast("Please select an option"),this.step=p.stepTest(t),this.shadowRoot.querySelector("#link-step-"+this.step).click())}}),0)}catch(t){}}maintainScroll(){this.shadowRoot&&this.step&&(this.scrollToThing(`#step-${this.step}`,{behavior:"instant",block:"start",inline:"nearest"}),setTimeout((()=>{this.scrollToThing(`#step-${this.step}`,{behavior:"instant",block:"start",inline:"nearest"})}),100))}firstUpdated(t){super.firstUpdated&&super.firstUpdated(t),setTimeout((()=>{null===this.step&&(this.step=1),this.scrollToThing(`#step-${this.step}`,{behavior:"instant",block:"start",inline:"nearest"})}),100),a((()=>{if(o(p.createSiteSteps)&&o(p.appReady)){const t=o(p.location);t.route&&t.route.step&&t.route.name&&setTimeout((()=>{this.scrollToThing("#".concat(t.route.name),{behavior:"smooth",block:"start",inline:"nearest"}),4===t.route.step&&4===p.stepTest(4)&&setTimeout((()=>{this.shadowRoot.querySelector("#sitename").focus(),this.scrollToThing("#step-4",{behavior:"instant",block:"start",inline:"nearest"})}),800)}),300)}})),a((()=>{if(this.shadowRoot&&o(p.createSiteSteps)&&o(p.appReady)){const t=o(p.activeItem);t&&t.name&&t.step&&!this.__overrideProgression&&this.shadowRoot.querySelector("#link-".concat(t.name)).click()}}))}scrollToThing(t,e){const s=void 0!==window.safari;this.shadowRoot.querySelector(".carousel-with-snapping-item.active-step")&&this.shadowRoot.querySelector(".carousel-with-snapping-item.active-step").classList.remove("active-step"),s?this.shadowRoot.querySelector(t).scrollIntoView():this.shadowRoot.querySelector(t).scrollIntoView(e),this.shadowRoot.querySelector(t).classList.add("active-step")}static get styles(){return[...super.styles,e`
        :host {
          display: block;
        }
        scrollable-component {
          --scrollbar-width: 0px;
          --scrollbar-height: 0px;
          --scrollbar-padding: 0;
          --viewport-overflow-x: hidden;
          overflow: hidden;
        }
        #grid-container {
          display: grid;
          grid-template-columns: 200px 200px 200px;
          background: transparent;
        }
        .carousel-with-snapping-track {
          display: grid;
          grid-auto-flow: column;
          grid-gap: 30px;
        }
        .carousel-with-snapping-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: normal;
          scroll-snap-align: center;
          scroll-snap-stop: always;
          scrollbar-gutter: stable;
          width: var(--viewport-width);
          font-size: 1.5rem;
          text-align: center;
          overflow-x: hidden;
          max-height: 60vh;
          padding-top: 1vh;
        }
        #step-links {
          padding: 0;
          margin: 0;
        }
        ul,
        li {
          list-style: none;
        }
        li {
          vertical-align: middle;
          display: inline-flex;
          margin: 5px;
        }
        li.step {
          border-radius: 50%;
          background-color: transparent;
        }
        li a {
          font-size: 12px;
          color: var(--simple-colors-default-theme-grey-12, white);
          text-decoration: none;
          padding: 5px;
          width: 20px;
          height: 20px;
          line-height: 20px;
          margin: 0;
          display: block;
          border: 0;
          border-radius: 50%;
          background-repeat: no-repeat;
          background-size: 30px 30px;
          background-color: var(--simple-colors-default-theme-grey-1, white);
          background-image: url("${s(m)}");
          transition: 0.3s ease-in-out background, 0.3s ease-in-out color;
          transition-delay: 0.6s, 0.3s;
        }
        li a[disabled] {
          background-image: url("${s(c)}");
          pointer-events: none;
          color: var(--simple-colors-default-theme-grey-7, grey);
          user-select: none;
        }
        li[disabled] {
          background-color: grey;
        }
        li.active-step a {
          background-color: orange;
          background-image: url("${s(d)}");
        }
        app-hax-button {
          padding: 10px 0px 10px 0px;
          background: transparent;
        }
        #theme-container {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: center;
        }
        img {
          pointer-events: none;
        }
        #themeContainer {
          width: 70vw;
          height: 55vh;
        }
        .theme-button {
          background-color: transparent;
          color: var(--simple-colors-default-theme-grey-12, white);
          border: none;
          margin: 8px;
          padding: 8px;
          width: 245px;
        }

        .theme-button div {
          font-family: "Press Start 2P", sans-serif;
          font-size: 14px;
          margin-top: 12px;
        }
        .theme-button:focus,
        .theme-button:hover {
          outline: 4px solid var(--app-hax-accent-color, var(--accent-color));
          outline-offset: 4px;
          background-color: transparent;
          border: none;
          cursor: pointer;
        }
        #sitename {
          font-family: "Press Start 2P", sans-serif;
          font-size: 32px;
          padding: 8px;
          width: 40vw;
        }
        #homebtn {
          --simple-icon-height: 30px;
          --simple-icon-width: 30px;
          border-radius: 50%;
          cursor: pointer;
          background-color: var(--simple-colors-default-theme-grey-1, white);
        }
        .homelnk {
          background-image: none;
          display: flex;
          padding: 0;
          margin: 0;
          height: 30px;
          width: 30px;
        }
        app-hax-site-button {
          justify-content: center;
          --app-hax-site-button-width: 35vw;
          --app-hax-site-button-min-width: 240px;
        }
        app-hax-hat-progress {
          height: 400px;
          width: 400px;
          display: block;
        }

        @media (max-width: 800px) {
          .theme-button {
            width: unset;
            padding: 0;
          }
          .theme-button div {
            font-size: 12px;
            margin-top: 8px;
          }
          .theme-button img {
            height: 70px;
          }
          app-hax-site-button {
            width: 320px;
            max-width: 60vw;
            --app-hax-site-button-font-size: 2.5vw;
          }
          #sitename {
            width: 70vw;
            font-size: 20px;
          }
          #grid-container {
            grid-template-columns: 150px 150px 150px;
          }
        }
        @media (max-height: 600px) {
          .carousel-with-snapping-item {
            padding-top: 4px;
            max-height: 57vh;
          }
          #sitename {
            width: 40vw;
            font-size: 14px;
          }
          app-hax-hat-progress {
            transform: scale(0.5);
            margin-top: -18vh;
          }
        }
        @media (max-width: 500px) {
          app-hax-hat-progress {
            transform: scale(0.5);
            margin-top: -15vh;
          }
        }
        @media (max-height: 400px) {
          .carousel-with-snapping-item {
            padding-top: 4px;
            max-height: 40vh;
          }
          app-hax-hat-progress {
            transform: scale(0.3);
          }
          .carousel-with-snapping-item.active-step app-hax-hat-progress {
            position: fixed;
            top: 20%;
            left: 20%;
          }
        }
      `]}progressFinished(t){t.detail&&(this.loaded=!0,p.appEl.playSound("success"),t.target.shadowRoot.querySelector(".game").focus(),this.scrollToThing(`#step-${this.step}`,{behavior:"instant",block:"start",inline:"nearest"}))}typeKey(){this.nameTyped=this.shadowRoot.querySelector("#sitename").value}keydown(t){[" ","/","\\","&","#","?","+","=","{","}","|","^","~","[","]","`",'"',"'"].includes(t.key)?(p.appEl.playSound("error"),p.toast(`"${t.key}" not allowed in names`),t.preventDefault()):"Enter"===t.key?this.chooseName():["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"].includes(t.key)||p.appEl.playSound("click")}stepLinkClick(t){const e=parseInt(t.target.getAttribute("data-step"),10);this.step<e?t.preventDefault():null===t.target.getAttribute("data-step")?(p.createSiteSteps=!1,p.appMode="home",this.nameTyped="",p.siteReady=!1,p.site.structure=null,p.site.type=null,p.site.theme=null,p.site.name=null):this.step>e&&(this.nameTyped="",p.siteReady=!1,1===e?(p.site.structure=null,p.site.type=null,p.site.theme=null,p.site.name=null):2===e?(p.site.type=null,p.site.theme=null,p.site.name=null):3===e?(p.site.theme=null,p.site.name=null):4===e&&(p.site.name=null),this.step=e)}renderTypes(e){const s=o(p.site.structure);var i=t``;switch(s){case"portfolio":i=t` <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="technology"
            coming-soon
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="business"
            coming-soon
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="art"
            coming-soon
          ></app-hax-button>`;break;default:case"course":i=t` <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="15w"
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="6w"
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="training"
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.docxImport}
            type="docx import"
          ></app-hax-button>`;break;case"website":i=t` <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            type="blog"
          ></app-hax-button>
          <app-hax-button
            tabindex="${2!==e?"-1":""}"
            @click=${this.chooseType}
            coming-soon
          ></app-hax-button>`}return i}render(){return t`
      <div id="container">
        <ul id="step-links">
          <li>
            ${o(p.isNewUser)?t``:t`
                  <a href="home" class="homelnk" tabindex="-1">
                    <simple-icon-lite
                      tabindex="0"
                      src="${h}"
                      id="homebtn"
                      title="Site list"
                      @click="${this.stepLinkClick}"
                    ></simple-icon-lite>
                  </a>
                  <simple-tooltip for="homebtn" position="bottom"
                    >Site list</simple-tooltip
                  >
                `}
          </li>
          ${this.stepRoutes.map(((e,s)=>t`<li
                ?disabled="${this.step<e.step||5===this.step}"
                class="step ${this.step===e.step?"active-step":""}"
              >
                <a
                  href="${e.path}"
                  ?disabled="${this.step<e.step||5===this.step}"
                  tabindex="${this.step<=e.step?"-1":"0"}"
                  @click="${this.stepLinkClick}"
                  id="link-${e.name}"
                  title="Step ${s+1}: ${e.label}"
                  data-step="${e.step}"
                  >${s+1}</a
                >
                <simple-tooltip for="link-${e.name}" position="bottom"
                  >Step ${s+1}: ${e.label}</simple-tooltip
                >
              </li>`))}
        </ul>
        <scrollable-component>
          <div class="carousel-with-snapping-track">
            <div class="carousel-with-snapping-item" id="step-1">
              <div class="step-wrapper">
                <app-hax-site-button
                  tabindex="${1!==this.step?"-1":""}"
                  label="&gt; Course"
                  value="course"
                  @click=${this.chooseStructure}
                ></app-hax-site-button>
                <app-hax-site-button
                  tabindex="${1!==this.step?"-1":""}"
                  label="&gt; Portfolio"
                  value="portfolio"
                  @click=${this.chooseStructure}
                ></app-hax-site-button>
                <app-hax-site-button
                  tabindex="${1!==this.step?"-1":""}"
                  label="&gt; Website"
                  value="website"
                  @click=${this.chooseStructure}
                  coming-soon
                ></app-hax-site-button>
              </div>
            </div>
            <div class="carousel-with-snapping-item" id="step-2">
              <div id="grid-container">${this.renderTypes(this.step)}</div>
            </div>
            <div class="carousel-with-snapping-item" id="step-3">
              <div id="themeContainer">
                ${this.appSettings&&this.appSettings.themes?this.themeNames.map((e=>t`
                        <button
                          aria-label="${this.appSettings.themes[e].name} theme"
                          value="${e}"
                          class="theme-button"
                          @click=${this.chooseTheme}
                          tabindex="${3!==this.step?"-1":""}"
                        >
                          <img
                            class="theme-img"
                            src="${this.appSettings.themes[e].thumbnail}"
                            alt=""
                            loading="lazy"
                            decoding="async"
                          />
                          <div>${this.appSettings.themes[e].name}</div>
                        </button>
                      `)):""}
              </div>
            </div>
            <div class="carousel-with-snapping-item" id="step-4">
              <input
                id="sitename"
                @input="${this.typeKey}"
                @keydown="${this.keydown}"
                maxlength="30"
                placeholder="${o(p.site.structure)} name.."
                tabindex="${4!==this.step?"-1":""}"
              />
              <app-hax-site-button
                class="sitenamebtn"
                tabindex="${4!==this.step?"-1":""}"
                label="&gt; Create journey"
                @click=${this.chooseName}
                ?disabled="${""===this.nameTyped}"
              >
              </app-hax-site-button>
            </div>
            <div class="carousel-with-snapping-item" id="step-5">
              <app-hax-hat-progress
                @progress-ready="${this.progressReady}"
                @promise-progress-finished="${this.progressFinished}"
                tabindex="${5!==this.step?"-1":""}"
              ></app-hax-hat-progress>
            </div>
          </div>
        </scrollable-component>
      </div>
    `}}customElements.define(AppHaxSteps.tag,AppHaxSteps);