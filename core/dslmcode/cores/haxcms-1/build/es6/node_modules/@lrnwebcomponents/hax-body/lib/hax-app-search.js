import{html as e,css as t}from"../../../lit-element/lit-element.js";import{SimpleColors as i}from"../../simple-colors/simple-colors.js";import{HAXStore as a}from"./hax-store.js";import{autorun as s,toJS as o}from"../../../mobx/dist/mobx.esm.js";class HaxAppSearch extends i{static get styles(){return[...super.styles,t`
        :host {
          display: block;
        }
        hexagon-loader {
          display: none;
          justify-content: center;
          width: 100%;
          z-index: 1000;
          position: absolute;
          --hexagon-color: var(--hax-color-bg-accent, #0085ba);
        }
        hexagon-loader[loading] {
          display: block;
          opacity: 0.8;
        }
        .card-content {
          padding: 16px;
        }
        .card-content p {
          padding: 0;
          margin: 0;
        }
        #itemlist {
          min-height: 172px;
          text-align: center;
          align-items: center;
        }
        hax-app-search-inputs {
          min-height: 80px;
          padding: 0 16px;
        }
        hax-app-pagination {
          min-height: 32px;
          font-size: 12.8px;
          display: none;
          justify-content: flex-end;
          justify-content: center;
        }
        .tos-text {
          font-size: 12px;
        }
        .tos-text ul {
          padding: 4px;
          margin: 0 16px;
        }
        .tos-text a {
          font-size: 12px;
          color: blue;
          text-decoration: underline;
        }
        .tos-text a:hover,
        .tos-text a:focus,
        .tos-text a:active {
          outline: 2px solid blue;
        }
      `]}constructor(){super(),this.auto=!1,this.headers={},this.method="GET",this.loading=!1,this.requestData={},this.media=[],this.tos=[],this.resultMap={},import("../../simple-fields/lib/simple-fields-field.js"),import("../../simple-fields/lib/simple-fields-container.js"),import("../../hexagon-loader/hexagon-loader.js"),import("./hax-app-search-inputs.js"),import("./hax-app-search-result.js"),s(()=>{this.activeApp=o(a.activeApp)})}render(){return e`
      ${this.tos.length>0?e`
            <div class="tos-text">Terms of service:</div>
            <ul class="tos-text">
              ${this.tos.map(t=>e`
                  <li>
                    <a
                      href="${t.link}"
                      target="_blank"
                      rel="noopener nofollow noreferrer"
                      >${t.title}</a
                    >
                  </li>
                `)}
            </ul>
          `:""}
      <hax-app-search-inputs
        id="searchinput"
        .label="${this.label}"
        .schema="${this.searchSchema}"
        @search-values-changed="${this._searchValuesChanged}"
      ></hax-app-search-inputs>
      <hax-app-pagination
        id="pagerbottom"
        .request-data="${this.requestData}"
        .pagination="${this.pagination}"
      ></hax-app-pagination>
      <hexagon-loader
        size="medium"
        item-count="4"
        ?loading="${this.loading}"
        aria-roledescription="Loading"
      ></hexagon-loader>
      <div id="itemlist">
        ${this.media.map(t=>e`
            <hax-app-search-result
              image="${t.image}"
              title="${t.title}"
              details="${t.details}"
              .map="${t.map}"
              type="${t.type}"
            ></hax-app-search-result>
          `)}
      </div>
    `}async loadAppData(){this.loading=!0;let e=this.requestUrl(this.requestEndPoint,this.requestParams);await fetch(e,{headers:this.headers,method:this.method}).then(e=>{if(e.ok)return e.json()}).then(e=>{this._requestDataChanged(e)})}updated(e){e.forEach((e,t)=>{["auto","method","headers","requestEndPoint","requestParams"].includes(t)&&(clearTimeout(this.__debounce),this.__debounce=setTimeout(()=>{this.requestEndPoint&&this.loadAppData()},100)),"activeApp"==t&&(this.requestParams={},this.searchSchema={},setTimeout(()=>{this.searchSchema={properties:{}},this._resetAppSearch(this.activeApp)},10))})}requestUrl(e="",t={}){var i="";if(null!=a.connectionRewrites.appendUploadEndPoint&&t.__HAXAPPENDUPLOADENDPOINT__&&(i=a.connectionRewrites.appendUploadEndPoint+"&"),null!=a.connectionRewrites.appendJwt&&t.__HAXJWT__&&(t[a.connectionRewrites.appendJwt]=localStorage.getItem(a.connectionRewrites.appendJwt)),i+=this.queryStringData(t)){var s=e.indexOf("?")>=0?"&":"?";return e+s+i}return e}queryStringData(e){var t,i,a=[];for(t in e)if(i=e[t],"__HAXJWT__"==t||"__HAXAPPENDUPLOADENDPOINT__"==t);else if(Array.isArray(i))for(var s=0;s<i.length;s++)a.push(t+"="+window.encodeURIComponent(i[s]));else null!==i?a.push(t+"="+window.encodeURIComponent(i)):a.push(t);return a.join("&")}static get tag(){return"hax-app-search"}static get properties(){return{activeApp:{type:Object},tos:{type:Array},auto:{type:Boolean},searchSchema:{type:Object},headers:{type:Object},method:{type:String},loading:{type:Boolean},requestData:{type:Object},media:{type:Array},requestEndPoint:{type:String},requestParams:{type:Object},resultMap:{type:Object}}}_searchValuesChanged(e){let t=this.requestParams;for(let i in e.detail)""!=e.detail[i]&&(t[i]=e.detail[i]);this.requestParams={...this.requestParams}}_resetAppSearch(e){if(e&&e.details){let s=e;var t={};this.label=s.details.title,s.details.tos&&s.details.tos.length>0?this.tos=[...s.details.tos]:this.tos=[],this.label=s.details.title,this.auto=!1,this.media=[],void 0!==s.connection.data&&(t=s.connection.data),void 0!==s.connection.operations.browse.data&&(t=Object.assign(t,s.connection.operations.browse.data)),this.method=s.connection.operations.browse.method,this.headers={},void 0!==s.connection.headers&&(this.headers=s.connection.headers),this.requestParams={...t};var i=s.connection.protocol+"://"+s.connection.url;"/"!=i.substr(i.length-1)&&(i+="/"),void 0!==s.connection.operations.browse.endPoint&&(i+=s.connection.operations.browse.endPoint),this.requestEndPoint=i;var a={properties:{}};void 0!==s.connection.operations.browse.search&&(a.properties=s.connection.operations.browse.search,this.searchSchema={...a}),this.resultMap=s.connection.operations.browse.resultMap,this.pagination={},void 0!==s.connection.operations.browse.pagination&&(this.pagination=s.connection.operations.browse.pagination),void 0!==s.connection.auto?this.auto=s.connection.auto:this.auto=!0}}_requestDataChanged(e){if(this.resultMap&&typeof e!={}){let s=[],o=this.resultMap,r=[];if(this.resultMap.items?void 0!==this._resolveObjectPath(o.items,e)?r=this._resolveObjectPath(o.items,e):null!=e&&(r=e):r=e,null!=r){for(var t=0;t<r.length;t++){if(s[t]={title:this._resolveObjectPath(o.preview.title,r[t]),details:this._resolveObjectPath(o.preview.details,r[t]),type:o.defaultGizmoType,map:{}},void 0!==s[t].details&&null!=s[t].details&&(s[t].details=s[t].details.replace(/(<([^>]+)>)/gi,"")),o.preview.id.constructor===Object){let e=this._resolveObjectPath(o.preview.id.property,r[t]);"split"===o.preview.id.op&&(e=e.split(o.preview.id.delimiter),s[t].id=e[o.preview.id.position])}else s[t].id=this._resolveObjectPath(o.preview.id,r[t]);for(var i in void 0!==o.preview.image?s[t].image=this._resolveObjectPath(o.preview.image,r[t]):void 0!==o.image?s[t].image=o.image:s[t].image="",o.gizmo)if("_url_source"===i){let e="";e=void 0!==s[t].map.__id?s[t].map.__id:this._resolveObjectPath(o.gizmo.id,r[t]),s[t].map.source=o.gizmo._url_source.replace("<%= id %>",e),s[t].map.url=s[t].map.source}else if(o.gizmo[i].constructor===Object){let e=this._resolveObjectPath(o.gizmo[i].property,r[t]);"split"===o.gizmo[i].op&&(e=e.split(o.gizmo[i].delimiter),s[t].map[i]=e[o.gizmo[i].position],"id"===i&&(s[t].map.__id=s[t].map[i]))}else s[t].map[i]=this._resolveObjectPath(o.gizmo[i],r[t]);void 0===s[t].map.url&&void 0!==s[t].map.source&&(s[t].map.url=s[t].map.source),void 0!==o.gizmo.type?s[t].type=this._resolveObjectPath(o.gizmo.type,r[t]):void 0!==o.gizmo.mimetype?s[t].type=a.mimeTypeToGizmoType(this._resolveObjectPath(o.gizmo.mimetype,r[t])):"*"!=a.guessGizmoType(o.gizmo)&&(s[t].type=a.guessGizmoType(o.gizmo))}this.media=[...s]}}this.loading=!1}_resolveObjectPath(e,t){return e.split(".").reduce((function(e,t){return e?e[t]:null}),t||self)}}window.customElements.define(HaxAppSearch.tag,HaxAppSearch);export{HaxAppSearch};