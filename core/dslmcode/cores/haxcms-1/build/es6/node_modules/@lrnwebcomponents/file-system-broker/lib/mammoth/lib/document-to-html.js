var e=require("underscore"),t=require("./promises"),n=require("./documents"),r=require("./styles/html-paths"),o=require("./results"),l=require("./images"),i=require("./html"),c=require("./writers");function DocumentConversion(m,f){var s=1,d=[],h=[],p=void 0===(m=e.extend({ignoreEmptyParagraphs:!0},m)).idPrefix?"":m.idPrefix,v=m.ignoreEmptyParagraphs,y=r.topLevelElement("p"),g=m.styleMap||[];function convertElements(e,t,n){return flatMap(e,(function(e){return elementToHtml(e,t,n)}))}function elementToHtml(e,t,n){if(!n)throw new Error("options not set");var r=I[e.type];return r?r(e,t,n):[]}function findHtmlPathForRunProperty(e,t){var n=findHtmlPath({type:e});return n||(t?r.element(t,{},{fresh:!1}):r.empty)}function findHtmlPath(e,t){var n=findStyle(e);return n?n.to:t}function findStyle(e){for(var t=0;t<g.length;t++)if(g[t].from.matches(e))return g[t]}function noteHtmlId(e){return referentHtmlId(e.noteType,e.noteId)}function noteRefHtmlId(e){return referenceHtmlId(e.noteType,e.noteId)}function referentHtmlId(e,t){return htmlId(e+"-"+t)}function referenceHtmlId(e,t){return htmlId(e+"-ref-"+t)}function htmlId(e){return p+e}var H=r.elements([r.element("table",{},{fresh:!0})]);function convertComment(e,t,n){var r=e.label,o=e.comment,l=convertElements(o.body,t,n).concat([i.nonFreshElement("p",{},[i.text(" "),i.freshElement("a",{href:"#"+referenceHtmlId("comment",o.commentId)},[i.text("↑")])])]);return[i.freshElement("dt",{id:referentHtmlId("comment",o.commentId)},[i.text("Comment "+r)]),i.freshElement("dd",{},l)]}var E,I={document:function(e,t,n){var r=convertElements(e.children,t,n),o=convertElements(d.map((function(t){return e.notes.resolve(t)})),t,n);return r.concat([i.freshElement("ol",{},o),i.freshElement("dl",{},flatMap(h,(function(e){return convertComment(e,t,n)})))])},paragraph:function convertParagraph(e,t,n){return function htmlPathForParagraph(e,t){var n=findStyle(e);return n?n.to:(e.styleId&&t.push(unrecognisedStyleWarning("paragraph",e)),y)}(e,t).wrap((function(){var r=convertElements(e.children,t,n);return v?r:[i.forceWrite].concat(r)}))},run:function convertRun(e,t,o){var nodes=function(){return convertElements(e.children,t,o)},l=[];e.isSmallCaps&&l.push(findHtmlPathForRunProperty("smallCaps")),e.isAllCaps&&l.push(findHtmlPathForRunProperty("allCaps")),e.isStrikethrough&&l.push(findHtmlPathForRunProperty("strikethrough","s")),e.isUnderline&&l.push(findHtmlPathForRunProperty("underline")),e.verticalAlignment===n.verticalAlignment.subscript&&l.push(r.element("sub",{},{fresh:!1})),e.verticalAlignment===n.verticalAlignment.superscript&&l.push(r.element("sup",{},{fresh:!1})),e.isItalic&&l.push(findHtmlPathForRunProperty("italic","em")),e.isBold&&l.push(findHtmlPathForRunProperty("bold","strong"));var i=r.empty,c=findStyle(e);return c?i=c.to:e.styleId&&t.push(unrecognisedStyleWarning("run",e)),l.push(i),l.forEach((function(e){nodes=e.wrap.bind(e,nodes)})),nodes()},text:function(e,t,n){return[i.text(e.value)]},tab:function(e,t,n){return[i.text("\t")]},hyperlink:function(e,t,n){var r={href:e.anchor?"#"+htmlId(e.anchor):e.href};null!=e.targetFrame&&(r.target=e.targetFrame);var o=convertElements(e.children,t,n);return[i.nonFreshElement("a",r,o)]},bookmarkStart:function(e,t,n){return[i.freshElement("a",{id:htmlId(e.name)},[i.forceWrite])]},noteReference:function(e,t,n){d.push(e);var r=i.freshElement("a",{href:"#"+noteHtmlId(e),id:noteRefHtmlId(e)},[i.text("["+s+++"]")]);return[i.freshElement("sup",{},[r])]},note:function(e,t,n){var o=convertElements(e.body,t,n),l=i.elementWithTag(r.element("p",{},{fresh:!1}),[i.text(" "),i.freshElement("a",{href:"#"+noteRefHtmlId(e)},[i.text("↑")])]),c=o.concat([l]);return i.freshElement("li",{id:noteHtmlId(e)},c)},commentReference:function convertCommentReference(e,t,n){return findHtmlPath(e,r.ignore).wrap((function(){var t=f[e.commentId],n=h.length+1,r="["+u(t)+n+"]";return h.push({label:r,comment:t}),[i.freshElement("a",{href:"#"+referentHtmlId("comment",e.commentId),id:referenceHtmlId("comment",e.commentId)},[i.text(r)])]}))},comment:convertComment,image:(E=function recoveringConvertImage(e){return function(n,r){return t.attempt((function(){return e(n,r)})).caught((function(e){return r.push(o.error(e)),[]}))}}(m.convertImage||l.dataUri),function(e,t,n){return[{type:"deferred",id:a++,value:function(){return E(e,t,n)}}]}),table:function convertTable(t,r,o){return findHtmlPath(t,H).wrap((function(){return function convertTableChildren(t,r,o){var l,c=e.findIndex(t.children,(function(e){return!e.type===n.types.tableRow||!e.isHeader}));-1===c&&(c=t.children.length);if(0===c)l=convertElements(t.children,r,e.extend({},o,{isTableHeader:!1}));else{var a=convertElements(t.children.slice(0,c),r,e.extend({},o,{isTableHeader:!0})),u=convertElements(t.children.slice(c),r,e.extend({},o,{isTableHeader:!1}));l=[i.freshElement("thead",{},a),i.freshElement("tbody",{},u)]}return[i.forceWrite].concat(l)}(t,r,o)}))},tableRow:function convertTableRow(e,t,n){var r=convertElements(e.children,t,n);return[i.freshElement("tr",{},[i.forceWrite].concat(r))]},tableCell:function convertTableCell(e,t,n){var r=n.isTableHeader?"th":"td",o=convertElements(e.children,t,n),l={};return 1!==e.colSpan&&(l.colspan=e.colSpan.toString()),1!==e.rowSpan&&(l.rowspan=e.rowSpan.toString()),[i.freshElement(r,l,[i.forceWrite].concat(o))]},break:function convertBreak(e,t,n){return function htmlPathForBreak(e){var t=findStyle(e);return t?t.to:"line"===e.breakType?r.topLevelElement("br"):r.empty}(e).wrap((function(){return[]}))}};return{convertToHtml:function convertToHtml(n){var r=[],l=elementToHtml(n,r,{}),a=[];walkHtml(l,(function(e){"deferred"===e.type&&a.push(e)}));var u={};return t.mapSeries(a,(function(e){return e.value().then((function(t){u[e.id]=t}))})).then((function(){var t=c.writer({prettyPrint:m.prettyPrint,outputFormat:m.outputFormat});return i.write(t,i.simplify(function replaceDeferred(t){return flatMap(t,(function(t){return"deferred"===t.type?u[t.id]:t.children?[e.extend({},t,{children:replaceDeferred(t.children)})]:[t]}))}(l))),new o.Result(t.asString(),r)}))}}}exports.DocumentConverter=function DocumentConverter(t){return{convertToHtml:function(r){var o=e.indexBy(r.type===n.types.document?r.comments:[],"commentId");return new DocumentConversion(t,o).convertToHtml(r)}}};var a=1;function unrecognisedStyleWarning(e,t){return o.warning("Unrecognised "+e+" style: '"+t.styleName+"' (Style ID: "+t.styleId+")")}function flatMap(t,n){return e.flatten(t.map(n),!0)}function walkHtml(e,t){e.forEach((function(e){t(e),e.children&&walkHtml(e.children,t)}))}var u=exports.commentAuthorLabel=function commentAuthorLabel(e){return e.authorInitials||""};