var e=require("assert"),t=require("path"),n=require("fs"),a=require("underscore"),o=require("../"),r=require("../lib/promises"),i=require("../lib/results"),d=require("./testing"),l=require("./test")(module),u=d.testData,s=d.createFakeDocxFile;l("should convert docx containing one paragraph to single p element",(function(){var n=t.join(__dirname,"test-data/single-paragraph.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<p>Walking on imported air</p>"),e.deepEqual(t.messages,[])}))})),l("should convert docx represented by a Buffer",(function(){var a=t.join(__dirname,"test-data/single-paragraph.docx");return r.nfcall(n.readFile,a).then((function(e){return o.convertToHtml({buffer:e})})).then((function(t){e.equal(t.value,"<p>Walking on imported air</p>"),e.deepEqual(t.messages,[])}))})),l("should read docx xml files with unicode byte order mark",(function(){var n=t.join(__dirname,"test-data/utf8-bom.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<p>This XML has a byte order mark.</p>"),e.deepEqual(t.messages,[])}))})),l("empty paragraphs are ignored by default",(function(){var n=t.join(__dirname,"test-data/empty.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,""),e.deepEqual(t.messages,[])}))})),l("empty paragraphs are preserved if ignoreEmptyParagraphs is false",(function(){var n=t.join(__dirname,"test-data/empty.docx");return o.convertToHtml({path:n},{ignoreEmptyParagraphs:!1}).then((function(t){e.equal(t.value,"<p></p>"),e.deepEqual(t.messages,[])}))})),l("style map can be expressed as string",(function(){var t=s({"word/document.xml":u("simple/word/document.xml")});return o.convertToHtml({file:t},{styleMap:"p => h1"}).then((function(t){e.equal("<h1>Hello.</h1>",t.value)}))})),l("style map can be expressed as array of style mappings",(function(){var t=s({"word/document.xml":u("simple/word/document.xml")});return o.convertToHtml({file:t},{styleMap:["p => h1"]}).then((function(t){e.equal("<h1>Hello.</h1>",t.value)}))})),l("embedded style map is used if present",(function(){var n=t.join(__dirname,"test-data/embedded-style-map.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<h1>Walking on imported air</h1>"),e.deepEqual(t.messages,[])}))})),l("explicit style map takes precedence over embedded style map",(function(){var n=t.join(__dirname,"test-data/embedded-style-map.docx");return o.convertToHtml({path:n},{styleMap:["p => p"]}).then((function(t){e.equal(t.value,"<p>Walking on imported air</p>"),e.deepEqual(t.messages,[])}))})),l("explicit style map is combined with embedded style map",(function(){var n=t.join(__dirname,"test-data/embedded-style-map.docx");return o.convertToHtml({path:n},{styleMap:["r => strong"]}).then((function(t){e.equal(t.value,"<h1><strong>Walking on imported air</strong></h1>"),e.deepEqual(t.messages,[])}))})),l("embedded style maps can be disabled",(function(){var n=t.join(__dirname,"test-data/embedded-style-map.docx");return o.convertToHtml({path:n},{includeEmbeddedStyleMap:!1}).then((function(t){e.equal(t.value,"<p>Walking on imported air</p>"),e.deepEqual(t.messages,[])}))})),l("embedded style map can be written and then read",(function(){var a=t.join(__dirname,"test-data/single-paragraph.docx");return r.nfcall(n.readFile,a).then((function(e){return o.embedStyleMap({buffer:e},"p => h1")})).then((function(e){return o.convertToHtml({buffer:e.toBuffer()})})).then((function(t){e.equal(t.value,"<h1>Walking on imported air</h1>"),e.deepEqual(t.messages,[])}))})),l("embedded style map can be retrieved",(function(){var a=t.join(__dirname,"test-data/single-paragraph.docx");return r.nfcall(n.readFile,a).then((function(e){return o.embedStyleMap({buffer:e},"p => h1")})).then((function(e){return o.readEmbeddedStyleMap({buffer:e.toBuffer()})})).then((function(t){e.equal(t,"p => h1")}))})),l("warning if style mapping is not understood",(function(){var n=t.join(__dirname,"test-data/single-paragraph.docx");return o.convertToHtml({path:n},{styleMap:"????\np => h1"}).then((function(t){e.equal("<h1>Walking on imported air</h1>",t.value);e.deepEqual(t.messages,[i.warning('Did not understand this style mapping, so ignored it: ????\nError was at character number 1: Expected element type but got unrecognisedCharacter "?"')])}))})),l("options are passed to document converter when calling mammoth.convertToHtml",(function(){var t=s({"word/document.xml":u("simple/word/document.xml")});return o.convertToHtml({file:t},{styleMap:"p => h1"}).then((function(t){e.equal("<h1>Hello.</h1>",t.value)}))})),l("options.transformDocument is used to transform document if set",(function(){var t=s({"word/document.xml":u("simple/word/document.xml")});return o.convertToHtml({file:t},{transformDocument:function(e){return e.children[0].styleId="Heading1",e}}).then((function(t){e.equal("<h1>Hello.</h1>",t.value)}))})),l("mammoth.transforms.paragraph only transforms paragraphs",(function(){var t=s({"word/document.xml":u("simple/word/document.xml")}),n={transformDocument:o.transforms.paragraph((function(e){return a.extend(e,{styleId:"Heading1"})}))};return o.convertToHtml({file:t},n).then((function(t){e.equal("<h1>Hello.</h1>",t.value)}))})),l("inline images referenced by path relative to part are included in output",(function(){var n=t.join(__dirname,"test-data/tiny-picture.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,'<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAAAXNSR0IArs4c6QAAAAlwSFlzAAAOvgAADr4B6kKxwAAAABNJREFUKFNj/M+ADzDhlWUYqdIAQSwBE8U+X40AAAAASUVORK5CYII=" /></p>')}))})),l("inline images referenced by path relative to base are included in output",(function(){var n=t.join(__dirname,"test-data/tiny-picture-target-base-relative.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,'<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAAAXNSR0IArs4c6QAAAAlwSFlzAAAOvgAADr4B6kKxwAAAABNJREFUKFNj/M+ADzDhlWUYqdIAQSwBE8U+X40AAAAASUVORK5CYII=" /></p>')}))})),l("src of inline images can be changed",(function(){var n=t.join(__dirname,"test-data/tiny-picture.docx"),a=o.images.imgElement((function(e){return e.read("base64").then((function(t){return{src:t.substring(0,2)+","+e.contentType}}))}));return o.convertToHtml({path:n},{convertImage:a}).then((function(t){e.equal(t.value,'<p><img src="iV,image/png" /></p>')}))})),l("images stored outside of document are included in output",(function(){var n=t.join(__dirname,"test-data/external-picture.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,'<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAAAXNSR0IArs4c6QAAAAlwSFlzAAAOvgAADr4B6kKxwAAAABNJREFUKFNj/M+ADzDhlWUYqdIAQSwBE8U+X40AAAAASUVORK5CYII=" /></p>'),e.deepEqual(t.messages,[])}))})),l("error if images stored outside of document are specified when passing file without path",(function(){var a=t.join(__dirname,"test-data/external-picture.docx"),r=n.readFileSync(a);return o.convertToHtml({buffer:r}).then((function(t){e.equal(t.value,""),e.equal(t.messages[0].message,"could not find external image 'tiny-picture.png', path of input document is unknown"),e.equal(t.messages[0].type,"error")}))})),l("simple list is converted to list elements",(function(){var n=t.join(__dirname,"test-data/simple-list.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<ul><li>Apple</li><li>Banana</li></ul>")}))})),l("word tables are converted to html tables",(function(){var n=t.join(__dirname,"test-data/tables.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<p>Above</p><table><tr><td><p>Top left</p></td><td><p>Top right</p></td></tr><tr><td><p>Bottom left</p></td><td><p>Bottom right</p></td></tr></table><p>Below</p>"),e.deepEqual(t.messages,[])}))})),l("footnotes are appended to text",(function(){var n=t.join(__dirname,"test-data/footnotes.docx");return o.convertToHtml({path:n},{idPrefix:"doc-42-"}).then((function(t){e.equal(t.value,'<p>Ouch<sup><a href="#doc-42-footnote-1" id="doc-42-footnote-ref-1">[1]</a></sup>.<sup><a href="#doc-42-footnote-2" id="doc-42-footnote-ref-2">[2]</a></sup></p><ol><li id="doc-42-footnote-1"><p> A tachyon walks into a bar. <a href="#doc-42-footnote-ref-1">↑</a></p></li><li id="doc-42-footnote-2"><p> Fin. <a href="#doc-42-footnote-ref-2">↑</a></p></li></ol>'),e.deepEqual(t.messages,[])}))})),l("endnotes are appended to text",(function(){var n=t.join(__dirname,"test-data/endnotes.docx");return o.convertToHtml({path:n},{idPrefix:"doc-42-"}).then((function(t){e.equal(t.value,'<p>Ouch<sup><a href="#doc-42-endnote-2" id="doc-42-endnote-ref-2">[1]</a></sup>.<sup><a href="#doc-42-endnote-3" id="doc-42-endnote-ref-3">[2]</a></sup></p><ol><li id="doc-42-endnote-2"><p> A tachyon walks into a bar. <a href="#doc-42-endnote-ref-2">↑</a></p></li><li id="doc-42-endnote-3"><p> Fin. <a href="#doc-42-endnote-ref-3">↑</a></p></li></ol>'),e.deepEqual(t.messages,[])}))})),l("relationships are handled properly in footnotes",(function(){var n=t.join(__dirname,"test-data/footnote-hyperlink.docx");return o.convertToHtml({path:n},{idPrefix:"doc-42-"}).then((function(t){e.equal(t.value,'<p><sup><a href="#doc-42-footnote-1" id="doc-42-footnote-ref-1">[1]</a></sup></p><ol><li id="doc-42-footnote-1"><p> <a href="http://www.example.com">Example</a> <a href="#doc-42-footnote-ref-1">↑</a></p></li></ol>'),e.deepEqual(t.messages,[])}))})),l("when style mapping is defined for comment references then comments are included",(function(){var n=t.join(__dirname,"test-data/comments.docx");return o.convertToHtml({path:n},{idPrefix:"doc-42-",styleMap:"comment-reference => sup"}).then((function(t){e.equal(t.value,'<p>Ouch<sup><a href="#doc-42-comment-0" id="doc-42-comment-ref-0">[MW1]</a></sup>.<sup><a href="#doc-42-comment-2" id="doc-42-comment-ref-2">[MW2]</a></sup></p><dl><dt id="doc-42-comment-0">Comment [MW1]</dt><dd><p>A tachyon walks into a bar. <a href="#doc-42-comment-ref-0">↑</a></p></dd><dt id="doc-42-comment-2">Comment [MW2]</dt><dd><p>Fin. <a href="#doc-42-comment-ref-2">↑</a></p></dd></dl>'),e.deepEqual(t.messages,[])}))})),l("textboxes are read",(function(){var n=t.join(__dirname,"test-data/text-box.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<p>Datum plane</p>")}))})),l("underline is ignored by default",(function(){var n=t.join(__dirname,"test-data/underline.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<p><strong>The Sunset Tree</strong></p>")}))})),l("underline can be configured with style mapping",(function(){var n=t.join(__dirname,"test-data/underline.docx");return o.convertToHtml({path:n},{styleMap:"u => em"}).then((function(t){e.equal(t.value,"<p><strong>The <em>Sunset</em> Tree</strong></p>")}))})),l("strikethrough is converted to <s> by default",(function(){var n=t.join(__dirname,"test-data/strikethrough.docx");return o.convertToHtml({path:n}).then((function(t){e.equal(t.value,"<p><s>Today's Special: Salmon</s> Sold out</p>")}))})),l("strikethrough conversion can be configured with style mappings",(function(){var n=t.join(__dirname,"test-data/strikethrough.docx");return o.convertToHtml({path:n},{styleMap:"strike => del"}).then((function(t){e.equal(t.value,"<p><del>Today's Special: Salmon</del> Sold out</p>")}))})),l("indentation is used if prettyPrint is true",(function(){var n=t.join(__dirname,"test-data/single-paragraph.docx");return o.convertToHtml({path:n},{prettyPrint:!0}).then((function(t){e.equal(t.value,"<p>\n  Walking on imported air\n</p>"),e.deepEqual(t.messages,[])}))})),l("using styleMapping throws error",(function(){try{o.styleMapping()}catch(t){e.equal(t.message,"Use a raw string instead of mammoth.styleMapping e.g. \"p[style-name='Title'] => h1\" instead of mammoth.styleMapping(\"p[style-name='Title'] => h1\")")}})),l("can convert single paragraph to markdown",(function(){var n=t.join(__dirname,"test-data/single-paragraph.docx");return o.convertToMarkdown({path:n}).then((function(t){e.equal(t.value,"Walking on imported air\n\n"),e.deepEqual(t.messages,[])}))})),l("extractRawText only retains raw text",(function(){var n=t.join(__dirname,"test-data/simple-list.docx");return o.extractRawText({path:n}).then((function(t){e.equal(t.value,"Apple\n\nBanana\n\n")}))})),l("extractRawText can use .docx files represented by a Buffer",(function(){var a=t.join(__dirname,"test-data/single-paragraph.docx");return r.nfcall(n.readFile,a).then((function(e){return o.extractRawText({buffer:e})})).then((function(t){e.equal(t.value,"Walking on imported air\n\n"),e.deepEqual(t.messages,[])}))})),l("should throw error if file is not a valid docx document",(function(){var n=t.join(__dirname,"test-data/empty.zip");return o.convertToHtml({path:n}).then((function(t){e.ok(!1,"Expected error")}),(function(t){e.equal(t.message,"Could not find main document part. Are you sure this is a valid .docx file?")}))}));