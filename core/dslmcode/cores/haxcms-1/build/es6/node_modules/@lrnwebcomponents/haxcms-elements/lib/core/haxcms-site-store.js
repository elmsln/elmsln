import{observable as t,makeObservable as e,computed as i,autorun as a,toJS as s,configure as n}from"../../../../mobx/dist/mobx.esm.js";import{varExists as o,varGet as r,localStorageGet as l}from"../../../utils/utils.js";import{JsonOutlineSchema as m}from"../../../json-outline-schema/json-outline-schema.js";import{DeviceDetails as c}from"../../../replace-tag/lib/PerformanceDetect.js";import{iconFromPageType as d}from"../../../course-design/lib/learning-component.js";import{SimpleIconsetStore as h}from"../../../simple-icon/lib/simple-iconset.js";import{UserScaffoldInstance as u}from"../../../user-scaffold/user-scaffold.js";n({enforceActions:!1});export const store=new class Store{constructor(){this.badDevice=!1,this.internalRoutes={search:{},views:{}},this.evaluatebadDevice(),this.location=null,this.currentRouterLocation={},this.jwt=null,this.version=null,this.soundStatus=l("app-hax-soundStatus",!0),this.darkMode=!!l("app-hax-darkMode")&&l("app-hax-darkMode"),this.setupSlots={"haxcms-site-editor-ui-prefix-avatar":[],"haxcms-site-editor-ui-prefix-buttons":[],"haxcms-site-editor-ui-suffix-buttons":[],"haxcms-site-editor-ui-main-menu":[],"haxcms-site-editor-ui-topbar-character-button":[]},fetch(new URL("../../package.json",import.meta.url)).then((t=>t.json())).then((t=>this.version=t.version)),this.appReady=!1,this.editMode=!1,this.manifest=null,this.activeItemContent="",this.themeElement=null,this.themeStyleElement=globalThis.document.createElement("style"),this.themeStyleElement.id="haxcms-theme-global-style-element",this.t={close:"Close",search:"Search",views:"Content Views",pageNotFound:"Page not found"},this.activeId=null,this.userData={},this.cmsSiteEditor={instance:null},this.cmsSiteEditorBackend={instance:null},this._registration={},e(this,{location:t.ref,currentRouterLocation:t.ref,internalRoutes:t,editMode:t,jwt:t,userData:t,manifest:t,activeItemContent:t,themeElement:t,version:t,routerManifest:i,siteTitle:i,siteDescription:i,isLoggedIn:i,themeData:i,regionData:i,entityData:i,homeLink:i,activeId:t,activeItem:i,activeItemFields:i,activeManifestIndex:i,activeManifestIndexCounter:i,activeTitle:i,activeTags:i,parentTitle:i,ancestorTitle:i,ancestorItem:i,darkMode:t,soundStatus:t,appReady:t,badDevice:t})}get entityData(){if(this.manifest&&this.manifest.items){var t={};return this.manifest.items.map((e=>{e.metadata&&(t[e.id]={id:e.id,title:e.title,color:e.metadata.color||null,icon:e.metadata.icon||null,type:e.metadata.entityType||"page"})})),t}}get regionData(){if(this.manifest){return o(this.manifest,"metadata.theme.regions")?this.manifest.metadata.theme.regions:{header:null,sidebarFirst:null,sidebarSecond:null,contentTop:null,contentBottom:null,footerPrimary:null,footerSecondary:null}}}getUniqueSlugName(t,e=null,i=!1){let a=t;if(null!=e&&null!=e.parent&&""!=e.parent&&i){let i=e,s=[t];for(;i=this.findItem(i.parent);){let t=i.slug.split("/");s.unshift(t.pop())}a=t=s.join("/")}let s=0,n=!1;for(;!n;)for(var o in n=!0,this.manifest.items){let i=this.manifest.items[o];if(a==i.slug){if(null!=e&&i.id==e.id)return a;s++,a=t+"-"+s,n=!1}}return a.toLowerCase().split(" ").join("-").replace(/[^0-9\-\/a-z]/gi,"")}async evaluatebadDevice(){this.badDevice=await c.badDevice(),this.badDevice&&(this.soundStatus=!1)}playSound(t){if(this.soundStatus&&this.appReady)try{switch(t){case"click":case"click2":case"coin":case"coin2":case"hit":case"success":case"error":"error"==t&&(t="hit"),this.audio=new Audio(new URL(`../../../app-hax/lib/assets/sounds/${t}.mp3`,import.meta.url).href),this.audio.volume=.3,this.audio.play();break;default:this.audio=new Audio(new URL("../../../app-hax/lib/assets/sounds/hit.mp3",import.meta.url).href),this.audio.volume=.3,this.audio.play(),console.warn(`${t} is not a valid sound file yet`)}}catch(t){console.warn(t)}}toast(t,e=2e3,i={},a="capsule",s=this.t.close,n=null,o=null){this.appReady&&globalThis.dispatchEvent(new CustomEvent("haxcms-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:t,duration:e,classStyle:a,closeText:s,eventCallback:n,slot:o,...i}}))}async loadManifest(t,e=null){if(null==e&&window&&(e=window),o(t,"metadata.siteName")){let e=r(t,"publishing.git",{});t.metadata.site={name:t.metadata.siteName,git:e,created:t.metadata.created,updated:t.metadata.updated},t.metadata.theme.variables={image:t.metadata.image,icon:t.metadata.icon,hexCode:t.metadata.hexCode,cssVariable:t.metadata.cssVariable},t.metadata.node={dynamicElementLoader:t.metadata.dynamicElementLoader,fields:t.metadata.fields},delete t.metadata.publishing,delete t.metadata.created,delete t.metadata.updated,delete t.metadata.siteName,delete t.metadata.image,delete t.metadata.icon,delete t.metadata.hexCode,delete t.metadata.cssVariable,delete t.metadata.dynamicElementLoader,delete t.metadata.fields}await t.items.forEach(((t,e,i)=>{t.slug||(i[e].slug=t.location.replace("pages/","").replace("/index.html","")),t.metadata.hasOwnProperty("published")||(i[e].metadata.published=!0),i[e].order=Number(i[e].order),t.metadata.hasOwnProperty("locked")||(i[e].metadata.locked=!1),t.metadata.hasOwnProperty("status")||(i[e].metadata.status="")}));var i=new m,a=i.itemsToNodes(t.items),s=i.nodesToItems(a),n=[];for(var l in s)n.push(t.items.find((t=>t.id===s[l].id)));globalThis.document.documentElement&&t.metadata.site.lang&&(globalThis.document.documentElement.lang=t.metadata.site.lang,globalThis.dispatchEvent(new CustomEvent("languagechange",{detail:t.metadata.site.lang}))),t.items=n,this.manifest=t,e.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:t})),globalThis.dispatchEvent(new CustomEvent("haxcms-item-rebuild",{bubbles:!0,composed:!0,cancelable:!1,detail:!0}))}cmsSiteEditorAvailability(){return this.cmsSiteEditor.instance||(this.cmsSiteEditor.instance=globalThis.document.createElement("haxcms-site-editor")),this.cmsSiteEditor.instance}get processedItems(){}_computeItems(t,e,i,a,s){if(s){let n,o=[],r=[];switch(s.items.forEach((t=>{t.parent||o.push(t)})),a){case"parent":n=s.items.find((t=>i===t.id)),n&&(i=n.parent);break;case"ancestor":for(n=s.items.find((t=>i===t.id));n&&null!=n.parent;)n=s.items.find((t=>t.id==n.parent));n&&(i=n.id)}return o.forEach(((a,s)=>{this._spiderChildren(a,r,t,e,i,!1)})),r}}_setChildren(t,e){const i=e.filter((e=>t.id===e.parent));t.children=i,t.children.length>0&&t.children.forEach((t=>{this._setChildren(t,e)}))}get routerManifest(){const t=this.manifest;if(globalThis.document.body.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:t})),t&&void 0!==t.items){let e=t.items.map((e=>{let i=null,a=null,s=t.items.find((t=>e.parent===t.id));s&&(i=s.location,a=s.slug);let n=e.metadata,o=e.location,r=e.slug;return n&&n.pageType&&!n.icon&&(e.metadata.icon=d(n.pageType)),Object.assign({},e,{parentLocation:i,parentSlug:a,location:o,slug:r,metadata:n})}));if(e.forEach(((t,i)=>{this._setChildren(t,e)})),!0===r(t,"metadata.site.settings.publishPagesOn",!0)){const filterHiddenParentsRecursive=t=>{if(!1===t.metadata.published)return!1;const i=e.find((e=>e.id===t.parent));return!i||filterHiddenParentsRecursive(i)};this.isLoggedIn||(e=e.filter((t=>filterHiddenParentsRecursive(t))))}return Object.assign({},t,{items:e})}}get siteTitle(){return this.manifest&&this.manifest.title?this.manifest.title:""}get siteDescription(){return this.manifest&&this.manifest.description?this.manifest.description:""}get homeLink(){if(this.manifest){const t=this.manifest.items.find((t=>void 0!==t.id));if(t)return t.slug}return"/"}get activeItem(){let t=this.findItem(this.activeId);if(this.activeId&&HAXcmsStore.storePieces&&HAXcmsStore.storePieces.siteRouter&&null==t&&"404"===this.activeId){t={id:"404",_internalRoute:!0,title:this.t.pageNotFound,location:"hax-fake-404.html"};const e=store.getInternalRoute();e&&store.internalRoutes[e]&&("function"==typeof store.internalRoutes[e].callback&&store.internalRoutes[e].callback(),t={id:"x/"+e,_internalRoute:!0,component:`site-${e}-route`,title:this.t[e]||e,location:"hax-internal-route.html"})}return t||null}get activeItemFields(){if(this.activeItem&&this.activeItem.metadata){let t={title:this.activeItem.title,description:this.activeItem.description,location:this.activeItem.location,slug:this.activeItem.slug,created:this.activeItem.metadata.created,updated:this.activeItem.metadata.created};if(this.activeItem.metadata.fields)return Object.assign({},t,this.activeItem.metadata.fields)}}get themeData(){if(this.manifest){var t={};return t=o(this.manifest,"metadata.theme")?this.manifest.metadata.theme:{"haxcms-basic-theme":{element:"haxcms-basic-theme",path:"@lrnwebcomponents/haxcms-elements/lib/core/themes/haxcms-basic-theme.js",name:"Basic theme",variables:{icon:"icons:record-voice-over",hexCode:"#da004e",cssVariable:"pink",image:"assets/banner.jpg",imageAlt:"",imageLink:""},regions:{header:null,sidebarFirst:null,sidebarSecond:null,contentTop:null,contentBottom:null,footerPrimary:null,footerSecondary:null}}},this.activeItem&&o(this.activeItem,"metadata.theme")?this.activeItem.metadata.theme:t}}get activeManifestIndex(){if(this.manifest&&this.manifest.items&&this.activeId)for(var t in this.manifest.items)if(this.manifest.items[t].id===this.activeId)return parseInt(t);return-1}get activeRouterManifestIndex(){if(this.routerManifest&&this.routerManifest.items&&this.activeId)for(var t in this.routerManifest.items)if(this.routerManifest.items[t].id===this.activeId)return parseInt(t);return-1}get activeManifestIndexCounter(){return null!==this.activeManifestIndex?1+this.activeManifestIndex:0}get activeTitle(){return this.activeItem?this.activeItem.title:""}get activeTags(){return this.activeItem&&this.activeItem.metadata&&this.activeItem.metadata.tags?this.activeItem.metadata.tags:null}get parentTitle(){if(this.manifest&&this.activeItem){let t=this.manifest.items.find((t=>this.activeItem.parent===t.id));if(t)return t.title}return""}get isLoggedIn(){return!(!this.jwt||"null"==this.jwt)}get ancestorTitle(){if(this.manifest&&this.activeItem){let t=this.manifest.items.find((t=>this.activeItem.parent===t.id));for(;t&&null!=t.parent;)t=this.manifest.items.find((e=>e.id==t.parent));if(t)return t.title}return""}get ancestorItem(){if(this.manifest&&this.activeItem){let t=this.manifest.items.find((t=>this.activeItem.parent===t.id));for(;t&&null!=t.parent;)t=this.manifest.items.find((e=>e.id==t.parent));if(t)return t}return null}findItem(t){return this.manifest&&t?this.manifest.items.find((e=>e.id===t)):null}async getLastChildItem(t){if(this.manifest&&t){let e={};return await this.manifest.items.map((i=>{i.parent===t&&(void 0===e.order||e.order<i.order)&&(e=i)})),e}return null}async findItemAsObject(t,e="id",i="item",a=!0){if(this.manifest&&t){var n=await this.manifest.items.find((i=>i[e]===t));if(a&&(n=s(n)),"item"==i)return n;if("parent"==i&&n.parent)return s(await this.manifest.items.find((t=>n.parent===t.id)))}return null}fallbackItemSlug(){if(this.manifest&&this.activeItem){if(this.activeManifestIndex>0&&this.manifest.items[this.activeManifestIndex-1])return this.manifest.items[this.activeManifestIndex-1].slug;if(this.activeManifestIndex<this.manifest.items.length-1&&this.manifest.items[this.activeManifestIndex+1])return this.manifest.items[this.activeManifestIndex+1].slug}return null}getManifestItems(t=!0){return t?s(this.manifest.items):this.manifest.items}getManifest(t=!0){return t?s(this.manifest):this.manifest}async addItem(t){var e=new m;let i=e.newItem();t.id&&(i.id=t.id),t.indent&&(i.indent=t.indent),i.location=t.location,i.slug=t.slug,i.order=t.order,i.parent=t.parent,i.title=t.title,i.metadata=t.metadata,e.items=s(this.manifest.items);let a={...e.validateItem(i)};e.items.push(a);var n=e.itemsToNodes(e.items),o=e.nodesToItems(n),r=[];for(var l in o)r.push(e.items.find((t=>t.id===o[l].id)));return this.manifest.items.replace(r),globalThis.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest})),globalThis.dispatchEvent(new CustomEvent("haxcms-item-rebuild",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),this.findItem(i.id)}removeItem(t){const e=this.findItem(t);if(e)if("new"===e.metadata.status){const t=this.manifest.items.indexOf(e);t>-1&&this.manifest.items.splice(t,1)}else e.metadata.status="delete"}spiderChildren(t,e,i,a,s,n,o){t.id===s||n?(n||(n=!0,!o&&t.indent>=i&&(i+=t.indent,a+=t.indent)),t.indent>=i&&t.indent<=a&&e.push(t),t.children.length>0&&t.children.forEach((t=>{this.spiderChildren(t,e,i,a,s,n,o)}))):t.children.length>0&&t.children.forEach((t=>{this.spiderChildren(t,e,a,s,n,o)}))}getInternalRoute(){return!!(this.currentRouterLocation&&this.currentRouterLocation.params&&this.currentRouterLocation.params[0])&&this.currentRouterLocation.params[0].replace("x/","")}computeItems(t,e,i,a,s,n){if(s){let o,r=[],l=[];switch(s.items.forEach((t=>{t.parent||r.push(t)})),a){case"parent":o=s.items.find((t=>i===t.id)),o&&(i=o.parent);break;case"ancestor":for(o=s.items.find((t=>i===t.id));o&&null!=o.parent;)o=s.items.find((t=>t.id==o.parent));o&&(i=o.id)}return s.items.forEach(((a,s)=>{store.spiderChildren(a,l,t,e,i,!1,n)})),l}}};globalThis.HAXCMS=globalThis.HAXCMS||{},globalThis.HAXCMS.setTheme=function(t){globalThis.HAXCMS.instance.store.manifest.metadata.theme.element=t},globalThis.HAXCMS.requestAvailability=()=>(globalThis.HAXCMS.instance||(globalThis.HAXCMS.instance=globalThis.document.createElement("haxcms-site-store"),globalThis.document.body.appendChild(globalThis.HAXCMS.instance)),globalThis.HAXCMS.instance);export const HAXcmsStore=globalThis.HAXCMS.requestAvailability();class HAXCMSSiteStore extends HTMLElement{constructor(){super(),this.storePieces={},this.store=store,this.source="",a((()=>{if(store.location&&store.location.route&&store.location.route.component){const t=store.location.route.name;store.manifest.items.filter((e=>e.id===t))&&(store.activeId=t)}})),a((()=>{const t=s(store.findItem(store.activeId));t&&(globalThis.document.body.dispatchEvent(new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:t})),globalThis.document.title=store.activeTitle)})),a((()=>{if(store.appReady){const t=globalThis.document.querySelector('link[rel="icon"]');t&&(this.faviconSiteDefault=t.href,this.faviconInstance=t)}})),a((()=>{const t=u.readMemory("versionLatest");store.version&&t!=store.version&&(null==t&&u.writeMemory("versionInitial",store.version,"long"),u.writeMemory("versionLatest",store.version,"long"))})),a((()=>{const t=s(store.editMode);globalThis.HaxStore&&globalThis.HaxStore.requestAvailability()&&globalThis.HaxStore.requestAvailability().write&&(globalThis.dispatchEvent(new CustomEvent("haxcms-edit-mode-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:t})),globalThis.HaxStore.requestAvailability().editMode=t,globalThis.HaxStore.requestAvailability().toastShowEventName="haxcms-toast-show")}))}connectedCallback(){globalThis.document.body.appendChild(this.store.themeStyleElement)}disconnectedCallback(){this.store.themeStyleElement.remove(),this.store.themeStyleElement=globalThis.document.createElement("style")}resetFavicon(){this.setFavicon()}setFavicon(t=null,e=!0){t?e&&(t=h.getIcon(t)):t=this.faviconSiteDefault,this.faviconInstance&&this.faviconInstance.setAttribute("href",t)}resetCursor(){this.setCursor()}setCursor(t=null,e=!0){t?(e&&(t=h.getIcon(t)),globalThis.document.body.style.cursor=`url("${t}") 16 16, pointer`):globalThis.document.body.style.removeProperty("cursor")}getApplicationContext(){let t="";if("undefined"!=typeof DatArchive)t="beaker";else switch(globalThis.HAXCMSContext){case"published":case"nodejs":case"php":case"11ty":case"demo":case"desktop":case"local":case"userfs":t=globalThis.HAXCMSContext;break;default:t="php"}return t}static get tag(){return"haxcms-site-store"}static get observedAttributes(){return["source"]}set source(t){this[name]=t,t&&this.setAttribute("source",t)}get source(){return this.getAttribute("source")}attributeChangedCallback(t,e,i){"source"==t&&""!=i&&fetch(this[t]).then((t=>t.json())).then((t=>{this.store.loadManifest(t)})).catch((t=>{console.warn(t)}))}}customElements.define(HAXCMSSiteStore.tag,HAXCMSSiteStore);export{HAXCMSSiteStore};