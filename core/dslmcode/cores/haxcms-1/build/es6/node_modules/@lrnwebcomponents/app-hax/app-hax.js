import{css as e,html as t,unsafeCSS as o}from"../../lit/index.js";import{toJS as a,autorun as i}from"../../mobx/dist/mobx.esm.js";import{localStorageSet as s,localStorageGet as r}from"../utils/utils.js";import"../simple-tooltip/simple-tooltip.js";import{SimpleColors as p}from"../simple-colors/simple-colors.js";import{store as n}from"./lib/v1/AppHaxStore.js";import{AppHaxAPI as l}from"./lib/v1/AppHaxBackendAPI.js";import{SimpleTourManager as d}from"../simple-popover/lib/simple-tour.js";import"../simple-colors-shared-styles/simple-colors-shared-styles.js";import"./lib/v1/AppHaxRouter.js";import"./lib/v1/app-hax-label.js";import"./lib/v1/app-hax-top-bar.js";const m=new URL("./lib/assets/images/HAXLogo.svg",import.meta.url).href,c=new URL("./lib/assets/images/Logout.svg",import.meta.url).href,h=new URL("./lib/assets/images/Help.svg",import.meta.url).href;function darkToggle(e){e.matches?n.darkMode=!0:n.darkMode=!1}function soundToggle(){n.soundStatus=!a(n.soundStatus),s("app-hax-soundStatus",a(n.soundStatus)),n.appEl.playSound("click")}export class AppHax extends p{static get tag(){return"app-hax"}playSound(e){if(n.soundStatus&&n.appReady){let t=["click","click2","coin","coin2","hit","success"].includes(e)?e:"hit";this.audio=new Audio(new URL(`./lib/assets/sounds/${t}.mp3`,import.meta.url).href),this.audio.volume=.2,this.audio.play()}}connectedCallback(){super.connectedCallback(),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",darkToggle),window.addEventListener("jwt-logged-in",this._jwtLoggedIn.bind(this))}disconnectedCallback(){window.matchMedia("(prefers-color-scheme: dark)").removeEventListener("change",darkToggle),window.removeEventListener("jwt-logged-in",this._jwtLoggedIn.bind(this)),super.disconnectedCallback()}constructor(){super(),this.__tour=d,this.__tour.registerNewTour({key:"hax",name:"Let's learn HAX",style:"\n      simple-popover-manager::part(simple-popover) {\n        max-width: 250px;\n      }\n      simple-popover-manager button {\n        font-family: 'Press Start 2P', sans-serif;\n        font-size: 12px;\n        margin: 0px 2px;\n        color: var(--simple-colors-default-theme-grey-12);\n      }\n      simple-popover-manager p {\n        font-family: 'Press Start 2P', sans-serif;\n        padding: 0;\n        margin: 0;\n        width: 250px;\n        font-size: 12px;\n        line-height: 20px;\n      }\n      simple-popover-manager h1 {\n        font-family: 'Press Start 2P', sans-serif;\n        margin: 0;\n        font-size: 12px;\n        width: 250px;\n        padding: 0;\n      }\n      simple-popover-manager::part(simple-popover-body),\n      simple-popover-manager::part(simple-popover-heading) {\n        color: black;\n        background-color: white;\n      }\n      body.dark-mode simple-popover-manager::part(simple-popover-body),\n      body.dark-mode simple-popover-manager::part(simple-popover-heading) {\n        color: white;\n        background-color: black;\n      }\n      body.dark-mode simple-popover-manager simple-icon-button-lite {\n        color: white;\n        background-color: black;\n      }\n      "}),i((()=>{this.siteReady=a(n.siteReady)})),i((()=>{const e=a(n.badDevice);!1===e?(import("../rpg-character/rpg-character.js"),import("./lib/random-word/random-word.js")):!0===e&&document.body.classList.add("bad-device")})),this.userMenuOpen=!1,this.courses=[],this.activeItem={},this.phrases={new:["What's ya name?","HAX to the moon","Welcome to the Jungle","We like to party","Build something awesome","Everything is awesome!","Everything is cool when you're part of the team","When you're living our dream"],return:["Welcome back, take 2?","That wasn't very long","Sup?","You again? Awesome!","Let's do this","There can only be one ring...","There is another","Fancy that, I love HAX and you show up"]},this.isNewUser=null,this.basePath="/",this.searchTerm="",this.appMode="",this.soundIcon="",this.store=n,this.sound=new Audio,i((()=>{this.isNewUser=a(n.isNewUser),this.isNewUser&&"create"!==a(n.appMode)&&"404"!==a(n.appMode)&&(n.appMode="create",setTimeout((()=>{n.createSiteSteps=!0}),0))})),i((()=>{this.userName=a(n.user.name)})),i((()=>{this.appMode=a(n.appMode)})),i((()=>{this.searchTerm=a(n.searchTerm)})),i((async()=>{const e=a(n.location);e&&e.route&&(e.route.step?(n.appMode="create",n.createSiteSteps=!0):e.route.slug?(this.reset(),setTimeout((()=>{window.location=e.route.slug}),0)):"404"===e.route.name?(n.createSiteSteps=!1,n.appMode="404",setTimeout((()=>{n.toast("the page miss.. it burns!!!",3e3,{fire:!0,walking:!0})}),500)):"home"!==e.route.name&&"search"!==e.route.name||(n.appMode="home",n.createSiteSteps=!1))})),i((()=>{n.routes.length>0&&null===n.location&&(n.location=a(n.routes[0]))})),null===r("app-hax-darkMode",null)&&(n.darkMode=window.matchMedia("(prefers-color-scheme: dark)").matches),i((()=>{s("app-hax-darkMode",a(n.darkMode)),a(n.darkMode)?(document.body.classList.add("dark-mode"),n.toast("I'm ascared of the dark",2e3,{fire:!0}),this.dark=!0):(document.body.classList.remove("dark-mode"),n.toast("Sunny day it is",2e3,{hat:"random"}),this.dark=!1)})),i((()=>{const e=a(n.appMode);e&&(document.body.classList.remove("app-hax-search"),document.body.classList.remove("app-hax-create"),document.body.classList.remove("app-hax-404"),document.body.classList.remove("app-hax-home"),document.body.classList.add(`app-hax-${e}`))}))}static get properties(){return{...super.properties,courses:{type:Array},userName:{type:String},activeItem:{type:Object},soundIcon:{type:String},searchTerm:{type:String},appMode:{type:String},isNewUser:{type:Boolean},phrases:{type:Object},userMenuOpen:{type:Boolean},siteReady:{type:Boolean},basePath:{type:String,attribute:"base-path"},token:{type:String}}}reset(e=!1){try{window.localStorage.removeItem("app-hax-step"),window.localStorage.removeItem("app-hax-site"),e&&(document.querySelector("base")?window.location=document.querySelector("base").href:window.location.reload())}catch(e){}}logout(){window.dispatchEvent(new CustomEvent("jwt-login-logout",{composed:!0,bubbles:!0,cancelable:!1,detail:!0})),this.closeMenu(),this.__logoutUserAction=!0}_jwtLoggedIn(e){!1===e.detail&&this.__logoutUserAction&&(this.__logoutUserAction=!1,setTimeout((()=>{this.reset(!0)}),100))}login(){import("./lib/v1/app-hax-site-login.js").then((()=>{const e=document.createElement("app-hax-site-login");if(this.querySelector('[slot="externalproviders"]')){const t=this.querySelector('[slot="externalproviders"]').cloneNode(!0);e.appendChild(t)}import("../simple-modal/simple-modal.js").then((()=>{setTimeout((()=>{this.dispatchEvent(new CustomEvent("simple-modal-show",{bubbles:!0,cancelable:!0,composed:!0,detail:{title:"< login >",elements:{content:e},modal:!0,styles:{"--simple-modal-titlebar-background":"transparent","--simple-modal-titlebar-color":"black","--simple-modal-width":"40vw","--simple-modal-min-width":"300px","--simple-modal-z-index":"100000000","--simple-modal-height":"62vh","--simple-modal-min-height":"400px","--simple-modal-titlebar-height":"64px"}}}))}),0)}))}))}static get styles(){return[...super.styles,e`
        :host {
          display: block;
          --app-hax-background-color-active: var(--app-hax-accent-color);
        }
        .wired-button-label {
          clip: rect(0 0 0 0);
          clip-path: inset(50%);
          height: 1px;
          overflow: hidden;
          position: absolute;
          white-space: nowrap;
          width: 1px;
        }
        .topbar-character {
          cursor: pointer;
          display: inline-block;
          border: none;
          border-radius: 0px;
          background-color: transparent;
        }
        .topbar-character:hover,
        .topbar-character:focus {
          background-color: var(--simple-colors-default-theme-light-blue-4);
          outline: var(--haxcms-color) solid 3px;
          outline-offset: -3px;
          height: 48px;
        }
        .topbar-character rpg-character {
          margin: -4px -14px 0px -10px;
          height: 52px;
          width: 64px;
          display: inline-block;
        }
        .content {
          text-align: center;
          margin-top: 24px;
        }
        .four04-character {
          margin-top: 16px;
        }
        .start-journey {
          display: flex;
          padding-top: 40px;
          justify-content: center;
        }
        app-hax-site-button {
          max-width: 60vw;
          justify-content: center;
        }
        app-hax-top-bar {
          top: 0;
          z-index: 1000;
          right: 0;
          left: 0;
          position: fixed;
        }
        @media (max-width: 780px) {
          app-hax-top-bar::part(top-bar) {
            grid-template-columns: 20% 20% 60%;
          }
        }
        @media (max-width: 600px) {
          app-hax-top-bar::part(top-bar) {
            grid-template-columns: 10% 30% 60%;
          }
        }
        .label {
          text-align: center;
        }
        app-hax-label {
          animation: 0.8s ease-in-out 0s scrollin;
          -webkit-animation: 0.8s ease-in-out 0s scrollin;
          display: block;
          overflow: hidden;
        }
        app-hax-label h1 {
          font-weight: normal;
          font-size: 4vw;
          margin: 0;
          padding: 0;
        }
        @keyframes scrollin {
          from {
            margin-top: -240px;
            margin-bottom: 240px;
          }
          to {
            margin-top: 0;
            margin-bottom: 0;
          }
        }
        .haxLogo {
          --simple-icon-height: 40px;
          --simple-icon-width: 40px;
          margin: 4px;
          color: var(--simple-colors-default-theme-grey-12);
          cursor: pointer;
        }
        .soundToggle {
          margin-right: 16px;
          position: relative;
          display: inline-flex;
          vertical-align: top;
        }

        .soundToggle img {
          width: 24px;
          height: 24px;
        }

        app-hax-search-bar {
          vertical-align: middle;
          display: inline-flex;
        }
        main {
          padding-top: 80px;
        }
        @media (max-width: 900px) {
          main {
            padding-top: 64px;
          }
        }
        app-hax-user-menu {
          z-index:1003;
        }
        .logout::part(menu-button) {
          background-image: url("${o(c)}");
          background-repeat: no-repeat;
          background-position: center;
          text-align: center;
          background-size: cover;
          border-top: 0px;
          border-bottom: 0px;
          padding: 10px;
        }
        app-hax-user-menu app-hax-user-menu-button::part(menu-button) {
          font-family: 'Press Start 2P', sans-serif;
          font-size: 12px;
        }

        random-word:not(:defined) {
          display: none;
        }
        random-word {
          transform: rotate(25deg);
          position: absolute;
          right: 10px;
          top: 120px;
          padding: 12px;
          font-size: 12px;
          border: 4px solid var(--simple-colors-default-theme-grey-12);
          background-color: var(--simple-colors-default-theme-yellow-5);
          color: var(--simple-colors-default-theme-grey-12);
          width: 100px;
          word-wrap: break-word;
          text-align: center;
          cursor: pointer;
          user-select: none;
          opacity: 1;
          visibility: visible;
          transition: all 0.3s ease-in-out;
        }
        #helpbtn {
          --simple-icon-height: 50px;
          --simple-icon-width: 50px;
          right: 200px;
          top: 100px;
          padding: 4px;
          background-color: var(--simple-colors-default-theme-grey-1);
          border-radius: 50%;
          position: absolute;
          color: var(--simple-colors-default-theme-grey-12);
          border: var(--simple-colors-default-theme-grey-12) 4px solid;
          cursor: pointer;
        }
        @media (max-width: 800px) {
          app-hax-site-button {
            width: 320px;
            max-width: 60vw;
            --app-hax-site-button-font-size: 16px;
          }
          #helpbtn {
            --simple-icon-height: 40px;
            --simple-icon-width: 40px;
            right: 8px;
            top: 64px;
            padding: 2px;
            border: var(--simple-colors-default-theme-grey-12) 2px solid;
          }
        }
        @media (prefers-reduced-motion: reduce) {
          app-hax-label {
            animation: none;
            -webkit-animation: none;
          }
        }
        @media (max-width: 680px) {
          random-word {
            visibility: none;
            opacity: 0;
          }
        }
        @media (max-height: 700px) {
          .content {
            margin-top: 4px;
          }
          random-word {
            visibility: none;
            opacity: 0;
          }
          .start-journey {
            padding-top: 0;
          }
        }
        @media (max-height: 500px) {
          app-hax-label h1 {
            font-family: monospace;
            font-weight: normal;
            font-size: 4vw;
            margin: 0;
            padding: 0;
          }
        }
      `]}helpClick(){n.appEl.playSound("coin2"),this.__tour.startTour("hax")}updated(e){super.updated&&super.updated(e),e.forEach(((e,t)=>{["basePath"].includes(t)&&this[t]&&(n.AppHaxAPI[t]=this[t]),["token"].includes(t)&&this[t]&&(n[t]=this[t])}))}firstUpdated(e){super.firstUpdated&&super.firstUpdated(e),import("./lib/v1/app-hax-steps.js"),import("./lib/v1/app-hax-site-button.js"),import("../../wired-elements/lib/wired-button.js"),import("./lib/v1/app-hax-toast.js"),import("./lib/v1/app-hax-wired-toggle.js"),import("./lib/v1/app-hax-search-bar.js"),import("./lib/v1/app-hax-search-results.js"),import("./lib/v1/app-hax-user-menu.js"),import("./lib/v1/app-hax-user-menu-button.js"),this.dispatchEvent(new CustomEvent("app-hax-loaded",{composed:!0,bubbles:!0,cancelable:!1,detail:!0})),n.appReady=!0,i((()=>{a(n.appReady)?document.body.classList.add("app-loaded"):document.body.classList.remove("app-loaded")})),n.appEl=this,i((()=>{n.activeItem&&(this.activeItem=a(n.activeItem))})),i((()=>{this.soundIcon=a(n.soundStatus)?new URL("./lib/assets/images/FullVolume.svg",import.meta.url).href:new URL("./lib/assets/images/Silence.svg",import.meta.url).href,a(n.soundStatus)?n.toast("You can hear me now? Good.",2e3,{hat:"random"}):n.toast("Sound off.. hey! HELLO!?!",2e3,{fire:!0})})),i((async()=>{if(a(n.appReady)&&n.AppHaxAPI&&a(n.isLoggedIn)&&a(n.appSettings)&&a(n.refreshSiteList)){const e=await l.makeCall("getSitesList");n.manifest=e.data}else a(n.appReady)&&!a(n.isLoggedIn)&&this.login()}))}toggleMenu(){this.userMenuOpen=!this.userMenuOpen,n.appEl.playSound("click")}closeMenu(){this.userMenuOpen&&(this.userMenuOpen=!this.userMenuOpen,this.shadowRoot.querySelector("#user-menu").removeAttribute("isOpen"))}render(){return t`<app-hax-router></app-hax-router>
      <header>
        <app-hax-top-bar>
          <a id="home" href="home" tabindex="-1" slot="left">
            <simple-icon-lite
              id="hlogo"
              src="${m}"
              tabindex="0"
              class="haxLogo"
              title="Home"
            ></simple-icon-lite>
          </a>
          <simple-tooltip for="hlogo" position="right" slot="left"
            >Home</simple-tooltip
          >
          <app-hax-search-bar
            slot="center"
            ?disabled="${this.isNewUser}"
          ></app-hax-search-bar>
          <wired-button
            elevation="1"
            slot="right"
            class="soundToggle"
            id="soundtb"
            @click="${soundToggle}"
          >
            <span class="wired-button-label">Toggle sound effects</span>
            <simple-icon-lite
              src="${this.soundIcon}"
              loading="lazy"
              decoding="async"
            ></simple-icon-lite>
          </wired-button>
          <simple-tooltip for="soundtb" position="bottom" slot="right"
            >Toggle sound</simple-tooltip
          >
          <app-hax-wired-toggle id="wt" slot="right"></app-hax-wired-toggle>
          <simple-tooltip for="wt" position="bottom" slot="right"
            >Toggle dark mode</simple-tooltip
          >

          <app-hax-user-menu slot="right" id="user-menu">
            <button class="topbar-character" slot="menuButton" id="tbchar">
              <rpg-character
                seed="${this.userName}"
                width="68"
                height="68"
                aria-label="System menu"
                title="System menu"
                hat="${this.userMenuOpen?"edit":"none"}"
                @click="${this.toggleMenu}"
              ></rpg-character>
            </button>
            <!-- <app-hax-user-menu-button
              slot="main-menu"
              icon="face"
              label="Account Info"
            ></app-hax-user-menu-button> -->
            <app-hax-user-menu-button
              slot="post-menu"
              class="logout"
              label="Logout"
              @click=${this.logout}
            ></app-hax-user-menu-button>
          </app-hax-user-menu>
          <simple-tooltip for="tbchar" position="bottom" slot="right"
                >System menu</simple-tooltip
              >
        </app-hax-top-bar>
      </header>
      lbh
      <main @click="${this.closeMenu}">
        <div class="label">
          <app-hax-label>
            ${this.activeItem&&!this.siteReady?t`
                  <h1>${this.activeItem.label}</h1>
                  <div slot="subtitle">${this.activeItem.statement}</div>
                `:""}
            ${this.activeItem&&this.siteReady?t`
                  <h1>${a(n.site.name)}</h1>
                  <div slot="subtitle">
                    Is all ready, are you ready to build?
                  </div>
                `:""}
          </app-hax-label>
        </div>
        <random-word
          key="${this.isNewUser?"new":"return"}"
          .phrases="${this.phrases}"
          @click="${this.getNewWord}"
        ></random-word>
        <simple-icon-lite
          id="helpbtn"
          @click="${this.helpClick}"
          src="${h}"
        >
        </simple-icon-lite>
        <simple-tooltip for="helpbtn" position="bottom">Help</simple-tooltip>
        <section class="content">${this.appBody(this.appMode)}</section>
      </main>`}getNewWord(){this.shadowRoot.querySelector("random-word").getNewWord(),n.appEl.playSound("click")}appBody(e){let o=t``;switch(e){case"home":case"search":o=this.templateHome();break;case"create":o=this.templateCreate();break;default:o=this.template404()}return o}templateHome(){return t` ${this.searchTerm?"":t` <div class="start-journey">
            <a
              href="createSite-step-1"
              @click="${this.startJourney}"
              tabindex="-1"
            >
              <app-hax-site-button
                label="&gt; Start new journey"
              ></app-hax-site-button>
            </a>
          </div>`}

      <app-hax-search-results></app-hax-search-results>`}templateCreate(){return t`<app-hax-steps
      @promise-progress-finished="${this.siteReadyToGo}"
    ></app-hax-steps>`}siteReadyToGo(e){e.detail&&(n.siteReady=!0)}template404(){return t` <div class="four04">
      <a
        href="createSite-step-1"
        class="start-journey"
        @click="${this.startJourney}"
        tabindex="-1"
      >
        <app-hax-site-button
          label="&gt; Start a new journey"
        ></app-hax-site-button>
      </a>
      <rpg-character
        class="four04-character"
        fire
        walking
        width="200"
        id="char404"
        height="200"
        seed="${this.userName}"
      ></rpg-character>
      <simple-tooltip for="char404" position="left">This</simple-tooltip>
      <simple-tooltip for="char404" position="right">fine</simple-tooltip>
      <simple-tooltip for="char404" position="bottom">is</simple-tooltip>
    </div>`}startJourney(){n.createSiteSteps=!1,n.siteReady=!1,n.site.structure=null,n.site.type=null,n.site.theme=null,n.site.name=null,n.appMode="create",n.appEl.playSound("click2")}}customElements.define(AppHax.tag,AppHax),window.AppHax=window.AppHax||{},window.AppHax.requestAvailability=()=>(window.AppHax.instance||(window.AppHax.instance=document.querySelector(AppHax.tag)),window.AppHax.instance);