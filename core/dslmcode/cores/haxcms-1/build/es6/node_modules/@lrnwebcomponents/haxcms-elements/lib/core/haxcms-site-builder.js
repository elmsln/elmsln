import{LitElement as e,html as t,css as i}from"../../../../lit-element/lit-element.js";import{setPassiveTouchGestures as a}from"../../../../@polymer/polymer/lib/utils/settings.js";import{encapScript as o,findTagsInHTML as s,wipeSlot as d,varExists as n}from"../../../utils/utils.js";import{autorun as h,toJS as r}from"../../../../mobx/lib/mobx.module.js";import{store as m}from"./haxcms-site-store.js";class HAXCMSSiteBuilder extends e{static get styles(){return[i`
        :host {
          display: block;
        }
        :host #slot {
          background-color: var(--haxcms-color, white);
          opacity: 0.2;
          visibility: hidden;
        }
        :host([dashboard-opened]) {
          display: inline-block !important;
          margin-left: 50vw;
          height: 100vh;
          pointer-events: none;
          opacity: 0.5;
          width: 100vw;
        }
        :host([theme-loaded]) #slot {
          opacity: 1;
          visibility: visible;
        }
        paper-progress {
          display: block;
          width: 100%;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background-color: transparent;
          z-index: 1000;
          --paper-progress-active-color: var(
            --haxcms-color,
            rgba(255, 255, 255, 0.5)
          );
          --paper-progress-container-color: transparent;
        }
      `]}static get tag(){return"haxcms-site-builder"}render(){return t`
      <haxcms-site-router base-uri="${this.baseURI}"></haxcms-site-router>
      <paper-progress .hidden="${!this.loading}" indeterminate></paper-progress>
      <div id="slot"><slot></slot></div>
      <simple-colors-polymer></simple-colors-polymer>
    `}_updateManifest(e){this.manifest={...e}}_updateLoading(e){this.loading=e.detail.value}_updateActiveItemContent(e){this.activeItemContent=e}async loadPageData(){this.activeItemLocation&&(this.loading=!0,await fetch(`${this.outlineLocation}${this.activeItemLocation}${this._timeStamp}`).then(e=>e.text()).then(e=>{this._updateActiveItemContent(e),this.loading=!1}).catch(e=>{this.lastErrorChanged(e)}))}async loadJOSData(){this.file&&(this.loading=!0,await fetch(`${this.outlineLocation}${this.file}${this._timeStamp}`).then(e=>e.json()).then(e=>{this._updateManifest(e),this.loading=!1}).catch(e=>{this.lastErrorChanged(e)}))}updated(e){e.forEach((e,t)=>{["outlineLocation","activeItemLocation","_timeStamp"].includes(t)&&this.loadPageData(),["outlineLocation","file","_timeStamp"].includes(t)&&this.loadJOSData(),"dashboardOpened"==t?this._dashboardOpenedChanged(this[t],e):"themeData"==t?this._themeChanged(this[t],e):"themeName"==t?this._themeNameChanged(this[t],e):"outlineLocation"==t?this.dispatchEvent(new CustomEvent("outline-location-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[t]})):"manifest"==t?(this.dispatchEvent(new CustomEvent("manifest-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[t]})),this._manifestChanged(this[t],e)):"activeItem"==t?(this.dispatchEvent(new CustomEvent("active-item-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[t]})),this._activeItemChanged(this[t],e)):"activeItemContent"==t&&(this.dispatchEvent(new CustomEvent("active-item-content-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[t]})),this._activeItemContentChanged(this[t],e))})}static get properties(){return{activeItemLocation:{type:String,attribute:"active-item-location"},_timeStamp:{type:String},dashboardOpened:{type:Boolean,reflect:!0,attribute:"dashboard-opened"},queryParams:{type:Object},loading:{type:Boolean,reflect:!0},outlineLocation:{type:String,attribute:"outline-location"},manifest:{type:Object},themeData:{type:Object},themeName:{type:String},__imported:{type:Object},themeLoaded:{type:Boolean,reflect:!0,attribute:"theme-loaded"},activeItem:{type:Object},activeItemContent:{type:String},file:{type:String},baseURI:{type:String,attribute:"base-uri"}}}_themeNameChanged(e){e&&(m.themeElement&&m.themeElement.remove(),d(this,"*"),m.themeElement=document.createElement(e),this.appendChild(m.themeElement))}lastErrorChanged(e){if(e){console.error(e);const t=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!1,detail:{text:e.detail.value.status+" "+e.detail.value.statusText}});window.dispatchEvent(t)}}constructor(){super(),a(!0),this.__disposer=[],this.queryParams={},this.loading=!1,this.__imported={},this.themeLoaded=!1,this._timeStamp="",this.outlineLocation="",this.activeItemLocation="",import("./haxcms-site-router.js"),import("../../../../@polymer/paper-progress/paper-progress.js"),import("../../../simple-toast/simple-toast.js"),import("../../../simple-colors/lib/simple-colors-polymer.js"),setTimeout(()=>{window.addEventListener("hax-store-ready",this.storeReady.bind(this)),window.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this)),window.addEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this)),h(e=>{this.dashboardOpened=r(m.dashboardOpened),this.__disposer.push(e)}),h(e=>{this.themeData=r(m.themeData),this.themeData&&this.themeData.element!==this.themeName&&(this.themeName=this.themeData.element),this.__disposer.push(e)}),h(e=>{this.activeItem=r(m.activeItem),this.activeItem&&this.activeItem.location&&(this.activeItemLocation=this.activeItem.location),this.__disposer.push(e)})},0)}_dashboardOpenedChanged(e,t){e?(this.setAttribute("aria-hidden","aria-hidden"),this.setAttribute("tabindex","-1")):!e&&t&&(this.removeAttribute("aria-hidden"),this.removeAttribute("tabindex"))}connectedCallback(){super.connectedCallback(),this.dispatchEvent(new CustomEvent("haxcms-ready",{bubbles:!0,composed:!0,cancelable:!1,detail:this})),import("./haxcms-editor-builder.js").then(e=>{this.editorBuilder=document.createElement("haxcms-editor-builder"),document.body.appendChild(this.editorBuilder),"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()&&(this._timeStamp="?"+Math.floor(Date.now()/1e3))}).catch(e=>{console.log(e)});var e=document.createEvent("UIEvents");e.initUIEvent("resize",!0,!1,window,0),window.dispatchEvent(e)}disconnectedCallback(){for(var e in this.__disposer)this.__disposer[e].dispose();super.disconnectedCallback()}storeReady(e){m.cmsSiteEditor&&m.cmsSiteEditor.instance&&window.HaxStore.instance.activeHaxBody&&m.activeItemContent&&window.HaxStore.instance.activeHaxBody.importContent(m.activeItemContent)}_activeItemContentChanged(e,t){if(e){var i=e;null!==i&&(d(m.themeElement,"*"),i=o(e),m.activeItemContent=i,setTimeout(()=>{if(0===m.themeElement.childNodes.length){let e=document.createRange().createContextualFragment(i);m.themeElement.appendChild(e),this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:i}))}if(!window.WCAutoload&&n(this.manifest,"metadata.node.dynamicElementLoader")){let t=s(i);const a=this.pathFromUrl(decodeURIComponent(import.meta.url));for(var e in t){const i=t[e];this.manifest.metadata.node.dynamicElementLoader[i]&&!window.customElements.get(i)&&import(`${a}../../../../${this.manifest.metadata.node.dynamicElementLoader[i]}`).then(e=>{}).catch(e=>{console.log(e)})}}else window.WCAutoload&&setTimeout(()=>{window.WCAutoload.process()},0)},5))}}_activeItemChanged(e,t){this.shadowRoot&&e&&void 0!==e.id?(this.queryParams.nodeId=e.id,this.editorBuilder&&"published"===this.editorBuilder.getContext()?this._timeStamp="":this._timeStamp="?"+Math.floor(Date.now()/1e3)):t&&!e&&this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:null}))}_triggerUpdatedData(e){this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&(this._timeStamp="?"+Math.floor(Date.now()/1e3))}_triggerUpdatedNode(e){this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()&&(this._timeStamp="?"+Math.floor(Date.now()/1e3)),this.activeItem.location&&this.loadPageData()}_manifestChanged(e,t){e&&e.metadata&&e.items&&m.loadManifest(e,this)}pathFromUrl(e){return e.substring(0,e.lastIndexOf("/")+1)}_themeChanged(e,t){if(e){this.themeLoaded=!1;let t=e;if(void 0!==this.__imported[t.element])this.themeLoaded=!0;else if(window.WCAutoload)this.__imported[t.element]=t.element,this.themeLoaded=!0,setTimeout(()=>{window.WCAutoload.process()},5);else try{import(this.pathFromUrl(decodeURIComponent(import.meta.url))+"../../../../"+e.path).then(e=>{this.__imported[t.element]=t.element,this.themeLoaded=!0})}catch(e){this.themeLoaded=!0}}}}window.HAXme=function(e=null){null==e&&(e="demo",window.appSettings={login:"dist/dev/login.json",logout:"dist/dev/logout.json",saveNodePath:"dist/dev/saveNode.json",saveManifestPath:"dist/dev/saveManifestPath.json",createNodePath:"dist/dev/saveNode.json",deleteNodePath:"dist/dev/saveNode.json",saveOutlinePath:"dist/dev/saveNode.json",publishSitePath:"dist/dev/saveNode.json",syncSitePath:"dist/dev/saveNode.json",getNodeFieldsPath:"dist/dev/getNodeFieldsPath.json",getSiteFieldsPath:"dist/dev/getSiteFieldsPath.json",revertSitePath:"dist/dev/saveNode.json",getFormToken:"adskjadshjudfu823u823u8fu8fij",appStore:{url:"dist/dev/appstore.json"},themes:{"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@lrnwebcomponents/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"}}}),"demo"==e&&(window.__haxCMSContextDemo=!0),document.body&&(document.body.getElementsByTagName("haxcms-editor-builder")[0].__appliedContext=!1,document.body.getElementsByTagName("haxcms-editor-builder")[0].applyContext(e))},window.customElements.define(HAXCMSSiteBuilder.tag,HAXCMSSiteBuilder);export{HAXCMSSiteBuilder};