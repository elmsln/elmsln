var t=require("events").EventEmitter,n=require("child_process").spawn,e=require("path"),o=e.dirname,i=e.basename,s=require("fs");function Option(t,n){this.flags=t,this.required=t.indexOf("<")>=0,this.optional=t.indexOf("[")>=0,this.bool=-1===t.indexOf("-no-"),(t=t.split(/[ ,|]+/)).length>1&&!/^[[<]/.test(t[1])&&(this.short=t.shift()),this.long=t.shift(),this.description=n||""}function Command(t){this.commands=[],this.options=[],this._execs={},this._allowUnknownOption=!1,this._args=[],this._name=t||""}function pad(t,n){var e=Math.max(0,n-t.length);return t+Array(e+1).join(" ")}function outputHelpIfNecessary(t,n){n=n||[];for(var e=0;e<n.length;e++)"--help"!==n[e]&&"-h"!==n[e]||(t.outputHelp(),process.exit(0))}function humanReadableArgName(t){var n=t.name+(!0===t.variadic?"...":"");return t.required?"<"+n+">":"["+n+"]"}function exists(t){try{if(s.statSync(t).isFile())return!0}catch(t){return!1}}require("util").inherits(Command,t),exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this.long.replace("--","").replace("no-","")},Option.prototype.attributeName=function(){return function camelcase(t){return t.split("-").reduce((function(t,n){return t+n[0].toUpperCase()+n.slice(1)}))}(this.name())},Option.prototype.is=function(t){return this.short===t||this.long===t},Command.prototype.command=function(t,n,e){"object"==typeof n&&null!==n&&(e=n,n=null),e=e||{};var o=t.split(/ +/),i=new Command(o.shift());return n&&(i.description(n),this.executables=!0,this._execs[i._name]=!0,e.isDefault&&(this.defaultExecutable=i._name)),i._noHelp=!!e.noHelp,this.commands.push(i),i.parseExpectedArgs(o),i.parent=this,n?this:i},Command.prototype.arguments=function(t){return this.parseExpectedArgs(t.split(/ +/))},Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},Command.prototype.parseExpectedArgs=function(t){if(t.length){var n=this;return t.forEach((function(t){var e={required:!1,name:"",variadic:!1};switch(t[0]){case"<":e.required=!0,e.name=t.slice(1,-1);break;case"[":e.name=t.slice(1,-1)}e.name.length>3&&"..."===e.name.slice(-3)&&(e.variadic=!0,e.name=e.name.slice(0,-3)),e.name&&n._args.push(e)})),this}},Command.prototype.action=function(t){var n=this,listener=function(e,o){e=e||[],o=o||[];var i=n.parseOptions(o);outputHelpIfNecessary(n,i.unknown),i.unknown.length>0&&n.unknownOption(i.unknown[0]),i.args.length&&(e=i.args.concat(e)),n._args.forEach((function(t,o){t.required&&null==e[o]?n.missingArgument(t.name):t.variadic&&(o!==n._args.length-1&&n.variadicArgNotLast(t.name),e[o]=e.splice(o))})),n._args.length?e[n._args.length]=n:e.push(n),t.apply(n,e)},e=this.parent||this,o=e===this?"*":this._name;return e.on("command:"+o,listener),this._alias&&e.on("command:"+this._alias,listener),this},Command.prototype.option=function(t,n,e,o){var i=this,s=new Option(t,n),r=s.name(),a=s.attributeName();if("function"!=typeof e)if(e instanceof RegExp){var p=e;e=function(t,n){var e=p.exec(t);return e?e[0]:n}}else o=e,e=null;return(!s.bool||s.optional||s.required)&&(s.bool||(o=!0),void 0!==o&&(i[a]=o,s.defaultValue=o)),this.options.push(s),this.on("option:"+r,(function(t){null!==t&&e&&(t=e(t,void 0===i[a]?o:i[a])),"boolean"==typeof i[a]||void 0===i[a]?i[a]=null==t?!!s.bool&&(o||!0):t:null!==t&&(i[a]=t)})),this},Command.prototype.allowUnknownOption=function(t){return this._allowUnknownOption=0===arguments.length||t,this},Command.prototype.parse=function(t){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=t,this._name=this._name||i(t[1],".js"),this.executables&&t.length<3&&!this.defaultExecutable&&t.push("--help");var n=this.parseOptions(this.normalize(t.slice(2))),e=this.args=n.args,o=this.parseArgs(this.args,n.unknown),s=o.args[0],r=null;return s&&(r=this.commands.filter((function(t){return t.alias()===s}))[0]),this._execs[s]&&"function"!=typeof this._execs[s]?this.executeSubCommand(t,e,n.unknown):r?(e[0]=r._name,this.executeSubCommand(t,e,n.unknown)):this.defaultExecutable?(e.unshift(this.defaultExecutable),this.executeSubCommand(t,e,n.unknown)):o},Command.prototype.executeSubCommand=function(t,r,a){(r=r.concat(a)).length||this.help(),"help"===r[0]&&1===r.length&&this.help(),"help"===r[0]&&(r[0]=r[1],r[1]="--help");var p,h=t[1],u=i(h,".js")+"-"+r[0],m=s.lstatSync(h).isSymbolicLink()?s.readlinkSync(h):h;m!==h&&"/"!==m.charAt(0)&&(m=e.join(o(h),m)),p=o(m);var c,l=e.join(p,u),d=!1;exists(l+".js")?(u=l+".js",d=!0):exists(l)&&(u=l),r=r.slice(1),"win32"!==process.platform?d?(r.unshift(u),r=(process.execArgv||[]).concat(r),c=n(process.argv[0],r,{stdio:"inherit",customFds:[0,1,2]})):c=n(u,r,{stdio:"inherit",customFds:[0,1,2]}):(r.unshift(u),c=n(process.execPath,r,{stdio:"inherit"}));["SIGUSR1","SIGUSR2","SIGTERM","SIGINT","SIGHUP"].forEach((function(t){process.on(t,(function(){!1===c.killed&&null===c.exitCode&&c.kill(t)}))})),c.on("close",process.exit.bind(process)),c.on("error",(function(t){"ENOENT"===t.code?console.error("\n  %s(1) does not exist, try --help\n",u):"EACCES"===t.code&&console.error("\n  %s(1) not executable. try chmod or run with root\n",u),process.exit(1)})),this.runningCommand=c},Command.prototype.normalize=function(t){for(var n,e,o,i=[],s=0,r=t.length;s<r;++s){if(n=t[s],s>0&&(e=this.optionFor(t[s-1])),"--"===n){i=i.concat(t.slice(s));break}e&&e.required?i.push(n):n.length>1&&"-"===n[0]&&"-"!==n[1]?n.slice(1).split("").forEach((function(t){i.push("-"+t)})):/^--/.test(n)&&~(o=n.indexOf("="))?i.push(n.slice(0,o),n.slice(o+1)):i.push(n)}return i},Command.prototype.parseArgs=function(t,n){var e;return t.length?(e=t[0],this.listeners("command:"+e).length?this.emit("command:"+t.shift(),t,n):this.emit("command:*",t)):(outputHelpIfNecessary(this,n),n.length>0&&this.unknownOption(n[0]),0===this.commands.length&&0===this._args.filter((function(t){return t.required})).length&&this.emit("command:*")),this},Command.prototype.optionFor=function(t){for(var n=0,e=this.options.length;n<e;++n)if(this.options[n].is(t))return this.options[n]},Command.prototype.parseOptions=function(t){for(var n,e,o,i=[],s=t.length,r=[],a=0;a<s;++a)if(o=t[a],n)i.push(o);else if("--"!==o)if(e=this.optionFor(o))if(e.required){if(null==(o=t[++a]))return this.optionMissingArgument(e);this.emit("option:"+e.name(),o)}else e.optional?(null==(o=t[a+1])||"-"===o[0]&&"-"!==o?o=null:++a,this.emit("option:"+e.name(),o)):this.emit("option:"+e.name());else o.length>1&&"-"===o[0]?(r.push(o),a+1<t.length&&"-"!==t[a+1][0]&&r.push(t[++a])):i.push(o);else n=!0;return{args:i,unknown:r}},Command.prototype.opts=function(){for(var t={},n=this.options.length,e=0;e<n;e++){var o=this.options[e].attributeName();t[o]=o===this._versionOptionName?this._version:this[o]}return t},Command.prototype.missingArgument=function(t){console.error(),console.error("  error: missing required argument `%s'",t),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(t,n){console.error(),n?console.error("  error: option `%s' argument missing, got `%s'",t.flags,n):console.error("  error: option `%s' argument missing",t.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(t){this._allowUnknownOption||(console.error(),console.error("  error: unknown option `%s'",t),console.error(),process.exit(1))},Command.prototype.variadicArgNotLast=function(t){console.error(),console.error("  error: variadic arguments must be last `%s'",t),console.error(),process.exit(1)},Command.prototype.version=function(t,n){if(0===arguments.length)return this._version;this._version=t;var e=new Option(n=n||"-V, --version","output the version number");return this._versionOptionName=e.long.substr(2)||"version",this.options.push(e),this.on("option:"+this._versionOptionName,(function(){process.stdout.write(t+"\n"),process.exit(0)})),this},Command.prototype.description=function(t,n){return 0===arguments.length?this._description:(this._description=t,this._argsDescription=n,this)},Command.prototype.alias=function(t){var n=this;if(0!==this.commands.length&&(n=this.commands[this.commands.length-1]),0===arguments.length)return n._alias;if(t===n._name)throw new Error("Command alias can't be the same as its name");return n._alias=t,this},Command.prototype.usage=function(t){var n=this._args.map((function(t){return humanReadableArgName(t)})),e="[options]"+(this.commands.length?" [command]":"")+(this._args.length?" "+n.join(" "):"");return 0===arguments.length?this._usage||e:(this._usage=t,this)},Command.prototype.name=function(t){return 0===arguments.length?this._name:(this._name=t,this)},Command.prototype.prepareCommands=function(){return this.commands.filter((function(t){return!t._noHelp})).map((function(t){var n=t._args.map((function(t){return humanReadableArgName(t)})).join(" ");return[t._name+(t._alias?"|"+t._alias:"")+(t.options.length?" [options]":"")+(n?" "+n:""),t._description]}))},Command.prototype.largestCommandLength=function(){return this.prepareCommands().reduce((function(t,n){return Math.max(t,n[0].length)}),0)},Command.prototype.largestOptionLength=function(){var t=[].slice.call(this.options);return t.push({flags:"-h, --help"}),t.reduce((function(t,n){return Math.max(t,n.flags.length)}),0)},Command.prototype.largestArgLength=function(){return this._args.reduce((function(t,n){return Math.max(t,n.name.length)}),0)},Command.prototype.padWidth=function(){var t=this.largestOptionLength();return this._argsDescription&&this._args.length&&this.largestArgLength()>t&&(t=this.largestArgLength()),this.commands&&this.commands.length&&this.largestCommandLength()>t&&(t=this.largestCommandLength()),t},Command.prototype.optionHelp=function(){var t=this.padWidth();return this.options.map((function(n){return pad(n.flags,t)+"  "+n.description+(n.bool&&void 0!==n.defaultValue?" (default: "+n.defaultValue+")":"")})).concat([pad("-h, --help",t)+"  output usage information"]).join("\n")},Command.prototype.commandHelp=function(){if(!this.commands.length)return"";var t=this.prepareCommands(),n=this.padWidth();return["  Commands:","",t.map((function(t){var e=t[1]?"  "+t[1]:"";return(e?pad(t[0],n):t[0])+e})).join("\n").replace(/^/gm,"    "),""].join("\n")},Command.prototype.helpInformation=function(){var t=[];if(this._description){t=["  "+this._description,""];var n=this._argsDescription;if(n&&this._args.length){var e=this.padWidth();t.push("  Arguments:"),t.push(""),this._args.forEach((function(o){t.push("    "+pad(o.name,e)+"  "+n[o.name])})),t.push("")}}var o=this._name;this._alias&&(o=o+"|"+this._alias);var i=["","  Usage: "+o+" "+this.usage(),""],s=[],r=this.commandHelp();r&&(s=[r]);var a=["  Options:","",""+this.optionHelp().replace(/^/gm,"    "),""];return i.concat(t).concat(a).concat(s).concat([""]).join("\n")},Command.prototype.outputHelp=function(t){t||(t=function(t){return t}),process.stdout.write(t(this.helpInformation())),this.emit("--help")},Command.prototype.help=function(t){this.outputHelp(t),process.exit()};