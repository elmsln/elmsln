/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{html as e,PolymerElement as t}from"../../../../../@polymer/polymer/polymer-element.js";import{setPassiveTouchGestures as i}from"../../../../../@polymer/polymer/lib/utils/settings.js";import{afterNextRender as o}from"../../../../../@polymer/polymer/lib/utils/render-status.js";import"../../../../../@polymer/iron-ajax/iron-ajax.js";import"../../../../jwt-login/jwt-login.js";import"../../../../hexagon-loader/hexagon-loader.js";import"../../../../json-outline-schema/json-outline-schema.js";import"../../../../simple-toast/simple-toast.js";import"../../../../simple-modal/simple-modal.js";import"../../../../simple-datetime/simple-datetime.js";import"../../../../simple-fields/simple-fields.js";import{SimpleColorsPolymer as a}from"../../../../simple-colors/lib/simple-colors-polymer.js";import"../../../../../@vaadin/vaadin-upload/vaadin-upload.js";class HAXCMSSiteListing extends t{constructor(){super(),this.SimpleColors=new a,i(!0),window.HAXCMS={},import("./haxcms-site-listing-deps.js")}static get tag(){return"haxcms-site-listing"}static get template(){return e`
      <style include="simple-colors-shared-styles-polymer">
        paper-icon-button {
          --paper-icon-button-ink-color: var(--haxcms-system-action-color);
        }
        app-toolbar div.main-title {
          margin-left: 50px;
          font-size: 24px;
        }
        app-header {
          color: var(--haxcms-site-listing-color-light);
          @apply --layout-fixed-top;
          --app-header-background-rear-layer: {
            background-color: var(--haxcms-site-listing-color-dark);
          }
        }
        app-toolbar {
          color: var(--haxcms-site-listing-color-light);
          background-color: var(--haxcms-site-listing-color-dark);
        }
        vaadin-grid {
          margin-top: 64px;
          height: calc(100vh - 64px);
        }
        .login-prompt {
          margin: 80px auto 0;
          display: flex;
          justify-content: center;
        }
        .login-prompt[hidden] {
          display: none;
        }
        .login-prompt div#selfie {
          position: absolute;
          margin: 0;
        }
        .has-snap {
          z-index: 3;
        }
        .hide-camera {
          display:none;
        }
        .login-prompt div#selfie img {
          z-index: 2;
          position: absolute;
          margin: 0 0 0 -78px;
          width: 355px;
          height: 200px;
          display: block;
        }
        simple-login {
          background: #EEEEEE;
          color: var(--haxcms-system-bg);
          --primary-color: var(--haxcms-system-bg);
          --primary-text-color: var(--haxcms-system-bg);
          --paper-input-container-focus-color: var(--haxcms-system-action-color);
          --login-btn-background-color: var(--haxcms-system-bg);
          --login-btn-raised-background-color: var(--haxcms-system-action-color);
          --login-form-color: var(--haxcms-system-bg);
          --login-btn-width: 80%;
          --login-btn-display: flex;
        }
        .forgot {
          margin: 32px 0 -16px 0;
          padding: 0;
          font-size: 12px;
          text-align: center;
        }
        hax-logo {
          margin-top: -50px;
          margin-bottom: 16px;
          text-align: center;
          --hax-logo-font-size: 24px;
          --hax-logo-letter-spacing: 0px;
        }
        .camera-buttons {
          width: 100%;
          justify-content: center;
          display: flex;
        }
        paper-dialog {
          width: 60vw;
        }
        paper-dialog-scrollable {
          overflow: scroll;
          height: 40vh;
        }
        h2.dialog-header {
          background-color: var(--haxcms-site-listing-color-dark);
          margin: 0;
          padding: 28px;
          color: var(--haxcms-site-listing-color-light);
        }
        .buttons {
          text-align: center;
          margin: 0 auto;
          display: flex;
          justify-content: center;
          margin-top: 2em;
          color: var(--haxcms-site-listing-color-dark);
          font-weight: 500;
        }
        .action-button {
          width: 50%;
          height: 64px;
          background-color: var(--haxcms-site-listing-color-dark);
          color: var(--haxcms-site-listing-color-light);
          margin-right: 48px;
        }
        .action-button:hover,
        .action-button:active,
        .action-button:focus {
          background-color: var(--haxcms-site-listing-color-hover);
        }
        .action-button iron-icon {
          margin-right: 8px;
        }
        paper-input {
          --paper-input-container-focus-color: var(--haxcms-site-listing-color-hover);
        }
        .small-location {
          font-size: 11px;
          text-align: center;
          font-style: italic;
        }
        #loading {
          width: 100%;
          z-index: 1000;
          opacity: 1;
          padding: 24px;
          top: 0;
          position: absolute;
          background-color: rgba(250, 250, 250, 0.8);
          transition: all linear 1s;
          visibility: visible;
          color: white;
        }
        #loading[data-loading] {
          background-color: rgba(0, 0, 0, 0);
          opacity: 0;
          visibility: hidden;
        }
        a {
          text-decoration: none;
        }
        .site-title {
          font-size: 20px;
          color: black;
          text-align: center;
          width: 100%;
          text-transform: unset;
          min-width: unset;
        }
        .site-title:hover,
        .site-title:active,
        .site-title:focus {
          background-color: var(--haxcms-site-listing-color-hover);
          color: var(--haxcms-site-listing-color-light);
        }
        .operations paper-button {
          font-weight: 500;
          font-size: 18px;
          color: var(--haxcms-site-listing-color-light);
          margin: 0;
          padding: 8px;
          width: auto;
          display: inline-flex;
          height: 48px;
        }
        .operations paper-button:hover,
        .operations paper-button:active,
        .operations paper-button:focus {
          background-color: var(--haxcms-site-listing-color-light);
          color: var(--haxcms-site-listing-color-hover);
        }
        .operations.right {
          right: 0;
          position: absolute;
          display: inline-flex;
        }
        #add {
          background-color: var(--haxcms-site-listing-color-hover);
          color: (--haxcms-site-listing-color-light);
          transition: .2s all linear;
        }
        #add:hover,
        #add:active,
        #add:focus {
          background-color: var(--haxcms-site-listing-color-light);
          color: var(--haxcms-site-listing-color-hover);
        }
        .selected-operations {
          margin: 0 16px;
          transition: 0.3s linear all;
          display: inline-flex;
          visibility: visible;
          opacity: 1;
          align-content: center;
          justify-content: space-evenly;
          width: 100%;
        }
        .selected-operations[hidden] {
          visibility: hidden;
          opacity: 0;
        }
        .selected-operations paper-button {
          background-color: var(--haxcms-site-listing-color-light);
          font-weight: 500;
          font-size: 16px;
          color: var(--haxcms-site-listing-color-dark);
          margin: 0;
          min-width: unset;
          margin: 8px;
          height: 48px;
        }
        .selected-operations paper-button:active,
        .selected-operations paper-button:hover,
        .selected-operations paper-button:focus {
          background-color: var(--haxcms-site-listing-color-hover);
          color: var(--haxcms-site-listing-color-light); !important;
        }
        .danger {
          color: var(--simple-colors-default-theme-red-7) !important;
        }
        .danger:hover {
          color: var(--haxcms-site-listing-color-light) !important;
        }
        #userphoto {
          width: 40px;
          height: 40px;
          margin-right: 4px;
          border-radius: 50%;
        }
        @media screen and (max-width: 1080px) {
          .selected-operations .small-hide {
            display:none;
          }
        }
        @media screen and (max-width: 800px) {
          .main-title {
            display:none;
          }
        }
        @media screen and (max-width: 700px) {
          .small-hide {
            display:none;
          }
        }
      </style>
      <div>
        <jwt-login
          id="jwt"
          method="[[method]]"
          url="[[__loginPath]]"
          refresh-url="[[__refreshPath]]"
          logout-url="[[__logoutPath]]"
          jwt="{{jwt}}"
        ></jwt-login>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="loaddata"
          auto=""
          loading="{{__loading}}"
          url="[[dataSource]]"
          handle-as="json"
          debounce-duration="250"
          last-response="{{sitesResponse}}"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="createrequest"
          method="[[method]]"
          body="[[createParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__createNewSitePath]]"
          handle-as="json"
          on-response="handleCreateResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="gitimportrequest"
          method="[[method]]"
          body="[[gitImportParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__gitImportSitePath]]"
          handle-as="json"
          on-response="handleGitImportResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="downloadrequest"
          method="[[method]]"
          body="[[downloadParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__downloadSitePath]]"
          handle-as="json"
          on-response="handleDownloadResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="archiverequest"
          method="[[method]]"
          body="[[archiveParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__archiveSitePath]]"
          handle-as="json"
          on-response="handleArchiveResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="deleterequest"
          method="[[method]]"
          body="[[deleteParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__deleteSitePath]]"
          handle-as="json"
          on-response="handleDeleteResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="clonerequest"
          method="[[method]]"
          body="[[cloneParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__cloneSitePath]]"
          handle-as="json"
          on-response="handleCloneResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="publishrequest"
          method="[[method]]"
          body="[[publishParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__publishSitePath]]"
          handle-as="json"
          on-response="handlePublishResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="syncrequest"
          method="[[method]]"
          body="[[syncParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__syncSitePath]]"
          handle-as="json"
          on-response="handleSyncResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="getconfigrequest"
          method="[[method]]"
          body="[[configParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__getConfigPath]]"
          handle-as="json"
          on-response="handleConfigResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="setconfigrequest"
          method="[[method]]"
          body="[[setConfigParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__setConfigPath]]"
          handle-as="json"
          on-response="handleSetConfigResponse"
        ></iron-ajax>
        <iron-ajax
          reject-with-request
          on-last-error-changed="lastErrorChanged"
          id="getuserdatarequest"
          method="[[method]]"
          body="[[getUserDataParams]]"
          headers='{"Authorization": "Bearer [[jwt]]"}'
          content-type="application/json"
          url="[[__getUserDataPath]]"
          handle-as="json"
          on-response="handleGetUserDataResponse"
        ></iron-ajax>
      </div>
      <div id="loading" data-loading\$="[[!__loading]]">
        <hexagon-loader
          item-count="4"
          color="white"
          loading
          size="large"
        ></hexagon-loader>
      </div>
      <app-header reveals>
        <app-toolbar>
          <slot name="app-header-pre"></slot>
          <div class="operations">
            <paper-button
              on-click="_addTap"
              id="add"
              raised
              hidden$="[[!loggedIn]]"
              title="Create new site"
            >
              <iron-icon icon="icons:add"></iron-icon>
              <span class="small-hide">Create</span>
            </paper-button>
            <paper-button
              on-click="_importTap"
              id="import"
              raised
              hidden$="[[!loggedIn]]"
              title="Import site"
            >
              <iron-icon icon="icons:cloud-download"></iron-icon>
              <span class="small-hide">Import</span>
            </paper-button>
          </div>
          <div class="main-title" hidden$="[[!loggedIn]]">[[title]]</div>
          <div class="operations right">
            <paper-button
              on-click="_settingsTap"
              id="settings"
              raised
              title="Settings"
              hidden$="[[!showSpecialButtons(hideGlobalSettings,loggedIn)]]"
            >
              <iron-icon icon="icons:settings"></iron-icon>
              <span class="small-hide">Settings</span>
            </paper-button>
            <paper-button
              hidden$="[[!showSpecialButtons(hideLogin,loggedIn)]]"
              id="login"
              on-click="_logoutUserRoutine"
              title="Logout"
            >
              <template is="dom-if" if="[[!logoutPhoto]]">
                <iron-icon
                  icon="[[__loginIcon]]"
                  class="small-hide"
                ></iron-icon>
              </template>
              <template is="dom-if" if="[[logoutPhoto]]">
                <img id="userphoto" src="[[logoutPhoto]]" class="small-hide" />
              </template>
              [[__loginText]]</paper-button
            >
          </div>
        </app-toolbar>
      </app-header>
      <app-header class="selected-operations" id="ops">
        <app-toolbar>
          <div>
            <paper-button
              title="Publish"
              on-click="_bulkSitesConfirm"
              id="publish"
              raised
            >
              <iron-icon icon="editor:publish"></iron-icon>
              <span class="small-hide">Publish site</span>
            </paper-button>
            <paper-button
              title="Sync git"
              on-click="_bulkSitesConfirm"
              id="sync"
              raised
            >
              <iron-icon icon="notification:sync"></iron-icon>
              <span class="small-hide">Sync git</span>
            </paper-button>
            <paper-button
              title="Copy site"
              on-click="_bulkSitesConfirm"
              id="clone"
              raised
            >
              <iron-icon icon="icons:content-copy"></iron-icon>
              <span class="small-hide">Copy site</span>
            </paper-button>
            <paper-button
              title="Download zip"
              on-click="_bulkSitesConfirm"
              id="download"
              raised
            >
              <iron-icon icon="icons:file-download"></iron-icon>
              <span class="small-hide">Download zip</span>
            </paper-button>
            <paper-button
              title="Archive"
              on-click="_bulkSitesConfirm"
              id="archive"
              raised
            >
              <iron-icon icon="icons:archive"></iron-icon>
              <span class="small-hide">Archive site</span>
            </paper-button>
            <paper-button
              on-click="_bulkSitesConfirm"
              id="delete"
              raised
              class="danger"
              title="Delete forever"
            >
              <iron-icon icon="icons:delete-forever"></iron-icon>
              <span class="small-hide">Delete forever</span>
            </paper-button>
          </div>
        </app-toolbar>
      </app-header>

      <vaadin-grid
        hidden$="[[!loggedIn]]"
        id="grid"
        items="[[sites]]"
        theme="row-dividers"
        column-reordering-allowed
        multi-sort
      >
        <vaadin-grid-selection-column
          auto-select
          frozen
        ></vaadin-grid-selection-column>
        <vaadin-grid-filter-column width="6em" path="title">
          <template>
            <portal-launcher>
              <a tabindex="-1" href$="[[item.location]]">
                <paper-button raised class="site-title">
                  [[item.title]]
                </paper-button>
                <div class="small-location">
                  [[cleanLocation(item.location)]]
                </div>
              </a>
            </portal-launcher>
          </template>
        </vaadin-grid-filter-column>
        <vaadin-grid-filter-column
          width="2em"
          path="metadata.theme.name"
          header="Theme"
        ></vaadin-grid-filter-column>
        <vaadin-grid-sort-column
          width="1em"
          path="metadata.pageCount"
          header="Pages"
        ></vaadin-grid-sort-column>
        <vaadin-grid-sort-column
          width="1em"
          header="Last published"
          path="metadata.lastPublished"
        >
          <template>
            <template
              is="dom-if"
              if="[[item.metadata.site.static.lastPublished]]"
            >
              <simple-datetime
                format="M jS, Y"
                timestamp="[[item.metadata.site.static.lastPublished]]"
                unix
              ></simple-datetime>
            </template>
          </template>
        </vaadin-grid-sort-column>
        <vaadin-grid-sort-column
          width="1em"
          header="Updated"
          path="metadata.updated"
        >
          <template>
            <template is="dom-if" if="[[item.metadata.site.updated]]">
              <simple-datetime
                format="M jS, Y"
                timestamp="[[item.metadata.site.updated]]"
                unix
              ></simple-datetime>
            </template>
          </template>
        </vaadin-grid-sort-column>
        <vaadin-grid-sort-column
          width="1em"
          header="Created"
          path="metadata.created"
        >
          <template>
            <template is="dom-if" if="[[item.metadata.site.created]]">
              <simple-datetime
                format="M jS, Y"
                timestamp="[[item.metadata.site.created]]"
                unix
              ></simple-datetime>
            </template>
          </template>
        </vaadin-grid-sort-column>
        <vaadin-grid-column width="1em" header="Icon">
          <template
            ><iron-icon
              icon="[[item.metadata.theme.variables.icon]]"
            ></iron-icon
          ></template>
        </vaadin-grid-column>
        <vaadin-grid-column width="1em" header="Color">
          <template>
            <div
              style$="border:1px solid black;width:48px;height:48px;background-color:[[item.metadata.theme.variables.hexCode]];"
            ></div>
          </template>
        </vaadin-grid-column>
        <vaadin-grid-column width="1em" header="Banner">
          <template
            ><iron-image
              sizing="contain"
              preload
              src$="[[item.metadata.theme.variables.image]]"
              style="width:100px; height:48px;"
            ></iron-image
          ></template>
        </vaadin-grid-column>
      </vaadin-grid>
      <div class="login-prompt" hidden$="[[loggedIn]]">
        <simple-login>
          <hax-logo size="mini" hide-hax><span>HAXcms login</span></hax-logo>
          <div class="camera-buttons">
            <paper-icon-button
              id="snap"
              icon="image:camera-alt"
              title="Snap photo"
            ></paper-icon-button>
            <paper-icon-button
              id="newsnap"
              icon="icons:cancel"
              title="Clear photo"
            ></paper-icon-button>
          </div>
          <simple-login-avatar>
            <div id="selfie"></div>
            <simple-login-camera id="camera" autoplay></simple-login-camera>
          </simple-login-avatar>
          <p class="forgot" slot="buttons">
            Forget your login? Check <strong>_config/config.php</strong>
          </p>
        </simple-login>
        <vaadin-upload
          capture
          headers='{"Authorization": "Bearer [[jwt]]"}'
          method="[[method]]"
          form-data-name="file-upload"
          hidden
          id="fileupload"
        ></vaadin-upload>
      </div>
      <paper-dialog id="confirm">
        <h2 class="dialog-header">
          [[activeOpertion]] these [[selectedItems.length]] sites
        </h2>
        <paper-dialog-scrollable>
          <ul>
            <dom-repeat items="[[selectedItems]]" as="site">
              <template>
                <li>[[site.title]]</li>
              </template>
            </dom-repeat>
          </ul>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button
            on-click="_confirmBulkOperation"
            dialog-confirm
            id="bulksites"
            class="action-button"
            raised
            ><iron-icon icon="icons:thumb-up"></iron-icon> Yes,
            [[activeOpertion]]</paper-button
          >
          <paper-button class="action-button" dialog-dismiss
            ><iron-icon icon="icons:thumb-down"></iron-icon>
            Cancel</paper-button
          >
        </div>
      </paper-dialog>
      <paper-dialog id="createsite">
        <h2 class="dialog-header">Create new site</h2>
        <paper-dialog-scrollable>
          <form>
            <simple-fields id="createsitefields" autofocus></simple-fields>
          </form>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button
            on-click="_createSite"
            class="action-button"
            dialog-confirm
            id="create"
            raised
            ><iron-icon icon="icons:home"></iron-icon> Create your new
            site!</paper-button
          >
          <paper-button class="action-button" dialog-dismiss
            ><iron-icon icon="icons:thumb-down"></iron-icon>
            Cancel</paper-button
          >
        </div>
      </paper-dialog>
      <paper-dialog id="importsite">
        <h2 class="dialog-header">Import site from git repo</h2>
        <paper-input id="importurl" label="Git url"></paper-input>
        <div class="buttons">
          <paper-button
            on-click="_gitImportSite"
            class="action-button"
            dialog-confirm
            id="importsite"
            raised
            ><iron-icon icon="icons:home"></iron-icon> Import</paper-button
          >
          <paper-button class="action-button" dialog-dismiss
            ><iron-icon icon="icons:thumb-down"></iron-icon>
            Cancel</paper-button
          >
        </div>
      </paper-dialog>
      <paper-dialog id="settingsdialog">
        <h2 class="dialog-header">Edit HAXCMS configuration</h2>
        <paper-dialog-scrollable>
          <simple-fields id="settingsform"></simple-fields>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button
            on-click="_saveConfig"
            dialog-confirm
            id="saveconfig"
            class="action-button"
            raised
            ><iron-icon icon="icons:save"></iron-icon> Save</paper-button
          >
          <paper-button class="action-button" dialog-dismiss
            ><iron-icon icon="icons:thumb-down"></iron-icon>
            Cancel</paper-button
          >
        </div>
      </paper-dialog>
    `}_sitesResponseChanged(e,t){e&&void 0!==e.items&&(this.title=e.title,this.set("sites",[]),this.set("sites",e.items),this.notifyPath("sites.*"))}cleanLocation(e){return e.replace("/_sites/","").replace("/","")}static get properties(){return{__loading:{type:Boolean},sitesResponse:{type:Object,notify:!0,observer:"_sitesResponseChanged"},method:{type:String,value:"POST"},title:{type:String,value:"My sites"},sites:{type:Array,notify:!0},basePath:{type:String},hideLogin:{type:Boolean,value:!1},hideGlobalSettings:{type:Boolean,value:!1},dataSource:{type:String,observer:"_dataSourceChanged"},jwt:{type:String,notify:!0,observer:"_jwtChanged"},userData:{type:Object,value:{},observer:"_userDataChanged"},createParams:{type:Object,value:{}},downloadParams:{type:Object,value:{}},deleteParams:{type:Object,value:{}},cloneParams:{type:Object,value:{}},publishParams:{type:Object,value:{}},syncParams:{type:Object,value:{}},archiveParams:{type:Object,value:{}},configParams:{type:Object,value:{}},setConfigParams:{type:Object,value:{}},getUserDataParams:{type:Object,value:{}},activeOpertion:{type:String},selectedItems:{type:Array,value:[],observer:"_selectedItemsChanged"},activeItem:{type:Object,notify:!0},loggedIn:{type:Boolean,value:!1,notify:!0,reflectToAttribute:!0,observer:"_loggedInChanged"},editMode:{type:Boolean,notify:!0,reflectToAttribute:!0,value:!1,observer:"_editModeChanged"},hideCamera:{type:Boolean,value:!1},logoutPhoto:{type:String,value:!1}}}_userDataChanged(e){e.userName&&(this.title=e.userName+" sites"),e.userPicture&&(this.logoutPhoto=e.userPicture)}showSpecialButtons(e,t){return!e&&!!t}_selectedItemsChanged(e){e&&e.length>0?this.shadowRoot.querySelector("#ops").removeAttribute("hidden"):this.shadowRoot.querySelector("#ops").setAttribute("hidden","hidden")}_dataSourceChanged(e){e&&(this._dataSource=e+"?"+Math.floor(Date.now()/1e3))}_jwtLoggedIn(e){e.detail?this.loggedIn=!0:this.loggedIn=!1}_tokenRefreshFailed(e){401==e.detail.value.status&&(this.jwt=null,this.loggedIn=!1)}_editModeChanged(e){this.__editIcon=e?"icons:check":"icons:create"}_addTap(){this._resetNewSiteForm(),this.shadowRoot.querySelector("#createsite").opened=!0}_importTap(){this.shadowRoot.querySelector("#importurl").value="",this.shadowRoot.querySelector("#importsite").opened=!0}_loggedInChanged(e,t){void 0!==t&&(e?(document.body.setAttribute("data-logged-in","data-logged-in"),this.__loginText="Log out",this.__loginIcon="icons:account-circle",this.standardResponse("Welcome, log in successful!"),this.shadowRoot.querySelector("#add").hidden=!1):(document.body.removeAttribute("data-logged-in"),this.__loginText="Log in",this.__loginIcon="icons:power-settings-new",this.standardResponse("You logged out"),this.shadowRoot.querySelector("#add").hidden=!0))}_jwtChanged(e){if(e){if(this.__loginText="Log out",this.__loginIcon="icons:account-circle",this.__cameraBlob){let t=new File([this.__cameraBlob],"userPhoto"+Date.now()+".jpg");this.shadowRoot.querySelector("#fileupload").target=this.__setUserPhotoPath+"&jwt="+e,this.shadowRoot.querySelector("#fileupload")._addFile(t),this.shadowRoot.querySelector("#fileupload").uploadFiles()}setTimeout(()=>{this.set("getUserDataParams",{}),this.set("getUserDataParams",{jwt:e}),this.notifyPath("getUserDataParams.*"),this.shadowRoot.querySelector("#getuserdatarequest").generateRequest()},500)}else this.__loginText="Log in",this.__loginIcon="icons:power-settings-new"}_editTap(e){this.editMode=!this.editMode}_settingsTap(e){this._loadConfig(),this.shadowRoot.querySelector("#settingsdialog").opened=!0}refreshData(e){this.shadowRoot.querySelector("#loaddata").generateRequest()}_gridSelectedItemsChanged(e){this.set("selectedItems",[]),this.set("selectedItems",this.shadowRoot.querySelector("#grid").selectedItems)}connectedCallback(){super.connectedCallback(),window.addEventListener("jwt-login-refresh-error",this._tokenRefreshFailed.bind(this)),window.addEventListener("jwt-token",this.updateJwt.bind(this)),navigator.mediaDevices||(this.shadowRoot.querySelector("#snap").style.display="none",this.shadowRoot.querySelector("#newsnap").style.display="none"),this.shadowRoot.querySelector("#fileupload").addEventListener("upload-response",this.handleSetUserPhotoResponse.bind(this)),this.jwt&&(this.loggedIn=!0),window.addEventListener("sites-listing-refresh-data",this.refreshData.bind(this)),o(this,(function(){if(document.head.createShadowRoot||document.head.attachShadow);else{console.warn("Shadow DOM missing, ALL YOUR IE R BELONG TO US"),console.warn("HAXCMS DOES NOT LOVE YOUR OLD BROWSER FOR EDITING JUST VIEWING"),console.warn("You get no authoring experience. Good day to you!");const e=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:"WARNING: You are using a polyfilled browser. HAXcms requires modern browsers, please upgrade or switch to a modern browser to edit in HAXcms!",duration:1e4}});this.dispatchEvent(e)}this.hideCamera?(this.shadowRoot.querySelector("#newsnap").classList.add("hide-camera"),this.shadowRoot.querySelector("#snap").classList.add("hide-camera"),this.shadowRoot.querySelector("#camera").classList.add("hide-camera")):import("../../../../simple-login/lib/simple-login-camera.js"),this.addEventListener("simple-login-login",this.loginPromptEvent.bind(this)),this.shadowRoot.querySelector("#grid").addEventListener("selected-items-changed",this._gridSelectedItemsChanged.bind(this)),this.__loginPath=window.appSettings.login,this.__refreshPath=window.appSettings.refreshUrl,this.__logoutPath=window.appSettings.logout,this.__setConfigPath=window.appSettings.setConfigPath,this.__getUserDataPath=window.appSettings.getUserDataPath,this.__setUserPhotoPath=window.appSettings.setUserPhotoPath,this.__getConfigPath=window.appSettings.getConfigPath,this.__createNewSitePath=window.appSettings.createNewSitePath,this.__gitImportSitePath=window.appSettings.gitImportSitePath,this.__downloadSitePath=window.appSettings.downloadSitePath,this.__archiveSitePath=window.appSettings.archiveSitePath,this.__cloneSitePath=window.appSettings.cloneSitePath,this.__publishSitePath=window.appSettings.publishSitePath,this.__syncSitePath=window.appSettings.syncSitePath,this.__revertSitePath=window.appSettings.revertSitePath,this.__deleteSitePath=window.appSettings.deleteSitePath,window.appSettings.jwt&&this.set("jwt",window.appSettings.jwt),document.body.addEventListener("haxcms-load-site",this.loadActiveSite.bind(this)),this.shadowRoot.querySelector("#snap").addEventListener("click",this.snapPhoto.bind(this)),this.shadowRoot.querySelector("#newsnap").addEventListener("click",this.clearPhoto.bind(this))}))}async snapPhoto(e){const t=this.shadowRoot.querySelector("#camera");this.__cameraBlob=await t.takeASnap().then(t.imageBlob);let i=document.createElement("img");i.src=URL.createObjectURL(this.__cameraBlob),t.removeAttribute("autoplay");const o=this.shadowRoot.querySelector("#selfie");o.innerHTML="",o.appendChild(i),o.classList.add("has-snap")}clearPhoto(e){this.shadowRoot.querySelector("#camera").setAttribute("autoplay","autoplay");const t=this.shadowRoot.querySelector("#selfie");t.innerHTML="",t.classList.remove("has-snap")}loginPromptEvent(e){this._loginUserRoutine({u:e.detail.u,p:e.detail.p})}_logoutUserRoutine(){this.dispatchEvent(new CustomEvent("jwt-login-logout",{composed:!0,bubbles:!0,cancelable:!1,detail:{}}))}_loginUserRoutine(e){this.dispatchEvent(new CustomEvent("jwt-login-login",{composed:!0,bubbles:!0,cancelable:!1,detail:e}))}_resetNewSiteForm(){let e=[],t=null;for(var i in window.appSettings.themes)e[i]=window.appSettings.themes[i].name,t||(t=i);const o=this.shadowRoot.querySelector("#createsitefields");o.fields=[{property:"id",title:"id",description:"",inputMethod:"boolean",hidden:!0},{property:"manifest",inputMethod:"tabs",properties:[{property:"site",title:"Details",properties:[{property:"name",title:"Site name",description:"This forms the folder name and metadata title for the site",inputMethod:"textfield",required:!0},{property:"domain",title:"Domain",description:"Optional domain name",inputMethod:"textfield"},{property:"description",title:"Description",description:"Addition detail, for personal use as well as search engine optimization",inputMethod:"textfield"}]},{property:"theme",title:"Theme",properties:[{property:"name",title:"Theme",description:"Design for presenting your new site",inputMethod:"select",allowNull:!1,options:e},{property:"image",title:"Image",description:"The image is typically used as the banner in themes",inputMethod:"haxupload",validationType:"url"},{property:"icon",title:"Pick an icon.",description:"The icon is used in some designs areas to help you know what site your on",inputMethod:"iconpicker"},{property:"color",title:"Color",description:"Choose a primary color to tint the UI or be used in the theme",inputMethod:"colorpicker"}]}]}],o.value={id:!1,manifest:{site:{name:"",domain:"",description:""},theme:{name:t,image:"assets/banner.jpg",color:"blue",icon:"icons:add-circle-outline"}}}}disconnectedCallback(){window.removeEventListener("jwt-login-refresh-error",this._tokenRefreshFailed.bind(this)),window.removeEventListener("jwt-token",this.updateJwt.bind(this)),window.removeEventListener("sites-listing-refresh-data",this.refreshData.bind(this)),document.body.removeEventListener("haxcms-load-site",this.loadActiveSite.bind(this)),this.removeEventListener("simple-login-login",this.loginPromptEvent.bind(this)),this.shadowRoot.querySelector("#snap").removeEventListener("click",this.snapPhoto.bind(this)),this.shadowRoot.querySelector("#newsnap").removeEventListener("click",this.clearPhoto.bind(this)),this.shadowRoot.querySelector("#grid").removeEventListener("selected-items-changed",this._gridSelectedItemsChanged.bind(this)),this.shadowRoot.querySelector("#jwt").removeEventListener("jwt-logged-in",this._jwtLoggedIn.bind(this)),super.disconnectedCallback()}ready(){super.ready(),this.shadowRoot.querySelector("#jwt").addEventListener("jwt-logged-in",this._jwtLoggedIn.bind(this)),window.JSONOutlineSchema.requestAvailability(),window.SimpleModal.requestAvailability(),window.SimpleToast.requestAvailability()}loadActiveSite(e){let t=this.sites.filter(t=>t.id===e.detail.id).pop();t.location?window.open(t.location):window.open(this.basePath+"_sites/"+t.metadata.site.name+"/")}_gitImportSite(e){let t=Object.assign({jwt:this.jwt,site:{git:{url:this.shadowRoot.querySelector("#importurl").value}}});this.set("gitImportParams",{}),this.set("gitImportParams",t),this.notifyPath("gitImportParams.*"),this.shadowRoot.querySelector("#gitimportrequest").generateRequest()}_createSite(e){let t=Object.assign({jwt:this.jwt},this.shadowRoot.querySelector("#createsitefields").value.manifest);this.set("createParams",{}),this.set("createParams",t),this.notifyPath("createParams.*"),this.shadowRoot.querySelector("#createrequest").generateRequest()}async _downloadSites(e){for(var t in this.set("downloadParams",{}),this.set("downloadParams",{jwt:this.jwt,site:{}}),this.notifyPath("downloadParams.*"),this.selectedItems)this.set("activeItem",{}),this.set("activeItem",this.selectedItems[t]),this.set("downloadParams.site.name",this.selectedItems[t].metadata.site.name),this.notifyPath("downloadParams.site.name"),await this.shadowRoot.querySelector("#downloadrequest").generateRequest()}async _archiveSites(e){for(var t in this.set("archiveParams",{}),this.set("archiveParams",{jwt:this.jwt,site:{}}),this.notifyPath("archiveParams.*"),this.selectedItems)this.set("activeItem",{}),this.set("activeItem",this.selectedItems[t]),this.set("archiveParams.site.name",this.selectedItems[t].metadata.site.name),this.notifyPath("archiveParams.site.name"),await this.shadowRoot.querySelector("#archiverequest").generateRequest()}_bulkSitesConfirm(e){let t=!1;if(e.target.id)t=e.target.id;else if(!e.path&&e.originalTarget)t=e.originalTarget.id?e.originalTarget.id:e.originalTarget.parentElement.id;else{let i=e.path;for(;!t&&i&&i.length>0;)i[0].id&&(t=i[0].id),i.shift()}this.activeOpertion=t,this.shadowRoot.querySelector("#confirm").opened=!0}async _confirmBulkOperation(e){await this["_"+this.activeOpertion+"Sites"](),this.activeOpertion="",this.shadowRoot.querySelector("#grid").set("selectedItems",[])}async _deleteSites(e){for(var t in this.set("deleteParams",{}),this.set("deleteParams",{jwt:this.jwt,site:{}}),this.notifyPath("deleteParams.*"),this.selectedItems)this.set("activeItem",{}),this.set("activeItem",this.selectedItems[t]),this.set("deleteParams.site.name",this.selectedItems[t].metadata.site.name),this.notifyPath("deleteParams.site.name"),await this.shadowRoot.querySelector("#deleterequest").generateRequest()}async _cloneSites(e){for(var t in this.set("cloneParams",{}),this.set("cloneParams",{jwt:this.jwt,site:{}}),this.notifyPath("cloneParams.*"),this.selectedItems)this.set("activeItem",{}),this.set("activeItem",this.selectedItems[t]),this.set("cloneParams.site.name",this.selectedItems[t].metadata.site.name),this.notifyPath("cloneParams.site.name"),await this.shadowRoot.querySelector("#clonerequest").generateRequest()}async _publishSites(e){for(var t in this.set("publishParams",{}),this.set("publishParams",{jwt:this.jwt,site:{}}),this.notifyPath("publishParams.*"),this.selectedItems)this.set("activeItem",{}),this.set("activeItem",this.selectedItems[t]),this.set("publishParams.site.name",this.selectedItems[t].metadata.site.name),this.notifyPath("publishParams.site.name"),await this.shadowRoot.querySelector("#publishrequest").generateRequest()}async _syncSites(e){for(var t in this.set("syncParams",{}),this.set("syncParams",{jwt:this.jwt,site:{}}),this.notifyPath("syncParams.*"),this.selectedItems)this.set("activeItem",{}),this.set("activeItem",this.selectedItems[t]),this.set("syncParams.site.name",this.selectedItems[t].metadata.site.name),this.notifyPath("syncParams.site.name"),await this.shadowRoot.querySelector("#syncrequest").generateRequest()}_loadConfig(){this.set("configParams",{}),this.set("configParams",{jwt:this.jwt,token:this.createParams.token}),this.notifyPath("configParams.*"),this.shadowRoot.querySelector("#getconfigrequest").generateRequest()}_saveConfig(e){window.HAXCMS.config.values=this.shadowRoot.querySelector("#settingsform").value,this.set("setConfigParams",{}),this.set("setConfigParams",{jwt:this.jwt,token:this.createParams.token,values:window.HAXCMS.config.values}),this.notifyPath("setConfigParams.*"),this.shadowRoot.querySelector("#setconfigrequest").generateRequest()}standardResponse(e,t=!0){t&&this.dispatchEvent(new CustomEvent("sites-listing-refresh-data",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),this.dispatchEvent(new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:e,duration:5e3}}))}handleCreateResponse(e){this._dataSource=this.dataSource+"?"+Math.floor(Date.now()/1e3),this.standardResponse(e.detail.response.title+" created!")}handleGitImportResponse(e){this._dataSource=this.dataSource+"?"+Math.floor(Date.now()/1e3),this.standardResponse(e.detail.response.title+" imported!")}handleConfigResponse(e){window.HAXCMS.config=e.detail.response,this.shadowRoot.querySelector("#settingsform").schema={},this.shadowRoot.querySelector("#settingsform").schema=window.HAXCMS.config.schema,this.shadowRoot.querySelector("#settingsform").value={},this.shadowRoot.querySelector("#settingsform").value=window.HAXCMS.config.values;var t=document.createEvent("UIEvents");t.initUIEvent("resize",!0,!1,window,0),window.dispatchEvent(t)}handleSetConfigResponse(e){this.shadowRoot.querySelector("#settingsdialog").opened=!1,this.standardResponse("HAXCMS configuration updated!")}handleGetUserDataResponse(e){this.userData=e.detail.response.data}handleSetUserPhotoResponse(e){delete this.__cameraBlob,this.standardResponse("User photo saved!",!1)}handleDownloadResponse(e){let t=document.createElement("a");t.setAttribute("href",e.detail.response.link),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),this.standardResponse(this.activeItem.title+" downloaded!")}handleArchiveResponse(e){this.standardResponse(this.activeItem.title+" archived!")}handleDeleteResponse(e){this.standardResponse(this.activeItem.title+" deleted!")}handleCloneResponse(e){this.standardResponse(this.activeItem.title+" cloned!")}handlePublishResponse(e){this.standardResponse(this.activeItem.title+" published!")}handleSyncResponse(e){this.standardResponse(this.activeItem.title+" published!")}lastErrorChanged(e){if(e.detail.value)switch(parseInt(e.detail.value.status)){case 401:this.dispatchEvent(new CustomEvent("jwt-login-logout",{composed:!0,bubbles:!0,cancelable:!1,detail:{redirect:!0}}));break;case 403:this.dispatchEvent(new CustomEvent("jwt-login-refresh-token",{composed:!0,bubbles:!0,cancelable:!1,detail:{element:{obj:this,callback:"refreshRequest",params:[e.path[0]]}}}));break;default:console.error(e);const t=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:e.detail.value.status+" "+e.detail.value.statusText}});window.dispatchEvent(t)}}updateJwt(e){this.jwt=e.detail}refreshRequest(e,t){this.jwt=e,t.body.jwt=e,setTimeout(()=>{t.generateRequest()},0)}}window.customElements.define(HAXCMSSiteListing.tag,HAXCMSSiteListing);export{HAXCMSSiteListing};