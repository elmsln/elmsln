import{html as e,css as t}from"../../lit/index.js";import{SimpleColors as i}from"../simple-colors/simple-colors.js";import{UndoManagerBehaviors as o}from"../undo-manager/undo-manager.js";import{HAXStore as a}from"./lib/hax-store.js";import{autorun as n,toJS as s}from"../../mobx/dist/mobx.esm.js";import"./lib/hax-text-editor-toolbar.js";import{encapScript as r,wipeSlot as l,generateResourceID as d,nodeToHaxElement as c,haxElementToNode as h,camelToDash as u,wrap as m,unwrap as g,ReplaceWithPolyfill as v,normalizeEventPath as p}from"../utils/utils.js";import{HaxUiBaseStyles as b}from"./lib/hax-ui-styles.js";import{I18NMixin as x}from"../i18n-manager/lib/I18NMixin.js";import"../absolute-position-behavior/absolute-position-behavior.js";Element.prototype.replaceWith||(Element.prototype.replaceWith=v),CharacterData.prototype.replaceWith||(CharacterData.prototype.replaceWith=v),DocumentType.prototype.replaceWith||(DocumentType.prototype.replaceWith=v),String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return this.split(e).join(t)});var y=null;class HaxBody extends(x(o(i))){static get tag(){return"hax-body"}static get styles(){return[...super.styles,t`
        :host([edit-mode]),
        :host([edit-mode]) * ::slotted(*) {
          line-height: 1.8;
        }
        :host([edit-mode]) ul,
        :host([edit-mode]) ol {
          padding-left: 20px;
          margin-left: 20px;
        }
        :host([edit-mode]) ul {
          list-style-type: disc;
        }
        :host([edit-mode]) li {
          margin-bottom: 6px;
        }
        :host([edit-mode][tray-status="full-panel"]) #bodycontainer {
          display: none;
        }
        :host {
          display: block;
          position: relative;
          min-height: 32px;
          min-width: 32px;
          outline: none;
          --hax-contextual-action-text-color: var(--hax-ui-background-color);
          --hax-contextual-action-hover-color: var(--hax-ui-color-accent);
          --hax-contextual-action-color: var(--hax-ui-color-accent-secondary);
          --hax-body-editable-outline: 1px solid
            var(--hax-ui-disabled-color, #ddd);
          --hax-body-active-outline-hover: 1px solid
            var(--hax-ui-color-faded, #444);
          --hax-body-active-outline: 1px solid var(--hax-ui-color-focus, #000);
          --hax-body-active-drag-outline: 1px solid
            var(--hax-ui-color-accent, #009dc7);
          --hax-body-target-background-color: var(
            --hax-ui-background-color-accent
          );
          --hax-body-possible-target-background-color: inherit;
        }
        #topcontext {
          z-index: calc(var(--hax-ui-focus-z-index) - 2);
          min-width: 280px;
        }
        #topcontextmenu {
          width: auto;
          max-width: 100%;
          position: absolute;
          bottom: 0;
        }
        .hax-context-menu {
          display: none;
          z-index: 1;
        }
        .hax-context-menu:hover {
          z-index: calc(var(--hax-ui-focus-z-index) + 1);
          transition: 0s z-index ease-in-out;
        }
        .hax-context-visible,
        .hax-context-menu-active {
          display: flex;
        }
        :host([edit-mode]) #bodycontainer ::slotted([contenteditable]) {
          -webkit-appearance: textfield;
          cursor: text;
          -moz-user-select: text;
          -khtml-user-select: text;
          -webkit-user-select: text;
          -o-user-select: text;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty)::before {
          content: attr(data-hax-ray);
          opacity: 0.2;
          transition: 0.2s all ease-in-out;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:hover:empty)::before {
          opacity: 0.4;
          cursor: text;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted([contenteditable][data-hax-ray]:empty:focus)::before {
          content: "";
        }
        :host([edit-mode]) #bodycontainer ::slotted(p) {
          min-height: var(--hax-base-styles-p-min-height, 1rem);
          font-size: var(--hax-base-styles-p-font-size);
          line-height: var(--hax-base-styles-p-line-height);
          letter-spacing: var(--hax-base-styles-p-letter-spacing);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a) {
          color: var(--hax-base-styles-a-color);
          font-size: var(
            --hax-base-styles-a-font-size,
            var(--hax-base-styles-p-font-size)
          );
          font-weight: var(--hax-base-styles-a-font-weight);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:visited) {
          color: var(--hax-base-styles-a-color-visited);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:active),
        :host([edit-mode]) #bodycontainer ::slotted(a:focus),
        :host([edit-mode]) #bodycontainer ::slotted(a:hover) {
          color: var(--hax-base-styles-a-color-active);
          font-weight: var(--hax-base-styles-a-font-weight-active);
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol),
        :host([edit-mode]) #bodycontainer ::slotted(ul),
        :host([edit-mode]) #bodycontainer ::slotted(li) {
          padding-bottom: var(--hax-base-styles-list-padding-bottom);
          line-height: var(
            --hax-base-styles-list-line-height,
            var(--hax-base-styles-p-line-height)
          );
          font-size: var(
            --hax-base-styles-list-font-size,
            var(--hax-base-styles-p-font-size)
          );
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol > li:last-child),
        :host([edit-mode]) #bodycontainer ::slotted(ul > li:last-child) {
          padding-bottom: var(--hax-base-styles-list-last-child-padding-bottom);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img[contenteditable]) {
          max-width: 100%;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          outline: none;
          caret-color: auto;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*.blinkfocus) {
          outline: 4px solid var(--hax-contextual-action-hover-color);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not([data-hax-layout])[contenteditable]:hover) {
          outline: var(--hax-body-active-outline-hover);
          caret-color: auto;
        }
        :host(.hax-add-content-visible[edit-mode])
          #bodycontainer
          ::slotted(*.hax-active) {
          margin-bottom: 30px;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not([data-hax-layout])[contenteditable]
            .hax-active:hover) {
          cursor: text !important;
          caret-color: auto;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(code.hax-active[contenteditable]) {
          display: block;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]) {
          outline: var(--hax-body-active-outline) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(hr[contenteditable]) {
          height: 2px;
          background-color: #eeeeee;
          padding-top: 4px;
          padding-bottom: 4px;
        }
        /** Fix to support safari as it defaults to none */
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          -webkit-user-select: text;
          cursor: pointer;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::-moz-selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::-moz-selection) {
          background-color: var(--hax-body-highlight, #ffffac);
          color: black;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::selection) {
          background-color: var(--hax-body-highlight, #ffffac);
          color: black;
        }
        #bodycontainer {
          -webkit-user-select: text;
          user-select: text;
        }
        absolute-position-behavior:not(:defined),
        .hax-context-menu:not(:defined) {
          display: none;
        }
        /* drag and drop */
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*)::before {
          background-color: var(--hax-body-possible-target-background-color);
          content: " ";
          width: 100%;
          display: block;
          position: relative;
          margin: -12px 0 0 0;
          z-index: 2;
          height: 12px;
          transition: 0.2s all ease-in-out;
        }
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(img) {
          outline: var(--hax-body-editable-outline);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered),
        :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered)::before {
          background-color: var(--hax-body-target-background-color) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered) {
          border-top: 8px
            var(--hax-contextual-action-hover-color, var(--hax-ui-color-accent));
          margin-top: -8px;
        }
        /** This is mobile layout for controls */
        @media screen and (max-width: 800px) {
          .hax-context-menu {
            height: 0px;
          }
          .hax-context-visible {
            height: auto;
          }
          :host([edit-mode]) #bodycontainer,
          :host([edit-mode]) #bodycontainer[element-align="left"],
          :host([edit-mode]) #bodycontainer[element-align="right"] {
            margin: calc(100px + var(--hax-tray-menubar-min-height)) 0 0 0;
          }
        }

        @media screen and (min-color-index: 0) and(-webkit-min-device-pixel-ratio:0) {
          /*
            Define here the CSS styles applied only to Safari browsers
            (any version and any device) via https://solvit.io/bcf61b6
          */
          :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*) {
            outline: var(--hax-body-editable-outline);
            background-color: var(--hax-body-possible-target-background-color);
          }
          :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered) {
            background-color: var(
              --hax-body-target-background-color
            ) !important;
            outline: var(--hax-body-active-outline);
          }
        }
      `]}constructor(){if(super(),this.__ignoreActive=!1,this.__dragMoving=!1,this.___moveLock=!1,this.viewSourceToggle=!1,this.editMode=!1,this.haxMover=!1,this.activeNode=null,this.part="hax-body",this.t={addContent:"Add Content"},this.registerLocalization({context:this,namespace:"hax"}),!window.HaxUiStyles){window.HaxUiStyles=document.createElement("div");let e=document.createElement("style"),t=b.map((e=>e.cssText)).join("");e.setAttribute("data-hax",!0),e.setAttribute("type","text/css"),e.styleSheet?e.styleSheet.cssText=t:e.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(e)}setTimeout((()=>{import("./lib/hax-context-behaviors.js"),import("./lib/hax-text-context.js"),import("./lib/hax-plate-context.js"),import("../grid-plate/grid-plate.js"),this.polyfillSafe=a.computePolyfillSafe(),this.addEventListener("place-holder-replace",this.replacePlaceholder.bind(this)),this.addEventListener("focusin",this._focusIn.bind(this)),this.addEventListener("mousemove",this._mouseMove.bind(this)),this.addEventListener("mouseleave",this._mouseLeave.bind(this)),this.addEventListener("touchstart",this._mouseMove.bind(this),{passive:!0}),this.addEventListener("mousedown",this._mouseDown.bind(this)),this.addEventListener("mouseup",this._mouseUp.bind(this)),this.addEventListener("dragenter",this.dragEnterBody.bind(this)),this.addEventListener("dragend",this.dragEndBody.bind(this)),this.addEventListener("drop",this.dropEvent.bind(this))}),0),n((()=>{this.editMode=s(a.editMode)})),n((()=>{this.elementAlign=s(a.elementAlign)})),n((()=>{this.trayStatus=s(a.trayStatus),this.trayDetail=s(a.trayDetail)})),n((()=>{this.activeNode=s(a.activeNode)})),n((()=>{s(a.activeEditingElement)}))}get isGridActive(){return a.isGridPlateElement(activeNode)}dragEndBody(e){this.__manageFakeEndCap(!1),a._lockContextPosition=!1,this.querySelectorAll(".hax-hovered").forEach((e=>{e.classList.remove("hax-hovered")}))}_mouseLeave(e){this.editMode&&a.ready&&(clearTimeout(this.__mouseQuickTimer),clearTimeout(this.__mouseTimer),this.__activeHover=null)}_mouseMove(e){}_mouseDown(e){if(this.editMode){this.__mouseDown=!0;let t=e.target;t.closest("[draggable]")?t=t.closest("[draggable]"):t.closest("[slot]")?t=t.closest("[slot]"):t.closest("[data-hax-ray]")?t=t.closest("[data-hax-ray]"):t.closest("[contenteditable]")?t=t.closest("[contenteditable]"):a.validTagList.includes(t.tagName.toLowerCase())||"HAX-BODY"===t.tagName||t.haxUIElement||console.warn(t),!t.haxUIElement&&this.__focusLogic(t)&&(e.stopPropagation(),e.stopImmediatePropagation())}}_mouseUp(e){setTimeout((()=>{this.__mouseDown=!1}),0),clearTimeout(y),this.__manageFakeEndCap(!1)}clickEvent(e){clearTimeout(y)}blurEvent(e){this.editMode&&a.activeEditingElement}__manageFakeEndCap(e=!0){if(e&&!this.__fakeEndCap){let e=document.createElement("fake-hax-body-end");e.style.width="100%",e.style.height="20px",e.style.zIndex="2",e.style.display="block",this.__fakeEndCap=e,this.haxMover=!0,this.appendChild(this.__fakeEndCap),this.__applyNodeEditableState(this.__fakeEndCap,!0)}else!e&&this.__fakeEndCap&&(this.__fakeEndCap.remove(),this.haxMover=!1,this.__fakeEndCap=null)}dragEnterBody(e){this.__manageFakeEndCap(!0)}render(){return e`
      <div
        id="bodycontainer"
        class="ignore-activation"
        element-align="${this.elementAlign||"right"}"
      >
        <slot id="body"></slot>
      </div>
      <absolute-position-behavior
        id="topcontext"
        fit-to-visible-bounds
        justify
        position="top"
        auto
        sticky
        data-node-type="${this.activeNode?this.viewSourceToggle?this.activeNode.parentNode.tagName:this.activeNode.tagName:""}"
        .target="${this.activeNode?this.viewSourceToggle?this.activeNode.parentNode:this.activeNode:document.body}"
        ?hidden="${!this.activeNode}"
      >
        <div id="topcontextmenu">
          <hax-plate-context
            id="platecontextmenu"
            class="hax-context-menu ignore-activation"
            .activeNode="${this.activeNode}"
            .trayDetail="${this.trayDetail}"
            .trayStatus="${this.trayStatus}"
            ?viewSource="${this.viewSourceToggle}"
            ?canMoveElement="${this.canMoveElement}"
          ></hax-plate-context>
          <hax-text-editor-toolbar
            id="textcontextmenu"
            class="hax-context-menu ignore-activation"
            .activeNode="${this.activeNode}"
            show="always"
          >
          </hax-text-editor-toolbar>
        </div>
      </absolute-position-behavior>
    `}static get properties(){return{...super.properties,allowLinkTarget:{type:Boolean},haxMover:{type:Boolean,attribute:"hax-mover",reflect:!0},editMode:{type:Boolean,reflect:!0,attribute:"edit-mode"},elementAlign:{type:String,reflect:!0,attribute:"element-align"},trayDetail:{type:String,reflect:!0,attribute:"tray-detail"},trayStatus:{type:String,reflect:!0,attribute:"tray-status"},activeNode:{type:Object},canMoveElement:{type:Boolean},viewSourceToggle:{type:Boolean,reflect:!0}}}firstUpdated(e){this.dispatchEvent(new CustomEvent("hax-register-body",{bubbles:!0,cancelable:!0,composed:!0,detail:this}));try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){console.warn(e)}this.contextMenus={text:this.shadowRoot.querySelector("#textcontextmenu"),plate:this.shadowRoot.querySelector("#platecontextmenu")},this.shadowRoot.querySelector("slot").addEventListener("mouseup",(e=>{this.editMode&&setTimeout((()=>{const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();try{const e=a.getRange();e.cloneRange&&(a._tmpRange=e.cloneRange())}catch(e){console.warn(e)}}),10)})),this.editMode=a.editMode,this.__tabTrap=!1,this.ready=!0,super.firstUpdated&&super.firstUpdated(e)}async updated(e){e.forEach((async(e,t)=>{"editMode"==t&&void 0!==e&&setTimeout((async()=>{this._editModeChanged(this[t],e),this[t]?(await this._activeNodeChanged(this.activeNode,null),this.activeNode.focus()):await this._activeNodeChanged(null,this.activeNode)}),0),"activeNode"==t&&this.ready&&await this._activeNodeChanged(this[t],e)})),super.updated&&super.updated(e)}connectedCallback(){super.connectedCallback(),this._observer=new MutationObserver((e=>{var t=!1;this.__ignoreActive||this.__dragMoving||this.undoStackIgnore||this.__fakeEndCap?this.undoStackIgnore&&e.forEach((e=>{e.addedNodes.length>0&&e.addedNodes.forEach((e=>{this._validElementTest(e)&&setTimeout((()=>{this.__applyNodeEditableState(e,this.editMode)}),0)}))})):e.forEach((e=>{if(e.addedNodes.length>0){for(var i of e.addedNodes)if(this._validElementTest(i)){if(!this.__delHit&&"BR"===i.tagName&&i.parentElement&&a.__validGridTags().includes(i.parentElement.tagName.toLowerCase())&&i===i.parentElement.childNodes[i.parentElement.childNodes.length-1]){let e=i.parentElement;if(i.remove(),e.childNodes.length>0){let t=e.childNodes[e.childNodes.length-1];t.textContent+="​",a._positionCursorInNode(t,t.length)}continue}if(this.__delHit=!1,"P"===i.tagName&&i.children.length>0&&"P"===i.children[0].tagName){g(i);continue}if("P"===i.tagName&&i.parentElement&&"P"===i.parentElement.tagName){g(i.parentElement);continue}if(null!=i.getAttribute("slot")&&i.parentElement===this){i.removeAttribute("slot");continue}if("LI"===i.tagName&&i.children.length>0&&"SPAN"===i.children[0].tagName){this.activeNode!==i.children[0]&&this.activeNode!==i||(this.activeNode=i),g(i.children[0]);continue}if("LI"===i.tagName&&i.parentElement&&!["UL","OL"].includes(i.parentElement.tagName)){g(i);continue}if("P"===i.tagName&&i.children.length>0&&["P","LI"].includes(i.children[0].tagName)){g(i.children[0]);continue}if(this.__slot&&(i.setAttribute("slot",this.__slot),this.__slot=null),this.__indentTrap)if("SPAN"===i.tagName)i.parentNode===this?this.haxChangeTagName(i,"p",!0):"LI"===i.parentNode.tagName&&(i.parentNode.innerHTML=i.textContent);else if("BR"===i.tagName){i.remove();continue}if(!this.editMode||"true"!=i.getAttribute("contenteditable")&&!0!==i.getAttribute("contenteditable")&&"contenteditable"!=i.getAttribute("contenteditable")||this.__applyNodeEditableState(i,!this.editMode),this.__applyNodeEditableState(i,this.editMode),a.isGridPlateElement(i)){let e=i.querySelectorAll("*");for(var o=0;o<e.length;o++)this._validElementTest(e[o])&&this.__applyNodeEditableState(e[o],this.editMode)}if(["H1","H2","H3","H4","H5","H6"].includes(i.tagName)&&null==i.getAttribute("id")&&i.setAttribute("id",d("header-")),this.___moveLock||t)this.___moveLock=!1;else if(t=!0,a.activeNode=i,"BR"===i.tagName){const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();const t=a.getRange();t.collapsed&&"BR"===this.activeNode.tagName&&this.activeNode.parentNode===t.commonAncestorContainer&&""===this.activeNode.innerText&&(a.activeNode=this.activeNode.parentNode)}}this.__indentTrap&&setTimeout((()=>{this.__indentTrap=!1}),0)}else this.ready&&this.editMode&&a.ready&&0===e.addedNodes.length&&e.removedNodes.length>0&&this.shadowRoot&&0===this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}).length&&setTimeout((()=>{0===this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}).length&&this.appendChild(document.createElement("p"))}),100)})),this.__ignoreActive&&(this.__ignoreActive=!1),a.haxTray.updateMap()})),this._observer.observe(this,{childList:!0,subtree:!0}),window.addEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),window.addEventListener("click",this.clickEvent.bind(this)),window.addEventListener("blur",this.blurEvent.bind(this)),window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keypress",this._onKeyPress.bind(this)),document.body.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.addEventListener("scroll",this._keepContextVisible.bind(this),{passive:!0}),window.addEventListener("resize",this._keepContextVisible.bind(this),{passive:!0})}disconnectedCallback(){window.removeEventListener("click",this.clickEvent.bind(this)),window.removeEventListener("blur",this.blurEvent.bind(this)),window.removeEventListener("keydown",this._onKeyDown.bind(this)),window.removeEventListener("keypress",this._onKeyPress.bind(this)),document.body.removeEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.removeEventListener("scroll",this._keepContextVisible.bind(this)),window.removeEventListener("resize",this._keepContextVisible.bind(this)),window.removeEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),this._observer.disconnect(),super.disconnectedCallback()}_keepContextVisible(e=null){this.editMode&&(clearTimeout(this.__contextVisibleLock),this.__contextVisibleLock=setTimeout((()=>{let e=!1;this.contextMenus.plate.classList.contains("hax-context-visible")&&(e=this.contextMenus.plate),e&&this.positionContextMenus()}),100))}_onKeyDown(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName&&this.getAttribute("contenteditable")){if(this.__dropActiveVisible(),this.__manageFakeEndCap(!1),null!=a.getSelection().anchorNode)switch(e.key){case"Z":case"z":e.ctrlKey&&(e.shiftKey?this.redo():this.undo(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation());break;case"Tab":a.isTextElement(this.activeNode)&&(e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.shiftKey?this._tabBackKeyPressed():this._tabKeyPressed());break;case"Enter":if(this.activeNode&&(this.__slot=this.activeNode.getAttribute("slot")),this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");this.keyboardShortCutProcess(e)}break;case"Backspace":case"Delete":this.__delHit=!0;break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":setTimeout((()=>{const e=a.getSelection();a._tmpSelection=e,a.haxSelectedText=e.toString();const t=a.getRange();t.commonAncestorContainer&&this.activeNode!==t.commonAncestorContainer&&"function"==typeof t.commonAncestorContainer.focus?"HAX-BODY"!==t.commonAncestorContainer.tagName&&this.__focusLogic(t.commonAncestorContainer,!1):t.commonAncestorContainer&&t.commonAncestorContainer.parentNode&&this.activeNode!==t.commonAncestorContainer.parentNode&&"function"==typeof t.commonAncestorContainer.parentNode.focus&&("HAX-BODY"!==t.commonAncestorContainer.parentNode.tagName?this.__focusLogic(t.commonAncestorContainer.parentNode,!1):this.__focusLogic(t.commonAncestorContainer,!1))}),0);break;default:setTimeout((()=>{if(this.activeNode&&"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");" "===e[e.length-1]&&this.keyboardShortCutProcess(e)}}),0)}}}keyboardShortCutProcess(e){if(a.keyboardShortcuts[e.replace(" ","")]){let t=h(a.keyboardShortcuts[e.replace(" ","")]);this.haxReplaceNode(this.activeNode,t),this.__focusLogic(t),"HR"===t.tagName&&this.haxInsert("p","",{})}else if("!"===e[0]){let t=e.replace("!","").replaceAll(/ /g,"");if(a.elementList[t]){let e,i=a.haxSchemaFromTag(t);e=i.gizmo.tag&&i.demoSchema&&i.demoSchema[0]?h(i.demoSchema[0]):document.createElement(t),this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e)}else a.toast(`${t} is not a valid tag`)}}_onKeyPress(e){let t=this.activeNode&&this.activeNode.nextElementSibling?this.activeNode.nextElementSibling:null;t&&"Enter"===e.key&&this.setActiveNode(this.activeNode.nextElementSibling),setTimeout((()=>{this.activeNode&&this.activeNode===t&&this.editMode&&this.activeNode.previousElementSibling&&this.haxInsert("p","",{},this.activeNode.previousElementSibling)}),1)}setActiveNode(e){e&&this.editMode&&this.activeNode&&a.isTextElement(this.activeNode)&&(this.activeNode=e,clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout((()=>{this.__addActiveVisible(),this.positionContextMenus()}),2e3))}elementMidViewport(){const e=this.activeNode.getBoundingClientRect().y;return e<0&&e>-1*this.activeNode.offsetHeight+140}replacePlaceholder(e){if("text"===e.detail){let e=document.createElement("p");this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e),this.activeNode.parentNode&&this.activeNode.parentNode.setAttribute("contenteditable",!0)}else this.replaceElementWorkflow()}async canTansformNode(e=null){return await this.replaceElementWorkflow(e,!0).length>0}async insertElementWorkflow(e=null,t=!1){}get primitiveTextBlocks(){return["p","div","pre","h1","h2","h3","h4","h5","h6"]}getAllSlotConfig(e){return e||(e=this.getParentGrid(node)),e&&e.tag?this.getSlotConfig(a.elementList[e.tag],slot):void 0}getParentGrid(e){return((e=e||this.activeNode)?e.slot:void 0)?c(e.parentNode):void 0}getSlotConfig(e="",t={}){let i=t.settings,o=i?Object.keys(i||{}).map((t=>i[t].filter((t=>!(!t.slot||e&&t.slot!==e))))).flat():void 0;return o&&o.length>0?o[0]:void 0}async replaceElementWorkflow(e=null,t=!1){null==e&&(e=this.activeNode);let i=await c(e,null);if(!i)return;let o="*",n=!1,s=(e||{}).slot,r=this.getParentGrid(e);"place-holder"===i.tag&&void 0!==i.properties.type?(o=i.properties.type,n=!0):this.primitiveTextBlocks.includes(i.tag)&&(n=!0);var l=i.content?{innerHTML:i.content}:{};if(void 0!==a.elementList[i.tag]&&!1!==a.elementList[i.tag].gizmo&&void 0!==a.elementList[i.tag].gizmo.handles&&a.elementList[i.tag].gizmo.handles.length>0){let e=a.elementList[i.tag].gizmo;for(var d=0;d<e.handles.length;d++)for(var h in i.properties.innerHTML&&(l.innerHTML=i.properties.innerHTML),e.handles[d])"type"!==h&&void 0!==i.properties[e.handles[d][h]]&&(l[h]=i.properties[e.handles[d][h]])}let u=a.guessGizmo(o,l,n),m=r?this.getSlotConfig(s,a.elementList[r.tag]):void 0,g=r&&"grid-plate"===r.tag?["grid-plate"]:m?m.excludedSlotWrappers:void 0,v=m?m.allowedSlotWrappers:void 0;if((g||v)&&(u=u.filter((e=>!g.includes(e.tag)&&(!v||v.includes(e.tag))))),u.length>0){let i=e.tagName.toLowerCase(),o=i.replace("-"," ");void 0!==a.elementList[i]&&!1!==a.elementList[i].gizmo&&(o=a.elementList[i].gizmo.title),t||(a.activePlaceHolder=this.activeNode,a.haxAppPicker.presentOptions(u,"__convert",`Change ${o} to...`,"gizmo"))}else t||a.toast("Sorry, this can not be transformed!",5e3);return u}_haxStorePropertyUpdated(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&(this[e.detail.property]=e.detail.value)}haxClearBody(e=!0){let t=!0;e&&(t=prompt("Are you sure you want to delete all content?")),t&&l(this)}haxInsert(e,t,i={},o=this.activeNode,n=!1){var s=document.createElement(e);s.innerHTML=t;const r=s.cloneNode(!0);for(var l in i){let e=u(l);i.hasOwnProperty(l)&&(!0===i[l]?r.setAttribute(e,e):!1===i[l]?r.removeAttribute(e):null!=i[l]&&i[l].constructor===Array||null!=i[l]&&i[l].constructor===Object?r.properties&&r.properties[l].readOnly||(r.set?r.set(e,i[l]):r[e]=i[l]):r.setAttribute(e,i[l]))}return null!==a.activePlaceHolder&&void 0!==a.activePlaceHolder.style?(r.style.width=a.activePlaceHolder.style.width,r.style.float=a.activePlaceHolder.style.float,r.style.margin=a.activePlaceHolder.style.margin,r.style.display=a.activePlaceHolder.style.display,this.haxReplaceNode(a.activePlaceHolder,r),a.activePlaceHolder=null):o&&o.parentNode?this.__isLayout(o.parentNode)?(null!=o.getAttribute("slot")&&r.setAttribute("slot",o.getAttribute("slot")),this.__addAbove?o.parentNode.insertBefore(r,o):o.parentNode.insertBefore(r,o.nextElementSibling)):o.parentNode&&o.parentNode.nextElementSibling?o.parentNode.nextElementSibling.parentNode.insertBefore(r,o.parentNode.nextElementSibling):o.parentNode&&o.nextElementSibling?this.__addAbove?o.parentNode.insertBefore(r,o):o.parentNode.insertBefore(r,o.nextElementSibling):o.parentNode&&o.parentNode.children[o.parentNode.children.length-1]===o?this.__addAbove?o.parentNode.insertBefore(r,o):o.parentNode.appendChild(r):o.parentNode?o.parentNode.insertBefore(r,o):this.appendChild(r):this.appendChild(r),this.contextMenus.text.hasSelectedText=!1,setTimeout((()=>{this.__focusLogic(r),this.scrollHere(r)}),0),r}async haxToContent(){this.hideContextMenus();var e=this.activeNode;a.activeNode=null;let t="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];for(var i="",o=0;o<t.length;o++)if(this._validElementTest(t[o]))this.__applyDragDropState(t[o],!1),t[o].classList.remove("hax-hovered"),t[o].contentEditable=!1,i+=await a.nodeToContent(t[o]),this.__isLayout(t[o])&&this._applyContentEditable(this.editMode,t[o]);else if(8===t[o].nodeType)i+="\x3c!-- "+t[o].textContent+" --\x3e";else if(t[o].haxUIElement&&t[o].children&&t[o].children[0]){let e=await a.runHook(t[o],"activeElementChanged",[this.activeNode,!1]);e&&e!==t[o]?i+=await a.nodeToContent(e):i+=await a.nodeToContent(t[o].children[0])}else 1!==t[o].nodeType&&void 0!==t[o].textContent&&"undefined"!==t[o].textContent?i+=t[o].textContent:console.warn(t[o]);if(i=(i=(i=(i=i.replace(/\scontenteditable=\"false\"/g,"")).replace(/\scontenteditable/g,"")).replace(/\sdraggable/g,"")).replace(/\sdata-hax-ray=\".*?\"/g,""),this.parentNode.tagName){let e=this.parentNode.tagName.toLowerCase(),t="style-scope "+e+" x-scope",n=new RegExp(t,"g");i=i.replace(n,""),t="style-scope "+e,n=new RegExp(t,"g"),i=i.replace(n,""),t="x-scope "+e+"-0",n=new RegExp(t,"g"),i=i.replace(n,"");let s=a.validTagList;for(var o in s)t="style-scope "+s[o],n=new RegExp(t,"g"),i=i.replace(n,""),t="x-scope "+s[o]+"-0 ",n=new RegExp(t,"g"),i=i.replace(n,""),t="x-scope "+s[o]+"-0",n=new RegExp(t,"g"),i=i.replace(n,"")}return i=(i=i.replace(/\sclass=\"\"/g,"")).replace(/\sclass=\"\s\"/g,""),this._applyContentEditable(this.editMode),a.activeNode=e,i=r(i)}async haxDuplicateNode(e){let t=await c(e,null);a.elementList[e.tagName.toLowerCase()];a.testHook(e,"preProcessInsertContent")&&(t=await a.runHook(e,"preProcessInsertContent",[t])),t.content==t.properties.innerHTML&&delete t.properties.innerHTML;var i=h({tag:t.tag,content:t.content,properties:t.properties});return"webview"===i.tagName.toLowerCase()&&a._isSandboxed&&void 0!==i.guestinstance&&delete i.guestinstance,null!==e?e.parentNode.insertBefore(i,e.nextSibling):e.parentNode.appendChild(i),a.activeNode=i,!0}hideContextMenus(e=!0){clearTimeout(y),clearTimeout(this.__contextVisibleLock),clearTimeout(this.__positionContextTimer),this._hideContextMenu(this.contextMenus.text),this.__activeHover=null,e&&this._hideContextMenu(this.contextMenus.plate)}positionContextMenus(e=this.activeNode){if(e&&e.tagName&&this.ready){let t=e.tagName.toLowerCase();a.elementList&&a.elementList[t]&&a.elementList[t].contentEditable?e.setAttribute("contenteditable",!0):e.removeAttribute("contenteditable"),clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout((()=>{if(!a._lockContextPosition){let t=e.tagName.toLowerCase();a._isSandboxed&&"webview"===t&&(t="iframe");let i=a.elementList[t];e?this._showContextMenu(this.contextMenus.plate):this._hideContextMenu(this.contextMenus.plate),void 0===i||a.isTextElement(e)?this._showContextMenu(this.contextMenus.text):(this._hideContextMenu(this.contextMenus.text),i.element=e);(i||{}).gizmo;let o=i&&i.gizmo&&(i.gizmo.handles||[]).filter((e=>"inline"===(e||{}).type)).length>0;i&&"core"!=i.editingElement?setTimeout((()=>{(e&&e.parentNode||!o)&&(this.canMoveElement=!0)}),250):this.activeNode&&("LI"===this.activeNode.tagName||this._HTMLInlineTextDecorationTest(this.activeNode))?this.canMoveElement=!1:this.canMoveElement=!0}}),50)}}__addActiveVisible(){for(var e in this.contextMenus)("add"!=e||this.__activeHover)&&this.contextMenus[e].classList.add("hax-context-menu-active")}__dropActiveVisible(){for(var e in this.contextMenus)this.contextMenus[e].classList.remove("hax-context-menu-active");this.__activeHover=null}haxMoveGridPlate(e,t=1){this.___moveLock=!0;let i=e?e.parentNode:void 0,o=t>0?e.nextElementSibling:e.previousElementSibling,a=this.__layoutSlots(i)||[],n=e.getAttribute("slot"),s=n?a.indexOf(n):-1,r=a[s+t];!o||n&&o.getAttribute("slot");return!o||n&&n!==o.getAttribute("slot")?r?e.setAttribute("slot",r):e&&i&&i!==this&&(o=t>0?i.nextElementSibling:i,r=i.getAttribute("slot"),o&&(i.parentNode.insertBefore(e,o),r&&e.setAttribute("slot",r))):i.insertBefore(e,t>0?o.nextElementSibling:o),this.scrollHere(e),this.positionContextMenus(e),!0}async haxGridPlateOps(e=!0,t="right",i=this.activeNode){let o=!1;if("GRID-PLATE"===i.tagName){if(e)switch(i.layout){case"1":i.layout="1-1",o=!0;break;case"1-1":i.layout="1-1-1",o=!0;break;case"1-1-1":i.layout="1-1-1-1",o=!0;break;case"1-1-1-1":i.layout="1-1-1-1-1",o=!0;break;case"1-1-1-1-1":i.layout="1-1-1-1-1-1",o=!0}else switch(i.layout){case"1-1":let e;await i.childNodes.forEach((t=>{t.tagName&&(e=t.cloneNode(!0),i.getAttribute("slot")?e.setAttribute("slot",i.getAttribute("slot")):e.removeAttribute("slot"),i.parentNode.insertBefore(e,i))})),a.activeNode=e,setTimeout((()=>{i.remove()}),0),o=!0;break;case"1-1-1":i.layout="1-1",o=!0;break;case"1-1-1-1":i.layout="1-1-1",o=!0;break;case"1-1-1-1-1":i.layout="1-1-1-1",o=!0;break;case"1-1-1-1-1-1":i.layout="1-1-1-1-1",o=!0}if(o){let e=this.contextMenus.plate.shadowRoot.querySelector("#right"),o=this.contextMenus.plate.shadowRoot.querySelector("#rightremove");e.disabled=!1,o.disabled=!1,"1-1-1-1-1-1"==i.layout&&(e.disabled=!0),"left"==t&&i.childNodes.forEach((e=>{if(e.tagName){let t=parseInt(e.getAttribute("slot").replace("col-",""),10)+1;e.setAttribute("slot",`col-${t}`)}}))}}else{let e=document.createElement("grid-plate");e.layout="1-1",e.disableResponsive=!0,i.getAttribute("slot")&&e.setAttribute("slot",i.getAttribute("slot"));let o="2";"right"==t&&(o="1");let a=i.cloneNode(!0);a.setAttribute("slot","col-"+o),e.appendChild(a),i.parentNode.insertBefore(e,i),setTimeout((()=>{i.remove()}),0)}await a.refreshActiveNodeForm()}haxReplaceNode(e,t){try{null==e&&(e=this.__oldActiveNode),!e.replaceWith&&a._tmpRange&&(e=a._tmpRange,a._tmpRange=null),e&&e.getAttribute&&null!=e.getAttribute("slot")&&t.setAttribute("slot",e.getAttribute("slot")),e.replaceWith(t)}catch(e){console.warn(e)}return t}haxChangeTagName(e,t,i=!0){for(var o=document.createElement(t),a=0,n=e.attributes.length;a<n;++a){let t=e.attributes.item(a).nodeName,i=e.attributes.item(a).value;try{o.setAttribute(t,i)}catch(t){console.warn(e.attributes),console.warn(t)}}i&&(o.innerHTML=e.innerHTML.trim()),"ul"==t||"ol"==t?"<br />"==o.innerHTML?o.innerHTML="<li><br /></li>":"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()&&(o.innerHTML="<li>"+e.innerHTML.trim().replace(/<br\/>/g,"</li>\n<li>").replace(/<br>/g,"</li>\n<li>")+"</li>"):"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()||(o.innerHTML=o.innerHTML.replace(/<ul>/g,"").replace(/<\/ul>/g,"").replace(/<li><\/li>/g,"").replace(/<li>/g,"").replace(/<\/li>/g,"<br/>"));try{e.replaceWith(o),i&&setTimeout((()=>{let e=o.children;e[0]&&e.tagName?e[0].focus():o.focus()}),10)}catch(t){console.warn(t),console.warn(o),console.warn(e)}return o}haxDeleteNode(e){if(e.previousElementSibling)a.activeNode=e.previousElementSibling;else if(e.nextElementSibling)a.activeNode=e.nextElementSibling;else{this.haxInsert("p","",{});try{var t=document.createRange(),i=a.getSelection();t.setStart(this.activeNode,0),t.collapse(!0),i.removeAllRanges(),i.addRange(t),this.activeNode.focus()}catch(e){console.warn(e)}}try{return e.remove()}catch(e){console.warn(e)}}importContent(e,t=!0){t&&l(this,"*"),setTimeout((()=>{e=r(e);let t=document.createElement("div");for(t.insertAdjacentHTML("beforeend",e);null!==t.firstChild;)if(void 0!==t.firstChild.tagName)if(a._isSandboxed&&"iframe"===t.firstChild.tagName.toLowerCase()){for(var i=document.createElement("webview"),o=0,n=t.firstChild.attributes.length;o<n;++o){var s=t.firstChild.attributes.item(o).nodeName,l=t.firstChild.attributes.item(o).value;"height"!==s&&"width"!==s||i.style[s],i.setAttribute(s,l)}this.appendChild(i)}else this.appendChild(t.firstChild);else t.removeChild(t.firstChild)}),0)}sortGridSlots(e=this.activeNode){let t=a.haxSchemaFromTag(e.tagName);"grid"===t.type&&("GRID-PLATE"===e.tagName?e.layout.split("-").map(((e,t)=>`col-${t}`)):a.slotsFromSchema(t).map((e=>e.slot))).reverse().forEach(((t,i)=>{0==i?e.querySelectorAll(`[slot=${t}]`).forEach((t=>e.append(t))):[...e.querySelectorAll(`[slot=${t}]`)].reverse().forEach((t=>e.insertBefore(t,e.firstChild)))}))}async _haxContextOperation(e){let t=e.detail,i=p(e),o=i&&i[0]?i[0].getAttribute("data-slot"):void 0;switch(t.eventName){case"insert-above-active":if(this.activeNode&&this.activeNode.previousElementSibling)this.haxInsert("p","",{},this.activeNode.previousElementSibling);else{let e=document.createElement("p");this.insertBefore(e,this.activeNode)}break;case"insert-below-active":this.haxInsert("p","",{});break;case"move-to-slot":o&&this.activeNode&&a.isGridPlateElement(this.activeNode.parentNode)&&(this.activeNode.slot=o,this.sortGridSlots(this.activeNode.parentNode));break;case"insert-into-active":if(o&&this.activeNode&&a.isGridPlateElement(this.activeNode)){let e=document.createElement("p");e.slot=o,this.activeNode.append(e),this.haxInsert("p","",{slot:o},e),e.remove(),this.sortGridSlots()}break;case"select-parent-grid":if(this.activeNode&&this.activeNode.parentNode&&a.isGridPlateElement(this.activeNode.parentNode)){let e=this.activeNode.parentNode;this.setActiveNode(e),this.positionContextMenus(e)}break;case"hax-source-view-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let e=await a.runHook(a.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),t=a.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),t.saveOptions&&t.saveOptions.unsetAttributes&&t.saveOptions.unsetAttributes.length)for(var n in t.saveOptions.unsetAttributes)e.removeAttribute(t.saveOptions.unsetAttributes[n]);this.__applyNodeEditableState(e,this.editMode),g(a.activeEditingElement),a.activeEditingElement=null,this.viewSourceToggle=!1}else this.activeNode.__haxSourceView=!0,a.activeEditingElement=document.createElement("code-editor"),a.activeEditingElement.language="html",a.activeEditingElement.title="",a.activeEditingElement.theme="vs",a.activeEditingElement.fontSize=12,a.activeEditingElement.wordWrap=!0,this.viewSourceToggle=!0,import("../code-editor/code-editor.js"),this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.__applyDragDropState(this.activeNode,!1),this.activeNode.classList.remove("hax-active"),a.testHook(this.activeNode,"preProcessNodeToContent")&&(this.activeNode=await a.runHook(this.activeNode,"preProcessNodeToContent",[this.activeNode])),m(this.activeNode,a.activeEditingElement),a.activeEditingElement.focus();break;case"hax-full-text-editor-toggle":if(this.activeNode.__haxSourceView){this.activeNode.__haxSourceView=!1;let e=await a.runHook(a.activeEditingElement,"activeElementChanged",[this.activeNode,!1]),t=a.haxSchemaFromTag(this.activeNode.tagName.toLowerCase());if(this.activeNode&&this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),t.saveOptions&&t.saveOptions.unsetAttributes&&t.saveOptions.unsetAttributes.length)for(var n in t.saveOptions.unsetAttributes)e.removeAttribute(t.saveOptions.unsetAttributes[n]);this.__applyNodeEditableState(e,this.editMode),g(a.activeEditingElement),a.activeEditingElement=null,this.viewSourceElement=a.activeEditingElement}else this.activeNode.__haxSourceView=!0,import("../rich-text-editor/rich-text-editor.js").then((()=>{a.activeEditingElement=document.createElement("rich-text-editor"),a.activeEditingElement.type="rich-text-editor-toolbar-full",this.activeNode.getAttribute&&null!=this.activeNode.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",this.activeNode.getAttribute("slot")),this.__ignoreActive=!0,this.activeNode.removeAttribute("contenteditable"),this.__applyDragDropState(this.activeNode,!1),this.activeNode.classList.remove("hax-active"),m(this.activeNode,a.activeEditingElement),this.viewSourceElement=a.activeEditingElement}));break;case"text-tag":a.activeNode=this.haxChangeTagName(this.activeNode,t.value),this.positionContextMenus();break;case"text-tag-ul":this.contextMenus.text.realSelectedValue="ul",a.activeNode=this.haxChangeTagName(this.activeNode,"ul"),this.positionContextMenus();break;case"text-tag-ol":this.contextMenus.text.realSelectedValue="ol",a.activeNode=this.haxChangeTagName(this.activeNode,"ol"),this.positionContextMenus();break;case"text-align-left":this.activeNode.style.textAlign=null;break;case"hax-transform-node":this.replaceElementWorkflow();break;case"hax-plate-create-right":this.haxGridPlateOps();break;case"hax-plate-remove-right":this.haxGridPlateOps(!1);break;case"hax-plate-duplicate":this.haxDuplicateNode(this.activeNode);break;case"hax-plate-delete":null!=this.activeNode&&this.haxDeleteNode(this.activeNode);break;case"hax-plate-up":this.haxMoveGridPlate(this.activeNode,-1);break;case"hax-plate-down":this.haxMoveGridPlate(this.activeNode);break;case"content-edit":"content-edit"===a.haxTray.trayDetail&&(a.haxTray.collapsed=!a.haxTray.collapsed),a.haxTray.trayDetail="content-edit"}}_focusIn(e){this.__mouseDown||this.__focusLogic(e.target)&&(e.stopPropagation(),e.stopImmediatePropagation())}__focusLogic(e,t=!0){let i=!1;if(this.editMode&&!this.__tabTrap){let o=e;"SPAN"===o.tagName&&a.isTextElement(o.parentNode)&&""==o.parentNode.getAttribute("slot")&&(o=e.parentNode);let n=null;if(this._validElementTest(o)&&o.parentNode&&o.parentNode.tagName){if("P"===o.parentNode.tagName&&""==o.parentNode.getAttribute("slot"))n=o,i=!0;else{for(;o.parentNode&&o.parentNode.tagName&&"HAX-BODY"!=o.parentNode.tagName;)null===n&&"B"!==o.tagName&&"I"!==o.tagName&&"STRONG"!==o.tagName&&"EM"!==o.tagName&&(n=o),o=o.parentNode;null===n?n=o:a.isGridPlateElement(o)||(n=o)}(this.activeNode&&this.activeNode.parentNode!==o&&!o.classList.contains("ignore-activation")||o.haxUIElement||o.classList.contains("ignore-activation"))&&(i=!0),n.haxUIElement||n.classList.contains("ignore-activation")||(a.activeNode=n,this.activeNode=n,setTimeout((()=>{if(t&&!this.__mouseDown&&a.isTextElement(n))try{var e=document.createRange(),i=a.getSelection();e.setStart(this.activeNode,0),e.collapse(!0),i.removeAllRanges(),i.addRange(e),this.activeNode.focus()}catch(e){console.warn(e)}this.positionContextMenus(n)}),0),i=!0)}}else this.__tabTrap=!1;return i}scrollHere(e){setTimeout((()=>{"function"==typeof e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded(!0):e.scrollIntoView({behavior:"smooth",inline:"center",block:"nearest"})}),0)}undo(){super.undo(),setTimeout((()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()}),0)}redo(){super.redo(),setTimeout((()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()}),0)}async _editModeChanged(e,t){if(void 0!==t){if(this._applyContentEditable(e),e)if(this.children&&this.children[0]&&this.children[0].focus)this.__focusLogic(this.children[0]);else{this.haxInsert("p","",{});try{var i=document.createRange(),o=a.getSelection();i.setStart(this.activeNode,0),i.collapse(!0),o.removeAllRanges(),o.addRange(i),this.activeNode.focus()}catch(e){console.warn(e)}}setTimeout((()=>{this.undoStack.undoStackLimit=50,this.undoStack.undoStackPosition=-1,this.undoStack.commands=[],this.undoStack.changed(),this.undoStackInitialValue=this.innerHTML,this.undoStackPrevValue=this.undoStackInitialValue}),0)}if(0==e){g(a.activeEditingElement),a.activeEditingElement=null,this.removeAttribute("contenteditable"),this.hideContextMenus();let e=this.querySelectorAll("[contenteditable],.hax-active");for(var n=0;n<e.length;n++){let t=e[n];t.removeAttribute("contenteditable"),t.classList.remove("hax-active")}}let s="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];0===s.length&&(s=this.shadowRoot.querySelector("#body").children);for(n=0;n<s.length;n++)await a.runHook(s[n],"editModeChanged",[e])}_haxResolvePreviousElement(e){for(e=e.previousElementSibling;null!=e&&void 0!==e.tagName&&"HAX-"===e.tagName.substring(0,4);)e=e.previousElementSibling;return e}_validElementTest(e){return!(e.haxUIElement||!e.tagName||["TEMPLATE","HAX-BODY","RICH-TEXT-EDITOR-CLIPBOARD","RICH-TEXT-EDITOR-PROMPT","RICH-TEXT-EDITOR-HIGHLIGHT","HAX-APP-SEARCH-RESULT","FAKE-HAX-BODY-END"].includes(e.tagName))&&(!this._HTMLInlineTextDecorationTest(e)||"HAX-BODY"==e.parentNode)}_HTMLInlineTextDecorationTest(e){return["span","b","strong","i","em",...Object.keys(window.HaxTextEditorToolbarConfig.inlineGizmos||{})].includes(e.tagName.toLowerCase())}_HTMLPrimativeTest(e){return null!=e&&void 0!==e.tagName&&-1==e.tagName.indexOf("-")}_applyContentEditable(e,t=this.shadowRoot.querySelector("#body")){let i="slot"===t.localName?t.assignedNodes({flatten:!0}):[];0===i.length&&(i=t.children);for(var o=0;o<i.length;o++)if(this._validElementTest(i[o])&&(!e||!0!==i[o].getAttribute("contenteditable")&&"true"!=i[o].getAttribute("contenteditable")&&"contenteditable"!=i[o].getAttribute("contenteditable"))&&this.__applyNodeEditableState(i[o],e),a.isGridPlateElement(i[o])){let t=i[o].querySelectorAll("*");for(var n=0;n<t.length;n++)this._validElementTest(t[n])&&this.__applyNodeEditableState(t[n],e)}}__layoutDropEvent(e,t){[...t.querySelectorAll(".active")].forEach((e=>{e.classList.remove("active")})),[...t.shadowRoot.querySelectorAll(".active")].forEach((e=>{e.classList.remove("active")}))}__layoutDragEnter(e){e.target.classList.add("active")}__layoutDragLeave(e){e.target.classList.remove("active")}__layoutMonitor(e){var t=p(e);t[0]&&t[0].assignedNodes&&t[0].assignedNodes().length?t[0].parentNode.classList.add("has-nodes"):t[0].parentNode.classList.remove("has-nodes")}__getLayoutOrder(e,t){if(!t.shadowRoot)return!1;let i=e.getAttribute("slot"),o=t.shadowRoot.querySelector(`[slot=${i}]`);return[...t.shadowRoot.querySelectorAll("[data-layout-slotname]")].indexOf(o)||-1}__layoutCanMove(e,t,i){if(!t.shadowRoot)return!1;let o=t.shadowRoot.querySelector(`[slot=${slot}]`),a=[...t.shadowRoot.querySelectorAll("[data-layout-slotname]")],n=(a.indexOf(o)||-1)+(i?-1:1);return n>=a[0]&&n<=a[a.length-1]}__layoutMove(e,t,i){if(!t.shadowRoot)return!1;let o=t.shadowRoot.querySelector(`[slot=${s}]`),a=[...t.shadowRoot.querySelectorAll("[data-layout-slotname]")],n=a.indexOf(o)||-1,s=a[n+(i?-1:1)];s&&e.setAttribute("slot",s)}async __sortLayoutChildren(e){e.setAttribute("hax-layout-sorting",!0);try{let t=Array.prototype.reduce.call(e.querySelectorAll("[slot]"),(function(e,t){return e}),[]);t=t.sort((function(t,i){return this.__getLayoutOrder(t,e)<this.__getLayoutOrder(i,e)?-1:1})),await t.forEach((t=>{t.parentNode===this&&e.appendChild(t)}))}catch(e){console.warn(e)}e.removeAttribute("hax-layout-sorting")}__layoutSlotValid(e,t){return this.__layoutSlots(t).includes(e.getAttribute("slot"))}__layoutSlots(e){return e.shadowRoot?[...e.shadowRoot.querySelectorAll("[data-layout-slotname]")].map((e=>e.getAttribute("data-layout-slotname"))):[]}__applyDragDropState(e,t){let i={drop:t=>this.__layoutDropEvent.bind(this)(t,e),dragenter:this.__layoutDragEnter.bind(this),dragleave:this.__layoutDragEnter.bind(this),slotchange:this.__layoutMonitor.bind(this)};if(e.setAttribute("data-hax-layout",!0),a.isGridPlateElement(e)&&e.setAttribute("data-hax-grid",!0),t&&e.setAttribute("data-hax-ray",t),t&&e.shadowRoot){e.addEventListener("drop",i.drop);let t=[...e.shadowRoot.querySelectorAll("drag-enabled")],o=[...e.shadowRoot.querySelectorAll("slot")];t.forEach((e=>{e.addEventListener("dragenter",i.dragenter),e.addEventListener("dragleave",i.dragleave)})),o.forEach((e=>e.addEventListener("slotchange",i.slotchange))),e.haxLayoutObserver=new MutationObserver((t=>{e.getAttribute("hax-layout-sorting")||(t.forEach((t=>{t.addedNodes.forEach((t=>{t.tagName&&t!==this&&t.parentElement&&"HAX-BODY"!==t.parentElement.tagName&&!this.__layoutSlotValid(t,e)&&this.__layoutSlots(e).length>0&&t.setAttribute("slot",this.__layoutSlots(e)[0])}))})),this.__sortLayoutChildren(e))})),e.haxLayoutObserver.observe(this,{childList:!0})}else if(e.shadowRoot){e.haxLayoutObserver&&e.haxLayoutObserver.disconnect(),this.removeEventListener("drop",i.drop);let t=[...e.shadowRoot.querySelectorAll("drag-enabled")],o=[...e.shadowRoot.querySelectorAll("slot")];t.forEach((e=>{e.removeEventListener("dragenter",i.dragenter),e.removeEventListener("dragleave",i.dragleave)})),o.forEach((e=>e.removeEventListener("slotchange",i.slotchange))),e.removeAttribute("data-hax-ray")}}__isLayout(e){return e&&a.haxSchemaFromTag(e.tagName)&&"grid"===a.haxSchemaFromTag(e.tagName).type}__applyNodeEditableState(e,t=!0){let i;if(!e.tagName)return!1;let o=e.tagName.replace("-"," ").toLowerCase(),n=s(a.gizmoList).findIndex((t=>{if(t)return t.tag===e.tagName.toLowerCase()}));if(-1!==n&&(o=s(a.gizmoList)[n].title),"IMG"==e.tagName&&e.setAttribute("draggable",!1),t?(this.__applyDragDropState(e,o),i="addEventListener"):(this.__applyDragDropState(e,!1),i="removeEventListener"),e[i]("drop",this.dropEvent.bind(this)),e[i]("dragenter",this.dragEnter.bind(this)),e[i]("dragleave",this.dragLeave.bind(this)),e[i]("dragover",(e=>{this.__dragMoving=!0,e.preventDefault()})),this._HTMLPrimativeTest(e)&&(t?e.setAttribute("contenteditable",t):e.removeAttribute("contenteditable"),e.querySelectorAll("a").length>0)){let o=e.querySelectorAll("a");for(var r=0,l=o.length;r<l;r++)t?o[r].setAttribute("contenteditable",t):o[r].removeAttribute("contenteditable"),o[r][i]("click",(e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}))}}undoManagerStackLogic(e){this.__dragMoving||(this.querySelectorAll(".hax-hovered").forEach((e=>{e.classList.remove("hax-hovered")})),super.undoManagerStackLogic(e))}dropEvent(e){if(this.editMode){this.__dragMoving=!1,this.undoManagerStackLogic({}),clearTimeout(y),a._lockContextPosition=!1,a.haxTray.activeTab="item-1";var t,i=null,o=p(e);o[0];i=e.target.closest("[data-hax-layout]")&&e.target.parentNode!=e.target.closest("[data-hax-layout]")?e.target.closest("[data-hax-layout]"):e.target.closest("[contenteditable],img")?e.target.closest("[contenteditable],img"):e.originalTarget?e.originalTarget:e.target,o[0].classList.contains("column")?this.__slot=o[0].getAttribute("id").replace("col","col-"):i.getAttribute("slot")&&(this.__slot=i.getAttribute("slot")),a.activeNode=i,this.querySelectorAll(".hax-hovered").forEach((e=>{e.classList.remove("hax-hovered")})),this.querySelectorAll(".active").forEach((e=>{e.classList.remove("active")}));try{if(e.dataTransfer&&e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let i=document.createElement("p");e.target.closest("[data-hax-layout]")&&e.target.parentNode!=e.target.closest("[data-hax-layout]")?t=e.target.closest("[data-hax-layout]"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&(t.tagName&&"HAX-BODY"!==t.tagName||!t.getAttribute("data-hax-layout"))||this.__isLayout(o[0])?(t.getAttribute("slot")?i.setAttribute("slot",t.getAttribute("slot")):o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):i.removeAttribute("slot"),t.parentNode.insertBefore(i,t)):(o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):t&&"HAX-BODY"===t.tagName&&i.getAttribute("slot")&&i.removeAttribute("slot"),t?t.appendChild(i):this.appendChild(i)),e.placeHolderElement=i,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}else{if(i=a.__dragTarget,t=e.target,e.target.closest("[data-hax-layout]")&&e.target.parentNode!=e.target.closest("[data-hax-layout]")?t=e.target.closest("[data-hax-layout]"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&i&&this._validElementTest(i)&&i!==t){try{"HAX-BODY"!==t.tagName&&!this.__isLayout(t)||this.__isLayout(o[0])?(t.getAttribute("slot")?i.setAttribute("slot",t.getAttribute("slot")):o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):i.removeAttribute("slot"),t.parentNode.insertBefore(i,t)):(o[0].classList.contains("column")?i.setAttribute("slot",o[0].getAttribute("id").replace("col","col-")):"HAX-BODY"===t.tagName&&i.getAttribute("slot")&&i.removeAttribute("slot"),t.appendChild(i))}catch(e){console.warn(e)}e.preventDefault(),e.stopPropagation()}i&&this._validElementTest(i)&&"function"==typeof i.focus&&(a.activeNode=i,this.dispatchEvent(new CustomEvent("hax-drop-focus-event",{bubbles:!0,cancelable:!0,composed:!0,detail:this.activeNode})),this.scrollHere(this.activeNode),this.positionContextMenus())}}catch(e){console.warn(e)}}a.__dragTarget=null,this.__manageFakeEndCap(!1)}dragEnter(e){this.editMode&&e.target&&a.__dragTarget&&(this.__dragMoving=!0,e.preventDefault(),e.target&&e.target.classList&&e.target.classList.add("hax-hovered"),this.handleMousemove(e))}handleMousemove(e){var t=e.clientX,i=e.clientY,o=document.documentElement.clientWidth,a=document.documentElement.clientHeight,n=a-200,s=o-200,r=t<200,l=t>s,d=i<200,c=i>n;if(r||l||d||c){var h=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.body.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth),u=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.body.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight),m=h-o,g=u-a;!function checkForWindowScroll(){clearTimeout(y),function adjustWindowScroll(){var e=window.pageXOffset,o=window.pageYOffset,a=o>0,h=o<g,u=e>0,v=e<m,p=e,b=o;if(r&&u){p-=25*((200-t)/200)}else if(l&&v){p+=25*((t-s)/200)}if(d&&a){b-=25*((200-i)/200)}else if(c&&h){b+=25*((i-n)/200)}return p=Math.max(0,Math.min(m,p)),b=Math.max(0,Math.min(g,b)),(p!==e||b!==o)&&(window.scrollTo(p,b),!0)}()&&(y=setTimeout(checkForWindowScroll,30))}()}else clearTimeout(y)}dragLeave(e){this.editMode&&e.target&&e.target.classList&&(this.__dragMoving=!0,e.target.classList.remove("hax-hovered"))}async _activeNodeChanged(e,t){if(window.SimplePopoverManager.requestAvailability().opened=!1,await this.querySelectorAll(".hax-active").forEach((e=>{e.classList.remove("hax-active")})),e&&t&&t.parentNode===e&&a.isGridPlateElement(e)&&(this.__ignoreActive=!0),this.editMode&&null!=e&&e.parentNode){let t=e.tagName.toLowerCase();e.classList.add("hax-active"),a.isTextElement(e)||"HR"===e.tagName||a.isGridPlateElement(e)?(e.setAttribute("contenteditable",!0),this.setAttribute("contenteditable",!0)):(e.removeAttribute("contenteditable"),this.removeAttribute("contenteditable")),this._keepContextVisible(),this.contextMenus.text.realSelectedValue=t}else null===e&&(this.hideContextMenus(),this.__oldActiveNode=t);if(this.editMode&&await a.runHook(t,"activeElementChanged",[t,!1])&&(this.__ignoreActive=!0),this.editMode&&await a.runHook(e,"activeElementChanged",[e,!0])&&(this.__ignoreActive=!0),this.editMode&&t){let e=a.haxSchemaFromTag(t.tagName.toLowerCase());if("core"!=e.editingElement||t.parentNode&&t.parentNode.haxUIElement&&t.parentNode===a.activeEditingElement){this.__ignoreActive=!0;let o=await a.runHook(a.activeEditingElement,"activeElementChanged",[t,!1]);if(o&&o!==t){if(t&&t.getAttribute&&null!=t.getAttribute("slot")&&o.setAttribute("slot",t.getAttribute("slot")),e.saveOptions&&e.saveOptions.unsetAttributes&&e.saveOptions.unsetAttributes.length)for(var i in e.saveOptions.unsetAttributes)o.removeAttribute(e.saveOptions.unsetAttributes[i]);this.__applyNodeEditableState(o,this.editMode)}g(a.activeEditingElement),a.activeEditingElement=null}}if(this.editMode&&e){let t=a.haxSchemaFromTag(e.tagName);if(t&&t.editingElement&&"core"!=t.editingElement){if(t.editingElement.import){let e=new URL("./../../",import.meta.url).href;await import(`${e}${t.editingElement.import}`)}a.activeEditingElement=document.createElement(t.editingElement.tag),e.getAttribute&&null!=e.getAttribute("slot")&&a.activeEditingElement.setAttribute("slot",e.getAttribute("slot")),t.editingElement.callback&&t.editingElement.callback(a.activeEditingElement),this.__ignoreActive=!0,m(e,a.activeEditingElement),await a.runHook(a.activeEditingElement,"activeElementChanged",[e,!0])}}}_getPosition(e){return{x:e.offsetLeft-e.scrollLeft+e.clientLeft,y:e.offsetTop-e.scrollTop+e.clientTop}}_showContextMenu(e){e.setAttribute("on-screen","on-screen"),e.classList.add("hax-context-visible","hax-context-menu-active")}_getContextContainer(e){let t=e&&e.parentNode?e.parentNode:void 0;return t&&t.nodeType?1==t.nodeType?t:t.host:void 0}_hideContextMenu(e){if(!e)return;let t=this._getContextContainer(e);e.removeAttribute("on-screen"),e.visible=!1,e.classList.remove("hax-context-visible","hax-context-menu-active"),t&&(t.menusVisible=!1)}_tabKeyPressed(){if(this.activeNode&&a.getRange().cloneRange)try{let t=!1,i=this.activeNode.parentNode;const o=this.activeNode.parentNode.tagName;let n=a.getRange().cloneRange();var e=n.commonAncestorContainer.tagName;if(void 0===e&&(e=n.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(o)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("indent"));else for(;!t;)null==i.nextSibling?t=!0:"function"===i.nextSibling.focus?(i.nextSibling.focus(),t=!0):i=i.nextSibling}catch(e){console.warn(e)}}_tabBackKeyPressed(){if(this.activeNode&&a.getRange().cloneRange)try{let t=this.activeNode.parentNode;const i=this.activeNode.parentNode.tagName;let o=a.getRange().cloneRange();var e=o.commonAncestorContainer.tagName;if(void 0===e&&(e=o.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(i)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("outdent"));else{if(null!=t)for(;null!=t&&!this._validElementTest(t);)t=t.previousSibling;null!=t&&setTimeout((()=>{t.focus()}),50)}}catch(e){console.warn(e)}}}window.customElements.define(HaxBody.tag,HaxBody);export{HaxBody};