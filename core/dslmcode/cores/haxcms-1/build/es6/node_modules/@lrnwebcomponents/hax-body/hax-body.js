import{html as e,css as t}from"../../lit-element/lit-element.js";import{SimpleColors as o}from"../simple-colors/simple-colors.js";import{encapScript as i,wipeSlot as a,generateResourceID as n,nodeToHaxElement as s,haxElementToNode as r,camelToDash as l}from"../utils/utils.js";import{UndoManagerBehaviors as d}from"../undo-manager/undo-manager.js";import{HAXStore as c}from"./lib/hax-store.js";import{autorun as h,toJS as u}from"../../mobx/dist/mobx.esm.js";var m=null;class HaxBody extends(d(o)){static get tag(){return"hax-body"}static get styles(){return[...super.styles,t`
        :host([edit-mode]),
        :host([edit-mode]) * ::slotted(*) {
          line-height: 1.8;
        }
        :host([edit-mode]) ul,
        :host([edit-mode]) ol {
          padding-left: 20px;
          margin-left: 20px;
        }
        :host([edit-mode]) ul {
          list-style-type: disc;
        }
        :host([edit-mode]) li {
          margin-bottom: 6px;
        }
        :host {
          display: block;
          position: relative;
          min-height: 32px;
          min-width: 32px;
          outline: none;
          --hax-contextual-action-text-color: var(
            --simple-colors-default-theme-grey-1,
            #fff
          );
          --hax-contextual-action-hover-color: var(
            --simple-colors-default-theme-grey-8,
            #009dc7
          );
          --hax-contextual-action-color: var(
            --simple-colors-default-theme-grey-12,
            #007999
          );
          --hax-body-editable-outline: 0px solid
            var(--simple-colors-default-theme-grey-4, #eeeeee);
          --hax-body-active-outline-hover: 1px solid
            var(--simple-colors-default-theme-grey-8, #eeeeee);
          --hax-body-active-outline: 0px solid
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          --hax-body-active-drag-outline: 1px solid
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          --hax-body-target-background-color: var(
            --simple-colors-default-theme-grey-11,
            #009dc7
          );
          --hax-body-possible-target-background-color: inherit;
        }
        #addincontext {
          opacity: 0.5;
          transition: 0.2s opacity ease-in-out;
        }
        #addincontext:hover,
        #addincontext:active,
        #addincontext:focus {
          opacity: 1;
        }
        .hax-context-menu {
          padding: 0;
          margin-left: -5000px;
          position: fixed;
          visibility: hidden;
          opacity: 0;
          z-index: 1000;
          float: left;
          display: block;
          pointer-events: none;
          transition: 0.2s top ease-in-out, 0.2s left ease-in-out;
        }
        #textcontextmenu.hax-context-menu {
          z-index: 1000;
        }
        .hax-context-visible {
          position: absolute;
          visibility: visible;
          pointer-events: all;
          opacity: 1;
        }
        .hax-context-menu-active {
          margin-left: unset;
        }
        :host([edit-mode]) #bodycontainer ::slotted(p) {
          min-height: var(--hax-base-styles-p-min-height, 1rem);
          font-size: var(--hax-base-styles-p-font-size);
          line-height: var(--hax-base-styles-p-line-height);
          letter-spacing: var(--hax-base-styles-p-letter-spacing);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a) {
          color: var(--hax-base-styles-a-color);
          font-size: var(
            --hax-base-styles-a-font-size,
            var(--hax-base-styles-p-font-size)
          );
          font-weight: var(--hax-base-styles-a-font-weight);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:visited) {
          color: var(--hax-base-styles-a-color-visited);
        }
        :host([edit-mode]) #bodycontainer ::slotted(a:active),
        :host([edit-mode]) #bodycontainer ::slotted(a:focus),
        :host([edit-mode]) #bodycontainer ::slotted(a:hover) {
          color: var(--hax-base-styles-a-color-active);
          font-weight: var(--hax-base-styles-a-font-weight-active);
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol),
        :host([edit-mode]) #bodycontainer ::slotted(ul),
        :host([edit-mode]) #bodycontainer ::slotted(li) {
          padding-bottom: var(--hax-base-styles-list-padding-bottom);
          line-height: var(
            --hax-base-styles-list-line-height,
            var(--hax-base-styles-p-line-height)
          );
          font-size: var(
            --hax-base-styles-list-font-size,
            var(--hax-base-styles-p-font-size)
          );
        }
        :host([edit-mode]) #bodycontainer ::slotted(ol > li:last-child),
        :host([edit-mode]) #bodycontainer ::slotted(ul > li:last-child) {
          padding-bottom: var(--hax-base-styles-list-last-child-padding-bottom);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img[contenteditable]) {
          max-width: 100%;
        }
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          outline: none;
          caret-color: var(--hax-color-text);
        }
        :host([edit-mode]) #bodycontainer ::slotted(*.blinkfocus) {
          outline: 4px solid var(--hax-contextual-action-hover-color);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not(grid-plate)[contenteditable]:hover) {
          outline: var(--hax-body-active-outline-hover);
          caret-color: #000000;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]:hover) {
          cursor: text !important;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*:not(grid-plate)[contenteditable] .hax-active:hover) {
          cursor: text !important;
          outline: var(--hax-body-active-outline-hover);
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(code.hax-active[contenteditable]) {
          display: block;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*.hax-active[contenteditable]) {
          outline: var(--hax-body-active-outline) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(hr[contenteditable]) {
          height: 2px;
          background-color: #eeeeee;
          padding-top: 4px;
          padding-bottom: 4px;
        }
        /** Fix to support safari as it defaults to none */
        :host([edit-mode]) #bodycontainer ::slotted(*[contenteditable]) {
          -webkit-user-select: text;
          cursor: pointer;
        }

        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::-moz-selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::-moz-selection) {
          background-color: var(
            --hax-body-highlight,
            var(--simple-colors-default-theme-yellow-2, yellow)
          );
          color: black;
        }
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable]::selection),
        :host([edit-mode])
          #bodycontainer
          ::slotted(*[contenteditable] *::selection) {
          background-color: var(
            --hax-body-highlight,
            var(--simple-colors-default-theme-yellow-2, yellow)
          );
          color: black;
        }
        #bodycontainer {
          -webkit-user-select: text;
          user-select: text;
        }
        :host([edit-mode][hax-ray-mode])
          #bodycontainer
          ::slotted(*[contenteditable]):before {
          content: attr(data-hax-ray) " " attr(resource) " " attr(typeof) " "
            attr(property) " " attr(content);
          font-size: 12px;
          line-height: 12px;
          left: unset;
          right: unset;
          top: unset;
          background-color: var(--simple-colors-default-theme-cyan-7, #3b97e3);
          color: #ffffff;
          bottom: unset;
          width: auto;
          padding: 6px;
          z-index: 1;
          margin: 0;
          float: right;
        }
        .hax-context-menu:not(:defined) {
          display: none;
        }
        /* drag and drop */
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*):before {
          background-color: var(--hax-body-possible-target-background-color);
          content: " ";
          width: 100%;
          display: block;
          position: relative;
          margin: -12px 0 0 0;
          z-index: 2;
          height: 12px;
          transition: 0.2s all ease-in-out;
        }
        :host([edit-mode][hax-mover]) #bodycontainer ::slotted(img) {
          outline: var(--hax-body-editable-outline);
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered),
        :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered):before {
          background-color: var(--hax-body-target-background-color) !important;
        }
        :host([edit-mode]) #bodycontainer ::slotted(img.hax-hovered) {
          border-top: 8px
            var(
              --hax-contextual-action-hover-color,
              var(--simple-colors-default-theme-cyan-7, #009dc7)
            );
          margin-top: -8px;
        }

        @media screen and (min-color-index: 0) and(-webkit-min-device-pixel-ratio:0) {
          /*
            Define here the CSS styles applied only to Safari browsers
            (any version and any device) via https://solvit.io/bcf61b6
          */
          :host([edit-mode][hax-mover]) #bodycontainer ::slotted(*) {
            outline: var(--hax-body-editable-outline);
            background-color: var(--hax-body-possible-target-background-color);
          }
          :host([edit-mode]) #bodycontainer ::slotted(*.hax-hovered) {
            background-color: var(
              --hax-body-target-background-color
            ) !important;
            outline: var(--hax-body-active-outline);
          }
        }
      `]}constructor(){super(),this.__ignoreActive=!1,this.__dragMoving=!1,this.___moveLock=!1,this.editMode=!1,this.haxMover=!1,this.globalPreferences={},this.haxRayMode=!1,this.activeNode=null,setTimeout(()=>{import("./lib/hax-text-context.js"),import("./lib/hax-ce-context.js"),import("./lib/hax-plate-context.js"),import("../grid-plate/grid-plate.js"),this.polyfillSafe=c.computePolyfillSafe(),this.addEventListener("place-holder-replace",this.replacePlaceholder.bind(this)),this.addEventListener("focusin",this._focusIn.bind(this)),this.addEventListener("mousemove",this._mouseMove.bind(this)),this.addEventListener("mouseleave",this._mouseLeave.bind(this)),this.addEventListener("touchstart",this._mouseMove.bind(this),{passive:!0}),this.addEventListener("mousedown",this._mouseDown.bind(this)),this.addEventListener("mouseup",this._mouseUp.bind(this)),this.addEventListener("dragenter",this.dragEnterBody.bind(this)),this.addEventListener("dragend",this.dragEndBody.bind(this)),this.addEventListener("drop",this.dropEvent.bind(this)),this.addEventListener("click",this.clickEvent.bind(this))},0),h(()=>{this.globalPreferences=u(c.globalPreferences)}),h(()=>{this.editMode=u(c.editMode)}),h(()=>{this.activeNode=u(c.activeNode)})}dragEndBody(e){this.__manageFakeEndCap(!1),c._lockContextPosition=!1,this.querySelectorAll(".hax-hovered").forEach(e=>{e.classList.remove("hax-hovered")})}_mouseLeave(e){this.editMode&&c.ready&&(clearTimeout(this.__mouseQuickTimer),clearTimeout(this.__mouseTimer),this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))}_mouseMove(e){this.editMode&&c.ready&&(clearTimeout(this.__mouseQuickTimer),this.__mouseQuickTimer=setTimeout(()=>{if(this.__activeHover&&this.__activeHover!=e.path[0].closest("[data-hax-ray]:not(li)")&&!e.path[0].closest("#addincontext")){let o;for(var t=0;t<e.path.length;t++)e.path[t].getAttribute&&"addincontext"==e.path[t].getAttribute("id")&&(o=!0);o||(this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))}},300),clearTimeout(this.__mouseTimer),this.__mouseTimer=setTimeout(()=>{this.__addActiveVisible();let t=e.path[0].closest("[data-hax-ray]:not(li)");if(t){this.__activeHover=t;let o=this.__activeHover.getBoundingClientRect(),i=this.contextMenus.add.getBoundingClientRect(),a=(e.pageY-(o.top+window.scrollY))/o.height,n=-i.height-1;a>.3?(n=o.height+1,this.__addAbove=!1):this.__addAbove=!0,this._positionContextMenu(this.contextMenus.add,this.__activeHover,o.width/2-i.width/2,n)}else if(e.path[0].closest(".column")&&e.path[3]&&e.path[3].closest("grid-plate")){let t,o,i=this.contextMenus.add.getBoundingClientRect(),a=-i.height-1;if(e.path[0].closest(".column:not(.has-nodes")){if(this.__addAbove=!1,this.__slot=e.path[0].closest(".column").getAttribute("id").replace("col","col-"),0==e.path[0].closest(".column").parentNode.parentNode.host.children.length){let t=document.createElement("p");t.innerHTML="<br />",e.path[0].closest(".column").parentNode.parentNode.host.appendChild(t)}this.__activeHover=e.path[0].closest(".column").parentNode.parentNode.host.children[0],t=e.path[0].closest(".column").getBoundingClientRect(),a=t.height/2-i.height/2,o=e.path[0].closest(".column")}else{this.__activeHover=e.path[0].closest(".column").parentNode.parentNode.host,o=this.__activeHover,t=this.__activeHover.getBoundingClientRect(),(e.pageY-(t.top+window.scrollY))/t.height>.3?(a=t.height+1,this.__addAbove=!1):this.__addAbove=!0}this._positionContextMenu(this.contextMenus.add,o,t.width/2-i.width/2,a)}else e.path[0].closest("#bodycontainer")&&(this.__activeHover=null,this._hideContextMenu(this.contextMenus.add))},600))}_mouseDown(e){this.__mouseDown=!0;let t=e.target;t.closest("[draggable]")?t=t.closest("[draggable]"):t.closest("[slot]")?t=t.closest("[slot]"):t.closest("[data-hax-ray]")?t=t.closest("[data-hax-ray]"):t.closest("[contenteditable]")&&(t=t.closest("[contenteditable]")),this.__focusLogic(t)&&(e.stopPropagation(),e.stopImmediatePropagation())}_mouseUp(e){setTimeout(()=>{this.__mouseDown=!1},0),clearTimeout(m),this.__manageFakeEndCap(!1)}clickEvent(e){clearTimeout(m)}__manageFakeEndCap(e=!0){if(e&&!this.__fakeEndCap){let e=document.createElement("fake-hax-body-end");e.style.width="100%",e.style.height="20px",e.style.zIndex="2",e.style.display="block",this.__fakeEndCap=e,this.haxMover=!0,this.appendChild(this.__fakeEndCap),this.__applyNodeEditableState(this.__fakeEndCap,!0)}else!e&&this.__fakeEndCap&&(this.__fakeEndCap.remove(),this.haxMover=!1,this.__fakeEndCap=null)}dragEnterBody(e){this.__manageFakeEndCap(!0)}render(){return e`
      <div id="bodycontainer" class="ignore-activation">
        <slot id="body"></slot>
      </div>
      <hax-text-context
        id="textcontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-text-context>
      <hax-ce-context
        id="cecontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-ce-context>
      <hax-plate-context
        id="platecontextmenu"
        class="hax-context-menu ignore-activation"
      ></hax-plate-context>
      <hax-context-item
        id="addincontext"
        class="hax-context-menu ignore-activation"
        icon="icons:add-circle"
        label="Add here"
        mini
        circle
      >
      </hax-context-item>
    `}static get properties(){return{...super.properties,haxMover:{type:Boolean,attribute:"hax-mover",reflect:!0},editMode:{type:Boolean,reflect:!0,attribute:"edit-mode"},haxRayMode:{type:Boolean,reflect:!0,attribute:"hax-ray-mode"},globalPreferences:{type:Object},activeNode:{type:Object}}}firstUpdated(e){this.dispatchEvent(new CustomEvent("hax-register-body",{bubbles:!0,cancelable:!0,composed:!0,detail:this}));try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("defaultParagraphSeparator",!1,"p")}catch(e){console.warn(e)}this.contextMenus={text:this.shadowRoot.querySelector("#textcontextmenu"),plate:this.shadowRoot.querySelector("#platecontextmenu"),ce:this.shadowRoot.querySelector("#cecontextmenu"),add:this.shadowRoot.querySelector("#addincontext")},this.contextMenus.add.addEventListener("click",this._addInContextClick.bind(this)),this.shadowRoot.querySelector("slot").addEventListener("mouseup",e=>{this.editMode&&setTimeout(()=>{const e=c.getSelection();c._tmpSelection=e,c.haxSelectedText=e.toString();try{const e=c.getRange();e.cloneRange&&(c._tmpRange=e.cloneRange())}catch(e){console.warn(e)}},10)}),this.editMode=c.editMode,this.__tabTrap=!1,this.__ready=!0,super.firstUpdated&&super.firstUpdated(e)}_addInContextClick(e){this.__mouseDown=!1;["ul","ol"].includes(this.__activeHover.parentNode.tagName.toLowerCase())&&(this.__activeHover=this.__activeHover.parentNode),this.haxInsert("p","",{},this.__activeHover),this.__activeHover=null,this._hideContextMenu(this.contextMenus.add)}updated(e){e.forEach((e,t)=>{"editMode"==t&&(this._editModeChanged(this[t],e),this[t]&&(this._activeNodeChanged(this.activeNode),this.activeNode.focus())),"globalPreferences"==t&&this._globalPreferencesUpdated(this[t],e),"activeNode"==t&&this.__ready&&this._activeNodeChanged(this[t],e)}),super.updated&&super.updated(e)}connectedCallback(){super.connectedCallback(),this._observer=new MutationObserver(e=>{var t=!1;this.__ignoreActive||this.__dragMoving||this.undoStackIgnore||this.__fakeEndCap?this.undoStackIgnore?e.forEach(e=>{e.addedNodes.length>0&&e.addedNodes.forEach(e=>{this._validElementTest(e)&&setTimeout(()=>{this.__applyNodeEditableState(e,this.editMode)},0)})}):this.__ignoreActive&&(this.__ignoreActive=!1):e.forEach(e=>{e.addedNodes.length>0&&(e.addedNodes.forEach(e=>{if(this._validElementTest(e))if(this.__slot&&(e.setAttribute("slot",this.__slot),this.__slot=null),"IMG"==e.tagName&&e.setAttribute("draggable",!1),this.__indentTrap&&("SPAN"===e.tagName?e.parentNode===this?this.haxChangeTagName(e,"p",!0):"LI"===e.parentNode.tagName&&(e.parentNode.innerHTML=e.textContent):"BR"===e.tagName&&e.remove()),!this.editMode||"true"!=e.getAttribute("contenteditable")&&!0!==e.getAttribute("contenteditable")&&"contenteditable"!=e.getAttribute("contenteditable")||this.__applyNodeEditableState(e,!this.editMode),this.__applyNodeEditableState(e,this.editMode),this.dispatchEvent(new CustomEvent("hax-body-tag-added",{bubbles:!0,cancelable:!0,composed:!0,detail:{node:e}})),["H1","H2","H3","H4","H5","H6"].includes(e.tagName)&&null==e.getAttribute("id")&&e.setAttribute("id",n("header-")),this.___moveLock||t)this.___moveLock=!1;else if(t=!0,c.activeNode=e,"BR"===e.tagName){const e=c.getSelection();c._tmpSelection=e,c.haxSelectedText=e.toString();const t=c.getRange();t.collapsed&&"BR"===this.activeNode.tagName&&this.activeNode.parentNode===t.commonAncestorContainer&&""===this.activeNode.innerText&&(c.activeNode=this.activeNode.parentNode)}}),this.__indentTrap&&setTimeout(()=>{this.__indentTrap=!1},0)),e.removedNodes.length>0&&e.removedNodes.forEach(e=>{this._validElementTest(e)&&!e.classList.contains("hax-active")&&this.dispatchEvent(new CustomEvent("hax-body-tag-removed",{bubbles:!0,cancelable:!0,composed:!0,detail:{node:e}}))})})}),this._observer.observe(this,{childList:!0,subtree:!0}),window.addEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keypress",this._onKeyPress.bind(this)),document.body.addEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.addEventListener("scroll",this._keepContextVisible.bind(this),{passive:!0}),window.addEventListener("resize",this._keepContextVisible.bind(this),{passive:!0})}disconnectedCallback(){window.removeEventListener("keydown",this._onKeyDown.bind(this)),window.removeEventListener("keypress",this._onKeyPress.bind(this)),document.body.removeEventListener("hax-store-property-updated",this._haxStorePropertyUpdated.bind(this)),window.removeEventListener("scroll",this._keepContextVisible.bind(this)),window.removeEventListener("resize",this._keepContextVisible.bind(this)),window.removeEventListener("hax-context-item-selected",this._haxContextOperation.bind(this)),this._observer.disconnect(),super.disconnectedCallback()}_keepContextVisible(e=null){this.editMode&&(clearTimeout(this.__contextVisibleLock),this.__contextVisibleLock=setTimeout(()=>{let e=!1;this.contextMenus.text.classList.contains("hax-context-visible")?e=this.contextMenus.text:this.contextMenus.ce.classList.contains("hax-context-visible")&&(e=this.contextMenus.ce),e&&(this.elementMidViewport()?(e.classList.add("hax-context-pin-top"),this.contextMenus.plate.classList.add("hax-context-pin-top")):(e.classList.remove("hax-context-pin-top"),this.contextMenus.plate.classList.remove("hax-context-pin-top")),this.positionContextMenus())},100))}_onKeyDown(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName)if(this.getAttribute("contenteditable")){if(this.__dropActiveVisible(),this.__manageFakeEndCap(!1),null!=c.getSelection().anchorNode)switch(e.key){case"Z":case"z":e.ctrlKey&&(e.shiftKey?this.redo():this.undo(),e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation());break;case"Tab":c.isTextElement(this.activeNode)&&(e.detail.keyboardEvent&&(e.detail.keyboardEvent.preventDefault(),e.detail.keyboardEvent.stopPropagation(),e.detail.keyboardEvent.stopImmediatePropagation()),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.shiftKey?this._tabBackKeyPressed():this._tabKeyPressed());break;case"Enter":if(this.__slot=this.activeNode.getAttribute("slot"),this.setAttribute("contenteditable",!0),"P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");this.keyboardShortCutProcess(e)}break;case"Backspace":case"Delete":this.__deleteItKey=!0;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":setTimeout(()=>{const e=c.getSelection();c._tmpSelection=e,c.haxSelectedText=e.toString();const t=c.getRange();t.commonAncestorContainer&&this.activeNode!==t.commonAncestorContainer&&"function"==typeof t.commonAncestorContainer.focus?"HAX-BODY"!==t.commonAncestorContainer.tagName&&(c.isTextElement(t.commonAncestorContainer)?this.setAttribute("contenteditable",!0):this.removeAttribute("contenteditable"),t.commonAncestorContainer.focus(),this.__focusLogic(t.commonAncestorContainer,!1)):t.commonAncestorContainer&&t.commonAncestorContainer.parentNode&&this.activeNode!==t.commonAncestorContainer.parentNode&&"function"==typeof t.commonAncestorContainer.parentNode.focus&&("HAX-BODY"!==t.commonAncestorContainer.parentNode.tagName?(c.isTextElement(t.commonAncestorContainer.parentNode)?this.setAttribute("contenteditable",!0):this.removeAttribute("contenteditable"),t.commonAncestorContainer.parentNode.focus(),this.__focusLogic(t.commonAncestorContainer.parentNode,!1)):(t.commonAncestorContainer.focus(),this.__focusLogic(t.commonAncestorContainer,!1)))},0);break;default:setTimeout(()=>{if("P"===this.activeNode.tagName&&["1","#","`",">","-","!"].includes(this.activeNode.textContent[0])){const e=this.activeNode.textContent.replaceAll(/ /g," ");" "===e[e.length-1]&&this.keyboardShortCutProcess(e)}},0)}}else switch(e.key){case"Delete":this.haxDeleteNode(this.activeNode)}}keyboardShortCutProcess(e){let t={"#":"h2","##":"h3","###":"h4","####":"h5","#####":"h6","-":"ul","1.":"ol","---":"hr","```":"code",">":"blockquote"};if(t[e.replace(" ","")]){let o=document.createElement(t[e.replace(" ","")]);o.innerHTML="<br />",["UL","OL"].includes(o.tagName)&&(o.innerHTML="<li></li>"),this.haxReplaceNode(this.activeNode,o),this.__focusLogic(o),"HR"===o.tagName&&this.haxInsert("p","",{})}else if("!"===e[0]){let t=e.replace("!","").replaceAll(/ /g,"");if(c.elementList[t]){let e,o=c.haxSchemaFromTag(t);e=o.gizmo.tag&&o.demoSchema&&o.demoSchema[0]?r(o.demoSchema[0]):document.createElement(t),this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e)}else c.toast(t+" is not a valid tag")}}_onKeyPress(e){clearTimeout(this.__keyPress),this.__keyPress=setTimeout(()=>{this.editMode&&this.activeNode&&c.isTextElement(this.activeNode)&&(clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout(()=>{this.__addActiveVisible(),this.positionContextMenus()},2500))},50)}elementMidViewport(){const e=this.activeNode.getBoundingClientRect().y;return e<0&&e>-1*this.activeNode.offsetHeight+140}replacePlaceholder(e){if("text"===e.detail){let e=document.createElement("p");e.innerHTML="<br/>",this.haxReplaceNode(this.activeNode,e),this.__focusLogic(e),this.activeNode.parentNode&&this.activeNode.parentNode.setAttribute("contenteditable",!0)}else this.replaceElementWorkflow()}canTansformNode(e=null){return this.replaceElementWorkflow(e,!0).length>0}replaceElementWorkflow(e=null,t=!1){null==e&&(e=this.activeNode);let o=s(e,null),i="*",a=!1;"place-holder"===o.tag&&void 0!==o.properties.type&&(i=o.properties.type,a=!0);var n={};if(void 0!==c.elementList[o.tag]&&!1!==c.elementList[o.tag].gizmo&&void 0!==c.elementList[o.tag].gizmo.handles&&c.elementList[o.tag].gizmo.handles.length>0){let e=c.elementList[o.tag].gizmo;for(var r=0;r<e.handles.length;r++)for(var l in e.handles[r])"type"!==l&&void 0!==o.properties[e.handles[r][l]]&&(n[l]=o.properties[e.handles[r][l]])}let d=c.guessGizmo(i,n,a);if(d.length>0){let o=e.tagName.toLowerCase(),i=o.replace("-"," ");void 0!==c.elementList[o]&&!1!==c.elementList[o].gizmo&&(i=c.elementList[o].gizmo.title),t||(c.activePlaceHolder=this.activeNode,c.haxAppPicker.presentOptions(d,"__convert",`Transform ${i} to..`,"gizmo"))}else t||c.toast("Sorry, this can not be transformed!",5e3);return d}_globalPreferencesUpdated(e,t){void 0!==e&&null!=e&&(this.haxRayMode=e.haxRayMode)}_haxStorePropertyUpdated(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&(this[e.detail.property]=e.detail.value)}haxClearBody(e=!0){let t=!0;e&&(t=prompt("Are you sure you want to delete all content?")),t&&a(this)}haxInsert(e,t,o={},i=this.activeNode){var a=document.createElement(e);a.innerHTML=t;const n=a.cloneNode(!0);for(var s in o){let e=l(s);o.hasOwnProperty(s)&&(!0===o[s]?n.setAttribute(e,e):!1===o[s]?n.removeAttribute(e):null!=o[s]&&o[s].constructor===Array||null!=o[s]&&o[s].constructor===Object?n.properties&&n.properties[s].readOnly||(n.set?n.set(e,o[s]):n[e]=o[s]):n.setAttribute(e,o[s]))}return null!==c.activePlaceHolder&&void 0!==c.activePlaceHolder.style?(n.style.width=c.activePlaceHolder.style.width,n.style.float=c.activePlaceHolder.style.float,n.style.margin=c.activePlaceHolder.style.margin,n.style.display=c.activePlaceHolder.style.display,this.haxReplaceNode(c.activePlaceHolder,n),c.activePlaceHolder=null):null!=i.parentNode?"GRID-PLATE"===i.parentNode.tagName?(null!=i.getAttribute("slot")&&n.setAttribute("slot",i.getAttribute("slot")),this.__addAbove?i.parentNode.insertBefore(n,i):i.parentNode.insertBefore(n,i.nextElementSibling)):i.parentNode&&i.parentNode.nextElementSibling?i.parentNode.nextElementSibling.parentNode.insertBefore(n,i.parentNode.nextElementSibling):i.parentNode&&i.nextElementSibling?this.__addAbove?i.parentNode.insertBefore(n,i):i.parentNode.insertBefore(n,i.nextElementSibling):i.parentNode&&i.parentNode.children[i.parentNode.children.length-1]===i?this.__addAbove?i.parentNode.insertBefore(n,i):i.parentNode.appendChild(n):i.parentNode?i.parentNode.insertBefore(n,i):this.appendChild(n):this.appendChild(n),this.contextMenus.text.hasSelectedText=!1,setTimeout(()=>{this.__focusLogic(n),this.scrollHere(n)},0),n}haxToContent(){this.hideContextMenus();var e=this.activeNode;c.activeNode=null;let t="slot"===this.shadowRoot.querySelector("#body").localName?this.shadowRoot.querySelector("#body").assignedNodes({flatten:!0}):[];for(var o="",a=0,n=t.length;a<n;a++)this._validElementTest(t[a])?(t[a].removeAttribute("data-hax-ray"),t[a].classList.remove("hax-hovered"),t[a].contentEditable=!1,o+=c.nodeToContent(t[a]),"grid-plate"===t[a].tagName.toLowerCase()&&this._applyContentEditable(this.editMode,t[a])):8===t[a].nodeType?o+="\x3c!-- "+t[a].textContent+" --\x3e":1!==t[a].nodeType&&void 0!==t[a].textContent&&"undefined"!==t[a].textContent&&(o+=t[a].textContent);if(o=(o=(o=(o=o.replace(/\scontenteditable=\"false\"/g,"")).replace(/\scontenteditable/g,"")).replace(/\sdraggable/g,"")).replace(/\sdata-hax-ray=\".*?\"/g,""),this.parentNode.tagName){let e=this.parentNode.tagName.toLowerCase(),t="style-scope "+e+" x-scope",i=new RegExp(t,"g");o=o.replace(i,""),t="style-scope "+e,i=new RegExp(t,"g"),o=o.replace(i,""),t="x-scope "+e+"-0",i=new RegExp(t,"g"),o=o.replace(i,"");let n=c.validTagList;for(var a in n)t="style-scope "+n[a],i=new RegExp(t,"g"),o=o.replace(i,""),t="x-scope "+n[a]+"-0 ",i=new RegExp(t,"g"),o=o.replace(i,""),t="x-scope "+n[a]+"-0",i=new RegExp(t,"g"),o=o.replace(i,"")}return o=(o=o.replace(/\sclass=\"\"/g,"")).replace(/\sclass=\"\s\"/g,""),this._applyContentEditable(this.editMode),c.activeNode=e,o=i(o)}haxDuplicateNode(e){let t=s(e,null);var o=c.elementList[e.tagName.toLowerCase()];if(void 0!==o&&void 0!==o.saveOptions.unsetAttributes)for(var i in o.saveOptions.unsetAttributes)t.properties[o.saveOptions.unsetAttributes[i]]&&delete t.properties[o.saveOptions.unsetAttributes[i]];void 0!==e.preProcessHaxInsertContent&&(t=e.preProcessHaxInsertContent(t)),t.content==t.properties.innerHTML&&delete t.properties.innerHTML;var a=r({tag:t.tag,content:t.content,properties:t.properties});return"webview"===a.tagName.toLowerCase()&&c._isSandboxed&&void 0!==a.guestinstance&&delete a.guestinstance,null!==e?e.parentNode.insertBefore(a,e.nextSibling):e.parentNode.appendChild(a),c.activeNode=a,!0}hideContextMenus(e=!0){clearTimeout(m),clearTimeout(this.__keyPress),clearTimeout(this.__contextVisibleLock),clearTimeout(this.__positionContextTimer),this._hideContextMenu(this.contextMenus.text),this._hideContextMenu(this.contextMenus.ce),this._hideContextMenu(this.contextMenus.add),this.__activeHover=null,e&&this._hideContextMenu(this.contextMenus.plate)}positionContextMenus(e=this.activeNode){clearTimeout(this.__positionContextTimer),this.__positionContextTimer=setTimeout(()=>{if(e&&e.tagName&&!c._lockContextPosition&&this.__ready){let t=140,o=e.tagName.toLowerCase();c._isSandboxed&&"webview"===o&&(o="iframe");let i=c.elementList[o];if(void 0===i||c.isTextElement(e)){this._hideContextMenu(this.contextMenus.ce),this._positionContextMenu(this.contextMenus.text,e,0,-28),t+=this.contextMenus.text.getBoundingClientRect().width}else this._hideContextMenu(this.contextMenus.text),i.element=e,this._positionContextMenu(this.contextMenus.ce,e,0,-28),t+=28;let a=e.getBoundingClientRect();"LI"===this.activeNode.tagName||this._HTMLInlineTextDecorationTest(this.activeNode)?this._hideContextMenu(this.contextMenus.plate):Math.round(t)>=Math.round(a.width)?this._positionContextMenu(this.contextMenus.plate,e,0,-56):this._positionContextMenu(this.contextMenus.plate,e,a.width-this.contextMenus.plate.getBoundingClientRect().width+1,-26),e&&"HR"!==e.tagName&&!c.isTextElement(e)?e.removeAttribute("contenteditable"):e&&e.setAttribute("contenteditable",!0)}},50)}__addActiveVisible(){for(var e in this.contextMenus)("add"!=e||this.__activeHover)&&this.contextMenus[e].classList.add("hax-context-menu-active")}__dropActiveVisible(){for(var e in this.contextMenus)this.contextMenus[e].classList.remove("hax-context-menu-active");this.__activeHover=null,this._hideContextMenu(this.contextMenus.add)}haxMoveGridPlate(e,t){switch(this.___moveLock=!0,e){case"up":null!==t.previousElementSibling&&t.parentNode.insertBefore(t,t.previousElementSibling);break;case"down":null!==t.nextElementSibling&&t.parentNode.insertBefore(t.nextElementSibling,t)}return this.scrollHere(t),this.positionContextMenus(t),!0}async haxGridPlateOps(e=!0,t="right",o=this.activeNode){let i=!1;if("GRID-PLATE"===o.tagName){if(e)switch(o.layout){case"1":o.layout="1-1",i=!0;break;case"1-1":o.layout="1-1-1",i=!0;break;case"1-1-1":o.layout="1-1-1-1",i=!0;break;case"1-1-1-1":o.layout="1-1-1-1-1",i=!0;break;case"1-1-1-1-1":o.layout="1-1-1-1-1-1",i=!0}else switch(o.layout){case"1-1":let e;await o.childNodes.forEach(t=>{t.tagName&&(e=t.cloneNode(!0),o.getAttribute("slot")?e.setAttribute("slot",o.getAttribute("slot")):e.removeAttribute("slot"),o.parentNode.insertBefore(e,o))}),c.activeNode=e,setTimeout(()=>{o.remove()},0),i=!0;break;case"1-1-1":o.layout="1-1",i=!0;break;case"1-1-1-1":o.layout="1-1-1",i=!0;break;case"1-1-1-1-1":o.layout="1-1-1-1",i=!0;break;case"1-1-1-1-1-1":o.layout="1-1-1-1-1",i=!0}if(i){let e=this.contextMenus.plate.shadowRoot.querySelector("#right"),i=this.contextMenus.plate.shadowRoot.querySelector("#rightremove");e.disabled=!1,i.disabled=!1,"1-1-1-1-1-1"==o.layout&&(e.disabled=!0),"left"==t&&o.childNodes.forEach(e=>{if(e.tagName){let t=parseInt(e.getAttribute("slot").replace("col-",""),10)+1;e.setAttribute("slot","col-"+t)}})}}else{let e=document.createElement("grid-plate");e.layout="1-1",e.disableResponsive=!0,o.getAttribute("slot")&&e.setAttribute("slot",o.getAttribute("slot"));let i="2";"right"==t&&(i="1");let a=o.cloneNode(!0);a.setAttribute("slot","col-"+i),e.appendChild(a),o.parentNode.insertBefore(e,o),setTimeout(()=>{o.remove()},0)}c.haxTray.refreshActiveNodeForm()}haxReplaceNode(e,t){try{null==e&&(e=this.__oldActiveNode),!e.replaceWith&&c._tmpRange&&(e=c._tmpRange,c._tmpRange=null),e.replaceWith(t),e&&e.getAttribute&&null!=e.getAttribute("slot")&&t.setAttribute("slot",e.getAttribute("slot"))}catch(e){console.warn(e)}return t}haxChangeTagName(e,t,o=!0){for(var i=document.createElement(t),a=0,n=e.attributes.length;a<n;++a){let t=e.attributes.item(a).nodeName,o=e.attributes.item(a).value;try{i.setAttribute(t,o)}catch(t){console.warn(e.attributes),console.warn(t)}}i.innerHTML=o?e.innerHTML.trim():"<br />","ul"==t||"ol"==t?"<br />"==i.innerHTML?i.innerHTML="<li><br /></li>":"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()&&(i.innerHTML="<li>"+e.innerHTML.trim().replace(/<br\/>/g,"</li>\n<li>").replace(/<br>/g,"</li>\n<li>")+"</li>"):"ul"!=e.tagName.toLowerCase()&&"ol"!=e.tagName.toLowerCase()||(i.innerHTML=i.innerHTML.replace(/<ul>/g,"").replace(/<\/ul>/g,"").replace(/<li><\/li>/g,"").replace(/<li>/g,"").replace(/<\/li>/g,"<br/>"));try{e.replaceWith(i),o&&setTimeout(()=>{let e=i.children;e[0]&&e.tagName?e[0].focus():i.focus()},10)}catch(t){console.warn(t),console.warn(i),console.warn(e)}return i}haxDeleteNode(e){if(e.previousElementSibling)c.activeNode=e.previousElementSibling;else if(e.nextElementSibling)c.activeNode=e.nextElementSibling;else{this.haxInsert("p","",{});try{var t=document.createRange(),o=c.getSelection();t.setStart(this.activeNode,0),t.collapse(!0),o.removeAllRanges(),o.addRange(t),this.activeNode.focus()}catch(e){console.warn(e)}}try{return e.remove()}catch(e){console.warn(e)}}importContent(e,t=!0){t&&a(this,"*"),setTimeout(()=>{e=i(e);let t=document.createElement("div");for(t.insertAdjacentHTML("beforeend",e);null!==t.firstChild;)if(void 0!==t.firstChild.tagName)if(c._isSandboxed&&"iframe"===t.firstChild.tagName.toLowerCase()){for(var o=document.createElement("webview"),a=0,n=t.firstChild.attributes.length;a<n;++a){var s=t.firstChild.attributes.item(a).nodeName,r=t.firstChild.attributes.item(a).value;"height"!==s&&"width"!==s||o.style[s],o.setAttribute(s,r)}this.appendChild(o)}else this.appendChild(t.firstChild);else t.removeChild(t.firstChild)},0)}_haxContextOperation(e){let t=e.detail;switch(t.eventName){case"text-tag":c.activeNode=this.haxChangeTagName(this.activeNode,t.value),this.positionContextMenus();break;case"text-tag-ul":this.contextMenus.text.realSelectedValue="ul",c.activeNode=this.haxChangeTagName(this.activeNode,"ul"),this.positionContextMenus();break;case"text-tag-ol":this.contextMenus.text.realSelectedValue="ol",c.activeNode=this.haxChangeTagName(this.activeNode,"ol"),this.positionContextMenus();break;case"text-align-left":this.activeNode.style.textAlign=null;break;case"hax-transform-node":this.replaceElementWorkflow();break;case"hax-plate-create-right":this.haxGridPlateOps();break;case"hax-plate-remove-right":this.haxGridPlateOps(!1);break;case"hax-plate-duplicate":this.haxDuplicateNode(this.activeNode);break;case"hax-plate-delete":null!=this.activeNode&&this.haxDeleteNode(this.activeNode);break;case"hax-plate-up":this.haxMoveGridPlate("up",this.activeNode);break;case"hax-plate-down":this.haxMoveGridPlate("down",this.activeNode)}}_focusIn(e){this.__mouseDown||this.__focusLogic(e.target)&&(e.stopPropagation(),e.stopImmediatePropagation())}__focusLogic(e,t=!0){let o=!1;if(this.editMode&&!this.__tabTrap){let i=e;"SPAN"===i.tagName&&c.isTextElement(i.parentNode)&&""==i.parentNode.getAttribute("slot")&&(i=e.parentNode);let a=null;if(this._validElementTest(i)&&i.parentNode&&i.parentNode.tagName){if("P"===i.parentNode.tagName&&""==i.parentNode.getAttribute("slot"))a=i,o=!0;else{for(;i.parentNode&&i.parentNode.tagName&&"HAX-BODY"!=i.parentNode.tagName;)null===a&&"B"!==i.tagName&&"I"!==i.tagName&&"STRONG"!==i.tagName&&"EM"!==i.tagName&&(a=i),i=i.parentNode;null===a?a=i:c.isGridPlateElement(i)||(a=i)}(this.activeNode&&this.activeNode.parentNode!==i&&!i.classList.contains("ignore-activation")||i.classList.contains("ignore-activation"))&&(o=!0),a.classList.contains("ignore-activation")||(c.activeNode=a,setTimeout(()=>{if(t&&!this.__mouseDown&&c.isTextElement(a))try{var e=document.createRange(),o=c.getSelection();e.setStart(this.activeNode,0),e.collapse(!0),o.removeAllRanges(),o.addRange(e),this.activeNode.focus()}catch(e){console.warn(e)}this.positionContextMenus(a)},0),o=!0)}}else this.__tabTrap=!1;return o}scrollHere(e){setTimeout(()=>{"function"==typeof e.scrollIntoViewIfNeeded?e.scrollIntoViewIfNeeded(!0):e.scrollIntoView({behavior:"smooth",inline:"center"})},0)}undo(){super.undo(),setTimeout(()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()},0)}redo(){super.redo(),setTimeout(()=>{let e=this.querySelector(".hax-active");e?(this.__focusLogic(e),this.scrollHere(e)):this.hideContextMenus()},0)}_editModeChanged(e,t){if(void 0!==t){if(this._applyContentEditable(e),e)if(this.children&&this.children[0]&&this.children[0].focus)this.__focusLogic(this.children[0]);else{this.haxInsert("p","",{});try{var o=document.createRange(),i=c.getSelection();o.setStart(this.activeNode,0),o.collapse(!0),i.removeAllRanges(),i.addRange(o),this.activeNode.focus()}catch(e){console.warn(e)}}setTimeout(()=>{this.undoStack.undoStackLimit=20,this.undoStack.undoStackPosition=-1,this.undoStack.commands=[],this.undoStack.changed(),this.undoStackInitialValue=this.innerHTML,this.undoStackPrevValue=this.undoStackInitialValue},0)}0==e&&(this.removeAttribute("contenteditable"),this.hideContextMenus(),this.querySelectorAll("[contenteditable],.hax-active").forEach(e=>{e.removeAttribute("contenteditable"),e.classList.remove("hax-active")}))}_haxResolvePreviousElement(e){for(e=e.previousElementSibling;null!=e&&void 0!==e.tagName&&"HAX-"===e.tagName.substring(0,4);)e=e.previousElementSibling;return e}_validElementTest(e){return!(!e.tagName||["TEMPLATE","HAX-BODY","HAX-APP-SEARCH-RESULT","FAKE-HAX-BODY-END"].includes(e.tagName))&&(!this._HTMLInlineTextDecorationTest(e)||"HAX-BODY"==e.parentNode)}_HTMLInlineTextDecorationTest(e){return["span","b","strong","i","em"].includes(e.tagName.toLowerCase())}_HTMLPrimativeTest(e){return null!=e&&void 0!==e.tagName&&-1==e.tagName.indexOf("-")}_applyContentEditable(e,t=this.shadowRoot.querySelector("#body")){let o="slot"===t.localName?t.assignedNodes({flatten:!0}):[];0===o.length&&(o=t.children);for(var i=0,a=o.length;i<a;i++)this._validElementTest(o[i])&&(!e||!0!==o[i].getAttribute("contenteditable")&&"true"!=o[i].getAttribute("contenteditable")&&"contenteditable"!=o[i].getAttribute("contenteditable"))&&this.__applyNodeEditableState(o[i],e)}__applyNodeEditableState(e,t=!0){let o,i=e.tagName.replace("-"," ").toLowerCase(),a=c.gizmoList.findIndex(t=>{if(t)return t.tag===e.tagName.toLowerCase()});if(-1!==a&&(i=c.gizmoList[a].title),t?(e.setAttribute("data-hax-ray",i),o="addEventListener"):(e.removeAttribute("data-hax-ray"),o="removeEventListener"),e[o]("drop",this.dropEvent.bind(this)),e[o]("dragenter",this.dragEnter.bind(this)),e[o]("dragleave",this.dragLeave.bind(this)),e[o]("dragover",e=>{this.__dragMoving=!0,e.preventDefault()}),this._HTMLPrimativeTest(e)&&(t?e.setAttribute("contenteditable",t):e.removeAttribute("contenteditable"),e.querySelectorAll("a").length>0)){let i=e.querySelectorAll("a");for(var n=0,s=i.length;n<s;n++)t?i[n].setAttribute("contenteditable",t):i[n].removeAttribute("contenteditable"),i[n][o]("click",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()})}}undoManagerStackLogic(e){this.__dragMoving||(this.querySelectorAll(".hax-hovered").forEach(e=>{e.classList.remove("hax-hovered")}),super.undoManagerStackLogic(e))}dropEvent(e){if(this.editMode){this.__dragMoving=!1,this.undoManagerStackLogic({}),clearTimeout(m),c._lockContextPosition=!1,c.haxTray.activeTab="item-1";var t,o=null;o=e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")?e.target.closest("[contenteditable],img"):e.originalTarget?e.originalTarget:e.target,e.path[0].classList.contains("column")?this.__slot=e.path[0].getAttribute("id").replace("col","col-"):o.getAttribute("slot")&&(this.__slot=o.getAttribute("slot")),c.activeNode=o,this.querySelectorAll(".hax-hovered").forEach(e=>{e.classList.remove("hax-hovered")}),this.querySelectorAll(".active").forEach(e=>{e.classList.remove("active")});try{if(e.dataTransfer&&e.dataTransfer.items&&e.dataTransfer.items.length>0&&"file"===e.dataTransfer.items[0].kind){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let o=document.createElement("p");e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?t=e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&t.tagName&&!["GRID-PLATE","HAX-BODY"].includes(t.tagName)||"GRID-PLATE"===e.path[0].tagName?(t.getAttribute("slot")?o.setAttribute("slot",t.getAttribute("slot")):e.path[0].classList.contains("column")?o.setAttribute("slot",e.path[0].getAttribute("id").replace("col","col-")):o.removeAttribute("slot"),t.parentNode.insertBefore(o,t)):(e.path[0].classList.contains("column")?o.setAttribute("slot",e.path[0].getAttribute("id").replace("col","col-")):t&&"HAX-BODY"===t.tagName&&o.getAttribute("slot")&&o.removeAttribute("slot"),t?t.appendChild(o):this.appendChild(o)),e.placeHolderElement=o,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}else{if(o=c.__dragTarget,t=e.target,e.target.closest("grid-plate")&&e.target.parentNode!=e.target.closest("grid-plate")?t=e.target.closest("grid-plate"):e.target.closest("[contenteditable],img")&&(t=e.target.closest("[contenteditable],img")),t&&o&&this._validElementTest(o)&&o!==t){try{["GRID-PLATE","HAX-BODY"].includes(t.tagName)&&"GRID-PLATE"!==e.path[0].tagName?(e.path[0].classList.contains("column")?o.setAttribute("slot",e.path[0].getAttribute("id").replace("col","col-")):"HAX-BODY"===t.tagName&&o.getAttribute("slot")&&o.removeAttribute("slot"),t.appendChild(o)):(t.getAttribute("slot")?o.setAttribute("slot",t.getAttribute("slot")):e.path[0].classList.contains("column")?o.setAttribute("slot",e.path[0].getAttribute("id").replace("col","col-")):o.removeAttribute("slot"),t.parentNode.insertBefore(o,t))}catch(e){console.warn(e)}e.preventDefault(),e.stopPropagation()}o&&this._validElementTest(o)&&"function"==typeof o.focus&&(c.activeNode=o,this.dispatchEvent(new CustomEvent("hax-drop-focus-event",{bubbles:!0,cancelable:!0,composed:!0,detail:this.activeNode})),this.scrollHere(this.activeNode),this.positionContextMenus())}}catch(e){console.warn(e)}}c.__dragTarget=null,this.__manageFakeEndCap(!1)}dragEnter(e){this.editMode&&e.target&&(this.__dragMoving=!0,e.preventDefault(),e.target&&e.target.classList&&e.target.classList.add("hax-hovered"),this.handleMousemove(e))}handleMousemove(e){var t=e.clientX,o=e.clientY,i=document.documentElement.clientWidth,a=document.documentElement.clientHeight,n=a-200,s=i-200,r=t<200,l=t>s,d=o<200,c=o>n;if(r||l||d||c){var h=Math.max(document.body.scrollWidth,document.body.offsetWidth,document.body.clientWidth,document.documentElement.scrollWidth,document.documentElement.offsetWidth,document.documentElement.clientWidth),u=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.body.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight,document.documentElement.clientHeight),p=h-i,g=u-a;!function checkForWindowScroll(){clearTimeout(m),function adjustWindowScroll(){var e=window.pageXOffset,i=window.pageYOffset,a=i>0,h=i<g,u=e>0,m=e<p,v=e,b=i;if(r&&u){v-=25*((200-t)/200)}else if(l&&m){v+=25*((t-s)/200)}if(d&&a){b-=25*((200-o)/200)}else if(c&&h){b+=25*((o-n)/200)}return v=Math.max(0,Math.min(p,v)),b=Math.max(0,Math.min(g,b)),(v!==e||b!==i)&&(window.scrollTo(v,b),!0)}()&&(m=setTimeout(checkForWindowScroll,30))}()}else clearTimeout(m)}dragLeave(e){this.editMode&&e.target&&e.target.classList&&(this.__dragMoving=!0,e.target.classList.remove("hax-hovered"))}async _activeNodeChanged(e,t){if(await this.querySelectorAll(".hax-active").forEach(e=>{e.classList.remove("hax-active")}),this.editMode&&null!=e&&e.parentNode){let t=e.tagName.toLowerCase();e.classList.add("hax-active"),c.isTextElement(e)||"HR"===e.tagName||c.isGridPlateElement(e)?(e.setAttribute("contenteditable",!0),this.setAttribute("contenteditable",!0)):(e.removeAttribute("contenteditable"),this.removeAttribute("contenteditable")),this._keepContextVisible(),this.contextMenus.text.realSelectedValue=t}else null===e&&(this.hideContextMenus(),this.__oldActiveNode=t)}_getPosition(e){return{x:e.offsetLeft-e.scrollLeft+e.clientLeft,y:e.offsetTop-e.scrollTop+e.clientTop}}_positionContextMenu(e,t,o,i){if(null!=t){let a=this._getPosition(t);e.style.left=null!=o?a.x+o+"px":a.x+"px",e.style.top=null!=i?a.y+i+"px":a.y+"px"}e.setAttribute("on-screen","on-screen"),e.classList.add("hax-context-visible","hax-context-menu-active")}_hideContextMenu(e){e.removeAttribute("on-screen"),e.visible=!1,e.classList.remove("hax-context-visible","hax-context-pin-top","hax-context-menu-active")}_tabKeyPressed(){if(this.activeNode&&c.getRange().cloneRange)try{let t=!1,o=this.activeNode.parentNode;const i=this.activeNode.parentNode.tagName;let a=c.getRange().cloneRange();var e=a.commonAncestorContainer.tagName;if(void 0===e&&(e=a.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(i)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("indent"));else for(;!t;)null==o.nextSibling?t=!0:"function"===o.nextSibling.focus?(o.nextSibling.focus(),t=!0):o=o.nextSibling}catch(e){console.warn(e)}}_tabBackKeyPressed(){if(this.activeNode&&c.getRange().cloneRange)try{let t=this.activeNode.parentNode;const o=this.activeNode.parentNode.tagName;let i=c.getRange().cloneRange();var e=i.commonAncestorContainer.tagName;if(void 0===e&&(e=i.commonAncestorContainer.parentNode.tagName),["UL","OL","LI"].includes(o)||["UL","OL","LI"].includes(e))this.polyfillSafe&&(this.__tabTrap=!0,this.__indentTrap=!0,document.execCommand("outdent"));else{if(null!=t)for(;null!=t&&!this._validElementTest(t);)t=t.previousSibling;null!=t&&setTimeout(()=>{t.focus()},50)}}catch(e){console.warn(e)}}}window.customElements.define(HaxBody.tag,HaxBody);export{HaxBody};