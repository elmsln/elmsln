/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as e,html as t}from"../../../../../lit/index.js";import{FileSystemBrokerSingleton as i}from"../../../../file-system-broker/file-system-broker.js";import{store as s,HAXcmsStore as a}from"../haxcms-site-store.js";import{autorun as n,toJS as o}from"../../../../../mobx/dist/mobx.esm.js";import{generateResourceID as l}from"../../../../utils/utils.js";import{HAXStore as d}from"../../../../hax-body/lib/hax-store.js";class HAXCMSBackendUserfs extends e{static get tag(){return"haxcms-backend-userfs"}static get properties(){return{jwt:{type:String},manifest:{type:Object},activeItem:{type:Object}}}constructor(){super(),this.fileObjects={},this.fileRoot="",this.windowControllers=new AbortController,this.__disposer=[],this.jwt="hax-cloud-fake",n((e=>{this.jwt=o(s.jwt),this.__disposer.push(e)})),n((e=>{this.activeItem=o(s.activeItem),this.__disposer.push(e)})),window.addEventListener("jwt-token",this._jwtTokenFired.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("haxcms-save-site-data",this.saveManifest.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("haxcms-save-outline",this.saveOutline.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("haxcms-save-node",this.saveNode.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("haxcms-delete-node",this.deleteNode.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("haxcms-create-node",this.createNode.bind(this),{signal:this.windowControllers.signal}),window.addEventListener("hax-app-picker-selection",this._appPicked.bind(this),{signal:this.windowControllers.signal})}async updateActiveItemContent(){let e=this.fileRoot+"/"+this.activeItem.location.replace("/index.html",""),t=await this.fileObjects.filter((t=>"file"===t.kind&&"index.html"===t.name&&t.folder===e));if(t.length>0){let e=await t[0].handle.getFile();a.storePieces.siteBuilder.activeItemContent="",a.storePieces.siteBuilder.activeItemContent=await e.text()}}async writeActiveItemContent(e){e=e.replace(/<page-break(.*?)><\/page-break>/gm,"");await d.nodeToContent(d.activeHaxBody.children[0]);let t=this.fileRoot+"/"+this.activeItem.location.replace("/index.html",""),i=await this.fileObjects.filter((e=>"file"===e.kind&&"index.html"===e.name&&e.folder===t));if(i.length>0)try{const t=await i[0].handle.createWritable();return await t.write(e),await t.close(),!0}catch(e){console.log(e)}return!1}_appPicked(e){if("dat"===e.detail.connection.protocol){e.preventDefault(),e.stopPropagation();let t=new FileReader;t.onload=e=>{let t="files/"+d.haxTray.shadowRoot.querySelector("#fileupload").files[0].name;d.haxTray.shadowRoot.querySelector("#url").value=t,d.haxTray.shadowRoot.querySelector("hax-tray-upload").newAssetConfigure()},t.readAsArrayBuffer(d.haxTray.shadowRoot.querySelector("#fileupload").files[0])}}async saveNode(e){await this.writeActiveItemContent(await d.activeHaxBody.haxToContent())&&(s.toast("Page updated!"),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update-node",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})))}async saveOutline(e){this.manifest=s.cmsSiteEditor.instance.manifest,this.manifest.items=e.detail,s.toast("Outline saved!"),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async deleteNode(e){let t=e.detail.item;this.manifest=s.cmsSiteEditor.instance.manifest,this.manifest.items=e.detail,console.log(e.detail),this.manifest.items.forEach(((e,i)=>{e.id===t.id&&this.splice("manifest.items",i,1)})),s.toast(`${t.title} deleted`),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async createNode(e){let t=e.detail.values;this.manifest=s.cmsSiteEditor.instance.manifest,this.manifest.items=e.detail,this.manifest.items.forEach(((e,i)=>{if(void 0===e.location){t.id||(t.id=l("item-")),t.location||(t.location="pages/"+t.id+"/index.html");t.location.replace("/index.html","");e.id=t.id,e.location=t.location,e.slug=t.title,e.order=t.order,e.indent=t.indent,e.parent=t.parent,e.description=t.description,e.metadata.created=Math.floor(Date.now()/1e3),e.metadata.updated=Math.floor(Date.now()/1e3),this.manifest.items[i]=e}})),s.toast(`${t.title} created!`),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}async saveManifest(e){if(this.manifest=e.detail,"string"==typeof this.manifest.metadata.theme){const e={"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@lrnwebcomponents/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"},"outline-player":{element:"outline-player",path:"@lrnwebcomponents/outline-player/outline-player.js",name:"Outline player"},"simple-blog":{element:"simple-blog",path:"@lrnwebcomponents/simple-blog/simple-blog.js",name:"Simple blog"}};e[this.manifest.metadata.theme]&&(this.manifest.metadata.theme=e[this.manifest.metadata.theme])}s.toast("Site details saved!"),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("haxcms-trigger-update",{bubbles:!0,composed:!0,cancelable:!1,detail:!0})),s.cmsSiteEditor.instance.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:this.manifest}))}_jwtTokenFired(e){this.jwt=e.detail,s.jwt=this.jwt,s.cmsSiteEditor&&s.cmsSiteEditor.instance&&(s.cmsSiteEditor.instance.jwt=this.jwt)}disconnectedCallback(){for(var e in this.__disposer)this.__disposer[e].dispose();this.windowControllers.abort(),super.disconnectedCallback()}async connectedCallback(){super.connectedCallback();let e=await fetch(new URL("../../../../hax-cloud/lib/appstore.json",import.meta.url).href).then((e=>e.json()));try{import("../haxcms-site-editor.js").then((t=>{s.cmsSiteEditorAvailability(),s.cmsSiteEditor.instance.jwt=this.jwt,s.cmsSiteEditor.instance.appStore=e}),(e=>{}))}catch(e){}}}customElements.define(HAXCMSBackendUserfs.tag,HAXCMSBackendUserfs);export{HAXCMSBackendUserfs};