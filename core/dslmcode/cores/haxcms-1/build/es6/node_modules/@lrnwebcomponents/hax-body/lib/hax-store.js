import{LitElement as e,html as t,css as i}from"../../../lit-element/lit-element.js";import{winEventsElement as o,getRange as a,encapScript as n,wipeSlot as r,stripMSWord as s}from"../../utils/utils.js";import{HAXElement as l}from"../../hax-body-behaviors/hax-body-behaviors.js";class HaxStore extends(o(l(e))){static get styles(){return[i`
        :host {
          display: none;
        }
      `]}render(){return t`
      <slot></slot>
      <undoer-element></undoer-element>
      <iron-ajax
        id="appstore"
        url="${this.appStore.url}"
        .params="${this.appStore.params}"
        method="GET"
        content-type="application/json"
        handle-as="json"
        @last-response-changed="${this.__appStoreDataChanged}"
      ></iron-ajax>
      <hal-9000
        id="hal"
        .responds-to="${this.voiceRespondsTo}"
        .debug="${this.voiceDebug}"
      ></hal-9000>
    `}__appStoreDataChanged(e){this.__appStoreData=e.detail.value}static get tag(){return"hax-store"}static get properties(){return{...super.properties,openDrawer:{type:Object},voiceDebug:{type:Boolean,attribute:"voice-debug"},activeGizmo:{type:Object},voiceRespondsTo:{type:String,attribute:"voice-responses-to"},skipHAXConfirmation:{type:Boolean,reflect:!0,attribute:"skip-hax-confirmation"},storageData:{type:Object},haxTray:{type:Object},haxAppPicker:{type:Object},haxStaxPicker:{type:Object},haxBloxPicker:{type:Object},haxAutoloader:{type:Object},haxBodies:{type:Array},activePlaceHolder:{type:Object},activeHaxBody:{type:Object},appStore:{type:Object},haxToast:{type:Object},haxExport:{type:Object},haxPreferences:{type:Object},activeNode:{type:Object},activeContainerNode:{type:Object},sessionObject:{type:Object},editMode:{type:Boolean},skipExitTrap:{type:Boolean},gizmoList:{type:Array},elementList:{type:Object},appList:{type:Array},staxList:{type:Array},bloxList:{type:Array},globalPreferences:{type:Object},activeApp:{type:Object},validTagList:{type:Array},validGizmoTypes:{type:Array},_isSandboxed:{type:Boolean},__appStoreData:{type:Object},__ready:{type:Boolean},connectionRewrites:{type:Object}}}_storageDataChanged(e){e&&window.HaxStore.ready&&this.__storageDataProcessed&&(window.localStorage.getItem("haxConfirm")?window.localStorage.setItem("haxUserData",JSON.stringify(e)):window.sessionStorage.getItem("haxConfirm")&&window.sessionStorage.setItem("haxUserData",JSON.stringify(e)))}isTextElement(e){let t;return null!=e&&e.tagName?t=e.tagName.toLowerCase():null!=e&&e.tag&&(t=e.tag.toLowerCase()),!!(t&&this.validTagList.includes(t)&&["p","ol","ul","li","a","h1","h2","h3","h4","h5","h6","strike","u","b","sub","sup","span","i","bold","em","strong","blockquote","code","figure"].includes(t))}isGridPlateElement(e){let t;return e&&e.tagName?t=e.tagName.toLowerCase():e&&e.tag&&(t=e.tag.toLowerCase()),!!(t&&this.validTagList.includes(t)&&["p","ol","ul","li","div","h1","h2","h3","h4","h5","h6","blockquote","code","figure","grid-plate"].includes(t))}_appStoreChanged(e,t){void 0!==e&&null!=e&&void 0!==t&&(void 0===e.apps&&this.shadowRoot&&this.shadowRoot.querySelector("#appstore")&&this.shadowRoot.querySelector("#appstore").generateRequest?this.shadowRoot.querySelector("#appstore").generateRequest():this.__appStoreData=e)}_loadAppStoreData(e,t,i){if(e&&void 0!==t&&null!=t){var o={};if(void 0!==t.autoloader)for(var a in t.autoloader=Object.assign({},t.autoloader),t.autoloader){let e=a,i=t.autoloader[a];isNaN(e)||(e=t.autoloader[a],i=`@lrnwebcomponents/${e}/${e}.js`),this.validTagList.push(e),o[e]=i}if(void 0!==t.apps){var n=t.apps;for(a=0;a<n.length;a++){let e=document.createElement("hax-app");e.data=n[a],window.HaxStore.instance.appendChild(e)}}if(void 0!==t.stax){var r=t.stax;for(a=0;a<r.length;a++){let e=document.createElement("hax-stax");e.data=r[a],window.HaxStore.instance.appendChild(e)}}if(void 0!==t.blox){var s=t.blox;for(a=0;a<s.length;a++){let e=document.createElement("hax-blox");e.data=s[a],window.HaxStore.instance.appendChild(e)}}this.dispatchEvent(new CustomEvent("hax-store-app-store-loaded",{bubbles:!0,cancelable:!0,composed:!0,detail:!0})),this._handleDynamicImports(o,i)}}pathFromUrl(e){return e.substring(0,e.lastIndexOf("/")+1)}async _handleDynamicImports(e,t){const i=this.pathFromUrl(decodeURIComponent(import.meta.url));for(var o in e)if(window.customElements.get(o)){let e=window.customElements.get(o);"function"==typeof e.getHaxProperties?this.setHaxProperties(e.getHaxProperties(),o):"function"==typeof e.HAXWiring?this.setHaxProperties(e.HAXWiring.getHaxProperties(),o):e.haxProperties?this.setHaxProperties(e.haxProperties,o):t.appendChild(document.createElement(o))}else await import(`${i}../../../${e[o]}`).then(e=>{for(var i in e){let a=e[i];"function"==typeof a.getHaxProperties?this.setHaxProperties(a.getHaxProperties(),o):"function"==typeof a.HAXWiring?this.setHaxProperties(a.HAXWiring.getHaxProperties(),o):a.haxProperties?this.setHaxProperties(a.haxProperties,o):t.appendChild(document.createElement(o))}}).catch(e=>{console.warn(e)})}_editModeChanged(e){e&&this.globalPreferences.haxVoiceCommands?this.__hal.auto=!0:this.__hal.auto=!1}_globalPreferencesChanged(e,t){if(this.__storageDataProcessed&&e&&void 0!==e.haxVoiceCommands&&window.HaxStore.ready){let t=this.storageData;t.globalPreferences=e,this.storageData=t,this._storageDataChanged(this.storageData),e.haxVoiceCommands&&this.editMode?this.__hal.auto=!0:this.__hal.auto=!1}}_haxContextOperation(e){let t=e.detail;if(this.activeNode){let e=!1;switch(t.eventName){case"hax-align-left":this.activeNode.style.float=null,this.activeNode.style.margin=null,this.activeNode.style.display=null,e=!0;break;case"hax-align-center":this.activeNode.style.float=null,this.activeNode.style.margin="0 auto",this.activeNode.style.display="block",e=!0;break;case"hax-align-right":this.activeNode.style.float="right",this.activeNode.style.margin="0 auto",this.activeNode.style.display="block",e=!0;break;case"hax-size-change":100==t.value?this.activeNode.style.width=null:this.activeNode.style.width=t.value+"%",e=!0}e&&setTimeout(()=>{this.activeHaxBody.positionContextMenus()},0)}}_haxConsentTap(e){window.localStorage.setItem("haxConfirm",!0),window.localStorage.setItem("haxUserData",JSON.stringify(this.storageData))}updated(e){let t=!1;e.forEach((e,i)=>{"openDrawer"==i&&this.openDrawersCallback(this[i],e),"appStore"==i&&this._appStoreChanged(this[i],e),"globalPreferences"==i&&this._globalPreferencesChanged(this[i],e),"editMode"==i&&this._editModeChanged(this[i],e),"activeNode"==i&&(this.activeGizmo=this._calculateActiveGizmo(this[i]),window.HaxStore.write("activeGizmo",this.activeGizmo,this)),["__ready","__appStoreData","haxAutoloader"].includes(i)&&(t=!0),["haxAutoloader","activeHaxBody","haxToast","haxExport","haxPreferences","haxAppPicker","haxTray"].includes(i)&&this._storePiecesAllHere(this.haxAutoloader,this.activeHaxBody,this.haxToast,this.haxExport,this.haxPreferences,this.haxAppPicker,this.haxTray)}),t&&this._loadAppStoreData(this.__ready,this.__appStoreData,this.haxAutoloader)}_calculateActiveGizmo(e){if(null==e)return null;for(var t in this.gizmoList){var i=this.gizmoList[t];if(i.tag===e.tagName.toLowerCase())return i}}firstUpdated(e){if(import("../../../@polymer/iron-ajax/iron-ajax.js").then(e=>{this.shadowRoot.querySelector("#appstore")&&this.shadowRoot.querySelector("#appstore").generateRequest()}),import("../../hal-9000/hal-9000.js").then(e=>{this.__hal=this.shadowRoot.querySelector("#hal")}),setTimeout(()=>{this.__storageDataProcessed=!0,this.storageData.globalPreferences&&window.HaxStore.write("globalPreferences",this.storageData.globalPreferences,this)},100),this.skipHAXConfirmation&&(window.sessionStorage.setItem("haxConfirm",!0),window.localStorage.setItem("haxConfirm",!0)),window.sessionStorage.getItem("haxConfirm")||window.localStorage.getItem("haxConfirm"))if(window.sessionStorage.getItem("haxConfirm")&&!window.localStorage.getItem("haxConfirm"))try{let e=window.sessionStorage.getItem("haxUserData")?JSON.parse(window.sessionStorage.getItem("haxUserData")):{};this.storageData=e,this._storageDataChanged(this.storageData)}catch(e){}else try{let e=window.localStorage.getItem("haxUserData")?JSON.parse(window.localStorage.getItem("haxUserData")):{};this.storageData=e,this._storageDataChanged(this.storageData)}catch(e){}else{window.sessionStorage.setItem("haxConfirm",!0);let e="\n    The HAX content editor keeps preferences in order to improve your experience.\n    This data is stored in your browser and is never sent anywhere.\n    Click to accept.\n    ";window.HaxStore.toast(e,"-1","fit-bottom","I Accept","hax-consent-tap")}}_storePiecesAllHere(e,t,i,o,a,n,r){!this.__ready&&t&&e&&i&&o&&a&&n&&r&&(this.dispatchEvent(new CustomEvent("hax-store-ready",{bubbles:!0,cancelable:!1,composed:!0,detail:!0})),window.HaxStore.ready=!0,this.__ready=!0,this._buildPrimitiveDefinitions(),this._initVoiceCommands(),this.__hal.commands={...this.voiceCommands})}_initVoiceCommands(){this.__voiceInit=!0,this.voiceCommands[`scroll up ${this.voiceRespondsTo}`]=()=>{window.scrollBy({top:-.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands[`scroll (down) ${this.voiceRespondsTo}`]=()=>{window.scrollBy({top:.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands[`scroll to bottom ${this.voiceRespondsTo}`]=()=>{window.scrollTo(0,document.body.scrollHeight)},this.voiceCommands[`scroll to top ${this.voiceRespondsTo}`]=()=>{window.scrollTo(0,0)},this.voiceCommands[`${this.voiceRespondsTo} (show)(focus) active (element)(content)`]=()=>{try{this._positionCursorInNode(this.activeNode)}catch(e){}},this.voiceCommands[`${this.voiceRespondsTo} (focus) previous (element)(content)`]=()=>{this.activeNode.previousElementSibling?(this.activeNode=this.activeNode.previousElementSibling,window.HaxStore.write("activeNode",this.activeNode,this),this.activeContainerNode=this.activeNode,window.HaxStore.write("activeContainerNode",this.activeNode,this),this._positionCursorInNode(this.activeNode)):this.speak("You are at the top of the document")},this.voiceCommands[`${this.voiceRespondsTo} (focus) next (element)(content)`]=()=>{this.activeNode.nextElementSibling?(this.activeNode=this.activeNode.nextElementSibling,window.HaxStore.write("activeNode",this.activeNode,this),this.activeContainerNode=this.activeNode,window.HaxStore.write("activeContainerNode",this.activeNode,this),this._positionCursorInNode(this.activeNode)):this.speak("You are at the bottom of the document")},this.voiceCommands[`${this.voiceRespondsTo} type *mycontent`]=e=>{if(window.HaxStore.instance.isTextElement(this.activeNode))try{let t=this._positionCursorInNode(this.activeNode),i=document.createTextNode(e);t.deleteContents(),t.insertNode(i)}catch(e){this.speak("That didn't work"),console.warn(e)}else this.speak("I'm sorry but I can only type in text areas. Try saying Insert Paragraph and try again.")},this.voiceCommands[`hey ${this.voiceRespondsTo}`]=()=>{this.speak("Yeah what do you want")},this.voiceCommands[`${this.voiceRespondsTo} now your name is *splat`]=e=>{const t=this.voiceRespondsTo;this.speak(`I used to be named ${t} but you can call me ${e} now.`),this.voiceRespondsTo=`(${e})`},this.voiceCommands[`${this.voiceRespondsTo} close`]=()=>{window.HaxStore.write("openDrawer",!1,this)}}speak(e){this.__hal&&this.__hal.speak&&this.__hal.speak(e),window.HaxStore.toast(`${this.voiceRespondsTo}: ${e}`)}addVoiceCommand(e,t,i){e=e.replace(":name:",this.voiceRespondsTo).toLowerCase(),this.voiceCommands[e]=t[i].bind(t),this.__voiceInit&&(this.__hal.commands={...this.voiceCommands})}_addVoiceCommand(e){this.addVoiceCommand(e.detail.command,e.detail.context,e.detail.callback)}_positionCursorInNode(e,t=0){this.activeHaxBody.positionContextMenus();var i=document.createRange(),o=window.HaxStore.getSelection();return i.setStart(e,t),i.collapse(!0),o.removeAllRanges(),o.addRange(i),i}_onBeforeUnload(e){if(!window.HaxStore.instance.skipExitTrap&&window.HaxStore.instance.editMode)return"Are you sure you want to leave? Your work will not be saved!"}_onPaste(e){if(window.HaxStore.instance.isTextElement(window.HaxStore.instance.activeNode)){let o="";e.clipboardData||e.originalEvent.clipboardData?o=(e.originalEvent||e).clipboardData.getData("text/html"):window.clipboardData&&(o=window.clipboardData.getData("Text"));var t=o.replace(/(class=(")?Mso[a-zA-Z]+(")?)/g,"");let a=!1,n="";o!=(t=t.replace("mso-style-",""))&&(a=!0),o=o.replace(/<span>\s*?<\/span>/g," "),o=o.replace(/<div/g,"<p"),o=o.replace(/<\/div>/g,"</p>"),o=s(o);let r=window.HaxStore.htmlToHaxElements(o);if(0===r.length){if(!a)return!1;n=o}else{if(1===r.length&&"p"===r[0].tag)return!1;if(!this.isGridPlateElement(r[0]))return!1;for(var i in r){delete r[i].properties.style,delete r[i].properties.start,delete r[i].properties.align;let e=window.HaxStore.haxElementToNode(r[i].tag,r[i].content.replace(/<span>&nbsp;<\/span>/g," ").trim(),r[i].properties);n+=window.HaxStore.nodeToContent(e)}}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();try{let e=window.HaxStore.getRange(),t=window.HaxStore.getSelection(),i=document.createElement("div");if(i.innerHTML=n,e&&t&&"function"==typeof e.deleteContents)for(e.deleteContents();i.lastChild;)e.insertNode(i.lastChild)}catch(e){console.warn(e)}}}__validTags(){return["p","div","span","table","caption","sup","sub","u","strike","tr","th","td","ol","ul","li","a","strong","kbd","em","i","b","hr","h1","h2","h3","h4","h5","h6","blockquote","code","figure","img","iframe","video","audio","section","grid-plate","template","webview"]}__validGizmoTypes(){return["data","video","audio","text","link","file","pdf","image","csv","doc","archive","markdown","html","wikipedia","content","text","inline","*"]}constructor(){super(),this.__winEvents={"hax-register-properties":"_haxStoreRegisterProperties","hax-consent-tap":"_haxConsentTap","hax-context-item-selected":"_haxContextOperation",onbeforeunload:"_onBeforeUnload",paste:"_onPaste","hax-register-app":"_haxStoreRegisterApp","hax-register-stax":"_haxStoreRegisterStax","hax-register-blox":"_haxStoreRegisterBlox","hax-store-write":"_writeHaxStore","hax-register-core-piece":"_haxStorePieceRegistrationManager","hax-register-body":"_haxStoreRegisterBody","hax-insert-content":"_haxStoreInsertContent","hax-insert-content-array":"_haxStoreInsertMultiple","hax-add-voice-command":"_addVoiceCommand"},this.voiceRespondsTo="(worker)",this.voiceCommands={},this.skipHAXConfirmation=!1,this.storageData={},this.appStore={url:"",params:{}},this.activeContainerNode=null,this.activeNode=null,this.haxBodies=[],this.activePlaceHolder=null,this.sessionObject={},this.editMode=!1,this.skipExitTrap=!1,this.gizmoList=[],this.elementList={},this.appList=[],this.staxList=[],this.bloxList=[],this.globalPreferences={},this.activeApp={},this.connectionRewrites={},this.voiceDebug=!1,this.validTagList=this.__validTags(),this.validGizmoTypes=this.__validGizmoTypes();let e=document.createElement("webview");this._isSandboxed="function"==typeof e.reload,null==window.HaxStore.instance&&(window.HaxStore.instance=this),import("./hax-app.js"),import("../../../@polymer/polymer/lib/utils/settings.js").then(e=>{e.setPassiveTouchGestures(!0)}),import("../../simple-toast/simple-toast.js").then(()=>{this.haxToast=window.SimpleToast.requestAvailability()}),import("../../media-behaviors/media-behaviors.js"),document.body.style.setProperty("--hax-ui-headings","#d4ff77")}_buildPrimitiveDefinitions(){if(window.HaxStore.instance._isSandboxed){let e={canScale:!0,canPosition:!0,canEditSource:!1,settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[]}};this.setHaxProperties(e,"webview")}this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Basic iframe",description:"A basic iframe",icon:"icons:fullscreen",color:"blue-grey",groups:["Content"],handles:[{type:"link",source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]}},"iframe");this.setHaxProperties({canScale:{min:10,step:5},canPosition:!0,canEditSource:!0,gizmo:{title:"Image",description:"A basic img tag",icon:"image:image",color:"blue-grey",groups:["Image","Media"],handles:[{type:"link",source:"src"},{type:"image",type_exclusive:!0,source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{quick:[{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item. Leave blank to respond to the natural resolution",inputMethod:"textfield",icon:"icons:swap-vert"}],configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"haxupload",icon:"link",required:!0,validationType:"url"},{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item. Leave blank to respond to the natural resolution",inputMethod:"textfield",icon:"icons:swap-vert"}],advanced:[{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]}},"img");let e={canScale:!1,canPosition:!1,canEditSource:!0,gizmo:{title:"Basic link",description:"A basic a tag",icon:"icons:link",color:"blue-grey",groups:["Link"],handles:[],meta:{author:"W3C",hidden:!0}},settings:{quick:[{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"textfield",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"}],configure:[{attribute:"innerText",title:"Text",description:"Text of the link",inputMethod:"textfield",required:!0},{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"haxupload",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"},{attribute:"target",title:"Target",description:"Where to place the link.",inputMethod:"select",icon:"icons:launch",options:{"":"Same window",_blank:"New window",_top:"Top window",_parent:"Parent window"}}],advanced:[]}};this.validGizmoTypes.forEach(t=>{e.gizmo.handles.push({type:t,source:"href",title:"innerText",alt:"title"})}),this.setHaxProperties(e,"a");this.setHaxProperties({canScale:!1,canPosition:!1,canEditSource:!0,gizmo:{title:"Paragraph",description:"A basic text area",icon:"hax:paragraph",color:"blue-grey",groups:["Text"],handles:[{type:"content",content:""}],meta:{author:"W3C",hidden:!0}},settings:{quick:[],configure:[],advanced:[]}},"p");this.setHaxProperties({canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Table",description:"A table for displaying data",icon:"image:grid-on",color:"blue-grey",groups:["Text"],meta:{author:"W3C"}},settings:{quick:[],configure:[{slot:"",title:"Body",description:"Tags that make up the table",inputMethod:"code-editor",slotWrapper:""}],advanced:[]}},"table");let t={caption:{title:"Caption",icon:"av:call-to-action"},video:{title:"Video",icon:"av:play-circle-filled"},audio:{title:"Audio",icon:"image:music-note"},section:{title:"Section",icon:"image:crop-landscape"},ol:{title:"Numbered list",icon:"editor:format-list-numbered"},ul:{title:"Bulleted list",icon:"editor:format-list-bulleted"},li:{title:"List item",icon:"editor:format-list-bulleted"},h1:{title:"Heading",icon:"hax:h1"},h2:{title:"Heading",icon:"hax:h2"},h3:{title:"Heading",icon:"hax:h3"},h4:{title:"Heading",icon:"hax:h4"},h5:{title:"Heading",icon:"hax:h5"},h6:{title:"Heading",icon:"hax:h6"},strike:{title:"Cross out",icon:"editor:format-strikethrough"},u:{title:"Underline",icon:"editor:format-underlined"},sub:{title:"Subscript",icon:"mdextra:subscript"},sup:{title:"Superscript",icon:"mdextra:superscript"},div:{title:"DIV",icon:"image:crop-landscape"},span:{title:"SPAN",icon:"editor:short-text"},i:{title:"Italic",icon:"editor:format-italic"},em:{title:"Emphasis",icon:"editor:format-italic"},strong:{title:"Bold",icon:"editor:format-bold"},b:{title:"Bold",icon:"editor:format-bold"},blockquote:{title:"Block quote",icon:"editor:format-quote"},code:{title:"Code",icon:"icons:code"},figure:{title:"Figure",icon:"icons:label-outline"},embed:{title:"Embedded object",icon:"icons:fullscreen"}};for(var i in t)this.setHaxProperties({canScale:!1,canPosition:!1,canEditSource:!0,gizmo:{title:t[i].title,icon:t[i].icon,meta:{hidden:!0}},settings:{quick:[],configure:[],advanced:[]}},i);this.setHaxProperties({canScale:{min:25,step:25},gizmo:{title:"Horizontal line",icon:"hax:hr",meta:{hidden:!0}},canPosition:!1,canEditSource:!1,settings:{quick:[],configure:[],advanced:[]}},"hr")}_haxStorePieceRegistrationManager(e){e.detail&&e.detail.piece&&e.detail.object&&(this[e.detail.piece]=e.detail.object)}openDrawersCallback(e=!1,t){let i=["haxAppPicker","haxPreferences","haxExport"];for(var o in i)e===this[i[o]]?(e.open(),setTimeout(()=>{null!=e.querySelector("paper-checkbox,paper-input,textarea,paper-button,hax-tray-button")&&e.querySelector("paper-checkbox,paper-input,textarea,paper-button,hax-tray-button").focus();var t=document.createEvent("UIEvents");t.initUIEvent("resize",!0,!1,window,0),window.dispatchEvent(t)},325)):this[i[o]].close()}_haxStoreInsertContent(e){if(e.detail){let i=e.detail;if(window.customElements.get(i.tag)){let e=Object.getPrototypeOf(document.createElement(i.tag));void 0!==e.preProcessHaxInsertContent&&(i=e.preProcessHaxInsertContent(i))}var t={};if(void 0!==i.properties&&(t=i.properties),t.innerHTML&&(""==i.content&&(i.content=t.innerHTML),delete t.innerHTML),t.innerText&&(""==i.content&&(i.content=t.innerText),delete t.innerText),this.activeHaxBody.__activeHover=null,i.replace&&i.replacement){let e=window.HaxStore.haxElementToNode(i.tag,i.content,t);this.activePlaceHolder?(this.activeHaxBody.haxReplaceNode(this.activePlaceHolder,e),this.activePlaceHolder=null):this.activeHaxBody.haxReplaceNode(this.activeNode,e)}else if(void 0!==i.__type&&"inline"===i.__type){let e=window.HaxStore.haxElementToNode(i.tag,i.content,t);null!==this.activePlaceHolder&&(this.activePlaceHolder.deleteContents(),this.activePlaceHolder.insertNode(e)),this.activePlaceHolder=null}else if(null!=this.activeContainerNode){let e=window.HaxStore.haxElementToNode(i.tag,i.content,t);this.activeContainerNode&&"GRID-PLATE"===this.activeContainerNode.tagName?(null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),this.activeHaxBody.haxInsert(i.tag,i.content,t,!1),this.activeHaxBody.shadowRoot.querySelector("#textcontextmenu").highlightOps=!1):this.activeHaxBody.haxInsert(i.tag,i.content,t,!1)}else this.activeHaxBody.haxInsert(i.tag,i.content,t,!1);setTimeout(()=>{let e=this.gizmoList;for(var t in e){if(e[t].tag===i.tag){let i=e[t];delete e[t],this.gizmoList.unshift(i)}}this.gizmoList=[...e],window.HaxStore.write("gizmoList",e,this)},10)}}_haxStoreInsertMultiple(e){var t;if(e.detail)for(var i in e.detail)t={},void 0!==e.detail[i].properties&&(t=e.detail[i].properties),this.activeHaxBody.haxInsert(e.detail[i].tag,e.detail[i].content,t,!1)}_haxStoreRegisterBody(e){e.detail&&(this.haxBodies.push(e.detail),this.activeHaxBody=e.detail,window.HaxStore.write("activeHaxBody",this.activeHaxBody,this),window.HaxStore.write("editMode",this.editMode,this))}computePolyfillSafe(){return!(!document.head.createShadowRoot&&!document.head.attachShadow)||(console.warn("Shadow DOM missing, certain operations hidden"),!1)}_writeHaxStore(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&e.detail.owner&&(null==e.detail.value?this[e.detail.property]=null:"object"==typeof e.detail.value&&(this[e.detail.property]={}),this[e.detail.property]=e.detail.value,this.dispatchEvent(new CustomEvent("hax-store-property-updated",{bubbles:!0,composed:!0,cancelable:!1,detail:{property:e.detail.property,value:e.detail.value,owner:e.detail.owner}})))}_haxStoreRegisterApp(e){if(e.detail){if(e.detail.index=this.appList.length,this.appList=[...this.appList,e.detail],window.HaxStore.write("appList",this.appList,this),e.detail.connection&&e.detail.connection.protocol&&e.detail.connection.url){let t=document.createElement("link");t.rel="preconnect",t.href=e.detail.connection.protocol+"://"+e.detail.connection.url,document.head.appendChild(t)}void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target)}}_haxStoreRegisterStax(e){e.detail&&(e.detail.index=this.staxList.length,this.staxList=[...this.staxList,e.detail],window.HaxStore.write("staxList",this.staxList,this),void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target))}_haxStoreRegisterBlox(e){e.detail&&(e.detail.index=this.bloxList.length,this.bloxList=[...this.bloxList,e.detail],window.HaxStore.write("bloxList",this.bloxList,this),void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target))}_haxStoreRegisterProperties(e){if(e.detail&&e.detail.properties&&e.detail.tag){if(void 0===this.elementList[e.detail.tag]){let t=e.detail.properties.gizmo;if(t){t.tag=e.detail.tag;let i=this.gizmoList;i.push(t),window.HaxStore.write("gizmoList",i,this)}this.elementList[e.detail.tag]=e.detail.properties,this.validTagList.find(t=>t===e.detail.tag)||this.validTagList.push(e.detail.tag)}void 0!==e.target.parentElement&&"HAX-AUTOLOADER"===e.target.parentElement.tagName&&this.haxAutoloader.removeChild(e.target)}}}window.customElements.define(HaxStore.tag,HaxStore),window.HaxStore=window.HaxStore||{},window.HaxStore.instance=null,window.HaxStore.requestAvailability=function(){return window.HaxStore.instance||(window.HaxStore.instance=document.createElement("hax-store"),document.body.appendChild(window.HaxStore.instance)),window.HaxStore.instance},window.HaxStore.toArray=e=>Object.keys(e).map((function(t){return e[t]})),window.HaxStore.camelToDash=e=>e.replace(/\W+/g,"-").replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase(),window.HaxStore.dashToCamel=e=>e.replace(/-([a-z])/g,(function(e){return e[1].toUpperCase()})),window.HaxStore.htmlToHaxElements=e=>{let t=[];const i=window.HaxStore.instance.validTagList;let o=document.createElement("div");o.innerHTML=e;const a=o.childNodes;for(var n=0;n<a.length;n++)void 0!==a[n].tagName&&i.includes(a[n].tagName.toLowerCase())&&t.push(window.HaxStore.nodeToHaxElement(a[n],null));return t},window.HaxStore.nodeToHaxElement=(e,t="insert-element")=>{if(!e)return null;var i={};let o;if(void 0!==e.style&&(i.style=e.getAttribute("style")),null!==i.style&&"null"!==i.style||delete i.style,void 0!==e.attributes.class&&(i.class=e.attributes.class.nodeValue.replace("hax-active","")),void 0!==e.attributes.id&&(i.id=e.getAttribute("id")),customElements.get(e.tagName.toLowerCase())&&(o=customElements.get(e.tagName.toLowerCase()).properties),void 0===o&&(o=e.__data),void 0!==o){for(var a in o)"class"!=a&&"style"!=a&&o.hasOwnProperty(a)&&void 0!==typeof e[a]&&null!=e[a]&&""!=e[a]?i[a]=e[a]:!1===e[a]&&(i[a]=e[a]);for(var n in e.attributes)void 0!==e.attributes[n].name&&"class"!=e.attributes[n].name&&"style"!=e.attributes[n].name&&"id"!=e.attributes[n].name&&e.attributes.hasOwnProperty(n)&&void 0!==typeof e.attributes[n].value&&null!=e.attributes[n].value&&""!=e.attributes[n].value&&!o.hasOwnProperty(window.HaxStore.dashToCamel(e.attributes[n].name))&&(i[window.HaxStore.dashToCamel(e.attributes[n].name)]=e.attributes[n].value)}else for(var n in e.attributes)void 0!==e.attributes[n].name&&"class"!=e.attributes[n].name&&"style"!=e.attributes[n].name&&"id"!=e.attributes[n].name&&e.attributes.hasOwnProperty(n)&&void 0!==typeof e.attributes[n].value&&null!=e.attributes[n].value&&""!=e.attributes[n].value&&(i[window.HaxStore.dashToCamel(e.attributes[n].name)]=e.attributes[n].value);let r=e.tagName.toLowerCase();window.HaxStore.instance._isSandboxed&&"iframe"===r&&(r="webview");let s=window.HaxStore.getHAXSlot(e);""==s&&(s=e.innerText),"a"===r?i.innerText=s:"p"!==r&&"table"!==r&&"ol"!==r&&"ul"!==r&&"div"!==r||(i.innerHTML=s);let l={tag:r,properties:i,content:s};return null!==t&&(l.eventName=t),l},window.HaxStore.haxElementToNode=(e,t,i)=>{window.HaxStore.instance._isSandboxed&&"iframe"===e&&(e="webview");var o=document.createElement(e);o.innerHTML=t;var a=o.cloneNode(!0);for(var n in i){let e=window.HaxStore.camelToDash(n);i.hasOwnProperty(n)&&(!0===i[n]?a.setAttribute(e,i[n]):!1===i[n]?a.removeAttribute(e):null!=i[n]&&i[n].constructor===Array?o.properties&&o.properties[n]&&o.properties[n].readOnly||(a.set?a.set(e,i[n]):a[e]=[...i[n]]):null!=i[n]&&i[n].constructor===Object?o.properties&&o.properties[n]&&o.properties[n].readOnly||(a.set?a.set(e,i[n]):a[e]={...i[n]}):a.setAttribute(e,i[n]))}return a},window.HaxStore.nodeToContent=e=>{let t=Object.getPrototypeOf(e);void 0!==t.preProcessHaxNodeToContent&&(e=t.preProcessHaxNodeToContent(e));let i=e.tagName.toLowerCase();window.HaxStore.instance._isSandboxed&&"webview"===i&&(i="iframe");var o="";o+="<"+i;for(var a=window.HaxStore.instance.elementList[i],n={},r=0,s=e.attributes.length;r<s;++r){var l=e.attributes.item(r).nodeName,d=e.attributes.item(r).value;"style"==l||typeof d!=typeof Object&&d.constructor!==Array?null!=d&&"null"!=d&&(!0===d||"true"===d?n[l]=!0:!1===d||("string"==typeof d&&""!==d?(d=d.replace(new RegExp('"',"g"),"&quot;"),n[l]=d):""===d?(""==d&&""!=e.attributes.item(r).value&&(d=e.attributes.item(r).value),n[l]=d):n[l]=d)):n[l]=JSON.stringify(d).replace(new RegExp('"',"g"),"&quot;")}let c;if(customElements.get(i)&&(c=customElements.get(i).properties),void 0===c&&(c=e.__data),void 0!==c)for(var r in c){l=window.HaxStore.camelToDash(r),d=null;void 0!==e[r]&&(d=e[r]),c[r].readOnly||c[r].computed||d===c[r].value||l.startsWith("__")||(null==d||"object"!=typeof d&&d.constructor!==Array?null!=d&&"null"!=d&&(!0===d||"true"===d?n[l]=!0:!1===d||("string"==typeof d&&""!==d?(d=d.replace(new RegExp('"',"g"),"&quot;"),n[l]=d):""===d?""==d&&""!=c[r].value?d=c[r].value:""===d&&c[r].value:n[l]=d)):d.constructor===Array&&d!=[]?n[l]=JSON.stringify(d).replace(new RegExp('"',"g"),"&quot;"):"object"==typeof d&&d!={}&&(n[l]=JSON.stringify(d).replace(new RegExp('"',"g"),"&quot;")))}if(void 0!==a&&void 0!==a.saveOptions.unsetAttributes)for(var h in a.saveOptions.unsetAttributes)delete n[a.saveOptions.unsetAttributes[h]];let p=["inner-text","inner-html","tabindex","guestinstance"];for(var u in p)void 0!==n[p[u]]&&delete n[p[u]];for(var h in void 0!==n.id&&""===n.id&&delete n.id,n)!0===n[h]?o+=" "+h:o+=" "+h+'="'+n[h]+'"';if(["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"].includes(i)?o+="/>":o+=">",void 0===a||!a.saveOptions.wipeSlot){let t=e.childNodes;if(t.length>0){r=0;for(var m=t.length;r<m;r++)void 0!==t[r].tagName?window.HaxStore.HTMLPrimativeTest(t[r].tagName)||"TEMPLATE"===t[r].tagName?(t[r].setAttribute("data-editable",!1),t[r].removeAttribute("data-hax-ray"),t[r].contentEditable=!1,o+=t[r].outerHTML):o+=window.HaxStore.nodeToContent(t[r]):8===t[r].nodeType?o+="\x3c!-- "+t[r].textContent+" --\x3e":1!==t[r].nodeType&&void 0!==t[r].textContent&&"undefined"!==t[r].textContent&&(o+=t[r].textContent)}}return"function"==typeof e.haxProgressiveEnhancement&&(o+=e.haxProgressiveEnhancement()),"span"===i?o+="</"+i+">":"hr"===i||"br"===i||"img"===i||(o+="</"+i+">\n"),o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=o.replace(/&nbsp;/gm," ")).replace(/ data-editable="(\s|.)*?"/gim,"")).replace(/ data-hax-ray="(\s|.)*?"/gim,"")).replace(/ class=""/gim,"")).replace(/ class="hax-active"/gim,"")).replace(/ contenteditable="(\s|.)*?"/gim,"")).replace(/<span style="(.*?)">/gim,"<span>")).replace(/<span>\s*?<\/span>/g," ")).replace(/<span><br\/><\/span>/gm,"")).replace(/<strong style="(.*?)">/gim,"<strong>")).replace(/<b style="(.*?)">/gim,"<b>")).replace(/<strike style="(.*?)">/gim,"<strike>")).replace(/<em style="(.*?)">/gim,"<em>")).replace(/<i style="(.*?)">/gim,"<i>")).replace(/<p>(\s*)<\/p>/gm,"<p></p>")).replace(/<p>&nbsp;<\/p>/gm,"<p></p>")).replace(/<p><br\/><\/p>/gm,"<p></p>")).replace(/<p><br><\/p>/gm,"<p></p>")).replace(/<\/p>(\s*)<p>/gm,"</p><p>")).split("\n\r").join("\n").split("\r").join("\n").split("\n\n").join("\n").split("\n\n").join("\n").split("\n\n").join("\n"),"function"===e.postProcesshaxNodeToContent&&(o=e.postProcesshaxNodeToContent(o)),o},window.HaxStore.HTMLPrimativeTest=e=>void 0!==e.tagName&&-1==e.tagName.indexOf("-"),window.HaxStore.getHAXSlot=e=>{if(window.HaxStore.instance.isTextElement(e))return e.innerHTML;let t="";var i=e.childNodes;if(i.length>0)for(var o=0,a=i.length;o<a;o++)void 0!==i[o].tagName?i[o].tagName.indexOf("-")>0?t+="  "+window.HaxStore.nodeToContent(i[o])+"\n":t+="  "+i[o].outerHTML+"\n":8===i[o].nodeType?t+="\x3c!-- "+i[o].textContent+" --\x3e":1!==i[o].nodeType&&void 0!==i[o].textContent&&"undefined"!==i[o].textContent&&(t+=i[o].textContent);return t},window.HaxStore.write=(e,t,i)=>{i&&i.dispatchEvent(new CustomEvent("hax-store-write",{composed:!0,bubbles:!0,cancelable:!1,detail:{property:e,value:t,owner:i}}))},window.HaxStore.guessGizmoType=e=>{if(void 0!==e.source){const t=e.source.toLowerCase();return-1!=t.indexOf(".mp3")?"audio":-1!=t.indexOf(".png")||-1!=t.indexOf(".jpg")||-1!=t.indexOf(".jpeg")||-1!=t.indexOf(".gif")?"image":-1!=t.indexOf(".pdf")?"pdf":-1!=t.indexOf(".svg")?"svg":-1!=t.indexOf(".csv")?"csv":-1!=t.indexOf(".md")?"markdown":-1!=t.indexOf(".html")||-1!=t.indexOf(".htm")?"html":-1!=t.indexOf(".txt")||-1!=t.indexOf(".doc")||-1!=t.indexOf(".docx")||-1!=t.indexOf(".xls")||-1!=t.indexOf(".xlsx")||-1!=t.indexOf(".ppt")?"document":-1!=t.indexOf(".zip")||-1!=t.indexOf(".tar.gz")||-1!=t.indexOf(".tar")?"archive":"external"!=window.MediaBehaviors.Video.getVideoType(t)?"video":"*"}},window.HaxStore.guessGizmo=(e,t,i=!1,o=!1)=>{var a=[];if(void 0!==e){var n=window.HaxStore.instance;if(n.validGizmoTypes.includes(e))for(var r in n.gizmoList){let d=n.gizmoList[r],c={},h=!1;if(d.handles)for(var s=0;s<d.handles.length;s++)if(e===d.handles[s].type||"*"===e&&!h){for(var l in d.handles[s])"type"!==l&&void 0!==t[l]&&("inline"!==e&&d.meta&&(!d.meta||d.meta.inlineOnly||d.meta.hidden)||(h=!0,c[d.handles[s][l]]=t[l]));if(h||i){if(o&&d.handles[s].type_exclusive)return[window.HaxStore.haxElementPrototype(d,c,"")];a.push(window.HaxStore.haxElementPrototype(d,c,""))}}}}return a},window.HaxStore.getHaxAppStoreTargets=e=>window.HaxStore.instance.appList.filter(t=>{if(void 0!==t.connection.operations.add){let i=t.connection.operations.add;if(void 0!==i.acceptsGizmoTypes&&i.acceptsGizmoTypes.includes(e))return!0}return!1}),window.HaxStore.haxElementPrototype=(e,t,i="")=>({tag:e.tag,properties:t,content:i,gizmo:e}),window.HaxStore.wipeSlot=(e,t="")=>{r(e,t)},window.HaxStore.encapScript=e=>n(e),window.HaxStore.toast=(e,t=4e3,i="capsule",o=null,a=null)=>{const n=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:e,duration:t,classStyle:i,closeText:o,eventCallback:a}});window.dispatchEvent(n)},window.HaxStore.getSelection=()=>{if(window.HaxStore.instance.activeHaxBody.parentNode){if(window.HaxStore.instance.activeHaxBody.parentNode.getSelection)return window.HaxStore.instance.activeHaxBody.parentNode.getSelection();if(a(window.HaxStore.instance.activeHaxBody.parentNode))return a(window.HaxStore.instance.activeHaxBody.parentNode)}return window.getSelection()},window.HaxStore.getRange=()=>{let e=window.HaxStore.getSelection();return e.getRangeAt&&e.rangeCount?e.getRangeAt(0):e||void 0};import{Undoer as d}from"../../../undoer/undoer.js";class UndoerElement extends HTMLElement{static get observedAttributes(){return["state"]}constructor(){super(),this.openDrawer=!1,this._root=this.attachShadow({mode:"open"}),this._selfAttributeChange=!0,window.setTimeout(()=>{this._selfAttributeChange=!1});const e=this.getAttribute("state"),t=this.hasAttribute("state");this._undoer=new d(e=>{const{value:t,attr:i}=e;this._updateAttribute(i?t:null),this.dispatchEvent(new CustomEvent("state",{detail:t}))},{value:e,attr:t})}attributeChangedCallback(e,t,i){"state"!==e||this._selfAttributeChange||this._internalSet(i,!0)}set state(e){if(!this.isConnected)throw new Error("can't push state while disconnected");const t="string"==typeof e||"number"==typeof e;this._internalSet(e,t)}get state(){const{value:e}=this._undoer.data;return e}_updateAttribute(e){this._selfAttributeChange=!0;try{e?this.setAttribute("state",e):this.removeAttribute("state")}finally{this._selfAttributeChange=!1}}_internalSet(e,t){this._updateAttribute(t?e:null),this._undoer.push({value:e,attr:t},this._root)}}window.customElements.define("undoer-element",UndoerElement);export{HaxStore,UndoerElement};