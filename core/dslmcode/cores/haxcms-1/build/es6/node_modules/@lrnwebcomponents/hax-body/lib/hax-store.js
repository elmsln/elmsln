import{LitElement as e,html as t}from"../../../lit/index.js";import{SimpleTourManager as i}from"../../simple-popover/lib/simple-tour.js";import{winEventsElement as a,getRange as o,stripMSWord as n,nodeToHaxElement as s,haxElementToNode as r,validURL as l,camelToDash as d,htmlEntities as c,localStorageGet as h,localStorageSet as p}from"../../utils/utils.js";import{observable as m,makeObservable as u,computed as g,configure as v,autorun as x,toJS as f}from"../../../mobx/dist/mobx.esm.js";v({enforceActions:!1,useProxies:"ifavailable"});import{HAXElement as y}from"../../hax-body-behaviors/hax-body-behaviors.js";import{I18NMixin as b,I18NManagerStore as w}from"../../i18n-manager/lib/I18NMixin.js";import{enableServices as S}from"../../micro-frontend-registry/lib/microServices.js";import"../../media-behaviors/media-behaviors.js";import"../../simple-toast/simple-toast.js";import"../../editable-table/editable-table.js";import"../../iframe-loader/iframe-loader.js";import"./hax-app.js";function sessionStorageGet(e){try{return sessionStorage.getItem(e)}catch(e){return!1}}function sessionStorageSet(e,t){try{return sessionStorage.setItem(e,t)}catch(e){return!1}}const T={attribute:"data-style-decoration",title:"Decoration",description:"Some built in styles to offset the material",inputMethod:"select",options:{"":"","highlight red":"Highlight (red)","highlight blue":"Highlight (blue)","highlight green":"Highlight (green)","highlight orange":"Highlight (orange)","highlight purple":"Highlight (purple)"}};class HaxStore extends(b(a(y(e)))){testHook(e,t){return!!(e&&e.tagName&&this.HTMLPrimativeTest(e)&&this.primativeHooks[e.tagName.toLowerCase()]&&this.primativeHooks[e.tagName.toLowerCase()][t])||e&&"function"==typeof e.haxHooks&&e.haxHooks()[t]}async runHook(e,t,i=[]){return!!this.testHook(e,t)&&(this.HTMLPrimativeTest(e)?await this.primativeHooks[e.tagName.toLowerCase()][t](...i):await e[e.haxHooks()[t]](...i))}getSelection(){if(this.activeHaxBody&&this.activeHaxBody.parentNode){if(this.activeHaxBody.parentNode.getSelection)return this.activeHaxBody.parentNode.getSelection();try{if(o(this.activeHaxBody.parentNode))return o(this.activeHaxBody.parentNode)}catch(e){}}return window.getSelection()}getRange(){let e=this.getSelection();return e.getRangeAt&&e.rangeCount?e.getRangeAt(0):e||void 0}guessGizmo(e,t,i=!1,a=!1){var o=[],n=[];if(void 0!==e&&this.validGizmoTypes.includes(e))for(var s in this.gizmoList){let d=this.gizmoList[s],c=t.innerHTML?{innerHTML:t.innerHTML}:{},h=!1;if(d&&d.handles)for(var r=0;r<d.handles.length;r++)if(e===d.handles[r].type||"*"===e&&!h){for(var l in d.handles[r])"type"!==l&&void 0!==t[l]&&(""===d.handles[r][l]||"inline"!==e&&d.meta&&(!d.meta||d.meta.inlineOnly||d.meta.hidden)||(h=!0,c[d.handles[r][l]]=t[l]));if(h||i){if(a&&d.handles[r].type_exclusive)return[this.haxElementPrototype(d,c,"")];{let e={};[...d.handles].forEach((t=>{t&&t.type&&""!=t.type&&(e[t.type.toLowerCase()]=!0)})),[...d.groups].forEach((t=>{t&&""!=t&&(e[t.toLowerCase()]=!0)})),d.keywords=Object.keys(e),n.includes(d.tag)||(o.push(this.haxElementPrototype(d,c,"")),n.push(d.tag))}}}}return o}insertLogicFromValues(e,t,i=!1,a=!1){let o=this.guessGizmoType(e),n=o,s=!0;if("*"==o){if(i)return!1;s=!1,n="link"}let r=this.guessGizmo(o,e,!1,s);return r.length>0?(1===r.length||a?1===r.length&&void 0!==r[0].tag?t.dispatchEvent(new CustomEvent("hax-insert-content",{bubbles:!0,cancelable:!0,composed:!0,detail:r[0]})):a&&t.dispatchEvent(new CustomEvent("hax-insert-content",{bubbles:!0,cancelable:!0,composed:!0,detail:r.find((e=>"a"==e.tag))})):this.haxAppPicker.presentOptions(r,o,"Pick how to present this "+n,"gizmo"),!0):(this.toast("Sorry, HAX doesn't know how to handle that type of link yet."),!1)}write(e,t,i){i&&i.dispatchEvent(new CustomEvent("hax-store-write",{composed:!0,bubbles:!0,cancelable:!1,detail:{property:e,value:t,owner:i}}))}mimeTypeToGizmoType(e){let t=e.split("/");switch(t[0]){case"audio":return"audio";case"image":return"svg+xml"==t[1]?"svg":"image";case"video":return"video";case"text":return["csv","html","markdown"].includes(t[1])?t[1]:"document";case"application":return"pdf"==t[1]?"pdf":["zip","gzip","x-tar"].includes(t[1])?"archive":"document"}}guessGizmoType(e){if(void 0!==e.source){const t=e.source.toLowerCase();if(-1!=t.indexOf(".mp3")||-1!=t.indexOf(".midi")||-1!=t.indexOf(".mid"))return"audio";if(-1!=t.indexOf(".png")||-1!=t.indexOf(".jpg")||-1!=t.indexOf(".jpeg")||-1!=t.indexOf(".gif"))return"image";if(-1!=t.indexOf(".pdf"))return"pdf";if(-1!=t.indexOf(".svg"))return"svg";if(-1!=t.indexOf(".csv"))return"csv";if(-1!=t.indexOf(".md"))return"markdown";if(-1!=t.indexOf(".html")||-1!=t.indexOf(".htm"))return"html";if(-1!=t.indexOf(".txt")||-1!=t.indexOf(".doc")||-1!=t.indexOf(".docx")||-1!=t.indexOf(".xls")||-1!=t.indexOf(".xlsx")||-1!=t.indexOf(".vtt")||-1!=t.indexOf(".ppt"))return"document";if(-1!=t.indexOf(".zip")||-1!=t.indexOf(".tar.gz")||-1!=t.indexOf(".tar"))return"archive";if("external"!=window.MediaBehaviors.Video.getVideoType(t))return"video"}return"*"}render(){return t` <slot></slot> `}static get tag(){return"hax-store"}toast(e,t=2e3,i={},a="capsule",o=this.t.close,n=null,s=null){window.dispatchEvent(new CustomEvent(this.toastShowEventName,{bubbles:!0,composed:!0,cancelable:!0,detail:{text:e,duration:t,classStyle:a,closeText:o,eventCallback:n,slot:s,...i}}))}static get properties(){return{...super.properties,voiceDebug:{type:Boolean,attribute:"voice-debug"},voiceRespondsTo:{type:String,attribute:"voice-responses-to"},skipHAXConfirmation:{type:Boolean,reflect:!0,attribute:"skip-hax-confirmation"},storageData:{type:Object},haxTray:{type:Object},haxCancel:{type:Object},haxAutoloader:{type:Object},haxBodies:{type:Array},activePlaceHolder:{type:Object},appStore:{type:Object},sessionObject:{type:Object},skipExitTrap:{type:Boolean},elementList:{type:Object},staxList:{type:Array},validTagList:{type:Array},validGridTagList:{type:Array},validGizmoTypes:{type:Array},_isSandboxed:{type:Boolean},__appStoreData:{type:Object},ready:{type:Boolean},connectionRewrites:{type:Object}}}_storageDataChanged(e){e&&this.ready&&this.__storageDataProcessed&&(h("haxConfirm",!1)?p("haxUserData",e):sessionStorageGet("haxConfirm")&&sessionStorageSet("haxUserData",e))}isSingleSlotElement(e){let t=Object.keys(this.slotsSchemaFromNode(e));return 1==t.length&&0===t[0].length}isTextElement(e){let t;return null!=e&&e.tagName?t=e.tagName.toLowerCase():null!=e&&e.tag&&(t=e.tag.toLowerCase()),!!(t&&this.validTagList.includes(t)&&["p","ol","ul","li","a","h1","h2","h3","h4","h5","h6","strike","u","b","sub","sup","span","i","bold","em","strong","blockquote","code","figure"].includes(t))}isGridPlateElement(e){let t;return e&&e.tagName?t=e.tagName.toLowerCase():e&&e.tag&&(t=e.tag.toLowerCase()),!(!t||!this.validGridTagList.includes(t))}isLayoutElement(e){let t=e&&e.tagName&&this.haxSchemaFromTag(e.tagName)||{};return t.type&&"grid"===t.type}isLayoutSlot(e){return!(!e||!e.parentNode)&&this.isLayoutElement(e.parentNode)}isOriginalGridPlate(e){return!!e&&"GRID-PLATE"===e.tagName}activeSchema(){return this.activeNode?this.haxSchemaFromTag(this.activeNode.tagName):void 0}activeParentSchema(){return this.activeNode&&this.activeNode.parentNode?this.haxSchemaFromTag(this.activeNode.parentNode.tagName):void 0}slottedContentByNode(e){let t={...this.slotsSchemaFromNode(e)||{}};return e?([...e.children||[]].forEach((e=>{e.slot&&""!==e.slot&&t[e.slot]?(t[e.slot].items=t[e.slot].items||[],t[e.slot].items.push(e)):e.slot&&""!==e.slot||!t[""]||(t[""].items=t[""].items||[],t[""].items.push(e))})),t):t}slotsSchemaFromNode(e){if(!e||!e.tagName)return{};let t={},i=this.haxSchemaFromTag(e.tagName||{}),a=this.slotsFromSchema(i);if(this.isOriginalGridPlate(e)){(e.layout||"1-1-1-1").split("-").map(((e,t)=>{a.push({slot:`col-${t+1}`,title:`Column ${t+1}`,excludedSlotWrappers:["grid-plate"]})}))}return a.forEach((a=>{a.items=void 0,a.label=a.title||a.slot,a.editMode={...i.editMode,...a.editMode},a.grid=e,(a.slot||""===a.slot)&&(t[a.slot]=a)})),t}schemaBySlotId(e,t){return(this.slotsSchemaFromNode(e)||{})[t]}_appStoreChanged(e,t){e&&t&&(e.url&&!e.apps&&this.shadowRoot?this.loadAppStoreFromRemote():this.__appStoreData=e)}async _loadAppStoreData(e){if(null!=e){var t={};if(void 0!==e.autoloader)for(var i in e.autoloader=Object.assign({},e.autoloader),e.autoloader){let a=i,o=e.autoloader[i];isNaN(a)||(a=e.autoloader[i],o=`@lrnwebcomponents/${a}/${a}.js`),"string"!=typeof o&&(o.haxProperties&&this.setHaxProperties(e.autoloader[i].haxProperties,a),o=e.autoloader[i].import),this.validTagList.push(a),t[a]=o}if(void 0!==e.apps){var a=e.apps;for(i=0;i<a.length;i++){let e=document.createElement("hax-app");e.data=a[i],this.appendChild(e)}}if(void 0!==e.stax){var o=e.stax;for(i=0;i<o.length;i++){let e=document.createElement("hax-stax");e.data=o[i],this.appendChild(e)}}this.dispatchEvent(new CustomEvent("hax-store-app-store-loaded",{bubbles:!0,cancelable:!0,composed:!0,detail:!0})),await this._handleDynamicImports(t,this.haxAutoloader),this.appStoreLoaded=!0}}async _handleDynamicImports(e,t){let i=new URL("./../../../",import.meta.url).href;for(var a in window.WCGlobalBasePath&&(i=window.WCGlobalBasePath),e)if(window.customElements.get(a))if(window.customElements.get(a).haxProperties)this.setHaxProperties(window.customElements.get(a).haxProperties,a);else try{let e=document.createElement(a);t.appendChild(e)}catch(e){}else{let o=`${i}${e[a]}`;this.isExternalURLImport(e[a])&&(o=e[a]),await import(o).then((e=>{window.customElements.get(a)&&window.customElements.get(a).haxProperties?this.setHaxProperties(window.customElements.get(a).haxProperties,a):t.appendChild(document.createElement(a))})).catch((e=>{console.warn(e),t.appendChild(document.createElement(a))}))}}isExternalURLImport(e){let t;try{t=new URL(e)}catch(e){return!1}return new URL(t).origin!==location.origin}_editModeChanged(e){this.__hal&&(e&&this.globalPreferences.haxVoiceCommands?this.__hal.auto=!0:this.__hal.auto=!1),e&&!this.appStoreLoaded&&this.__appStoreData&&this.haxAutoloader&&(clearTimeout(this.__readyToProcessAppStoreData),this._loadAppStoreData(this.__appStoreData))}async _globalPreferencesChanged(e){if(this.__storageDataProcessed&&e&&void 0!==e.haxVoiceCommands&&this.ready){let t=this.storageData;"string"==typeof t&&(t=JSON.parse(t)),t.globalPreferences=e,this.storageData=t,this._storageDataChanged(this.storageData),e.haxVoiceCommands&&!this.__hal&&import("../../hal-9000/hal-9000.js").then((e=>{this._initVoiceCommands(),this.__hal=document.createElement("hal-9000"),this.__hal.respondsTo=this.voiceRespondsTo,this.__hal.debug=this.voiceDebug,this.__hal.auto=!0,this.shadowRoot.appendChild(this.__hal),this.__hal.commands={...this.voiceCommands}})),this.__hal&&(e.haxVoiceCommands&&this.editMode?this.__hal.auto=!0:this.__hal.auto=!1),e.haxLang&&HAXStore.editMode&&(clearTimeout(this._debounceLang),this._debounceLang=setTimeout((async()=>{for(var e in this.elementList){let t=this.elementList[e];t=await this.attemptGizmoTranslation(e,t),this.elementList[e]=t}this.gizmoList.forEach((e=>{this.elementList[e.tag].gizmo.title&&(e.title=this.elementList[e.tag].gizmo.title),this.elementList[e.tag].gizmo.description&&(e.description=this.elementList[e.tag].gizmo.description)}))}),100))}}_haxContextOperation(e){let t=e.detail;if(this.activeNode){let e=!1;switch(t.eventName){case"hax-align-left":this.activeNode.style.float=null,this.activeNode.style.margin=null,this.activeNode.style.display=null,e=!0;break;case"hax-align-center":this.activeNode.style.float=null,this.activeNode.style.margin="0 auto",this.activeNode.style.display="block",e=!0;break;case"hax-align-right":this.activeNode.style.float="right",this.activeNode.style.margin="0 auto",this.activeNode.style.display="block",e=!0;break;case"hax-size-change":100==t.value?this.activeNode.style.width=null:this.activeNode.style.width=t.value+"%",e=!0}e&&(clearTimeout(this.__repositionMenu),this.__repositionMenu=setTimeout((()=>{this.activeHaxBody.positionContextMenus()}),0))}}_haxConsentTap(e){p("haxConfirm",!0),p("haxUserData",JSON.stringify(this.storageData))}updated(e){super.updated&&super.updated(e),e.forEach(((e,t)=>{"appStore"==t&&this[t]&&this._appStoreChanged(this[t],e),["ready","__appStoreData","haxAutoloader"].includes(t)&&this.ready&&this.__appStoreData&&this.haxAutoloader&&(clearTimeout(this.__readyToProcessAppStoreData),this.__readyToProcessAppStoreData=setTimeout((()=>{this._loadAppStoreData(this.__appStoreData)}),0)),["haxAutoloader","haxTray","haxCancel"].includes(t)&&(clearTimeout(this.__storeReady),this.__storeReady=setTimeout((()=>{this._storePiecesAllHere(this.haxAutoloader,this.activeHaxBody,this.haxTray,this.haxCancel)}),0))}))}_calculateActiveGizmo(e){if(null==e||!e.tagName)return null;for(var t in this.gizmoList){var i=this.gizmoList[t];if(i.tag===e.tagName.toLowerCase())return i}}loadAppStoreFromRemote(){const e=new URLSearchParams(this.appStore.params);let t=this.appStore.url;e&&(t+=`?${e}`),fetch(t,{method:this.method}).then((e=>{if(e.ok)return e.json()})).then((e=>{this.__appStoreData=e}))}firstUpdated(e){if(super.firstUpdated&&super.firstUpdated(e),this.skipHAXConfirmation&&(sessionStorageSet("haxConfirm",!0),p("haxConfirm",!0)),sessionStorageGet("haxConfirm")||h("haxConfirm"))if(sessionStorageGet("haxConfirm")&&!h("haxConfirm"))try{let e=sessionStorageGet("haxUserData")?JSON.parse(sessionStorageGet("haxUserData")):{};this.storageData=e,this._storageDataChanged(this.storageData)}catch(e){}else try{let e=h("haxUserData",{});this.storageData=e,this._storageDataChanged(this.storageData)}catch(e){}else{sessionStorageSet("haxConfirm",!0);let e="\n    The HAX content editor keeps preferences in order to improve your experience.\n    This data is stored in your browser and is never sent anywhere.\n    Click to accept.\n    ";this.toast(e,"-1",{},"fit-bottom","I Accept","hax-consent-tap")}setTimeout((()=>{this.__storageDataProcessed=!0,this.storageData.globalPreferences&&this.write("globalPreferences",this.storageData.globalPreferences,this)}),0)}_storePiecesAllHere(e,t,i,a){!this.ready&&t&&e&&i&&a&&(this.dispatchEvent(new CustomEvent("hax-store-ready",{bubbles:!0,cancelable:!1,composed:!0,detail:!0})),i.shadowRoot.querySelector("#haxcancelbutton")&&(a.shadowRoot.querySelector("#dialog").associateEvents(i.shadowRoot.querySelector("#haxcancelbutton")),a.shadowRoot.querySelector("#dialog")&&window.addEventListener("simple-modal-confirmed",this._handleConfirmCancel.bind(this))),this.ready=!0,this._buildPrimitiveDefinitions())}_handleConfirmCancel(e){e.detail.invokedBy===this.haxTray.shadowRoot.querySelector("#haxcancelbutton")&&(this.editMode=!1,this.dispatchEvent(new CustomEvent("hax-cancel",{bubbles:!0,composed:!0,cancelable:!1,detail:e.detail})))}_initVoiceCommands(){this.__voiceInit=!0,this.voiceCommands[`scroll up ${this.voiceRespondsTo}`]=()=>{window.scrollBy({top:-.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands[`scroll (down) ${this.voiceRespondsTo}`]=()=>{window.scrollBy({top:.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands[`scroll to bottom ${this.voiceRespondsTo}`]=()=>{window.scrollTo(0,document.body.scrollHeight)},this.voiceCommands[`scroll to top ${this.voiceRespondsTo}`]=()=>{window.scrollTo(0,0)},this.voiceCommands[`${this.voiceRespondsTo} (show)(focus) active (element)(content)`]=()=>{try{this._positionCursorInNode(this.activeNode)}catch(e){}},this.voiceCommands[`${this.voiceRespondsTo} (focus) previous (element)(content)`]=()=>{this.activeNode.previousElementSibling?(this.activeNode=this.activeNode.previousElementSibling,this.write("activeNode",this.activeNode,this),this._positionCursorInNode(this.activeNode)):this.speak("You are at the top of the document")},this.voiceCommands[`${this.voiceRespondsTo} (focus) next (element)(content)`]=()=>{this.activeNode.nextElementSibling?(this.activeNode=this.activeNode.nextElementSibling,this.write("activeNode",this.activeNode,this),this._positionCursorInNode(this.activeNode)):this.speak("You are at the bottom of the document")},this.voiceCommands[`${this.voiceRespondsTo} type *mycontent`]=e=>{if(this.isTextElement(this.activeNode))try{let t=this._positionCursorInNode(this.activeNode),i=document.createTextNode(e);t.deleteContents(),t.insertNode(i)}catch(e){this.speak("That didn't work"),console.warn(e)}else this.speak("I'm sorry but I can only type in text areas. Try saying Insert Paragraph and try again.")},this.voiceCommands[`hey ${this.voiceRespondsTo}`]=()=>{this.speak("Yeah what do you want")},this.voiceCommands[`${this.voiceRespondsTo} now your name is *splat`]=e=>{const t=this.voiceRespondsTo;this.speak(`I used to be named ${t} but you can call me ${e} now.`),this.voiceRespondsTo=`(${e})`}}speak(e){this.__hal&&this.__hal.speak&&this.__hal.speak(e),this.toast(`${this.voiceRespondsTo}: ${e}`)}addVoiceCommand(e,t,i){t&&(e=e.replace(":name:",this.voiceRespondsTo).toLowerCase(),this.voiceCommands[e]=t[i].bind(t),this.__voiceInit&&(this.__hal.commands={...this.voiceCommands}))}_addVoiceCommand(e){let t=e.detail.context;t||(t=e.target),this.addVoiceCommand(e.detail.command,t,e.detail.callback)}_positionCursorInNode(e,t=0){this.activeHaxBody.positionContextMenus();var i=document.createRange(),a=this.getSelection();return i.setStart(e,t),i.collapse(!0),a.removeAllRanges(),a.addRange(i),i}_onBeforeUnload(e){if(!this.skipExitTrap&&this.editMode)return"Are you sure you want to leave? Your work will not be saved!"}isBase64(e){try{return btoa(atob(e))==e}catch(e){return!1}}retrieveImageFromClipboardAsBlob(e,t){if(0==e.clipboardData&&"function"==typeof t)return t(void 0);var i=e.clipboardData.items;if(null==i&&"function"==typeof t)return t(void 0);for(var a=0;a<i.length;a++)if(-1!=i[a].type.indexOf("image")){var o=i[a].getAsFile();if("function"==typeof t)return t(o)}}async _onPaste(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName){this.isTextElement(this.activeNode)||(this.activeNode=this.activeHaxBody.haxInsert("p","",{}));let s="",d="";if(e.clipboardData||e.originalEvent.clipboardData?(s=(e.originalEvent||e).clipboardData.getData("text/html"),""==s&&(s=(e.originalEvent||e).clipboardData.getData("text"))):window.clipboardData&&(s=window.clipboardData.getData("Text")),d=s,this.isBase64(d))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.retrieveImageFromClipboardAsBlob(e,(t=>{if(t){var i=window.URL||window.webkitURL;let o=document.createElement("img");for(var a in o.src=i.createObjectURL(t),this.activeNode.parentNode.insertBefore(o,this.activeNode.nextElementSibling),e.clipboardData.items)!e.clipboardData.items[a].name&&e.clipboardData.items[a].type&&(e.clipboardData.items[a].name="image-"+Math.floor(Date.now()/1e3)+e.clipboardData.items[a].type.replace("image/","."));return e.dataTransfer=e.clipboardData,e.placeHolderElement=o,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e})),o}return!1}));if(e.clipboardData.files.length>0){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let i=this.activeHaxBody.haxInsert("p","",{});for(var t in e.dataTransfer=e.clipboardData,e.clipboardData.files)!e.clipboardData.files[t].name&&e.clipboardData.files[t].type&&(e.clipboardData.files[t].name="image-"+Math.floor(Date.now()/1e3)+e.clipboardData.files[t].type.replace("image/","."));e.placeHolderElement=i,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}let c=!1,h="";s=s.replace(/<span>\s*?<\/span>/g," "),s=s.replace(/(?:style="(\S+:\s*[^;"]+;\s*)*)(\S+:\s*var\(--hax[^;"]+(?:[;"]\s*))+/g,""),s=s.replace(/<div/g,"<p"),s=s.replace(/<\/div>/g,"</p>"),s=n(s),s=s.replace(/<h1>/g,"<h2>"),s=s.replace(/<\/h1>/g,"</h2>"),s=s.replace(/<img src=\"file:(.*?)\/>/g,(function(e,t){return`<place-holder type="image" text="file:${t.split('"')[0]}"></place-holder>`}));let p=await this.htmlToHaxElements(s);if(1!==p.length||this.__validGridTags().includes(p[0].tag)||(p=await this.htmlToHaxElements(p[0].content)),0===p.length&&l(s)){""!=this.activeNode.innerText.trim()&&(c=!0);let e={source:s,title:s};if(!c&&!this.insertLogicFromValues(e,this,!1,!0))return!1}else if(0===p.length){if(c=!0,d==s)return!1;h=s}else if(1===p.length&&"p"===p[0].tag)h=s,c=!0;else if(1===p.length&&"a"===p[0].tag&&p[0].properties.href)if(""!=this.activeNode.innerText.trim())h=p[0].properties.href,c=!0;else{let e={source:p[0].properties.href,title:p[0].content};if(!this.insertLogicFromValues(e,this))return!1}else{if(!this.isGridPlateElement(p[0]))return!1;for(var t in p){"p"==p[t].tag&&["li","ol","ul"].includes(this.activeNode.tagName.toLowerCase())&&(p[t].tag="li"),delete p[t].properties.style,delete p[t].properties.start,delete p[t].properties.align;let e=r({tag:p[t].tag,content:p[t].content.replace(/<span>&nbsp;<\/span>/g," ").trim(),properties:p[t].properties});h+=await this.nodeToContent(e)}}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();try{let e=this.getRange(),n=this.getSelection(),r=document.createElement("div");if(r.innerHTML=h,e&&n){for(var t in r.children)r.children[t].tagName&&this.isTextElement(r.children[t])&&""===r.children[t].innerHTML&&r.children[t].remove();if(c){let t;if(l(s))t=document.createElement("a"),t.setAttribute("href",s),t.setAttribute("rel","noopener noreferrer"),t.setAttribute("target","_blank"),t.innerText=s;else if(r.children&&r.children.length>0){for(;r.childNodes.length>1;)e.insertNode(Array.from(r.childNodes).pop());t=Array.from(r.childNodes).pop()}else t=document.createTextNode(r.innerHTML);e.insertNode(t),setTimeout((()=>{this._positionCursorInNode(t,t.length)}),0)}else{var i,a,o;for(""!=this.activeNode.innerText.trim()&&e.endOffset!=this.activeNode.innerText.length&&(i=!0,document.execCommand("insertParagraph")),e.commonAncestorContainer&&e.commonAncestorContainer.parentNode&&(o||this.activeNode==e.commonAncestorContainer||(o=e.commonAncestorContainer.parentNode)||(o=e.commonAncestorContainer));r.firstElementChild;)a=r.firstElementChild,o?(o.getAttribute&&o.getAttribute("slot")&&a.setAttribute("slot",o.getAttribute("slot")),i?(this.activeHaxBody.haxReplaceNode(o.previousElementSibling,a),i=!1):o.parentNode?o.parentNode.insertBefore(a,o.nextElementSibling):o.insertBefore(a,o.nextElementSibling)):this.activeNode?(this.activeNode.getAttribute("slot")&&a.setAttribute("slot",this.activeNode.getAttribute("slot")),""==this.activeNode.innerText.trim()?this.activeHaxBody.haxReplaceNode(this.activeNode,a):this.activeNode.parentNode.insertBefore(a,this.activeNode.nextElementSibling)):this.activeHaxBody.appendChild(a),o=a;setTimeout((()=>{a&&a.childNodes&&a.childNodes[0]&&(this._positionCursorInNode(a.childNodes[0],a.childNodes[0].length),a=null,o=null)}),0)}}}catch(e){console.warn(e)}}}__validGridTags(){return["p","ol","ul","li","div","h1","h2","h3","h4","h5","h6","blockquote","code","section","dl","dd","dt","figure"]}__validTags(){return["p","div","span","table","caption","sup","sub","u","strike","tr","th","td","ol","ul","li","a","strong","kbd","tt","em","i","b","hr","h1","h2","h3","h4","h5","h6","blockquote","code","figure","figcaption","img","iframe","video","audio","section","dl","dt","dd","template","webview"]}__validGizmoTypes(){return["data","video","audio","text","link","file","pdf","image","csv","doc","archive","markdown","html","content","text","inline","*"]}constructor(){super(),S(["core"]),this.toastShowEventName="simple-toast-show",this.t={close:"Close"},this.primativeHooks={},this.__dragTarget=null,this.registerLocalization({context:this,namespace:"hax",basePath:import.meta.url+"/../../",locales:["es"]}),this.method="GET",this.haxSelectedText="",this.__winEvents={"hax-register-properties":"_haxStoreRegisterProperties","hax-consent-tap":"_haxConsentTap","hax-context-item-selected":"_haxContextOperation",onbeforeunload:"_onBeforeUnload",paste:"_onPaste","hax-register-app":"_haxStoreRegisterApp","hax-register-stax":"_haxStoreRegisterStax","hax-store-write":"_writeHaxStore","hax-register-core-piece":"_haxStorePieceRegistrationManager","hax-register-body":"_haxStoreRegisterBody","hax-insert-content":"_haxStoreInsertContent","hax-insert-content-array":"_haxStoreInsertMultiple","hax-add-voice-command":"_addVoiceCommand","hax-refresh-tray-form":"refreshActiveNodeForm"},window.onbeforeunload=e=>{if(!this.skipExitTrap&&this.editMode){var t="Are you sure you want to leave? Your work will not be saved!";return e.returnValue=t,t}},i.registerNewTour({key:"hax",name:"Let's learn HAX",style:"\n      simple-popover-manager::part(simple-popover) {\n        max-width: 250px;\n      }\n      simple-popover-manager button {\n        font-size: 12px;\n        margin: 0px 2px;\n      }\n      simple-popover-manager p {\n        --hax-base-styles-p-font-size: 14px;\n        padding: 0;\n        margin: 0;\n        font-size: 14px;\n        line-height: 20px;\n      }\n      simple-popover-manager h3 {\n        --hax-base-styles-h3-font-size: 18px;\n        margin: 8px 2px;\n      }"}),this.voiceRespondsTo="(worker)",this.voiceCommands={},this.skipHAXConfirmation=!1,this.storageData={},this.appStore={url:"",params:{}},this.activeNode=null,this.activeEditingElement=null,this.haxBodies=[],this.activePlaceHolder=null,this.sessionObject={},this.editMode=!1,this.skipExitTrap=!1,this.appStoreLoaded=!1,this.elementList={},this.elementAlign=h("hax-tray-elementAlign"),this.elementAlign&&null!=this.elementAlign||(this.elementAlign="right"),this.trayStatus="collapsed",this.trayDetail="content-edit",this.appList=[],this.gizmoList=[],this.haxAutoloader=null,this.activeHaxBody=null,this.haxTray=null,this.haxCancel=null,this.staxList=[],this.globalPreferences={},this.activeApp={},this.connectionRewrites={},this.voiceDebug=!1,this.keyboardShortcuts={"#":{tag:"h2",content:""},"##":{tag:"h3",content:""},"###":{tag:"h4",content:""},"####":{tag:"h5",content:""},"#####":{tag:"h6",content:""},"-":{tag:"ul",content:"<li></li>"},"1.":{tag:"ol",content:"<li></li>"},"---":{tag:"hr"},"```":{tag:"code",content:""},">":{tag:"blockquote",content:""}},this.validTagList=this.__validTags(),this.validGridTagList=this.__validGridTags(),this.validGizmoTypes=this.__validGizmoTypes();let e=document.createElement("webview");this._isSandboxed="function"==typeof e.reload,window.SimpleToast.requestAvailability(),document.body.style.setProperty("--hax-ui-headings","#d4ff77"),u(this,{gizmoList:m,activeNode:m,globalPreferences:m,activeGizmo:g,activeNodeIndex:g,editMode:m,elementAlign:m,trayStatus:m,trayDetail:m,appList:m,activeApp:m,haxSelectedText:m,activeEditingElement:m,activeHaxBody:m,appStoreLoaded:m}),x((()=>{this._globalPreferencesChanged(f(this.globalPreferences))})),x((()=>{this._editModeChanged(f(this.editMode))}))}_buildPrimitiveDefinitions(){if(this._isSandboxed){let e={type:"element",editingElement:"core",canScale:!0,canPosition:!0,canEditSource:!0,settings:{configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[]}};this.setHaxProperties(e,"webview")}this.setHaxProperties({canScale:{min:10,step:5},type:"element",editingElement:"core",canPosition:!0,canEditSource:!0,gizmo:{title:"Image",description:"A basic img tag",icon:"image:image",color:"blue-grey",groups:["Image","Media"],handles:[{type:"link",source:"src"},{type:"image",type_exclusive:!0,source:"src",height:"height",width:"width"}],meta:{author:"W3C",outlineDesigner:!0}},settings:{configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"haxupload",icon:"link",required:!0,validationType:"url"},{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item. Leave blank to respond to the natural resolution",inputMethod:"textfield",icon:"icons:swap-vert"}],advanced:[{attribute:"aria-describedby",title:"Aria-describedby",description:"Space-separated list of IDs for elements that describe the image.",inputMethod:"textfield",icon:"accessibility"},{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]},demoSchema:[{tag:"img",content:"",properties:{src:"https://cdn2.thecatapi.com/images/9j5.jpg",loading:"lazy"}}]},"img");let e={canScale:{min:10,step:5},type:"grid",canPosition:!0,canEditSource:!0,gizmo:{title:"Figure",description:"A basic figure tag",icon:"hax:figure",color:"blue-grey",groups:["Image","Media","Layout"],requiresChildren:"figcaption",handles:[],meta:{author:"W3C"}},settings:{advanced:[T]},demoSchema:[{tag:"figure",properties:{},content:'<img src="https://dummyimage.com/300x200/000/fff" alt="image other media here">\n<figcaption><p>Image Caption Here</p></figcaption>'}]};this.setHaxProperties(e,"figure");let t={canScale:{min:10,step:5},type:"grid",editingElement:"core",canPosition:!0,canEditSource:!0,gizmo:{title:"Figure caption",description:"Used inside of a figure tag",icon:"image:image",color:"blue-grey",groups:["Image","Media"],handles:[],requiresParent:"figure",meta:{author:"W3C"}},settings:{configure:[{slot:"",title:"Figure Caption",description:"Caption for the figure",inputMethod:"code-editor"},T]},demoSchema:[{tag:"figcaption",properties:{},content:"Image Caption Here"}]};this.setHaxProperties(t,"figcaption");let i={type:"element",editingElement:"core",canScale:!1,canPosition:!1,canEditSource:!0,contentEditable:!0,gizmo:{title:"Basic link",description:"A basic a tag",icon:"icons:link",color:"blue-grey",groups:["Link"],handles:[],meta:{author:"W3C"}},settings:{configure:[{attribute:"innerText",title:"Text",description:"Text of the link",inputMethod:"textfield",required:!0},{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"haxupload",required:!0,validationType:"url"},{attribute:"target",title:"Target",description:"Where to place the link.",inputMethod:"select",options:{"":"Same window",_blank:"New window - _blank",_top:"Top window - _top",_parent:"Parent window - _parent"}},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield"},T],advanced:[{attribute:"rel",title:"rel",description:"Specifies the relationship between this document and the opened document. Change as part of security or SEO policy.",inputMethod:"select",options:{noopener:"noopener","noopener noreferrer":"noopener noreferrer","nofollow ":"nofollow","noopener noreferrer nofollow":"noopener noreferrer nofollow",opener:"opener"}}]}};this.validGizmoTypes.forEach((e=>{i.gizmo.handles.push({type:e,source:"href",title:"innerText",alt:"title"})})),this.setHaxProperties(i,"a");let a={type:"element",editingElement:"core",canScale:!1,canPosition:!1,canEditSource:!0,contentEditable:!0,gizmo:{title:"Paragraph",description:"A basic text area",icon:"hax:paragraph",color:"blue-grey",groups:["Content"],handles:[{type:"content",title:"innerHTML",alt:"title"}],meta:{author:"W3C",outlineDesigner:!0}},settings:{configure:[],advanced:[T]},demoSchema:[{tag:"p",content:"Paragraph",properties:{}}]};this.setHaxProperties(a,"p");let o={type:"element",editingElement:{tag:"editable-table",import:"@lrnwebcomponents/editable-table/editable-table.js",callback:this.setupEditableTable.bind(this)},canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Table",description:"A table for displaying data",icon:"image:grid-on",color:"blue-grey",groups:["Content","Table","Data"],meta:{hidden:!0,author:"W3C"}},settings:{configure:[],advanced:[]}};this.setHaxProperties(o,"table");let n=document.createElement("editable-table");this.haxAutoloader.appendChild(n);let s={type:"element",editingElement:{tag:"iframe-loader",import:"@lrnwebcomponents/iframe-loader/iframe-loader.js",callback:this.setupIframeLoader.bind(this)},canScale:!1,canPosition:!0,canEditSource:!1,gizmo:{title:"iFrame",description:"A basic way to frame external web content",icon:"hax:iframe",color:"blue-grey",groups:["Content"],handles:[],meta:{hidden:!0,author:"W3C"}},settings:{configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}]}};this.setHaxProperties(s,"iframe");let r=document.createElement("iframe-loader");this.haxAutoloader.appendChild(r);let l={caption:{title:"Caption",icon:"av:call-to-action"},video:{title:"Video",icon:"av:play-circle-filled"},audio:{title:"Audio",icon:"image:music-note"},section:{title:"Section",icon:"image:crop-landscape"},dl:{title:"Data list",icon:"editor:format-list-bulleted"},dt:{title:"Data term",icon:"editor:format-list-bulleted"},dd:{title:"Data definition",icon:"editor:format-list-bulleted"},ol:{title:"Numbered list",icon:"editor:format-list-numbered"},ul:{title:"Bulleted list",icon:"editor:format-list-bulleted"},li:{title:"List item",icon:"editor:format-list-bulleted"},h1:{title:"Heading",icon:"hax:h1"},h2:{title:"Heading",icon:"hax:h2"},h3:{title:"Heading",icon:"hax:h3"},h4:{title:"Heading",icon:"hax:h4"},h5:{title:"Heading",icon:"hax:h5"},h6:{title:"Heading",icon:"hax:h6"},strike:{title:"Cross out",icon:"editor:format-strikethrough"},u:{title:"Underline",icon:"editor:format-underlined"},sub:{title:"Subscript",icon:"mdextra:subscript"},sup:{title:"Superscript",icon:"mdextra:superscript"},div:{title:"DIV",icon:"image:crop-landscape"},span:{title:"SPAN",icon:"editor:short-text",handles:[{type:"inline",text:"text"}]},i:{title:"Italic",icon:"editor:format-italic"},em:{title:"Emphasis",icon:"editor:format-italic"},strong:{title:"Bold",icon:"editor:format-bold"},b:{title:"Bold",icon:"editor:format-bold"},blockquote:{title:"Block quote",icon:"editor:format-quote"},code:{title:"Code",icon:"icons:code"},embed:{title:"Embedded object",icon:"icons:fullscreen"}};for(var d in l){let e="";"h2"==d?e="Heading":"ul"!=d&&"ol"!=d||(e="<li>Item 1</li><li>Item 2</li>"),this.setHaxProperties({type:"element",editingElement:"core",canScale:!1,canPosition:!1,canEditSource:!0,contentEditable:!0,gizmo:{title:l[d].title,icon:l[d].icon,groups:["Content"],handles:l[d].handles||[],meta:{author:"HAXTheWeb core team",inlineOnly:!0,hidden:"h2"!=d,outlineDesigner:!!["h2","ul"].includes(d)}},settings:{configure:[],advanced:[T]},demoSchema:[{tag:d,content:e,properties:{}}]},d)}let c={canScale:{min:25,step:25},type:"element",editingElement:"core",canPosition:!1,canEditSource:!1,contentEditable:!0,gizmo:{title:"Horizontal line",icon:"hax:hr",meta:{author:"W3C"}},settings:{configure:[],advanced:[T]},demoSchema:[{tag:"hr",content:"",properties:{style:"width:50%;"}}]};this.setHaxProperties(c,"hr")}_haxStorePieceRegistrationManager(e){e.detail&&e.detail.piece&&e.detail.object&&(this[e.detail.piece]=e.detail.object)}setupEditableTable(e){this.activeNode=e,setTimeout((()=>{e.editMode=!0,e.focus()}),0)}setupIframeLoader(e){this.activeNode=e,setTimeout((()=>{e.disabled=!0}),0)}setupAutocomplete(e){e.triggers={"!":e=>{let t=[];return this.gizmoList.forEach((e=>{t.push({groups:e.groups&&e.groups.length?e.groups.join(" "):"",icon:e.icon,label:e.title,value:e.tag})})),t}}}async _haxStoreInsertContent(e){if(e.detail){let i=e.detail;if(window.customElements.get(i.tag)){let e=document.createElement(i.tag);this.testHook(e,"preProcessInsertContent")&&(i=await this.runHook(e,"preProcessInsertContent",[i,this.activeNode]))}var t={};if(void 0!==i.properties&&(t=i.properties),t.innerHTML&&(""==i.content&&(i.content=t.innerHTML),delete t.innerHTML),t.innerText&&(""==i.content&&(i.content=t.innerText),delete t.innerText),void 0!==i.__type&&"inline"===i.__type){let e=r({tag:i.tag,content:i.content,properties:t});null!==this.activePlaceHolder&&(this.activePlaceHolder.deleteContents(),this.activePlaceHolder.insertNode(e)),this.activePlaceHolder=null}else if(i.replace||i.replacement||i.nextToActive){let e=r({tag:i.tag,content:i.content,properties:t});this.activePlaceHolder?(this.activeHaxBody.haxReplaceNode(this.activePlaceHolder,e),this.activePlaceHolder=null):i.nextToActive&&this.activeNode?this.activeHaxBody.__slot&&this.activeNode.haxLayoutContainer?this.activeNode.appendChild(e):this.activeNode.parentNode.insertBefore(e,this.activeNode):this.activeHaxBody.haxReplaceNode(this.activeNode,e)}else if(this.activeNode.parentNode&&"HAX-BODY"!=this.activeNode.parentNode.tagName){let e=r({tag:i.tag,content:i.content,properties:t});this.activeNode.parentNode.haxLayoutContainer?(null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),this.activeHaxBody.haxInsert(i.tag,i.content,t)):this.activeHaxBody.haxInsert(i.tag,i.content,t)}else this.activeHaxBody.haxInsert(i.tag,i.content,t)}}slotsFromSchema(e,t=!1){let i=e?e.settings:{},a=[];return Object.keys({...i||{}}).map((e=>(i[e]||[]).filter((e=>{let i=!t||!e.required;return!(!e.slot&&""!==e.slot||a.includes(e.slot)||!i)&&(a.push(e.slot),!0)})))).flat()}haxSchemaFromTag(e){return e&&e.toLowerCase&&(e=e.toLowerCase(),this.elementList&&this.elementList[e])?this.elementList[e]:{}}_haxStoreInsertMultiple(e){var t;if(e.detail)for(var i in e.detail)t={},void 0!==e.detail[i].properties&&(t=e.detail[i].properties),this.activeHaxBody.haxInsert(e.detail[i].tag,e.detail[i].content,t)}_haxStoreRegisterBody(e){e.detail&&(this.haxBodies.push(e.detail),this.activeHaxBody=e.detail,this.write("activeHaxBody",this.activeHaxBody,this),this.write("editMode",this.editMode,this),clearTimeout(this.__storeReady),this.__storeReady=setTimeout((()=>{this._storePiecesAllHere(this.haxAutoloader,this.activeHaxBody,this.haxTray,this.haxCancel)}),0))}computePolyfillSafe(){return!(!document.head.createShadowRoot&&!document.head.attachShadow)||(console.warn("Shadow DOM missing, certain operations hidden"),!1)}_writeHaxStore(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&e.detail.owner&&(e.detail.owner!==this&&(null==e.detail.value?this[e.detail.property]=null:"object"==typeof e.detail.value&&(this[e.detail.property]={}),this[e.detail.property]=e.detail.value),this.dispatchEvent(new CustomEvent("hax-store-property-updated",{bubbles:!0,composed:!0,cancelable:!1,detail:{property:e.detail.property,value:e.detail.value,owner:e.detail.owner}})))}_haxStoreRegisterApp(e){if(e.detail){if(e.detail.index=this.appList.length,this.appList=[...this.appList,e.detail],this.write("appList",f(this.appList),this),e.detail.connection&&e.detail.connection.protocol&&e.detail.connection.url){let t=document.createElement("link");t.rel="preconnect",t.href=e.detail.connection.protocol+"://"+e.detail.connection.url,document.head.appendChild(t)}void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target)}}_haxStoreRegisterStax(e){e.detail&&(e.detail.index=this.staxList.length,this.staxList=[...this.staxList,e.detail],this.write("staxList",this.staxList,this),void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target))}activeBodyIgnoreActive(e){this.activeHaxBody.__ignoreActive=e}dashToCamel(e){return e.replace(/-([a-z])/g,(function(e){return e[1].toUpperCase()}))}async htmlToHaxElements(e){let t=[];const i=this.validTagList;let a=document.createElement("div");a.innerHTML=e;const o=a.childNodes;for(var n=0;n<o.length;n++)void 0!==o[n].tagName&&i.includes(o[n].tagName.toLowerCase())&&t.push(await s(o[n],null));return t}async nodeToContent(e){this.testHook(e,"preProcessNodeToContent")&&(e=await this.runHook(e,"preProcessNodeToContent",[e]));let t=e.tagName.toLowerCase();this._isSandboxed&&"webview"===t&&(t="iframe");var i="";i+="<"+t;for(var a=this.elementList[t],o={},n=0,s=e.attributes.length;n<s;++n){var r=e.attributes.item(n).nodeName,l=e.attributes.item(n).value;"style"==r||typeof l!=typeof Object&&l.constructor!==Array?null!=l&&"null"!=l&&(!0===l||"true"===l?o[r]=!0:!1===l||("string"==typeof l&&""!==l?(l=l.replace(new RegExp('"',"g"),"&quot;"),o[r]=l):""===l?(""==l&&""!=e.attributes.item(n).value&&(l=e.attributes.item(n).value),o[r]=l):o[r]=l)):o[r]=JSON.stringify(l).replace(new RegExp('"',"g"),"&quot;")}let h;if(customElements.get(t)&&(h=customElements.get(t).properties),void 0===h&&(h=e.__data),void 0!==h)for(var n in h){r=d(n),l=null;void 0!==e[n]&&(l=e[n]),h[n].readOnly||h[n].computed||l===h[n].value||r.startsWith("__")||(null==l||"object"!=typeof l&&l.constructor!==Array?null!=l&&"null"!=l&&(!0===l||"true"===l?o[r]=!0:!1===l||("string"==typeof l&&""!==l?(l=l.replace(new RegExp('"',"g"),"&quot;"),o[r]=l):""===l?""==l&&""!=h[n].value?l=h[n].value:""===l&&h[n].value:o[r]=l)):(l.constructor===Array&&l!=[]||"object"==typeof l&&l!={})&&(o[r]=JSON.stringify(l).replace(new RegExp('"',"g"),"&quot;")))}if(void 0!==a&&void 0!==a.saveOptions.unsetAttributes)for(var p in a.saveOptions.unsetAttributes)delete o[a.saveOptions.unsetAttributes[p]];let m=["inner-text","inner-html","tabindex","guestinstance"];for(var u in m)void 0!==o[m[u]]&&delete o[m[u]];for(var p in void 0!==o.id&&""===o.id&&delete o.id,delete o.draggable,delete o.contenteditable,delete o["data-hax-ray"],delete o["data-hax-layout"],""!=o.class&&"hax-active"!=o.class||delete o.class,o)!0===o[p]?i+=" "+p:i+=" "+p+'="'+o[p]+'"';if(["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"].includes(t)?i+="/>":i+=">",void 0===a||!a.saveOptions.wipeSlot){let t=e.childNodes;if(t.length>0){n=0;for(var g=t.length;n<g;n++)void 0!==t[n].tagName?this.HTMLPrimativeTest(t[n].tagName)||"TEMPLATE"===t[n].tagName?(t[n].removeAttribute("data-hax-ray"),t[n].contentEditable=!1,i+=t[n].outerHTML):i+=await this.nodeToContent(t[n]):8===t[n].nodeType?i+="\x3c!-- "+t[n].textContent+" --\x3e":1!==t[n].nodeType&&void 0!==t[n].textContent&&"undefined"!==t[n].textContent&&(i+=c(t[n].textContent))}}return this.testHook(e,"progressiveEnhancement")&&(i+=await this.runHook(e,"progressiveEnhancement",[e])),"span"===t?i+="</"+t+">":"hr"===t||"br"===t||"img"===t||(i+="</"+t+">\n"),i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=i.replace(/&nbsp;/gm," ")).replace(/ data-hax-ray="(\s|.)*?"/gim,"")).replace(/ class=""/gim,"")).replace(/ class="hax-active"/gim,"")).replace(/ contenteditable="(\s|.)*?"/gim,"")).replace(/<span style="(.*?)">/gim,"<span>")).replace(/<span>\s*?<\/span>/g," ")).replace(/<span><br\/><\/span>/gm,"")).replace(/<strong style="(.*?)">/gim,"<strong>")).replace(/<b style="(.*?)">/gim,"<b>")).replace(/<strike style="(.*?)">/gim,"<strike>")).replace(/<em style="(.*?)">/gim,"<em>")).replace(/<i style="(.*?)">/gim,"<i>")).replace(/<p>(\s*)<\/p>/gm,"<p></p>")).replace(/<p>&nbsp;<\/p>/gm,"<p></p>")).replace(/<p><br\/><\/p>/gm,"<p></p>")).replace(/<p><br><\/p>/gm,"<p></p>")).replace(/<\/p>(\s*)<p>/gm,"</p><p>")).split("\n\r").join("\n").split("\r").join("\n").split("\n\n").join("\n").split("\n\n").join("\n").split("\n\n").join("\n"),this.testHook(e,"postProcessNodeToContent")&&(i=await this.runHook(e,"postProcessNodeToContent",[i])),i}HTMLPrimativeTest(e){return void 0!==e.tagName&&-1==e.tagName.indexOf("-")}getHaxAppStoreTargets(e){return f(this.appList).filter((t=>{if(void 0!==t.connection.operations.add){let i=t.connection.operations.add;if(void 0!==i.acceptsGizmoTypes&&i.acceptsGizmoTypes.includes(e))return!0}return!1}))}async refreshActiveNodeForm(){this.haxTray.activeHaxElement=await s(this.haxTray.activeNode,null),await this.haxTray._setupForm()}haxElementPrototype(e,t,i=""){return{tag:e.tag,properties:t,content:i,gizmo:e}}async getHAXSlot(e){if(this.isTextElement(e))return e.innerHTML;let t="";var i=e.childNodes;if(i.length>0)for(var a=0,o=i.length;a<o;a++){if(!i[a])return;void 0!==i[a].tagName?i[a].tagName.indexOf("-")>0?t+="  "+await this.nodeToContent(i[a])+"\n":t+="  "+i[a].outerHTML+"\n":8===i[a].nodeType?t+="\x3c!-- "+i[a].textContent+" --\x3e":1!==i[a].nodeType&&void 0!==i[a].textContent&&"undefined"!==i[a].textContent&&(t+=i[a].textContent)}return t}async _haxStoreRegisterProperties(e){if(e.detail&&e.detail.properties&&e.detail.tag){if(!this.elementList[e.detail.tag]){let t=e.detail;t.properties=await this.attemptGizmoTranslation(t.tag,t.properties);let i=t.properties.gizmo;if(i){i.tag=t.tag;let e=this.gizmoList;e.push(i),this.gizmoList=[...e],this.write("gizmoList",e,this)}this.elementList[t.tag]=t.properties,this.validTagList.find((e=>e===t.tag))||this.validTagList.push(t.tag),"grid"!=t.properties.type||this.validGridTagList.find((e=>e===t.tag))||this.validGridTagList.push(t.tag),window.customElements.get(e.detail.tag)&&this.testHook(document.createElement(e.detail.tag),"gizmoRegistration")&&await this.runHook(document.createElement(e.detail.tag),"gizmoRegistration",[this])}void 0!==e.target.parentElement&&"HAX-AUTOLOADER"===e.target.parentElement.tagName&&this.haxAutoloader.removeChild(e.target)}}get activeGizmo(){let e=f(this._calculateActiveGizmo(this.activeNode));return this.write("activeGizmo",e,this),e}get activeNodeIndex(){let e=null;return this.activeNode&&Array.from(f(this.activeHaxBody).children).map(((t,i)=>{f(this.activeNode)!==t&&f(this.activeNode).parentElement!==t||(e=i)})),e}async attemptGizmoTranslation(e,t){var i=await w.loadNamespaceFile(e+".haxProperties");if(!i&&"en"==this.globalPreferences.haxLang&&window.customElements.get(e)&&window.customElements.get(e).haxProperties&&"string"==typeof(i=window.customElements.get(e).haxProperties)&&(i=await fetch(i).then((e=>!(!e||!e.json)&&e.json()))),i){if(t.gizmo&&i.gizmo)for(var a in i.gizmo)t.gizmo[a]=i.gizmo[a];if(t.settings&&i.settings){let e={advanced:"advanced",configure:"configure"};for(var o in e)if(t.settings[o]&&i.settings[o])for(var a in i.settings[o])for(var n in i.settings[o][a])t.settings[o][a][n]=i.settings[o][a][n]}if(t.demoSchema&&i.demoSchema)for(var a in i.demoSchema)if(i.demoSchema[a].properties)for(var n in i.demoSchema[a].properties)t.demoSchema[a].properties[n]=i.demoSchema[a].properties[n]}return t}}customElements.define(HaxStore.tag,HaxStore);export{HaxStore};window.HaxStore=window.HaxStore||{},window.HaxStore.requestAvailability=function(){return window.HaxStore.instance||(window.HaxStore.instance=document.createElement("hax-store"),document.body.appendChild(window.HaxStore.instance)),window.HaxStore.instance};export const HAXStore=window.HaxStore.requestAvailability();window.Hax=window.Hax||{},window.Hax.add=function(e){if(HAXStore.elementList[e]){let t,i=HAXStore.haxSchemaFromTag(e);t=i.gizmo.tag&&i.demoSchema&&i.demoSchema[0]?r(i.demoSchema[0]):document.createElement(e),HAXStore.activeHaxBody.haxReplaceNode(HAXStore.activeNode,t),HAXStore.activeHaxBody.__focusLogic(t)}else HAXStore.toast(`${e} is not a valid tag`)},window.Hax.delete=function(){null!=HAXStore.activeNode&&HAXStore.activeHaxBody.haxDeleteNode(HAXStore.activeNode)},window.Hax.duplicate=function(){HAXStore.activeHaxBody.haxDuplicateNode(HAXStore.activeNode)},window.Hax.move=function(e=!0){e?HAXStore.activeHaxBody.haxMoveGridPlate(HAXStore.activeNode,-1):HAXStore.activeHaxBody.haxMoveGridPlate(HAXStore.activeNode)},window.Hax.grid=function(e=!0){HAXStore.activeHaxBody.haxGridPlateOps(e)},window.Hax.set=function(e,t){HAXStore.write(e,t,window)},window.Hax.get=function(e){return HAXStore[e]},window.Hax.export=async function(){return await HAXStore.activeHaxBody.haxToContent()},window.Hax.import=function(e="<p></p>"){return HAXStore.activeHaxBody.importContent(e)};