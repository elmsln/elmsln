import{LitElement as e,html as t}from"../../../lit-element/lit-element.js";import{SimpleTourManager as i}from"../../simple-popover/lib/simple-tour.js";import{winEventsElement as o,getRange as a,stripMSWord as n,nodeToHaxElement as s,haxElementToNode as r,validURL as l,camelToDash as d}from"../../utils/utils.js";import{observable as c,makeObservable as h,computed as p,configure as m,autorun as u,toJS as g}from"../../../mobx/dist/mobx.esm.js";m({enforceActions:!1,useProxies:"ifavailable"});import{HAXElement as v}from"../../hax-body-behaviors/hax-body-behaviors.js";class HaxStore extends(o(v(e))){testHook(e,t){return e&&"function"==typeof e.haxHooks&&e.haxHooks()[t]}runHook(e,t,i=[]){return!!this.testHook(e,t)&&e[e.haxHooks()[t]](...i)}getSelection(){if(this.activeHaxBody&&this.activeHaxBody.parentNode){if(this.activeHaxBody.parentNode.getSelection)return this.activeHaxBody.parentNode.getSelection();try{if(a(this.activeHaxBody.parentNode))return a(this.activeHaxBody.parentNode)}catch(e){}}return window.getSelection()}getRange(){let e=this.getSelection();return e.getRangeAt&&e.rangeCount?e.getRangeAt(0):e||void 0}guessGizmo(e,t,i=!1,o=!1){var a=[];if(void 0!==e&&this.validGizmoTypes.includes(e))for(var n in this.gizmoList){let l=this.gizmoList[n],d={},c=!1;if(l&&l.handles)for(var s=0;s<l.handles.length;s++)if(e===l.handles[s].type||"*"===e&&!c){for(var r in l.handles[s])"type"!==r&&void 0!==t[r]&&("inline"!==e&&l.meta&&(!l.meta||l.meta.inlineOnly||l.meta.hidden)||(c=!0,d[l.handles[s][r]]=t[r]));if(c||i){if(o&&l.handles[s].type_exclusive)return[this.haxElementPrototype(l,d,"")];a.push(this.haxElementPrototype(l,d,""))}}}return a}insertLogicFromValues(e,t,i=!1){let o=this.guessGizmoType(e),a=o,n=!0;if("*"==o){if(i)return!1;n=!1,a="link"}let s=this.guessGizmo(o,e,!1,n);return s.length>0?(1===s.length?void 0!==s[0].tag&&t.dispatchEvent(new CustomEvent("hax-insert-content",{bubbles:!0,cancelable:!0,composed:!0,detail:s[0]})):this.haxAppPicker.presentOptions(s,o,"Pick how to present this "+a,"gizmo"),!0):(this.toast("Sorry, HAX doesn't know how to handle that type of link yet."),!1)}write(e,t,i){i&&i.dispatchEvent(new CustomEvent("hax-store-write",{composed:!0,bubbles:!0,cancelable:!1,detail:{property:e,value:t,owner:i}}))}mimeTypeToGizmoType(e){let t=e.split("/");switch(t[0]){case"audio":return"audio";case"image":return"svg+xml"==t[1]?"svg":"image";case"video":return"video";case"text":return["csv","html","markdown"].includes(t[1])?t[1]:"document";case"application":return"pdf"==t[1]?"pdf":["zip","gzip","x-tar"].includes(t[1])?"archive":"document"}}guessGizmoType(e){if(void 0!==e.source){const t=e.source.toLowerCase();if(-1!=t.indexOf(".mp3")||-1!=t.indexOf(".midi")||-1!=t.indexOf(".mid"))return"audio";if(-1!=t.indexOf(".png")||-1!=t.indexOf(".jpg")||-1!=t.indexOf(".jpeg")||-1!=t.indexOf(".gif"))return"image";if(-1!=t.indexOf(".pdf"))return"pdf";if(-1!=t.indexOf(".svg"))return"svg";if(-1!=t.indexOf(".csv"))return"csv";if(-1!=t.indexOf(".md"))return"markdown";if(-1!=t.indexOf(".html")||-1!=t.indexOf(".htm"))return"html";if(-1!=t.indexOf(".txt")||-1!=t.indexOf(".doc")||-1!=t.indexOf(".docx")||-1!=t.indexOf(".xls")||-1!=t.indexOf(".xlsx")||-1!=t.indexOf(".vtt")||-1!=t.indexOf(".ppt"))return"document";if(-1!=t.indexOf(".zip")||-1!=t.indexOf(".tar.gz")||-1!=t.indexOf(".tar"))return"archive";if("external"!=window.MediaBehaviors.Video.getVideoType(t))return"video"}return"*"}render(){return t` <slot></slot> `}static get tag(){return"hax-store"}toast(e,t=2e3,i="capsule",o=null,a=null){window.dispatchEvent(new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!0,detail:{text:e,duration:t,classStyle:i,closeText:o,eventCallback:a}}))}static get properties(){return{...super.properties,voiceDebug:{type:Boolean,attribute:"voice-debug"},voiceRespondsTo:{type:String,attribute:"voice-responses-to"},skipHAXConfirmation:{type:Boolean,reflect:!0,attribute:"skip-hax-confirmation"},storageData:{type:Object},haxTray:{type:Object},haxAutoloader:{type:Object},haxBodies:{type:Array},activePlaceHolder:{type:Object},appStore:{type:Object},sessionObject:{type:Object},skipExitTrap:{type:Boolean},elementList:{type:Object},staxList:{type:Array},validTagList:{type:Array},validGridTagList:{type:Array},validGizmoTypes:{type:Array},_isSandboxed:{type:Boolean},__appStoreData:{type:Object},ready:{type:Boolean},connectionRewrites:{type:Object}}}_storageDataChanged(e){e&&this.ready&&this.__storageDataProcessed&&(window.localStorage.getItem("haxConfirm")?window.localStorage.setItem("haxUserData",JSON.stringify(e)):window.sessionStorage.getItem("haxConfirm")&&window.sessionStorage.setItem("haxUserData",JSON.stringify(e)))}isTextElement(e){let t;return null!=e&&e.tagName?t=e.tagName.toLowerCase():null!=e&&e.tag&&(t=e.tag.toLowerCase()),!!(t&&this.validTagList.includes(t)&&["p","ol","ul","li","a","h1","h2","h3","h4","h5","h6","strike","u","b","sub","sup","span","i","bold","em","strong","blockquote","code","figure"].includes(t))}isGridPlateElement(e){let t;return e&&e.tagName?t=e.tagName.toLowerCase():e&&e.tag&&(t=e.tag.toLowerCase()),!(!t||!this.validGridTagList.includes(t))}_appStoreChanged(e,t){e&&t&&(e.url&&!e.apps&&this.shadowRoot?this.loadAppStoreFromRemote():this.__appStoreData=e)}_loadAppStoreData(e){if(null!=e){var t={};if(void 0!==e.autoloader)for(var i in e.autoloader=Object.assign({},e.autoloader),e.autoloader){let o=i,a=e.autoloader[i];isNaN(o)||(o=e.autoloader[i],a=`@lrnwebcomponents/${o}/${o}.js`),this.validTagList.push(o),t[o]=a}if(void 0!==e.apps){var o=e.apps;for(i=0;i<o.length;i++){let e=document.createElement("hax-app");e.data=o[i],this.appendChild(e)}}if(void 0!==e.stax){var a=e.stax;for(i=0;i<a.length;i++){let e=document.createElement("hax-stax");e.data=a[i],this.appendChild(e)}}this.dispatchEvent(new CustomEvent("hax-store-app-store-loaded",{bubbles:!0,cancelable:!0,composed:!0,detail:!0})),this._handleDynamicImports(t,this.haxAutoloader),this.__appStoreHasLoaded=!0}}pathFromUrl(e){return e.substring(0,e.lastIndexOf("/")+1)}async _handleDynamicImports(e,t){const i=this.pathFromUrl(decodeURIComponent(import.meta.url));for(var o in e)window.customElements.get(o)?window.customElements.get(o).haxProperties?this.setHaxProperties(window.customElements.get(o).haxProperties,o):t.appendChild(document.createElement(o)):await import(`${i}../../../${e[o]}`).then(e=>{window.customElements.get(o)&&window.customElements.get(o).haxProperties?this.setHaxProperties(window.customElements.get(o).haxProperties,o):t.appendChild(document.createElement(o))}).catch(e=>{console.warn(e),t.appendChild(document.createElement(o))})}_editModeChanged(e){this.__hal&&(e&&this.globalPreferences.haxVoiceCommands?this.__hal.auto=!0:this.__hal.auto=!1),e&&!this.__appStoreHasLoaded&&this.__appStoreData&&this.haxAutoloader&&(clearTimeout(this.__readyToProcessAppStoreData),this._loadAppStoreData(this.__appStoreData))}_globalPreferencesChanged(e){if(this.__storageDataProcessed&&e&&void 0!==e.haxVoiceCommands&&this.ready){let t=this.storageData;t.globalPreferences=e,this.storageData=t,this._storageDataChanged(this.storageData),e.haxVoiceCommands&&!this.__hal&&import("../../hal-9000/hal-9000.js").then(e=>{this._initVoiceCommands(),this.__hal=document.createElement("hal-9000"),this.__hal.respondsTo=this.voiceRespondsTo,this.__hal.debug=this.voiceDebug,this.__hal.auto=!0,this.shadowRoot.appendChild(this.__hal),this.__hal.commands={...this.voiceCommands}}),this.__hal&&(e.haxVoiceCommands&&this.editMode?this.__hal.auto=!0:this.__hal.auto=!1)}}_haxContextOperation(e){let t=e.detail;if(this.activeNode){let e=!1;switch(t.eventName){case"hax-align-left":this.activeNode.style.float=null,this.activeNode.style.margin=null,this.activeNode.style.display=null,e=!0;break;case"hax-align-center":this.activeNode.style.float=null,this.activeNode.style.margin="0 auto",this.activeNode.style.display="block",e=!0;break;case"hax-align-right":this.activeNode.style.float="right",this.activeNode.style.margin="0 auto",this.activeNode.style.display="block",e=!0;break;case"hax-size-change":100==t.value?this.activeNode.style.width=null:this.activeNode.style.width=t.value+"%",e=!0}e&&(clearTimeout(this.__repositionMenu),this.__repositionMenu=setTimeout(()=>{this.activeHaxBody.positionContextMenus()},0))}}_haxConsentTap(e){window.localStorage.setItem("haxConfirm",!0),window.localStorage.setItem("haxUserData",JSON.stringify(this.storageData))}updated(e){super.updated&&super.updated(e),e.forEach((e,t)=>{"appStore"==t&&this[t]&&this._appStoreChanged(this[t],e),["ready","__appStoreData","haxAutoloader"].includes(t)&&this.ready&&this.__appStoreData&&this.haxAutoloader&&(clearTimeout(this.__readyToProcessAppStoreData),this.__readyToProcessAppStoreData=setTimeout(()=>{this._loadAppStoreData(this.__appStoreData)},0)),["haxAutoloader","activeHaxBody","haxTray"].includes(t)&&(clearTimeout(this.__storeReady),this.__storeReady=setTimeout(()=>{this._storePiecesAllHere(this.haxAutoloader,this.activeHaxBody,this.haxTray,this.haxExport)},0))})}_calculateActiveGizmo(e){if(null==e||!e.tagName)return null;for(var t in this.gizmoList){var i=this.gizmoList[t];if(i.tag===e.tagName.toLowerCase())return i}}loadAppStoreFromRemote(){const e=new URLSearchParams(this.appStore.params);let t=this.appStore.url;e&&(t+="?"+e),fetch(t,{method:this.method}).then(e=>{if(e.ok)return e.json()}).then(e=>{this.__appStoreData=e})}firstUpdated(e){if(super.firstUpdated&&super.firstUpdated(e),this.skipHAXConfirmation&&(window.sessionStorage.setItem("haxConfirm",!0),window.localStorage.setItem("haxConfirm",!0)),window.sessionStorage.getItem("haxConfirm")||window.localStorage.getItem("haxConfirm"))if(window.sessionStorage.getItem("haxConfirm")&&!window.localStorage.getItem("haxConfirm"))try{let e=window.sessionStorage.getItem("haxUserData")?JSON.parse(window.sessionStorage.getItem("haxUserData")):{};this.storageData=e,this._storageDataChanged(this.storageData)}catch(e){}else try{let e=window.localStorage.getItem("haxUserData")?JSON.parse(window.localStorage.getItem("haxUserData")):{};this.storageData=e,this._storageDataChanged(this.storageData)}catch(e){}else{window.sessionStorage.setItem("haxConfirm",!0);let e="\n    The HAX content editor keeps preferences in order to improve your experience.\n    This data is stored in your browser and is never sent anywhere.\n    Click to accept.\n    ";this.toast(e,"-1","fit-bottom","I Accept","hax-consent-tap")}setTimeout(()=>{this.__storageDataProcessed=!0,this.storageData.globalPreferences&&this.write("globalPreferences",this.storageData.globalPreferences,this)},0)}_storePiecesAllHere(e,t,i,o){!this.ready&&t&&e&&i&&o&&(this.dispatchEvent(new CustomEvent("hax-store-ready",{bubbles:!0,cancelable:!1,composed:!0,detail:!0})),HAXStore.haxExport.shadowRoot.querySelector("#dialog").associateEvents(i.shadowRoot.querySelector("#exportbtn")),this.ready=!0,this._buildPrimitiveDefinitions())}_initVoiceCommands(){this.__voiceInit=!0,this.voiceCommands["scroll up "+this.voiceRespondsTo]=()=>{window.scrollBy({top:-.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands["scroll (down) "+this.voiceRespondsTo]=()=>{window.scrollBy({top:.5*window.innerHeight,left:0,behavior:"smooth"})},this.voiceCommands["scroll to bottom "+this.voiceRespondsTo]=()=>{window.scrollTo(0,document.body.scrollHeight)},this.voiceCommands["scroll to top "+this.voiceRespondsTo]=()=>{window.scrollTo(0,0)},this.voiceCommands[this.voiceRespondsTo+" (show)(focus) active (element)(content)"]=()=>{try{this._positionCursorInNode(this.activeNode)}catch(e){}},this.voiceCommands[this.voiceRespondsTo+" (focus) previous (element)(content)"]=()=>{this.activeNode.previousElementSibling?(this.activeNode=this.activeNode.previousElementSibling,this.write("activeNode",this.activeNode,this),this._positionCursorInNode(this.activeNode)):this.speak("You are at the top of the document")},this.voiceCommands[this.voiceRespondsTo+" (focus) next (element)(content)"]=()=>{this.activeNode.nextElementSibling?(this.activeNode=this.activeNode.nextElementSibling,this.write("activeNode",this.activeNode,this),this._positionCursorInNode(this.activeNode)):this.speak("You are at the bottom of the document")},this.voiceCommands[this.voiceRespondsTo+" type *mycontent"]=e=>{if(this.isTextElement(this.activeNode))try{let t=this._positionCursorInNode(this.activeNode),i=document.createTextNode(e);t.deleteContents(),t.insertNode(i)}catch(e){this.speak("That didn't work"),console.warn(e)}else this.speak("I'm sorry but I can only type in text areas. Try saying Insert Paragraph and try again.")},this.voiceCommands["hey "+this.voiceRespondsTo]=()=>{this.speak("Yeah what do you want")},this.voiceCommands[this.voiceRespondsTo+" now your name is *splat"]=e=>{const t=this.voiceRespondsTo;this.speak(`I used to be named ${t} but you can call me ${e} now.`),this.voiceRespondsTo=`(${e})`}}speak(e){this.__hal&&this.__hal.speak&&this.__hal.speak(e),this.toast(`${this.voiceRespondsTo}: ${e}`)}addVoiceCommand(e,t,i){t&&(e=e.replace(":name:",this.voiceRespondsTo).toLowerCase(),this.voiceCommands[e]=t[i].bind(t),this.__voiceInit&&(this.__hal.commands={...this.voiceCommands}))}_addVoiceCommand(e){let t=e.detail.context;t||(t=e.target),this.addVoiceCommand(e.detail.command,t,e.detail.callback)}_positionCursorInNode(e,t=0){this.activeHaxBody.positionContextMenus();var i=document.createRange(),o=this.getSelection();return i.setStart(e,t),i.collapse(!0),o.removeAllRanges(),o.addRange(i),i}_onBeforeUnload(e){if(!this.skipExitTrap&&this.editMode)return"Are you sure you want to leave? Your work will not be saved!"}isBase64(e){try{return btoa(atob(e))==e}catch(e){return!1}}retrieveImageFromClipboardAsBlob(e,t){if(0==e.clipboardData&&"function"==typeof t)return t(void 0);var i=e.clipboardData.items;if(null==i&&"function"==typeof t)return t(void 0);for(var o=0;o<i.length;o++)if(-1!=i[o].type.indexOf("image")){var a=i[o].getAsFile();if("function"==typeof t)return t(a)}}_onPaste(e){if(this.editMode&&"HAX-TRAY"!==document.activeElement.tagName&&"BODY"!==document.activeElement.tagName&&"SIMPLE-MODAL"!==document.activeElement.tagName){this.isTextElement(this.activeNode)||(this.activeNode=this.activeHaxBody.haxInsert("p","",{}));let s="",d="";if(e.clipboardData||e.originalEvent.clipboardData?(s=(e.originalEvent||e).clipboardData.getData("text/html"),""==s&&(s=(e.originalEvent||e).clipboardData.getData("text"))):window.clipboardData&&(s=window.clipboardData.getData("Text")),d=s,this.isBase64(d))return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.retrieveImageFromClipboardAsBlob(e,t=>{if(t){var i=window.URL||window.webkitURL;let a=document.createElement("img");for(var o in a.src=i.createObjectURL(t),this.activeNode.parentNode.insertBefore(a,this.activeNode.nextElementSibling),e.clipboardData.items)!e.clipboardData.items[o].name&&e.clipboardData.items[o].type&&(e.clipboardData.items[o].name="image-"+Math.floor(Date.now()/1e3)+e.clipboardData.items[o].type.replace("image/","."));return e.dataTransfer=e.clipboardData,e.placeHolderElement=a,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e})),a}return!1});if(e.clipboardData.files.length>0){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();let i=this.activeHaxBody.haxInsert("p","",{});for(var t in e.dataTransfer=e.clipboardData,e.clipboardData.files)!e.clipboardData.files[t].name&&e.clipboardData.files[t].type&&(e.clipboardData.files[t].name="image-"+Math.floor(Date.now()/1e3)+e.clipboardData.files[t].type.replace("image/","."));e.placeHolderElement=i,this.dispatchEvent(new CustomEvent("place-holder-file-drop",{bubbles:!0,cancelable:!0,composed:!0,detail:e}))}let c=!1,h="";s=s.replace(/<span>\s*?<\/span>/g," "),s=s.replace(/<div/g,"<p"),s=s.replace(/<\/div>/g,"</p>"),s=n(s);let p=this.htmlToHaxElements(s);if(0===p.length&&l(s)){if(""!=this.activeNode.innerText.trim())return!1;let e={source:s,title:s};if(!this.insertLogicFromValues(e,this))return!1}else if(0===p.length){if(c=!0,d==s)return!1;h=s}else if(1===p.length&&"p"===p[0].tag)h=s,c=!0;else if(1===p.length&&"a"===p[0].tag&&p[0].properties.href)if(""!=this.activeNode.innerText.trim())h=p[0].properties.href,c=!0;else{let e={source:p[0].properties.href,title:p[0].content};if(!this.insertLogicFromValues(e,this))return!1}else{if(!this.isGridPlateElement(p[0]))return!1;for(var t in p){"p"==p[t].tag&&["li","ol","ul"].includes(this.activeNode.tagName.toLowerCase())&&(p[t].tag="li"),delete p[t].properties.style,delete p[t].properties.start,delete p[t].properties.align;let e=r({tag:p[t].tag,content:p[t].content.replace(/<span>&nbsp;<\/span>/g," ").trim(),properties:p[t].properties});h+=this.nodeToContent(e)}}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();try{let e=this.getRange(),n=this.getSelection(),s=document.createElement("div");if(s.innerHTML=h,e&&n){for(var t in s.children)s.children[t].tagName&&this.isTextElement(s.children[t])&&""===s.children[t].innerHTML&&s.children[t].remove();if(c){let t=document.createTextNode(s.innerHTML);e.insertNode(t),setTimeout(()=>{this._positionCursorInNode(t,t.length)},0)}else{var i,o,a;for(""!=this.activeNode.innerText.trim()&&e.endOffset!=this.activeNode.innerText.length&&(i=!0,document.execCommand("insertParagraph")),e.commonAncestorContainer&&e.commonAncestorContainer.parentNode&&(a||this.activeNode==e.commonAncestorContainer||(a=e.commonAncestorContainer.parentNode)||(a=e.commonAncestorContainer));s.firstElementChild;)o=s.firstElementChild,a?(a.getAttribute&&a.getAttribute("slot")&&o.setAttribute("slot",a.getAttribute("slot")),i?(this.activeHaxBody.haxReplaceNode(a.previousElementSibling,o),i=!1):a.parentNode.insertBefore(o,a.nextElementSibling)):this.activeNode?(this.activeNode.getAttribute("slot")&&o.setAttribute("slot",this.activeNode.getAttribute("slot")),""==this.activeNode.innerText.trim()?this.activeHaxBody.haxReplaceNode(this.activeNode,o):this.activeNode.parentNode.insertBefore(o,this.activeNode.nextElementSibling)):this.activeHaxBody.appendChild(o),a=o;setTimeout(()=>{o&&o.childNodes&&o.childNodes[0]&&(this._positionCursorInNode(o.childNodes[0],o.childNodes[0].length),o=null,a=null)},0)}}}catch(e){console.warn(e)}}}__validGridTags(){return["p","ol","ul","li","div","h1","h2","h3","h4","h5","h6","blockquote","code","figure"]}__validTags(){return["p","div","span","table","caption","sup","sub","u","strike","tr","th","td","ol","ul","li","a","strong","kbd","tt","em","i","b","hr","h1","h2","h3","h4","h5","h6","blockquote","code","figure","img","iframe","video","audio","section","grid-plate","template","webview"]}__validGizmoTypes(){return["data","video","audio","text","link","file","pdf","image","csv","doc","archive","markdown","html","wikipedia","content","text","inline","*"]}constructor(){super(),this.method="GET",this.haxSelectedText="",this.__winEvents={"hax-register-properties":"_haxStoreRegisterProperties","hax-consent-tap":"_haxConsentTap","hax-context-item-selected":"_haxContextOperation",onbeforeunload:"_onBeforeUnload",paste:"_onPaste","hax-register-app":"_haxStoreRegisterApp","hax-register-stax":"_haxStoreRegisterStax","hax-store-write":"_writeHaxStore","hax-register-core-piece":"_haxStorePieceRegistrationManager","hax-register-body":"_haxStoreRegisterBody","hax-insert-content":"_haxStoreInsertContent","hax-insert-content-array":"_haxStoreInsertMultiple","hax-add-voice-command":"_addVoiceCommand"},window.onbeforeunload=e=>{if(!this.skipExitTrap&&this.editMode){var t="Are you sure you want to leave? Your work will not be saved!";return e.returnValue=t,t}},i.registerNewTour({key:"hax",name:"Let's learn HAX",style:"\n      simple-popover-manager::part(simple-popover) {\n        max-width: 250px;\n      }\n      simple-popover-manager button {\n        font-size: 12px;\n        margin: 0px 2px;\n      }\n      simple-popover-manager p {\n        --hax-base-styles-p-font-size: 14px;\n        padding: 0;\n        margin: 0;\n        font-size: 14px;\n        line-height: 20px;\n      }\n      simple-popover-manager h3 {\n        --hax-base-styles-h3-font-size: 18px;\n        margin: 8px 2px;\n      }"}),this.voiceRespondsTo="(worker)",this.voiceCommands={},this.skipHAXConfirmation=!1,this.storageData={},this.appStore={url:"",params:{}},this.activeNode=null,this.activeEditingElement=null,this.haxBodies=[],this.activePlaceHolder=null,this.sessionObject={},this.editMode=!1,this.skipExitTrap=!1,this.elementList={},this.appList=[],this.gizmoList=[],this.activeHaxBody=null,this.staxList=[],this.globalPreferences={},this.activeApp={},this.connectionRewrites={},this.voiceDebug=!1,this.keyboardShortcuts={"#":{tag:"h2",content:""},"##":{tag:"h3",content:""},"###":{tag:"h4",content:""},"####":{tag:"h5",content:""},"#####":{tag:"h6",content:""},"-":{tag:"ul",content:"<li></li>"},"1.":{tag:"ol",content:"<li></li>"},"---":{tag:"hr"},"```":{tag:"code",content:""},">":{tag:"blockquote",content:""}},this.validTagList=this.__validTags(),this.validGridTagList=this.__validGridTags(),this.validGizmoTypes=this.__validGizmoTypes();let e=document.createElement("webview");this._isSandboxed="function"==typeof e.reload,import("./hax-app.js"),import("../../simple-toast/simple-toast.js").then(()=>{window.SimpleToast.requestAvailability()}),import("../../media-behaviors/media-behaviors.js"),document.body.style.setProperty("--hax-ui-headings","#d4ff77"),h(this,{gizmoList:c,activeNode:c,globalPreferences:c,activeGizmo:p,editMode:c,appList:c,activeApp:c,haxSelectedText:c,activeEditingElement:c,activeHaxBody:c}),u(()=>{this._globalPreferencesChanged(g(this.globalPreferences))}),u(()=>{this._editModeChanged(g(this.editMode))})}_buildPrimitiveDefinitions(){if(this._isSandboxed){let e={type:"element",editingElement:"core",canScale:!0,canPosition:!0,canEditSource:!0,settings:{configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[]}};this.setHaxProperties(e,"webview")}this.setHaxProperties({type:"element",editingElement:"core",canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Basic iframe",description:"A basic iframe",icon:"icons:fullscreen",color:"blue-grey",groups:["Content"],handles:[{type:"link",source:"src",height:"height",width:"width"},{type:"pdf",source:"src",height:"height",width:"width"},{type:"document",source:"src",height:"height",width:"width"},{type:"html",source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"textfield",icon:"link",required:!0,validationType:"url"}],advanced:[{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]}},"iframe");this.setHaxProperties({canScale:{min:10,step:5},type:"element",editingElement:"core",canPosition:!0,canEditSource:!0,gizmo:{title:"Image",description:"A basic img tag",icon:"image:image",color:"blue-grey",groups:["Image","Media"],handles:[{type:"link",source:"src"},{type:"image",type_exclusive:!0,source:"src",height:"height",width:"width"}],meta:{author:"W3C"}},settings:{configure:[{attribute:"src",title:"Source",description:"The URL for this video.",inputMethod:"haxupload",icon:"link",required:!0,validationType:"url"},{attribute:"alt",title:"Alt text",description:"Useful for screen readers and improved SEO.",inputMethod:"alt",icon:"accessibility"},{attribute:"height",title:"Height",description:"height in pixels of the item. Leave blank to respond to the natural resolution",inputMethod:"textfield",icon:"icons:swap-vert"}],advanced:[{attribute:"aria-describedby",title:"Aria-describedby",description:"Space-separated list of IDs for elements that describe the image.",inputMethod:"textfield",icon:"accessibility"},{attribute:"loading",title:"Loading method",description:"Whether or not to lazy load this",inputMethod:"select",options:{lazy:"Load when visible",auto:"Automatic"}}]}},"img");let e={type:"element",editingElement:"core",canScale:!1,canPosition:!1,canEditSource:!0,contentEditable:!0,gizmo:{title:"Basic link",description:"A basic a tag",icon:"icons:link",color:"blue-grey",groups:["Link"],handles:[],meta:{author:"W3C"}},settings:{configure:[{attribute:"innerText",title:"Text",description:"Text of the link",inputMethod:"textfield",required:!0},{attribute:"href",title:"Link",description:"The URL for this video.",inputMethod:"haxupload",icon:"icons:link",required:!0,validationType:"url"},{attribute:"title",title:"Title text",description:"Useful for screen readers and improved SEO.",inputMethod:"textfield",icon:"icons:accessibility"},{attribute:"target",title:"Target",description:"Where to place the link.",inputMethod:"select",icon:"icons:launch",options:{"":"Same window",_blank:"New window",_top:"Top window",_parent:"Parent window"}}],advanced:[]}};this.validGizmoTypes.forEach(t=>{e.gizmo.handles.push({type:t,source:"href",title:"innerText",alt:"title"})}),this.setHaxProperties(e,"a");this.setHaxProperties({type:"element",editingElement:"core",canScale:!1,canPosition:!1,canEditSource:!0,contentEditable:!0,gizmo:{title:"Paragraph",description:"A basic text area",icon:"hax:paragraph",color:"blue-grey",groups:["Content"],handles:[{type:"content",content:""}],meta:{author:"W3C"}},settings:{configure:[],advanced:[]},demoSchema:[{tag:"p",content:"Text",properties:{}}]},"p");this.setHaxProperties({type:"element",editingElement:{tag:"editable-table",import:"@lrnwebcomponents/editable-table/editable-table.js"},canScale:!0,canPosition:!0,canEditSource:!0,gizmo:{title:"Table",description:"A table for displaying data",icon:"image:grid-on",color:"blue-grey",groups:["Content","Table","Data"],meta:{author:"W3C"}},settings:{configure:[],advanced:[]},demoSchema:[{tag:"table",content:"<tr><td>-</td><td>-</td><td>-</td></tr><tr><td>-</td><td>-</td><td>-</td></tr><tr><td>-</td><td>-</td><td>-</td></tr>",properties:{}}]},"table");let t={caption:{title:"Caption",icon:"av:call-to-action"},video:{title:"Video",icon:"av:play-circle-filled"},audio:{title:"Audio",icon:"image:music-note"},section:{title:"Section",icon:"image:crop-landscape"},ol:{title:"Numbered list",icon:"editor:format-list-numbered"},ul:{title:"Bulleted list",icon:"editor:format-list-bulleted"},li:{title:"List item",icon:"editor:format-list-bulleted"},h1:{title:"Heading",icon:"hax:h1"},h2:{title:"Heading",icon:"hax:h2"},h3:{title:"Heading",icon:"hax:h3"},h4:{title:"Heading",icon:"hax:h4"},h5:{title:"Heading",icon:"hax:h5"},h6:{title:"Heading",icon:"hax:h6"},strike:{title:"Cross out",icon:"editor:format-strikethrough"},u:{title:"Underline",icon:"editor:format-underlined"},sub:{title:"Subscript",icon:"mdextra:subscript"},sup:{title:"Superscript",icon:"mdextra:superscript"},div:{title:"DIV",icon:"image:crop-landscape"},span:{title:"SPAN",icon:"editor:short-text"},i:{title:"Italic",icon:"editor:format-italic"},em:{title:"Emphasis",icon:"editor:format-italic"},strong:{title:"Bold",icon:"editor:format-bold"},b:{title:"Bold",icon:"editor:format-bold"},blockquote:{title:"Block quote",icon:"editor:format-quote"},code:{title:"Code",icon:"icons:code"},figure:{title:"Figure",icon:"icons:label-outline"},embed:{title:"Embedded object",icon:"icons:fullscreen"}};for(var i in t)this.setHaxProperties({type:"element",editingElement:"core",canScale:!1,canPosition:!1,canEditSource:!0,contentEditable:!0,gizmo:{title:t[i].title,icon:t[i].icon,meta:{hidden:"h2"!=i}},settings:{configure:[],advanced:[]},demoSchema:[{tag:i,content:"h2"==i?"Heading":"",properties:{}}]},i);this.setHaxProperties({canScale:{min:25,step:25},type:"element",editingElement:"core",canPosition:!1,canEditSource:!1,contentEditable:!0,gizmo:{title:"Horizontal line",icon:"hax:hr",meta:{author:"W3C"}},settings:{configure:[],advanced:[]},demoSchema:[{tag:"hr",content:"",properties:{style:"width:50%;"}}]},"hr")}_haxStorePieceRegistrationManager(e){e.detail&&e.detail.piece&&e.detail.object&&(this[e.detail.piece]=e.detail.object)}setupAutocomplete(e){e.triggers={"!":e=>{let t=[];return this.gizmoList.forEach(e=>{t.push({groups:e.groups&&e.groups.length?e.groups.join(" "):"",icon:e.icon,label:e.title,value:e.tag})}),t}}}_haxStoreInsertContent(e){if(e.detail){let i=e.detail;if(window.customElements.get(i.tag)){let e=document.createElement(i.tag);this.testHook(e,"preProcessInsertContent")&&(i=this.runHook(e,"preProcessInsertContent",[i]))}var t={};if(void 0!==i.properties&&(t=i.properties),t.innerHTML&&(""==i.content&&(i.content=t.innerHTML),delete t.innerHTML),t.innerText&&(""==i.content&&(i.content=t.innerText),delete t.innerText),void 0!==i.__type&&"inline"===i.__type){let e=r({tag:i.tag,content:i.content,properties:t});null!==this.activePlaceHolder&&(this.activePlaceHolder.deleteContents(),this.activePlaceHolder.insertNode(e)),this.activePlaceHolder=null}else if(i.replace||i.replacement||i.nextToActive){let e=r({tag:i.tag,content:i.content,properties:t});this.activePlaceHolder?(this.activeHaxBody.haxReplaceNode(this.activePlaceHolder,e),this.activePlaceHolder=null):i.nextToActive&&this.activeNode?this.activeHaxBody.__slot&&"GRID-PLATE"===this.activeNode.tagName?this.activeNode.appendChild(e):this.activeNode.parentNode.insertBefore(e,this.activeNode):this.activeHaxBody.haxReplaceNode(this.activeNode,e)}else if(this.activeNode.parentNode&&"HAX-BODY"!=this.activeNode.parentNode.tagName){let e=r({tag:i.tag,content:i.content,properties:t});"GRID-PLATE"===this.activeNode.parentNode.tagName?(null!=this.activeNode.getAttribute("slot")&&e.setAttribute("slot",this.activeNode.getAttribute("slot")),this.activeHaxBody.haxInsert(i.tag,i.content,t)):this.activeHaxBody.haxInsert(i.tag,i.content,t)}else this.activeHaxBody.haxInsert(i.tag,i.content,t)}}haxSchemaFromTag(e){return e=e.toLowerCase(),this.elementList&&this.elementList[e]?this.elementList[e]:{}}_haxStoreInsertMultiple(e){var t;if(e.detail)for(var i in e.detail)t={},void 0!==e.detail[i].properties&&(t=e.detail[i].properties),this.activeHaxBody.haxInsert(e.detail[i].tag,e.detail[i].content,t)}_haxStoreRegisterBody(e){e.detail&&(this.haxBodies.push(e.detail),this.activeHaxBody=e.detail,this.write("activeHaxBody",this.activeHaxBody,this),this.write("editMode",this.editMode,this))}computePolyfillSafe(){return!(!document.head.createShadowRoot&&!document.head.attachShadow)||(console.warn("Shadow DOM missing, certain operations hidden"),!1)}_writeHaxStore(e){e.detail&&void 0!==e.detail.value&&e.detail.property&&e.detail.owner&&(e.detail.owner!==this&&(null==e.detail.value?this[e.detail.property]=null:"object"==typeof e.detail.value&&(this[e.detail.property]={}),this[e.detail.property]=e.detail.value),this.dispatchEvent(new CustomEvent("hax-store-property-updated",{bubbles:!0,composed:!0,cancelable:!1,detail:{property:e.detail.property,value:e.detail.value,owner:e.detail.owner}})))}_haxStoreRegisterApp(e){if(e.detail){if(e.detail.index=this.appList.length,this.appList=[...this.appList,e.detail],this.write("appList",this.appList,this),e.detail.connection&&e.detail.connection.protocol&&e.detail.connection.url){let t=document.createElement("link");t.rel="preconnect",t.href=e.detail.connection.protocol+"://"+e.detail.connection.url,document.head.appendChild(t)}void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target)}}_haxStoreRegisterStax(e){e.detail&&(e.detail.index=this.staxList.length,this.staxList=[...this.staxList,e.detail],this.write("staxList",this.staxList,this),void 0!==e.target.parentElement&&"HAX-STORE"===e.target.parentElement.tagName&&e.target.parentElement.removeChild(e.target))}dashToCamel(e){return e.replace(/-([a-z])/g,(function(e){return e[1].toUpperCase()}))}htmlToHaxElements(e){let t=[];const i=this.validTagList;let o=document.createElement("div");o.innerHTML=e;const a=o.childNodes;for(var n=0;n<a.length;n++)void 0!==a[n].tagName&&i.includes(a[n].tagName.toLowerCase())&&t.push(s(a[n],null));return t}nodeToContent(e){this.testHook(e,"preProcessNodeToContent")&&(e=this.runHook(e,"preProcessNodeToContent",[e]));let t=e.tagName.toLowerCase();this._isSandboxed&&"webview"===t&&(t="iframe");var i="";i+="<"+t;for(var o=this.elementList[t],a={},n=0,s=e.attributes.length;n<s;++n){var r=e.attributes.item(n).nodeName,l=e.attributes.item(n).value;"style"==r||typeof l!=typeof Object&&l.constructor!==Array?null!=l&&"null"!=l&&(!0===l||"true"===l?a[r]=!0:!1===l||("string"==typeof l&&""!==l?(l=l.replace(new RegExp('"',"g"),"&quot;"),a[r]=l):""===l?(""==l&&""!=e.attributes.item(n).value&&(l=e.attributes.item(n).value),a[r]=l):a[r]=l)):a[r]=JSON.stringify(l).replace(new RegExp('"',"g"),"&quot;")}let c;if(customElements.get(t)&&(c=customElements.get(t).properties),void 0===c&&(c=e.__data),void 0!==c)for(var n in c){r=d(n),l=null;void 0!==e[n]&&(l=e[n]),c[n].readOnly||c[n].computed||l===c[n].value||r.startsWith("__")||(null==l||"object"!=typeof l&&l.constructor!==Array?null!=l&&"null"!=l&&(!0===l||"true"===l?a[r]=!0:!1===l||("string"==typeof l&&""!==l?(l=l.replace(new RegExp('"',"g"),"&quot;"),a[r]=l):""===l?""==l&&""!=c[n].value?l=c[n].value:""===l&&c[n].value:a[r]=l)):(l.constructor===Array&&l!=[]||"object"==typeof l&&l!={})&&(a[r]=JSON.stringify(l).replace(new RegExp('"',"g"),"&quot;")))}if(void 0!==o&&void 0!==o.saveOptions.unsetAttributes)for(var h in o.saveOptions.unsetAttributes)delete a[o.saveOptions.unsetAttributes[h]];let p=["inner-text","inner-html","tabindex","guestinstance"];for(var m in p)void 0!==a[p[m]]&&delete a[p[m]];for(var h in void 0!==a.id&&""===a.id&&delete a.id,delete a.draggable,delete a.contenteditable,delete a["data-hax-ray"],""!=a.class&&"hax-active"!=a.class||delete a.class,a)!0===a[h]?i+=" "+h:i+=" "+h+'="'+a[h]+'"';if(["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"].includes(t)?i+="/>":i+=">",void 0===o||!o.saveOptions.wipeSlot){let t=e.childNodes;if(t.length>0){n=0;for(var u=t.length;n<u;n++)void 0!==t[n].tagName?this.HTMLPrimativeTest(t[n].tagName)||"TEMPLATE"===t[n].tagName?(t[n].removeAttribute("data-hax-ray"),t[n].contentEditable=!1,i+=t[n].outerHTML):i+=this.nodeToContent(t[n]):8===t[n].nodeType?i+="\x3c!-- "+t[n].textContent+" --\x3e":1!==t[n].nodeType&&void 0!==t[n].textContent&&"undefined"!==t[n].textContent&&(i+=t[n].textContent)}}return this.testHook(e,"progressiveEnhancement")&&(i+=this.runHook(e,"progressiveEnhancement",[e])),"span"===t?i+="</"+t+">":"hr"===t||"br"===t||"img"===t||(i+="</"+t+">\n"),i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=(i=i.replace(/&nbsp;/gm," ")).replace(/ data-hax-ray="(\s|.)*?"/gim,"")).replace(/ class=""/gim,"")).replace(/ class="hax-active"/gim,"")).replace(/ contenteditable="(\s|.)*?"/gim,"")).replace(/<span style="(.*?)">/gim,"<span>")).replace(/<span>\s*?<\/span>/g," ")).replace(/<span><br\/><\/span>/gm,"")).replace(/<strong style="(.*?)">/gim,"<strong>")).replace(/<b style="(.*?)">/gim,"<b>")).replace(/<strike style="(.*?)">/gim,"<strike>")).replace(/<em style="(.*?)">/gim,"<em>")).replace(/<i style="(.*?)">/gim,"<i>")).replace(/<p>(\s*)<\/p>/gm,"<p></p>")).replace(/<p>&nbsp;<\/p>/gm,"<p></p>")).replace(/<p><br\/><\/p>/gm,"<p></p>")).replace(/<p><br><\/p>/gm,"<p></p>")).replace(/<\/p>(\s*)<p>/gm,"</p><p>")).split("\n\r").join("\n").split("\r").join("\n").split("\n\n").join("\n").split("\n\n").join("\n").split("\n\n").join("\n"),this.testHook(e,"postProcessNodeToContent")&&(i=this.runHook(e,"postProcessNodeToContent",[i])),i}HTMLPrimativeTest(e){return void 0!==e.tagName&&-1==e.tagName.indexOf("-")}getHaxAppStoreTargets(e){return this.appList.filter(t=>{if(void 0!==t.connection.operations.add){let i=t.connection.operations.add;if(void 0!==i.acceptsGizmoTypes&&i.acceptsGizmoTypes.includes(e))return!0}return!1})}refreshActiveNodeForm(){this.haxTray.activeHaxElement=s(this.haxTray.activeNode,null),this.haxTray._setupForm()}haxElementPrototype(e,t,i=""){return{tag:e.tag,properties:t,content:i,gizmo:e}}getHAXSlot(e){if(this.isTextElement(e))return e.innerHTML;let t="";var i=e.childNodes;if(i.length>0)for(var o=0,a=i.length;o<a;o++)void 0!==i[o].tagName?i[o].tagName.indexOf("-")>0?t+="  "+this.nodeToContent(i[o])+"\n":t+="  "+i[o].outerHTML+"\n":8===i[o].nodeType?t+="\x3c!-- "+i[o].textContent+" --\x3e":1!==i[o].nodeType&&void 0!==i[o].textContent&&"undefined"!==i[o].textContent&&(t+=i[o].textContent);return t}_haxStoreRegisterProperties(e){if(e.detail&&e.detail.properties&&e.detail.tag){if(!this.elementList[e.detail.tag]){let t=e.detail.properties.gizmo;if(t){t.tag=e.detail.tag;let i=this.gizmoList;i.push(t),this.gizmoList=[...i],this.write("gizmoList",i,this),window.customElements.get(t.tag)&&this.testHook(document.createElement(t.tag),"gizmoRegistration")&&this.runHook(document.createElement(t.tag),"gizmoRegistration",[this])}this.elementList[e.detail.tag]=e.detail.properties,this.validTagList.find(t=>t===e.detail.tag)||this.validTagList.push(e.detail.tag),"grid"!=e.detail.properties.type||this.validGridTagList.find(t=>t===e.detail.tag)||this.validGridTagList.push(e.detail.tag)}void 0!==e.target.parentElement&&"HAX-AUTOLOADER"===e.target.parentElement.tagName&&this.haxAutoloader.removeChild(e.target)}}get activeGizmo(){let e=g(this._calculateActiveGizmo(this.activeNode));return this.write("activeGizmo",e,this),e}}window.customElements.define(HaxStore.tag,HaxStore);export{HaxStore};window.HaxStore=window.HaxStore||{},window.HaxStore.requestAvailability=function(){return window.HaxStore.instance||(window.HaxStore.instance=document.createElement("hax-store"),document.body.appendChild(window.HaxStore.instance)),window.HaxStore.instance};export const HAXStore=window.HaxStore.requestAvailability();window.Hax=window.Hax||{},window.Hax.add=function(e){if(HAXStore.elementList[e]){let t,i=HAXStore.haxSchemaFromTag(e);t=i.gizmo.tag&&i.demoSchema&&i.demoSchema[0]?r(i.demoSchema[0]):document.createElement(e),HAXStore.activeHaxBody.haxReplaceNode(HAXStore.activeNode,t),HAXStore.activeHaxBody.__focusLogic(t)}else HAXStore.toast(e+" is not a valid tag")},window.Hax.delete=function(){null!=HAXStore.activeNode&&HAXStore.activeHaxBody.haxDeleteNode(HAXStore.activeNode)},window.Hax.duplicate=function(){HAXStore.activeHaxBody.haxDuplicateNode(HAXStore.activeNode)},window.Hax.move=function(e=!0){e?HAXStore.activeHaxBody.haxMoveGridPlate("up",HAXStore.activeNode):HAXStore.activeHaxBody.haxMoveGridPlate("down",HAXStore.activeNode)},window.Hax.grid=function(e=!0){HAXStore.activeHaxBody.haxGridPlateOps(e)},window.Hax.set=function(e,t){HAXStore.write(e,t,window)},window.Hax.get=function(e){return HAXStore[e]},window.Hax.export=function(){return HAXStore.activeHaxBody.haxToContent()},window.Hax.import=function(e="<p></p>"){return HAXStore.activeHaxBody.importContent(e)};