var e;try{throw new Error}catch(t){e=t}var t=require("./schedule"),s=require("./queue"),n=require("./util");function Async(){this._customScheduler=!1,this._isTickUsed=!1,this._lateQueue=new s(16),this._normalQueue=new s(16),this._haveDrainedQueues=!1,this._trampolineEnabled=!0;var e=this;this.drainQueues=function(){e._drainQueues()},this._schedule=t}function AsyncInvokeLater(e,t,s){this._lateQueue.push(e,t,s),this._queueTick()}function AsyncInvoke(e,t,s){this._normalQueue.push(e,t,s),this._queueTick()}function AsyncSettlePromises(e){this._normalQueue._pushOne(e),this._queueTick()}Async.prototype.setScheduler=function(e){var t=this._schedule;return this._schedule=e,this._customScheduler=!0,t},Async.prototype.hasCustomScheduler=function(){return this._customScheduler},Async.prototype.enableTrampoline=function(){this._trampolineEnabled=!0},Async.prototype.disableTrampolineIfNecessary=function(){n.hasDevTools&&(this._trampolineEnabled=!1)},Async.prototype.haveItemsQueued=function(){return this._isTickUsed||this._haveDrainedQueues},Async.prototype.fatalError=function(e,t){t?(process.stderr.write("Fatal "+(e instanceof Error?e.stack:e)+"\n"),process.exit(2)):this.throwLater(e)},Async.prototype.throwLater=function(e,t){if(1===arguments.length&&(t=e,e=function(){throw t}),"undefined"!=typeof setTimeout)setTimeout((function(){e(t)}),0);else try{this._schedule((function(){e(t)}))}catch(e){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")}},n.hasDevTools?(Async.prototype.invokeLater=function(e,t,s){this._trampolineEnabled?AsyncInvokeLater.call(this,e,t,s):this._schedule((function(){setTimeout((function(){e.call(t,s)}),100)}))},Async.prototype.invoke=function(e,t,s){this._trampolineEnabled?AsyncInvoke.call(this,e,t,s):this._schedule((function(){e.call(t,s)}))},Async.prototype.settlePromises=function(e){this._trampolineEnabled?AsyncSettlePromises.call(this,e):this._schedule((function(){e._settlePromises()}))}):(Async.prototype.invokeLater=AsyncInvokeLater,Async.prototype.invoke=AsyncInvoke,Async.prototype.settlePromises=AsyncSettlePromises),Async.prototype._drainQueue=function(e){for(;e.length()>0;){var t=e.shift();if("function"==typeof t){var s=e.shift(),n=e.shift();t.call(s,n)}else t._settlePromises()}},Async.prototype._drainQueues=function(){this._drainQueue(this._normalQueue),this._reset(),this._haveDrainedQueues=!0,this._drainQueue(this._lateQueue)},Async.prototype._queueTick=function(){this._isTickUsed||(this._isTickUsed=!0,this._schedule(this.drainQueues))},Async.prototype._reset=function(){this._isTickUsed=!1},module.exports=Async,module.exports.firstLineError=e;