/**
 * Copyright 2021 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
window.I18NManagerStore=window.I18NManagerStore||{},window.I18NManagerStore.requestAvailability=()=>(window.I18NManagerStore.instance||(window.I18NManagerStore.instance=document.createElement("i18n-manager"),document.body.appendChild(window.I18NManagerStore.instance)),window.I18NManagerStore.instance);export const I18NManagerStore=window.I18NManagerStore.requestAvailability();class I18NManager extends HTMLElement{constructor(){super(),this.fetchTargets={},this.elements=[],this.locales=new Set([]),this.lang=this.documentLang,this.dir=this.documentDir}get documentLang(){return document.body.getAttribute("xml:lang")||document.body.getAttribute("lang")||document.documentElement.getAttribute("xml:lang")||document.documentElement.getAttribute("lang")||navigator.language||"en"}get documentDir(){return document.body.getAttribute("xml:dir")||document.body.getAttribute("dir")||document.documentElement.getAttribute("xml:dir")||document.documentElement.getAttribute("dir")||"ltr"}connectedCallback(){this.__ready=!0,window.addEventListener("i18n-manager-register-element",this.registerLocalizationEvent.bind(this)),window.addEventListener("languagechange",this.changeLanguageEvent.bind(this))}disconnectedCallback(){window.removeEventListener("i18n-manager-register-element",this.registerLocalizationEvent.bind(this)),window.removeEventListener("languagechange",this.changeLanguageEvent.bind(this))}changeLanguageEvent(e){this.lang=e.detail}registerLocalizationEvent(e){let t=this.detailNormalize(e.detail);t.namespace&&t.localesPath&&t.locales&&this.registerLocalization(t)}detailNormalize(e){if(!e.namespace&&e.context&&(e.namespace=e.context.tagName.toLowerCase()),!e.updateCallback&&e.context&&(e.context.requestUpdate?e.updateCallback="requestUpdate":e.context.render&&(e.updateCallback="render")),!e.localesPath&&e.basePath&&(e.localesPath=`${decodeURIComponent(e.basePath)}/../locales`),e.context&&e.namespace){e.context.t&&(e.context._t={...e.context.t});let t=this.elements.filter((t=>{if(t.namespace==e.namespace&&t.localesPath&&t.locales)return!0}));t&&t.length&&t[0]&&(e.localesPath=t[0].localesPath,e.locales=t[0].locales)}return e}registerLocalization(e){(!e.context&&0===this.elements.filter((t=>t.namespace===e.namespace)).length||0===this.elements.filter((t=>t.context===e.context)).length)&&(e=this.detailNormalize(e),this.elements.push(e),e&&e.locales&&e.locales.forEach(this.locales.add,this.locales),this.lang&&this.__ready&&e.locales&&e.locales.includes(this.lang)&&(clearTimeout(this._debounce),this._debounce=setTimeout((()=>{this.updateLanguage(this.lang)}),0)))}static get tag(){return"i18n-manager"}async loadNamespaceFile(e,t=this.lang){const a=t.split("-");let n=this.elements.filter((n=>n.namespace===e&&(n.locales.includes(t)||n.locales.includes(a[0]))));if(n&&1===n.length){const e=n[0];var i="";return e.locales.includes(t)?i=`${e.localesPath}/${e.namespace}.${t}.json`:e.locales.includes(a[0])&&(i=`${e.localesPath}/${e.namespace}.${a[0]}.json`),""==i?{}:(this.fetchTargets[i]||(this.fetchTargets[i]=await fetch(i).then((e=>!(!e||!e.json)&&e.json()))),this.fetchTargets[i])}}async updateLanguage(e){if(e){const i=e.split("-"),s=this.elements.filter((t=>{try{return t.locales.includes(e)||t.locales.includes(i[0])}catch(e){console.error("i18n registration incorrect in:",t,e)}})),l=this.elements.filter((t=>!t.locales.includes(e)&&!t.locales.includes(i[0])));if(0!==l.length)for(var t in l){let e=l[t];e.context&&(e.context.t={...e.context._t},e.updateCallback&&e.context[e.updateCallback]())}for(var t in s){let l=s[t];var a="";if(l.locales.includes(e)?a=`${l.localesPath}/${l.namespace}.${e}.json`:l.locales.includes(i[0])&&(a=`${l.localesPath}/${l.namespace}.${i[0]}.json`),this.fetchTargets[a]){if(l.context){let e=this.fetchTargets[a];for(var n in e)l.context.t[n]=e[n];l.context.t={...l.context.t},l.updateCallback&&l.context[l.updateCallback]()}}else if(this.fetchTargets[a]=await fetch(a).then((e=>!(!e||!e.json)&&e.json())),l.context){for(var n in this.fetchTargets[a])l.context.t[n]=this.fetchTargets[a][n];l.context.t={...l.context.t},l.updateCallback&&l.context&&l.context[l.updateCallback]()}}}}static get observedAttributes(){return["lang","dir"]}attributeChangedCallback(e,t,a){"lang"!==e&&"dir"!==e||this.dispatchEvent(new CustomEvent(`${e}-changed`,{detail:{value:a}})),"lang"===e&&a&&this.__ready&&this.updateLanguage(a)}get lang(){return this.getAttribute("lang")}set lang(e){e?this.setAttribute("lang",e):this.removeAttribute("lang")}get dir(){return this.getAttribute("dir")}set dir(e){e?this.setAttribute("dir",e):this.removeAttribute("dir")}}customElements.define(I18NManager.tag,I18NManager);export{I18NManager};