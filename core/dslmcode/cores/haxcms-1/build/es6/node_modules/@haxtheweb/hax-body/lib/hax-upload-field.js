import{html as e,css as t}from"../../../lit/index.js";import{SimpleFieldsUpload as o}from"../../simple-fields/lib/simple-fields-upload.js";import{winEventsElement as a,localStorageGet as i}from"../../utils/utils.js";import{HAXStore as l}from"./hax-store.js";import{SuperDaemonInstance as s}from"../../super-daemon/super-daemon.js";import{I18NMixin as n}from"../../i18n-manager/lib/I18NMixin.js";class HaxUploadField extends(a(n(o))){constructor(){super(),this.showSources=!0,this.autocomplete="on",this.noScreenRecord=!1,this.__winEvents={"hax-app-picker-selection":"_haxAppPickerSelection","jwt-token":"_jwtTokenRefreshed"},this.t=this.t||{},this.t={...this.t,whereUpload:"Where would you like to upload this",serverStorageLocationCantHandle:"Server storage location can't handle",fileUploadsMustHaveAFileExtension:"File uploads must have a file extension",uploads:"uploads",dropMediaHereOr:"drop media here or",selectMedia:"Select media",upload:"Upload",takePhoto:"Take photo",recordAudio:"Record audio",cancel:"Cancel",uploadMedia:"Upload media"},this.registerLocalization({context:this,namespace:"hax"})}static get tag(){return"hax-upload-field"}_canUpload(){return!this.__allowUpload&&l}static get properties(){return{...super.properties,showSources:{type:Boolean,reflect:!0,attribute:"show-sources"}}}_fileAboutToUpload(e){if(this._canUpload()){e.preventDefault(),e.stopPropagation();let o={source:e.detail.file.name,type:e.detail.file.type};if(""!==e.detail.file.type||e.detail.file.name.includes(".")){var t=l.guessGizmoType(o);let e=l.getHaxAppStoreTargets(t);1===e.length?this._haxAppPickerSelection({detail:e[0]}):0!==e.length?l.haxAppPicker.presentOptions(e,t,`${this.t.whereUpload} ${t}?`,"app"):l.toast(`${this.t.serverStorageLocationCantHandle} ${t} ${this.t.uploads}!`,5e3)}else l.toast(`${this.t.fileUploadsMustHaveAFileExtension}!`,5e3),this.shadowRoot.querySelector("#fileupload").files=[]}else this.__allowUpload=!1}_haxAppPickerSelection(e){let t=e.detail.connection;this.__appUsed=e.detail,this.shadowRoot.querySelector("#fileupload").method=t.operations.add.method;let o=t.protocol+"://"+t.url;"/"!=o.substr(o.length-1)&&(o+="/"),void 0!==t.operations.add.endPoint&&(o+=t.operations.add.endPoint),this.__baseEndpoint=o,null!=l.connectionRewrites.appendUploadEndPoint?o+="?"+l.connectionRewrites.appendUploadEndPoint:globalThis.store&&globalThis.store.manifest&&globalThis.store.activeId?(o+="?siteName="+globalThis.store.manifest.metadata.site.name+"&nodeId="+globalThis.store.activeId,console.warn("HAXStore.connectionRewrites.appendUploadEndPoint was not set, using fallback from store")):console.error("Cannot determine siteName and nodeId for file upload - appendUploadEndPoint not set and store not available"),null!=l.connectionRewrites.appendJwt&&(o+="&"+l.connectionRewrites.appendJwt+"="+i(l.connectionRewrites.appendJwt)),this.shadowRoot.querySelector("#fileupload").headers=t.headers,this.shadowRoot.querySelector("#fileupload").target=o,this.__allowUpload=!0,this.shadowRoot.querySelector("#fileupload").uploadFiles()}_jwtTokenRefreshed(e){if(this.__pendingUploadRetry){const e=this.shadowRoot.querySelector("#fileupload");if(e){let t=this.__pendingUploadRetry.baseEndpoint;null!=l.connectionRewrites.appendUploadEndPoint?t+="?"+l.connectionRewrites.appendUploadEndPoint:globalThis.store&&globalThis.store.manifest&&globalThis.store.activeId&&(t+="?siteName="+globalThis.store.manifest.metadata.site.name+"&nodeId="+globalThis.store.activeId),null!=l.connectionRewrites.appendJwt&&(t+="&"+l.connectionRewrites.appendJwt+"="+i(l.connectionRewrites.appendJwt)),e.target=t,this.__allowUpload=!0,e.uploadFiles()}this.__pendingUploadRetry=null}}_fileUploadResponse(e){if(403===e.detail.xhr.status)return this.__pendingUploadRetry={baseEndpoint:this.__baseEndpoint,appUsed:this.__appUsed},void globalThis.dispatchEvent(new CustomEvent("jwt-login-refresh-token",{composed:!0,bubbles:!0,cancelable:!1,detail:{}}));if(200===e.detail.xhr.status){try{let o=JSON.parse(e.detail.xhr.response),a=this.__appUsed.connection.operations.add.resultMap,i={},s={};for(var t in void 0!==this._resolveObjectPath(a.item,o)&&(i=this._resolveObjectPath(a.item,o)),s.type=a.defaultGizmoType,a.gizmo)s[t]=this._resolveObjectPath(a.gizmo[t],i);void 0===s.url&&void 0!==s.source&&(s.url=s.source),void 0!==a.gizmo.type&&(s.type=this._resolveObjectPath(a.gizmo.type,i)),this.shadowRoot.querySelector("#url").value=s.url,l.activePlaceHolderCallback&&"function"==typeof l.activePlaceHolderCallback&&(l.activePlaceHolderCallback({file:s.url,item:s,response:o}),l.activePlaceHolderCallback=null)}catch(e){console.warn("Error parsing response",e)}this.shadowRoot.querySelector("#url")&&(this.shadowRoot.querySelector("#fileupload").files=[])}}get sources(){return e` <simple-toolbar-button
        ?disabled="${this.disabled}"
        label="${this.t.selectMedia}.."
        ?show-text-label="${this.responsiveSize.indexOf("s")<0}"
        icon="hax:multimedia"
        show-text-label
        @click="${this._clickMediaButton}"
        controls="fieldset"
        part="merlin"
        ?hidden="${!this.showSources}"
      >
      </simple-toolbar-button>
      ${super.sources}`}valueChanged(e){this.value=e.detail.value}_clickMediaButton(e){var t="sources";if(this.label.toLowerCase().includes("image"))t="image";else if(this.label.toLowerCase().includes("video"))t="video";else if(l.haxTray.activeHaxElement){let e=l.guessGizmoType(l.haxTray.activeHaxElement.properties);"*"!=e&&(t=e)}s.runProgram(t),"hax-upload-field"==this.tagName.toLowerCase()&&(s.programTarget=this),s.open()}}globalThis.customElements.define(HaxUploadField.tag,HaxUploadField);export{HaxUploadField};