!function(r,e){var o,t,n,a={},i={};r(document).ready((function(){o=H5PAdminIntegration.libraryInfo;const e=r("#h5p-admin-container").html("");t=r('<ul class="content-upgrade-log"></ul>').appendTo(e),n=r("<div><p>"+o.message+"</p></div>").appendTo(e);var a=r(getVersionSelect(o.versions)).appendTo(n);r("<button/>",{class:"h5p-admin-upgrade-button",text:o.buttonLabel,click:function(){new ContentUpgrade(a.val())}}).appendTo(n)}));var getVersionSelect=function(r){var e="";for(var o in r)e+='<option value="'+o+'">'+r[o]+"</option>";if(""!==e)return e="<select>"+e+"</select>"};function Throbber(r){var e=H5PUtils.throbber(r);n.html("").append(e),this.setProgress=function(o){e.text(r+" "+o)}}function ContentUpgrade(r){var t=this;t.version=new e(o.versions[r]),t.version.libraryId=r,t.throbber=new Throbber(o.inProgress.replace("%ver",t.version)),t.started=(new Date).getTime(),t.io=0,t.working=0;var start=function(){t.nextBatch({libraryId:r,token:o.token})};void 0!==globalThis.Worker?(t.initWorkers(),start()):t.loadScript(o.scriptBaseUrl+"/h5p-content-upgrade-process.js"+o.buster,start)}ContentUpgrade.prototype.initWorkers=function(){var r=this,t=void 0!==globalThis.navigator&&globalThis.navigator.hardwareConcurrency?globalThis.navigator.hardwareConcurrency:4;r.workers=new Array(t);for(var n={done:function(e){r.workDone(e.id,e.params,this)},error:function(e){r.printError(e.err),r.workDone(e.id,null,this)},loadLibrary:function(o){var t=this;r.loadLibrary(o.name,new e(o.version),(function(r,e){r||t.postMessage({action:"libraryLoaded",library:e})}))}},a=0;a<t;a++)r.workers[a]=new Worker(o.scriptBaseUrl+"/h5p-content-upgrade-worker.js"+o.buster),r.workers[a].onmessage=function(r){void 0!==r.data.action&&n[r.data.action]&&n[r.data.action].call(this,r.data)}},ContentUpgrade.prototype.nextBatch=function(e){var t=this,n=(new Date).getTime();r.post(o.infoUrl,e,(function(r){if(t.io+=(new Date).getTime()-n,!(r instanceof Object))return t.setStatus(r);if(0===r.left){var e=(new Date).getTime()-t.started;return globalThis.console&&console.log&&console.log("The upgrade process took "+e/1e3+" seconds. ("+Math.round(t.io/(e/100)*100)/100+" % IO)"),t.terminate(),t.setStatus(o.done)}t.left=r.left,t.token=r.token,t.processBatch(r.params,r.skipped)}))},ContentUpgrade.prototype.setStatus=function(r){n.html(r)},ContentUpgrade.prototype.processBatch=function(r,e){var o=this;for(var t in o.upgraded={},o.skipped=e,o.parameters=r,o.ids=[],r)r.hasOwnProperty(t)&&o.ids.push(t);if(o.current=-1,void 0!==o.workers)for(var n=0;n<o.workers.length;n++)o.assignWork(o.workers[n]);else o.assignWork()},ContentUpgrade.prototype.assignWork=function(r){var t=this,n=t.ids[t.current+1];if(void 0===n)return!1;t.current++,t.working++,r?r.postMessage({action:"newJob",id:n,name:o.library.name,oldVersion:o.library.version,newVersion:t.version.toString(),params:t.parameters[n]}):new H5P.ContentUpgradeProcess(o.library.name,new e(o.library.version),t.version,t.parameters[n],n,(function loadLibrary(r,e,n){t.loadLibrary(r,e,(function(a,i){i.upgradesScript?t.loadScript(i.upgradesScript,(function(t){t&&(t=o.errorScript.replace("%lib",r+" "+e)),n(t,i)})):n(null,i)}))}),(function done(r,e){r&&(t.printError(r),e=null),t.workDone(n,e)}))},ContentUpgrade.prototype.workDone=function(r,e,t){var n=this;n.working--,null===e?n.skipped.push(r):n.upgraded[r]=e,n.throbber.setProgress(Math.round((o.total-n.left+n.current)/(o.total/100))+" %"),!1===n.assignWork(t)&&0===n.working&&n.nextBatch({libraryId:n.version.libraryId,token:n.token,skipped:JSON.stringify(n.skipped),params:JSON.stringify(n.upgraded)})},ContentUpgrade.prototype.terminate=function(){var r=this;if(r.workers)for(var e=0;e<r.workers.length;e++)r.workers[e].terminate()};var s={};ContentUpgrade.prototype.loadLibrary=function(e,t,n){var i=this,p=e+"/"+t.major+"/"+t.minor;if(!0===a[p])return void 0===s[p]?void(s[p]=[n]):void s[p].push(n);if(void 0===a[p]){var d=(new Date).getTime();a[p]=!0,r.ajax({dataType:"json",cache:!0,url:o.libraryBaseUrl+"/"+p}).fail((function(){i.io+=(new Date).getTime()-d,n(o.errorData.replace("%lib",e+" "+t))})).done((function(r){if(i.io+=(new Date).getTime()-d,a[p]=r,n(null,r),void 0!==s[p])for(var e=0;e<s[p].length;e++)s[p][e](null,r);delete s[p]}))}else n(null,a[p])},ContentUpgrade.prototype.loadScript=function(e,o){var t=this;if(void 0===i[e]){var n=(new Date).getTime();r.ajax({dataType:"script",cache:!0,url:e}).fail((function(){t.io+=(new Date).getTime()-n,o(!0)})).done((function(){i[e]=!0,t.io+=(new Date).getTime()-n,o()}))}else o()},ContentUpgrade.prototype.printError=function(e){switch(e.type){case"errorParamsBroken":e=o.errorContent.replace("%id",e.id)+" "+o.errorParamsBroken;break;case"libraryMissing":e=o.errorLibrary.replace("%lib",e.library);break;case"scriptMissing":e=o.errorScript.replace("%lib",e.library);break;case"errorTooHighVersion":e=o.errorContent.replace("%id",e.id)+" "+o.errorTooHighVersion.replace("%used",e.used).replace("%supported",e.supported);break;case"errorNotSupported":e=o.errorContent.replace("%id",e.id)+" "+o.errorNotSupported.replace("%used",e.used)}r("<li>"+o.error+"<br/>"+e+"</li>").appendTo(t)}}(H5P.jQuery,H5P.Version);