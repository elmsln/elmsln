/**
 * Copyright 2018 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../../lit/index.js";globalThis.AbsolutePositionStateManager=globalThis.AbsolutePositionStateManager||{},globalThis.AbsolutePositionStateManager.requestAvailability=()=>{if(!globalThis.AbsolutePositionStateManager.instance&&globalThis.document){globalThis.AbsolutePositionStateManager.instance=globalThis.document.createElement("absolute-position-state-manager");let t=globalThis.AbsolutePositionStateManager.instance;globalThis.document.body.appendChild(t)}return globalThis.AbsolutePositionStateManager.instance};class AbsolutePositionStateManager extends t{static get tag(){return"absolute-position-state-manager"}static get properties(){return{scrollTarget:{type:Object},elements:{type:Array},__observer:{type:Object},__timeout:{type:Object},__timeout2:{type:Object}}}constructor(){super(),this.windowControllers=new AbortController,this.elements=[],this.__timeout=!1,this.__observer=new MutationObserver((t=>this.checkMutations(t)))}loadElement(t){this.elements.length<1&&(this.__observer.observe(document,{attributes:!0,childList:!0,subtree:!0,characterData:!0}),this.updateElements(),this.windowControllers=new AbortController,globalThis.document.addEventListener("load",this.updateElements.bind(this),{signal:this.windowControllers.signal}),globalThis.addEventListener("resize",this._handleResize.bind(this),{signal:this.windowControllers.signal})),this.elements.filter((e=>e===t)).length<1&&(this.elements.push(t),t.style.top=0,t.style.left=0),this.positionElement(t)}unloadElement(t){this.elements=this.elements.filter((e=>e!==t)),this.elements.length<1&&this.removeEventListeners()}_handleScroll(){this.__timeout2&&clearTimeout(this.__timeout2),this.__timeout2=setTimeout(globalThis.AbsolutePositionStateManager.instance.updateStickyElements(),1e3)}_handleResize(){this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(globalThis.AbsolutePositionStateManager.instance.updateElements(),250)}checkMutations(t){let e=!1;t.forEach((t=>{e||(e=e||!("attributes"===t.type&&"style"===t.attributeName&&this.elements.includes(t.target)))})),e&&(this.__timeout&&clearTimeout(this.__timeout),this.__timeout=setTimeout(globalThis.AbsolutePositionStateManager.instance.updateElements(),250))}findTarget(t){let e="#"+t.for,i=t.target,o=t;for(;t.for&&!i&&o&&o.parentNode&&o!==document;)o=o.parentNode,i=o?o.querySelector(e):void 0,11===o.nodeType&&(o=o.host),i=!i&&o?o.querySelector(e):i;return i}removeEventListeners(){this.__observer&&this.__observer.disconnect&&this.__observer.disconnect(),this.windowControllers.abort(),this.__watchSticky&&this.scrollTarget&&this.scrollTarget.removeEventListener("scroll",this._handleScroll)}updateElements(){this.elements.forEach((t=>this.positionElement(t))),this.loadSticky()}updateStickyElements(){this.elements.forEach((t=>{t.sticky&&this.positionElement(t)}))}loadSticky(){!this.__watchSticky&&this.elements.filter((t=>t.sticky)).length>0&&this.scrollTarget?(this.__watchSticky=!0,this.scrollTarget.addEventListener("scroll",this._handleScroll,{passive:!0})):this.__watchSticky&&this.elements.filter((t=>t.sticky)).length<1&&this.scrollTarget&&(this.scrollTarget.removeEventListener("scroll",this._handleScroll,{passive:!0}),this.__watchSticky=!1)}_getParentNode(t){let e=t.parentNode;return null!=e&&e.nodeType===Node.DOCUMENT_FRAGMENT_NODE&&(e=e.host),e}positionElement(t){t.position||(t.position="bottom"),t.style.position="absolute",t.style.top||(t.style.top="0px"),t.style.left||(t.style.left="0px");let e=this.findTarget(t),i=t.offsetParent,o=e&&e.getBoundingClientRect?e.getBoundingClientRect():{};if(!e||!i)return;t.justify&&(t.style.width=`${o.width}px`);let s=globalThis.document.body.getBoundingClientRect(),l=i.getBoundingClientRect(),n=t.getBoundingClientRect(),a=parseFloat(t.offset),pxToNum=t=>parseFloat(t.replace("px","")),vertical=(e=t.position)=>"left"!==e&&"right"!==e,setAlign=(e=vertical(t.position))=>{let i,l=e?pxToNum(t.style.left)-n.left:pxToNum(t.style.top)-n.top,a=e?"left":"top",distance=t=>e?t.width:t.height,r=l+distance(s)-distance(n),h=l;return"end"===t.positionAlign?h+=o[a]-distance(n)+distance(o):"start"===t.positionAlign?h+=o[a]:h+=o[a]-distance(n)/2+distance(o)/2,i=t.fitToVisibleBounds?Math.max(l,Math.min(r,h)):h,i},getCoord=(e=t.position)=>{let i,s=vertical(e)?pxToNum(t.style.top)-n.top:pxToNum(t.style.left)-n.left,l=t.allowOverlap||"visible"!=globalThis.getComputedStyle(t,null).overflowY?n.height:Math.max(n.height,t.scrollHeight),r=t.allowOverlap||"visible"!=globalThis.getComputedStyle(t,null).overflowX?n.width:Math.max(n.width,t.scrollWidth);return i="top"===e?o.top+s-l-a:"left"===e?o.left+s-r-a:o[e]+s+a,i},isFit=(e=t.position)=>{let distance=t=>vertical(e)?n.height+a:n.width+a;return((e=t.position)=>"left"===e||"top"===e)(e)?o[e]-s[e]>distance:s[e]-o[e]>distance},r=!1!==t.fitToVisibleBounds&&!isFit(t.position),h={top:["bottom","left","right"],left:["right","top","bottom"],bottom:["top","right","left"],right:["left","bottom","top"]};r&&isFit(h[t.position][0])?t.position=h[t.position][0]:r&&isFit(h[t.position][1])?t.position=h[t.position][1]:r&&isFit(h[t.position][2])&&(t.position=h[t.position][2]);let p=vertical(t.position)?getCoord():setAlign(),c=vertical(t.position)?setAlign():getCoord();if(t.sticky){let e=globalThis.pageYOffset||(globalThis.document.documentElement||globalThis.document.body.parentNode||globalThis.document.body).scrollTop,s=globalThis.innerHeight,l=0===n.height&&t.children&&t.children[0]?t.children[0].offsetHeight:n.height,a=o.top-n.height<0&&o.top+o.height>20+l,r=o.top+o.height+n.height>s&&o.top<s-l;"top"===t.position&&a&&(p=e-i.offsetTop+(l-n.height)),"bottom"===t.position&&r&&(p=e+s-i.offsetTop-l)}t.style.top=p+"px",t.style.left=c+"px",t.__positions={self:n,parent:l,target:o}}disconnectedCallback(){this.removeEventListeners(),super.disconnectedCallback()}}customElements.define(AbsolutePositionStateManager.tag,AbsolutePositionStateManager);export{AbsolutePositionStateManager};