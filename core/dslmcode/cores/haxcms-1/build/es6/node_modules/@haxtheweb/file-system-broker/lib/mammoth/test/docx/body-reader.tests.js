var e=require("assert"),n=require("path"),a=require("underscore"),r=require("hamjest"),t=r.assertThat,l=r.promiseThat,i=r.allOf,s=r.contains,d=r.hasProperties,o=r.willBe,u=r.FeatureMatcher,w=require("./document-matchers"),m=w.isEmptyRun,p=w.isHyperlink,c=w.isRun,h=w.isText,f=w.isTable,g=w.isRow,v=require("../../lib/docx/body-reader").createBodyReader,E=require("../../lib/docx/body-reader")._readNumberingProperties,y=require("../../lib/documents"),b=require("../../lib/xml"),q=b.Element,I=require("../../lib/docx/numbering-xml").defaultNumbering,k=require("../../lib/docx/relationships-reader").Relationships,X=require("../../lib/docx/styles-reader").Styles,x=require("../../lib/results").warning,C=require("../testing"),T=require("../test")(module),P=C.createFakeDocxFile;function readXmlElement(e,n){return(n=Object.create(n||{})).styles=n.styles||new X({},{}),n.numbering=n.numbering||I,v(n).readXmlElement(e)}function readXmlElementValue(n,a){var r=readXmlElement(n,a);return e.deepEqual(r.messages,[]),r.value}var V={findContentType:function(e){return{".png":"image/png",".emf":"image/x-emf"}[n.extname(e)]}};function paragraphWithIndent(e){var n=new q("w:ind",e,[]),a=new q("w:pPr",{},[n]);return new q("w:p",{},[a])}T("paragraph has no style if it has no properties",(function(){var n=readXmlElementValue(new q("w:p",{},[]));e.deepEqual(n.styleId,null)})),T("paragraph has style ID and name read from paragraph properties if present",(function(){var n=new q("w:pStyle",{"w:val":"Heading1"},[]),a=new q("w:pPr",{},[n]),r=readXmlElementValue(new q("w:p",{},[a]),{styles:new X({Heading1:{name:"Heading 1"}},{})});e.deepEqual(r.styleId,"Heading1"),e.deepEqual(r.styleName,"Heading 1")})),T("warning is emitted when paragraph style cannot be found",(function(){var n=new q("w:pStyle",{"w:val":"Heading1"},[]),a=new q("w:pPr",{},[n]),r=readXmlElement(new q("w:p",{},[a]),{styles:new X({},{})}),t=r.value;e.deepEqual(t.styleId,"Heading1"),e.deepEqual(t.styleName,null),e.deepEqual(r.messages,[x("Paragraph style with ID Heading1 was referenced but not defined in the document")])})),T("paragraph has justification read from paragraph properties if present",(function(){var n=new q("w:jc",{"w:val":"center"},[]),a=new q("w:pPr",{},[n]),r=readXmlElementValue(new q("w:p",{},[a]));e.deepEqual(r.alignment,"center")})),T("paragraph indent",{"when w:start is set then start indent is read from w:start":function(){var n=readXmlElementValue(paragraphWithIndent({"w:start":"720","w:left":"40"}));e.equal(n.indent.start,"720")},"when w:start is not set then start indent is read from w:left":function(){var n=readXmlElementValue(paragraphWithIndent({"w:left":"720"}));e.equal(n.indent.start,"720")},"when w:end is set then end indent is read from w:end":function(){var n=readXmlElementValue(paragraphWithIndent({"w:end":"720","w:right":"40"}));e.equal(n.indent.end,"720")},"when w:end is not set then end indent is read from w:right":function(){var n=readXmlElementValue(paragraphWithIndent({"w:right":"720"}));e.equal(n.indent.end,"720")},"paragraph has indent firstLine read from paragraph properties if present":function(){var n=readXmlElementValue(paragraphWithIndent({"w:firstLine":"720"}));e.equal(n.indent.firstLine,"720")},"paragraph has indent hanging read from paragraph properties if present":function(){var n=readXmlElementValue(paragraphWithIndent({"w:hanging":"720"}));e.equal(n.indent.hanging,"720")},"when indent attributes aren't set then indents are null":function(){var n=readXmlElementValue(paragraphWithIndent({}));e.equal(n.indent.start,null),e.equal(n.indent.end,null),e.equal(n.indent.firstLine,null),e.equal(n.indent.hanging,null)}}),T("paragraph has numbering properties from paragraph properties if present",(function(){var n=new q("w:numPr",{},[new q("w:ilvl",{"w:val":"1"}),new q("w:numId",{"w:val":"42"})]),a=new q("w:pPr",{},[n]),r=readXmlElementValue(new q("w:p",{},[a]),{numbering:new NumberingMap({findLevel:{42:{1:{isOrdered:!0,level:"1"}}}})});e.deepEqual(r.numbering,{level:"1",isOrdered:!0})})),T("numbering on paragraph style takes precedence over numPr",(function(){var n=new q("w:numPr",{},[new q("w:ilvl",{"w:val":"1"}),new q("w:numId",{"w:val":"42"})]),a=new q("w:pPr",{},[new q("w:pStyle",{"w:val":"List"}),n]),r=readXmlElementValue(new q("w:p",{},[a]),{numbering:new NumberingMap({findLevelByParagraphStyleId:{List:{isOrdered:!0,level:"1"}}}),styles:new X({List:{name:"List"}},{})});e.deepEqual(r.numbering,{level:"1",isOrdered:!0})})),T("numbering properties are converted to numbering at specified level",(function(){var n=new q("w:numPr",{},[new q("w:ilvl",{"w:val":"1"}),new q("w:numId",{"w:val":"42"})]),a=new NumberingMap({findLevel:{42:{1:{isOrdered:!0,level:"1"}}}}),r=E(null,n,a);e.deepEqual(r,{level:"1",isOrdered:!0})})),T("numbering properties are ignored if w:ilvl is missing",(function(){var n=new q("w:numPr",{},[new q("w:numId",{"w:val":"42"})]),a=new NumberingMap({findLevel:{42:{1:{isOrdered:!0,level:"1"}}}}),r=E(null,n,a);e.equal(r,null)})),T("numbering properties are ignored if w:numId is missing",(function(){var n=new q("w:numPr",{},[new q("w:ilvl",{"w:val":"1"})]),a=new NumberingMap({findLevel:{42:{1:{isOrdered:!0,level:"1"}}}}),r=E(null,n,a);e.equal(r,null)})),T("complex fields",function(){var n="http://example.com",a=new q("w:r",{},[new q("w:fldChar",{"w:fldCharType":"begin"})]),r=new q("w:r",{},[new q("w:fldChar",{"w:fldCharType":"end"})]),l=new q("w:r",{},[new q("w:fldChar",{"w:fldCharType":"separate"})]),i=new q("w:instrText",{},[b.text(' HYPERLINK "'+n+'"')]),d=runOfText("this is a hyperlink"),o=isHyperlinkedRun({children:[]});function isHyperlinkedRun(e){return c({children:s(p(e))})}return{"stores instrText returns empty result":function(){var n=readXmlElementValue(i);e.deepEqual(n,[])},"runs in a complex field for hyperlink without switch are read as external hyperlinks":function(){var e=runOfText("this is a hyperlink"),d=readXmlElementValue(new q("w:p",{},[a,i,l,e,r]));t(d.children,s(m,o,isHyperlinkedRun({href:n,children:s(h("this is a hyperlink"))}),m))},"runs in a complex field for hyperlink with l switch are read as internal hyperlinks":function(){var e=runOfText("this is a hyperlink"),n=readXmlElementValue(new q("w:p",{},[a,new q("w:instrText",{},[b.text(' HYPERLINK \\l "InternalLink"')]),l,e,r]));t(n.children,s(m,o,isHyperlinkedRun({anchor:"InternalLink",children:s(h("this is a hyperlink"))}),m))},"runs after a complex field for hyperlinks are not read as hyperlinks":function(){var e=runOfText("this will not be a hyperlink"),n=readXmlElementValue(new q("w:p",{},[a,i,l,r,e]));t(n.children,s(m,o,m,c({children:s(h("this will not be a hyperlink"))})))},"can handle split instrText elements":function(){var e=new q("w:instrText",{},[b.text(" HYPE")]),i=new q("w:instrText",{},[b.text('RLINK "'+n+'"')]),u=readXmlElementValue(new q("w:p",{},[a,e,i,l,d,r]));t(u.children,s(m,o,isHyperlinkedRun({href:n,children:s(h("this is a hyperlink"))}),m))},"hyperlink is not ended by end of nested complex field":function(){var e=new q("w:instrText",{},[b.text(' AUTHOR "John Doe"')]),u=readXmlElementValue(new q("w:p",{},[a,i,l,a,e,l,r,d,r]));t(u.children,s(m,o,o,o,o,isHyperlinkedRun({href:n,children:s(h("this is a hyperlink"))}),m))},"complex field nested within a hyperlink complex field is wrapped with the hyperlink":function(){var e=new q("w:instrText",{},[b.text(' AUTHOR "John Doe"')]),d=readXmlElementValue(new q("w:p",{},[a,i,l,a,e,l,runOfText("John Doe"),r,r]));t(d.children,s(m,o,o,o,isHyperlinkedRun({href:n,children:s(h("John Doe"))}),o,m))},"field without separate w:fldChar is ignored":function(){var e=runOfText("this is a hyperlink"),d=readXmlElementValue(new q("w:p",{},[a,i,l,a,r,e,r]));t(d.children,s(m,o,o,o,isHyperlinkedRun({href:n,children:s(h("this is a hyperlink"))}),m))}}}()),T("run has no style if it has no properties",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.styleId,null)})),T("run has style ID and name read from run properties if present",(function(){var n=readXmlElementValue(runWithProperties([new q("w:rStyle",{"w:val":"Heading1Char"})]),{styles:new X({},{Heading1Char:{name:"Heading 1 Char"}})});e.deepEqual(n.styleId,"Heading1Char"),e.deepEqual(n.styleName,"Heading 1 Char")})),T("warning is emitted when run style cannot be found",(function(){var n=readXmlElement(runWithProperties([new q("w:rStyle",{"w:val":"Heading1Char"})]),{styles:new X({},{})}),a=n.value;e.deepEqual(a.styleId,"Heading1Char"),e.deepEqual(a.styleName,null),e.deepEqual(n.messages,[x("Run style with ID Heading1Char was referenced but not defined in the document")])})),T("isBold is false if bold element is not present",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.isBold,!1)})),T("isBold is true if bold element is present",(function(){var n=readXmlElementValue(runWithProperties([new q("w:b")]));e.equal(n.isBold,!0)})),T("isBold is false if bold element is present and w:val is false",(function(){var n=readXmlElementValue(runWithProperties([new q("w:b",{"w:val":"false"})]));e.equal(n.isBold,!1)})),T("isUnderline is false if underline element is not present",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.isUnderline,!1)})),T("isUnderline is true if underline element is present without w:val attribute",(function(){var n=readXmlElementValue(runWithProperties([new q("w:u")]));e.equal(n.isUnderline,!0)})),T("isUnderline is false if underline element is present and w:val is false",(function(){var n=readXmlElementValue(runWithProperties([new q("w:u",{"w:val":"false"})]));e.equal(n.isUnderline,!1)})),T("isUnderline is false if underline element is present and w:val is 0",(function(){var n=readXmlElementValue(runWithProperties([new q("w:u",{"w:val":"0"})]));e.equal(n.isUnderline,!1)})),T("isUnderline is false if underline element is present and w:val is none",(function(){var n=readXmlElementValue(runWithProperties([new q("w:u",{"w:val":"none"})]));e.equal(n.isUnderline,!1)})),T("isUnderline is false if underline element is present and w:val is not none or falsy",(function(){var n=readXmlElementValue(runWithProperties([new q("w:u",{"w:val":"single"})]));e.equal(n.isUnderline,!0)})),T("isStrikethrough is false if strikethrough element is not present",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.isStrikethrough,!1)})),T("isStrikethrough is true if strikethrough element is present",(function(){var n=readXmlElementValue(runWithProperties([new q("w:strike")]));e.equal(n.isStrikethrough,!0)})),T("isItalic is false if bold element is not present",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.isItalic,!1)})),T("isItalic is true if bold element is present",(function(){var n=readXmlElementValue(runWithProperties([new q("w:i")]));e.equal(n.isItalic,!0)})),T("isSmallCaps is false if smallcaps element is not present",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.isSmallCaps,!1)})),T("isSmallCaps is true if smallcaps element is present",(function(){var n=readXmlElementValue(runWithProperties([new q("w:smallCaps")]));e.equal(n.isSmallCaps,!0)}));function row(){return new q("w:tr",{},Array.prototype.slice.call(arguments))}function emptyCell(){return new q("w:tc",{},[new q("w:tcPr",{},Array.prototype.slice.call(arguments))])}function vMerge(e){return new q("w:vMerge",{"w:val":e},[])}function gridSpan(e){return new q("w:gridSpan",{"w:val":e})}function docRow(e){return new y.TableRow(e)}function docEmptyCell(e){return new y.TableCell([],e)}[{name:"isBold",tagName:"w:b"},{name:"isUnderline",tagName:"w:u"},{name:"isItalic",tagName:"w:i"},{name:"isStrikethrough",tagName:"w:strike"},{name:"isAllCaps",tagName:"w:caps"},{name:"isSmallCaps",tagName:"w:smallCaps"}].forEach((function(n){T(n.name+" is false if "+n.tagName+" is present and w:val is false",(function(){var a=readXmlElementValue(runWithProperties([new q(n.tagName,{"w:val":"false"})]));e.equal(a[n.name],!1)})),T(n.name+" is false if "+n.tagName+" is present and w:val is 0",(function(){var a=readXmlElementValue(runWithProperties([new q(n.tagName,{"w:val":"0"})]));e.equal(a[n.name],!1)})),T(n.name+" is true if "+n.tagName+" is present and w:val is true",(function(){var a=readXmlElementValue(runWithProperties([new q(n.tagName,{"w:val":"true"})]));e.equal(a[n.name],!0)})),T(n.name+" is true if "+n.tagName+" is present and w:val is 1",(function(){var a=readXmlElementValue(runWithProperties([new q(n.tagName,{"w:val":"1"})]));e.equal(a[n.name],!0)}))})),T("run has baseline vertical alignment by default",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.verticalAlignment,y.verticalAlignment.baseline)})),T("run has vertical alignment read from properties",(function(){var n=readXmlElementValue(runWithProperties([new q("w:vertAlign",{"w:val":"superscript"})]));e.deepEqual(n.verticalAlignment,y.verticalAlignment.superscript)})),T("run has null font by default",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.font,null)})),T("run has font read from properties",(function(){var n=readXmlElementValue(runWithProperties([new q("w:rFonts",{"w:ascii":"Arial"})]));e.deepEqual(n.font,"Arial")})),T("run has null fontSize by default",(function(){var n=readXmlElementValue(runWithProperties([]));e.deepEqual(n.fontSize,null)})),T("run has fontSize read from properties",(function(){var n=readXmlElementValue(runWithProperties([new q("w:sz",{"w:val":"28"})]));e.deepEqual(n.fontSize,14)})),T("run with invalid w:sz has null font size",(function(){var n=readXmlElementValue(runWithProperties([new q("w:sz",{"w:val":"28a"})]));e.deepEqual(n.fontSize,null)})),T("run properties not included as child of run",(function(){var n=new q("w:rStyle"),a=new q("w:rPr",{},[n]),r=readXmlElement(new q("w:r",{},[a]));e.deepEqual(r.value.children,[])})),T("w:tab is read as document tab element",(function(){var n=readXmlElement(new q("w:tab"));e.deepEqual(n.value,new y.Tab)})),T("w:noBreakHyphen is read as non-breaking hyphen character",(function(){var n=readXmlElement(new q("w:noBreakHyphen"));e.deepEqual(n.value,new y.Text("‑"))})),T("soft hyphens are read as text",(function(){var n=readXmlElementValue(new q("w:softHyphen",{},[]));e.deepEqual(n,new y.Text("­"))})),T("w:sym with supported font and supported code point in ASCII range is converted to text",(function(){var n=readXmlElementValue(new q("w:sym",{"w:font":"Wingdings","w:char":"28"},[]));e.deepEqual(n,new y.Text("🕿"))})),T("w:sym with supported font and supported code point in private use area is converted to text",(function(){var n=readXmlElementValue(new q("w:sym",{"w:font":"Wingdings","w:char":"F028"},[]));e.deepEqual(n,new y.Text("🕿"))})),T("w:sym with unsupported font and code point produces empty result with warning",(function(){var n=readXmlElement(new q("w:sym",{"w:font":"Dingwings","w:char":"28"},[]));e.deepEqual(n.value,[]),e.deepEqual(n.messages,[x("A w:sym element with an unsupported character was ignored: char 28 in font Dingwings")])})),T("w:tbl is read as document table element",(function(){var n=readXmlElement(new q("w:tbl",{},[new q("w:tr",{},[new q("w:tc",{},[new q("w:p",{},[])])])]));e.deepEqual(n.value,new y.Table([new y.TableRow([new y.TableCell([new y.Paragraph([])])])]))})),T("table has no style if it has no properties",(function(){var n=readXmlElementValue(new q("w:tbl",{},[]));e.deepEqual(n.styleId,null)})),T("table has style ID and name read from table properties if present",(function(){var n=new q("w:tblStyle",{"w:val":"TableNormal"},[]),a=new q("w:tblPr",{},[n]),r=readXmlElementValue(new q("w:tbl",{},[a]),{styles:new X({},{},{TableNormal:{name:"Normal Table"}})});e.deepEqual(r.styleId,"TableNormal"),e.deepEqual(r.styleName,"Normal Table")})),T("warning is emitted when table style cannot be found",(function(){var n=new q("w:tblStyle",{"w:val":"TableNormal"},[]),a=new q("w:tblPr",{},[n]),r=readXmlElement(new q("w:tbl",{},[a]),{styles:X.EMPTY}),t=r.value;e.deepEqual(t.styleId,"TableNormal"),e.deepEqual(t.styleName,null),e.deepEqual(r.messages,[x("Table style with ID TableNormal was referenced but not defined in the document")])})),T("w:tblHeader marks table row as header",(function(){var e=readXmlElementValue(new q("w:tbl",{},[new q("w:tr",{},[new q("w:trPr",{},[new q("w:tblHeader")])]),new q("w:tr")]));t(e,f({children:s(g({isHeader:!0}),g({isHeader:!1}))}))})),T("w:gridSpan is read as colSpan for table cell",(function(){var n=readXmlElement(new q("w:tbl",{},[new q("w:tr",{},[new q("w:tc",{},[new q("w:tcPr",{},[new q("w:gridSpan",{"w:val":"2"})]),new q("w:p",{},[])])])]));e.deepEqual(n.value,new y.Table([new y.TableRow([new y.TableCell([new y.Paragraph([])],{colSpan:2})])]))})),T("w:vMerge is read as rowSpan for table cell",(function(){var n=readXmlElement(new q("w:tbl",{},[row(emptyCell()),row(emptyCell(vMerge("restart"))),row(emptyCell(vMerge("continue"))),row(emptyCell(vMerge("continue"))),row(emptyCell())]));e.deepEqual(n.value,new y.Table([docRow([docEmptyCell()]),docRow([docEmptyCell({rowSpan:3})]),docRow([]),docRow([]),docRow([docEmptyCell()])]))})),T("w:vMerge without val is treated as continue",(function(){var n=readXmlElement(new q("w:tbl",{},[row(emptyCell(vMerge("restart"))),row(emptyCell(vMerge()))]));e.deepEqual(n.value,new y.Table([docRow([docEmptyCell({rowSpan:2})]),docRow([])]))})),T("w:vMerge accounts for cells spanning columns",(function(){var n=readXmlElement(new q("w:tbl",{},[row(emptyCell(),emptyCell(),emptyCell(vMerge("restart"))),row(emptyCell(gridSpan("2")),emptyCell(vMerge("continue"))),row(emptyCell(),emptyCell(),emptyCell(vMerge("continue"))),row(emptyCell(),emptyCell(),emptyCell())]));e.deepEqual(n.value,new y.Table([docRow([docEmptyCell(),docEmptyCell(),docEmptyCell({rowSpan:3})]),docRow([docEmptyCell({colSpan:2})]),docRow([docEmptyCell(),docEmptyCell()]),docRow([docEmptyCell(),docEmptyCell(),docEmptyCell()])]))})),T("no vertical cell merging if merged cells do not line up",(function(){var n=readXmlElement(new q("w:tbl",{},[row(emptyCell(gridSpan("2"),vMerge("restart"))),row(emptyCell(),emptyCell(vMerge("continue")))]));e.deepEqual(n.value,new y.Table([docRow([docEmptyCell({colSpan:2})]),docRow([docEmptyCell(),docEmptyCell()])]))})),T("warning if non-row in table",(function(){var n=readXmlElement(new q("w:tbl",{},[new q("w:p")]));e.deepEqual(n.messages,[x("unexpected non-row element in table, cell merging may be incorrect")])})),T("warning if non-cell in table row",(function(){var n=readXmlElement(new q("w:tbl",{},[row(new q("w:p"))]));e.deepEqual(n.messages,[x("unexpected non-cell element in table row, cell merging may be incorrect")])})),T("w:bookmarkStart is read as a bookmarkStart",(function(){var n=readXmlElement(new q("w:bookmarkStart",{"w:name":"_Peter","w:id":"42"}));e.deepEqual(n.value.name,"_Peter"),e.deepEqual(n.value.type,"bookmarkStart")})),T("_GoBack bookmark is ignored",(function(){var n=readXmlElement(new q("w:bookmarkStart",{"w:name":"_GoBack"}));e.deepEqual(n.value,[])}));var S=new Buffer("Not an image at all!"),R="rId5";function isSuccess(e){return d({messages:[],value:e})}function isImage(e){var n=d(a.extend({type:"image"},a.omit(e,"buffer")));return e.buffer?i(n,new u(o(e.buffer),"buffer","buffer",(function(e){return e.read()}))):n}function readEmbeddedImage(e){return readXmlElement(e,{relationships:new k([imageRelationship("rId5","media/hat.png")]),contentTypes:V,docxFile:P({"word/media/hat.png":S})})}function assertChildrenAreConvertedNormally(n){var a=new q("w:r",{},[]),r=readXmlElement(new q(n,{},[a]));e.deepEqual(r.value[0].type,"run")}function paragraphWithStyleId(e){return new q("w:p",{},[new q("w:pPr",{},[new q("w:pStyle",{"w:val":e},[])])])}function runWithProperties(e){return new q("w:r",{},[createRunPropertiesXml(e)])}function createRunPropertiesXml(e){return new q("w:rPr",{},e)}function single(e){if(1===e.length)return e[0];throw new Error("Array has "+e.length+" elements")}function createInlineImage(e){return new q("w:drawing",{},[new q("wp:inline",{},[new q("wp:docPr",{descr:e.description,title:e.title}),new q("a:graphic",{},[new q("a:graphicData",{},[new q("pic:pic",{},[new q("pic:blipFill",{},[e.blip])])])])])])}function createEmbeddedBlip(e){return new q("a:blip",{"r:embed":e})}function runOfText(e){var n=new q("w:t",{},[b.text(e)]);return new q("w:r",{},[n])}function hyperlinkRelationship(e,n){return{relationshipId:e,target:n,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink"}}function imageRelationship(e,n){return{relationshipId:e,target:n,type:"http://schemas.openxmlformats.org/officeDocument/2006/relationships/image"}}function NumberingMap(e){var n=e.findLevel,a=e.findLevelByParagraphStyleId||{};return{findLevel:function(e,a){return n[e][a]},findLevelByParagraphStyleId:function(e){return a[e]}}}T("can read imagedata elements with r:id attribute",(function(){var e=readEmbeddedImage(new q("v:imagedata",{"r:id":R,"o:title":"It's a hat"}));return l(e,isSuccess(isImage({altText:"It's a hat",contentType:"image/png",buffer:S})))})),T("when v:imagedata element has no relationship ID then it is ignored with warning",(function(){var n=readXmlElement(new q("v:imagedata"));e.deepEqual(n.value,[]),e.deepEqual(n.messages,[x("A v:imagedata element without a relationship ID was ignored")])})),T("can read inline pictures",(function(){var e=readEmbeddedImage(createInlineImage({blip:createEmbeddedBlip(R),description:"It's a hat"}));return l(e,isSuccess(s(isImage({altText:"It's a hat",contentType:"image/png",buffer:S}))))})),T("alt text title is used if alt text description is missing",(function(){var e=readEmbeddedImage(createInlineImage({blip:createEmbeddedBlip(R),title:"It's a hat"}));return l(e,isSuccess(s(isImage({altText:"It's a hat"}))))})),T("alt text title is used if alt text description is blank",(function(){var e=readEmbeddedImage(createInlineImage({blip:createEmbeddedBlip(R),description:" ",title:"It's a hat"}));return l(e,isSuccess(s(isImage({altText:"It's a hat"}))))})),T("alt text description is preferred to alt text title",(function(){var e=readEmbeddedImage(createInlineImage({blip:createEmbeddedBlip(R),description:"It's a hat",title:"hat"}));return l(e,isSuccess(s(isImage({altText:"It's a hat"}))))})),T("can read anchored pictures",(function(){var e=readEmbeddedImage(new q("w:drawing",{},[new q("wp:anchor",{},[new q("wp:docPr",{descr:"It's a hat"}),new q("a:graphic",{},[new q("a:graphicData",{},[new q("pic:pic",{},[new q("pic:blipFill",{},[new q("a:blip",{"r:embed":R})])])])])])]));return l(e,isSuccess(s(isImage({altText:"It's a hat",contentType:"image/png",buffer:S}))))})),T("can read linked pictures",(function(){var e,n=single(readXmlElementValue(createInlineImage({blip:(e="rId5",new q("a:blip",{"r:link":e})),description:"It's a hat"}),{relationships:new k([imageRelationship("rId5","file:///media/hat.png")]),contentTypes:V,files:C.createFakeFiles({"file:///media/hat.png":S})}));return l(n,isImage({altText:"It's a hat",contentType:"image/png",buffer:S}))})),T("warning if unsupported image type",(function(){var n=readXmlElement(createInlineImage({blip:createEmbeddedBlip("rId5"),description:"It's a hat"}),{relationships:new k([imageRelationship("rId5","media/hat.emf")]),contentTypes:V,docxFile:P({"word/media/hat.emf":S})});e.deepEqual(n.messages,[x("Image of type image/x-emf is unlikely to display in web browsers")]);var a=single(n.value);e.equal(a.contentType,"image/x-emf")})),T("no elements created if image cannot be found in w:drawing",(function(){var n=readXmlElement(new q("w:drawing",{},[]));e.deepEqual(n.messages,[]),e.deepEqual(n.value,[])})),T("no elements created if image cannot be found in wp:inline",(function(){var n=readXmlElement(new q("wp:inline",{},[]));e.deepEqual(n.messages,[]),e.deepEqual(n.value,[])})),T("children of w:ins are converted normally",(function(){assertChildrenAreConvertedNormally("w:ins")})),T("children of w:object are converted normally",(function(){assertChildrenAreConvertedNormally("w:object")})),T("children of w:smartTag are converted normally",(function(){assertChildrenAreConvertedNormally("w:smartTag")})),T("children of v:group are converted normally",(function(){assertChildrenAreConvertedNormally("v:group")})),T("children of v:rect are converted normally",(function(){assertChildrenAreConvertedNormally("v:rect")})),T("w:hyperlink",{"is read as external hyperlink if it has a relationship ID":function(){var n=new q("w:r",{},[]),a=readXmlElement(new q("w:hyperlink",{"r:id":"r42"},[n]),{relationships:new k([hyperlinkRelationship("r42","http://example.com")])});e.deepEqual(a.value.href,"http://example.com"),e.deepEqual(a.value.children[0].type,"run")},"is read as external hyperlink if it has a relationship ID and an anchor":function(){var n=new q("w:r",{},[]),a=readXmlElement(new q("w:hyperlink",{"r:id":"r42","w:anchor":"fragment"},[n]),{relationships:new k([hyperlinkRelationship("r42","http://example.com/")])});e.deepEqual(a.value.href,"http://example.com/#fragment"),e.deepEqual(a.value.children[0].type,"run")},"existing fragment is replaced when anchor is set on external link":function(){var n=new q("w:r",{},[]),a=readXmlElement(new q("w:hyperlink",{"r:id":"r42","w:anchor":"fragment"},[n]),{relationships:new k([hyperlinkRelationship("r42","http://example.com/#previous")])});e.deepEqual(a.value.href,"http://example.com/#fragment"),e.deepEqual(a.value.children[0].type,"run")},"is read as internal hyperlink if it has an anchor":function(){var n=new q("w:r",{},[]),a=readXmlElement(new q("w:hyperlink",{"w:anchor":"_Peter"},[n]));e.deepEqual(a.value.anchor,"_Peter"),e.deepEqual(a.value.children[0].type,"run")},"is ignored if it does not have a relationship ID nor anchor":function(){var n=new q("w:r",{},[]),a=readXmlElement(new q("w:hyperlink",{},[n]));e.deepEqual(a.value[0].type,"run")},"target frame is read":function(){var e=readXmlElementValue(new q("w:hyperlink",{"w:anchor":"Introduction","w:tgtFrame":"_blank"}));t(e,d({targetFrame:"_blank"}))},"empty target frame is ignored":function(){var e=readXmlElementValue(new q("w:hyperlink",{"w:anchor":"Introduction","w:tgtFrame":""}));t(e,d({targetFrame:null}))}}),T("w:br without explicit type is read as line break",(function(){var n=readXmlElementValue(new q("w:br",{},[]));e.deepEqual(n,y.lineBreak)})),T("w:br with textWrapping type is read as line break",(function(){var n=readXmlElementValue(new q("w:br",{"w:type":"textWrapping"},[]));e.deepEqual(n,y.lineBreak)})),T("w:br with page type is read as page break",(function(){var n=readXmlElementValue(new q("w:br",{"w:type":"page"},[]));e.deepEqual(n,y.pageBreak)})),T("w:br with column type is read as column break",(function(){var n=readXmlElementValue(new q("w:br",{"w:type":"column"},[]));e.deepEqual(n,y.columnBreak)})),T("warning on breaks that aren't recognised",(function(){var n=readXmlElement(new q("w:br",{"w:type":"unknownBreakType"},[]));e.deepEqual(n.value,[]),e.deepEqual(n.messages,[x("Unsupported break type: unknownBreakType")])})),T("w:footnoteReference has ID read",(function(){var n=readXmlElement(new q("w:footnoteReference",{"w:id":"4"}));e.deepEqual(n.value,y.noteReference({noteType:"footnote",noteId:"4"})),e.deepEqual(n.messages,[])})),T("w:commentReference has ID read",(function(){var n=readXmlElement(new q("w:commentReference",{"w:id":"4"}));e.deepEqual(n.value,y.commentReference({commentId:"4"})),e.deepEqual(n.messages,[])})),T("emits warning on unrecognised element",(function(){var n=readXmlElement(new q("w:not-an-element"));e.deepEqual(n.messages,[{type:"warning",message:"An unrecognised element was ignored: w:not-an-element"}]),e.deepEqual(n.value,[])})),T("w:bookmarkEnd is ignored without warning",(function(){var n=readXmlElement(new q("w:bookmarkEnd"));e.deepEqual(n.messages,[]),e.deepEqual([],n.value)})),T("text boxes have content appended after containing paragraph",(function(){var n=new q("w:pict",{},[new q("v:shape",{},[new q("v:textbox",{},[new q("w:txbxContent",{},[paragraphWithStyleId("textbox-content")])])])]),a=readXmlElement(new q("w:p",{},[new q("w:r",{},[n])]));e.deepEqual(a.value[1].styleId,"textbox-content")})),T("mc:Fallback is used when mc:AlternateContent is read",(function(){var n=new X({first:{name:"First"},second:{name:"Second"}},{}),a=readXmlElement(new q("mc:AlternateContent",{},[new q("mc:Choice",{Requires:"wps"},[paragraphWithStyleId("first")]),new q("mc:Fallback",{},[paragraphWithStyleId("second")])]),{styles:n});e.deepEqual(a.value[0].styleId,"second")})),T("w:sdtContent is used when w:sdt is read",(function(){var n=readXmlElement(b.element("w:sdt",{},[b.element("w:sdtContent",{},[b.element("w:t",{},[b.text("Blackdown")])])]));e.deepEqual(n.value,[new y.Text("Blackdown")])})),T("text nodes are ignored when reading children",(function(){var n=readXmlElementValue(new q("w:r",{},[b.text("[text]")]));e.deepEqual(n,new y.Run([]))}));