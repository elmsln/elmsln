import{store as e}from"../haxcms-site-store.js";import{toJS as t}from"../../../../../mobx/dist/mobx.esm.js";import{b64toBlob as a}from"../../../../utils/utils.js";import{MicroFrontendRegistry as r}from"../../../../micro-frontend-registry/micro-frontend-registry.js";export class PrintHelper{static async printBranch(){let i="";globalThis.document.querySelector("base")&&(i=globalThis.document.querySelector("base").href);const n=t(e.manifest),o={type:"site",site:{file:i+"site.json",id:n.id,title:n.title,author:n.author,description:n.description,license:n.license,metadata:n.metadata,items:n.items},ancestor:t(e.activeId),link:i,magic:globalThis.__appCDN,base:i,format:"json"};try{const e=await r.call("@haxcms/siteToHtml",o);200==e.status&&e.data?globalThis.open(globalThis.URL.createObjectURL(a(btoa(unescape(encodeURIComponent(e.data))),"text/html")),"","left=0,top=0,width=800,height=800,toolbar=0,scrollbars=0,status=0,noopener=1,noreferrer=1"):this.printFallback()}catch(e){console.error("Print error:",e),this.printFallback()}}static async printWholeSite(){let i="";globalThis.document.querySelector("base")&&(i=globalThis.document.querySelector("base").href);const n=t(e.manifest),o={type:"site",site:{file:i+"site.json",id:n.id,title:n.title,author:n.author,description:n.description,license:n.license,metadata:n.metadata,items:n.items},ancestor:null,link:i,magic:globalThis.__appCDN,base:i,format:"json"};try{const e=await r.call("@haxcms/siteToHtml",o);200==e.status&&e.data?globalThis.open(globalThis.URL.createObjectURL(a(btoa(unescape(encodeURIComponent(e.data))),"text/html")),"","left=0,top=0,width=800,height=800,toolbar=0,scrollbars=0,status=0,noopener=1,noreferrer=1"):this.printFallback()}catch(e){console.error("Print error:",e),this.printFallback()}}static printFallback(){globalThis.open(globalThis.location.href+"?format=print-page","","left=0,top=0,width=800,height=800,toolbar=0,scrollbars=0,status=0,noopener=1,noreferrer=1")}static printCurrentPage(){globalThis.print()}static openPrintView(){globalThis.open(globalThis.location.href+"?format=print-page","_blank")}static openJSONView(){globalThis.open(globalThis.location.href+"?format=json","_blank")}}export const createPrintProgram=e=>async(t,a)=>{const i=[],n={printPage:e&&e.t&&e.t.printPage||"Print page",printSite:e&&e.t&&e.t.printSite||"Print site",printBranch:"Print this page and children",printCurrent:"Print current page only",downloadPdf:"Download PDF",printView:"Open print-friendly view",jsonView:"View page data (JSON)",printingPleaseWait:"Printing, please wait.."};return i.push({title:n.printBranch,icon:"icons:print",tags:["print","page","branch","children"],value:{target:PrintHelper,method:"printBranch",args:[]},eventName:"super-daemon-element-method",path:"CMS/action/print/branch",more:"Print the current page and all its child pages as HTML"}),i.push({title:n.printSite,icon:"icons:print",tags:["print","site","all","complete"],value:{target:PrintHelper,method:"printWholeSite",args:[]},eventName:"super-daemon-element-method",path:"CMS/action/print/site",more:"Print all pages in the site as HTML"}),i.push({title:n.printCurrent,icon:"icons:print",tags:["print","page","current","browser"],value:{target:PrintHelper,method:"printCurrentPage",args:[]},eventName:"super-daemon-element-method",path:"CMS/action/print/current",more:"Use browser's print dialog for current page only"}),r.has("@haxcms/siteToHtml")&&i.push({title:n.downloadPdf,icon:"hax:file-pdf",tags:["print","pdf","download","export"],value:{target:PrintHelper,method:"printBranch",args:[]},eventName:"super-daemon-element-method",path:"CMS/action/print/pdf",more:"Export current page and children as PDF (when service is available)"}),i.push({title:n.printView,icon:"icons:launch",tags:["print","view","friendly","clean"],value:{target:PrintHelper,method:"openPrintView",args:[]},eventName:"super-daemon-element-method",path:"CMS/action/print/view",more:"Open a clean, print-optimized view in new window"}),i.push({title:n.jsonView,icon:"code",tags:["json","data","view","code","debug"],value:{target:PrintHelper,method:"openJSONView",args:[]},eventName:"super-daemon-element-method",path:"CMS/action/view/json",more:"View the current page's activeItem data as JSON in a code sample"}),i};