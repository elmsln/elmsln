import{store as t}from"../haxcms-site-store.js";import{toJS as e}from"../../../../../mobx/dist/mobx.esm.js";import{generateResourceID as a}from"../../../../utils/utils.js";export class SiteSkeletonGenerator{static async generateFromCurrentSite(a=!1){const i=e(t.manifest);if(!i||!i.items)throw new Error("No site data available to generate skeleton");if(i.items.length>20&&!a){if(!confirm(`This site has ${i.items.length} pages. Generating a skeleton may take a while and create a large file. Continue?`))throw new Error("Skeleton generation cancelled by user")}const s=this.extractThemeConfiguration(i),n=await this.extractSiteStructure(i.items),r=await this.extractSiteFiles();return{meta:{name:this.getSiteMetaName(i),description:this.getSiteDescription(i),version:"1.0.0",created:(new Date).toISOString(),type:"skeleton",sourceUrl:globalThis.location.href,useCaseTitle:this.getSiteMetaName(i),useCaseDescription:this.getSiteDescription(i),useCaseImage:"",category:this.extractSiteCategories(i)||[],tags:this.extractSiteTags(i)||[],attributes:[]},site:{name:this.getSiteMetaName(i),description:this.getSiteDescription(i),theme:s.element||"clean-one"},build:{type:"skeleton",structure:"from-skeleton",items:n,files:r.map((t=>({path:t})))},theme:{...s.variables||{},...s.settings||{}},_skeleton:{originalMetadata:this.extractSiteMetadata(i),originalSettings:this.extractSiteSettings(i),fullThemeConfig:s}}}static getSiteMetaName(t){return t.metadata&&t.metadata.site&&t.metadata.site.name?t.metadata.site.name:"Untitled Skeleton"}static getSiteDescription(t){return t.description?`Template based on ${t.description}`:t.title?`Template based on ${t.title}`:"Template based on HAX Site"}static extractSiteMetadata(t){const e=t.metadata||{},a=e.site||{};return{site:{category:a.category||[],tags:a.tags||[],settings:this.cleanSiteSettings(a.settings||{})},licensing:e.licensing||{},node:e.node||{},platform:e.platform||{}}}static cleanSiteSettings(t){const e={...t};return delete e.created,delete e.updated,e}static extractThemeConfiguration(t){const e=(t.metadata||{}).theme||{};return{element:e.element||"clean-one",variables:e.variables||{},settings:{hexCode:e.hexCode,cssVariable:e.cssVariable,icon:e.icon,image:e.image,...this.extractCustomThemeProperties(e)}}}static extractCustomThemeProperties(t){const e={},a=["element","variables","hexCode","cssVariable","icon","image"];return Object.keys(t).forEach((i=>{a.includes(i)||(e[i]=t[i])})),e}static async extractSiteStructure(e){const i=new Map;e.forEach((t=>{i.set(t.id,a())}));const s=[];for(let a=0;a<e.length;a++){const n=e[a];let r="";try{r=await t.loadItemContent(n.id)}catch(t){console.warn(`Could not fetch content for page ${n.id}:`,t),r=""}s.push({id:i.get(n.id),title:n.title,slug:n.slug,order:n.order||a,parent:n.parent?i.get(n.parent):null,indent:n.indent||0,content:r,metadata:{published:this.getMetadataValue(n,"published",!0),hideInMenu:this.getMetadataValue(n,"hideInMenu",!1),tags:this.getMetadataValue(n,"tags",[]),...this.extractRelevantMetadata(n.metadata||{})}})}return s}static async extractSiteFiles(){const a=new Set,i=e(t.manifest);for(const e of i.items)try{const i=await t.loadItemContent(e.id);if(i){this.extractFileReferences(i,"files/").forEach((t=>a.add(t.path)))}}catch(t){console.warn(`Could not process files for page ${e.id}:`,t)}return Array.from(a)}static extractFileReferences(t,e){const a=[],i=/\w+="files\/([^"'\s>]+\.[a-zA-Z0-9]+)"/gi;let s;for(;null!==(s=i.exec(t));){const t=s[1];a.push({path:t})}return a}static getMetadataValue(t,e,a){return t.metadata&&void 0!==t.metadata[e]?t.metadata[e]:a}static extractRelevantMetadata(t){const e={};return["wordCount","difficulty","audience","contentType"].forEach((a=>{void 0!==t[a]&&(e[a]=t[a])})),e}static extractSiteCategories(t){return((t.metadata||{}).site||{}).category||[]}static extractSiteTags(t){return((t.metadata||{}).site||{}).tags||[]}static extractSiteSettings(t){const e=((t.metadata||{}).site||{}).settings||{},a={};return Object.keys(e).forEach((t=>{const i=e[t];null==i||""===i||Array.isArray(i)&&0===i.length||"object"==typeof i&&0===Object.keys(i).length||(a[t]=i)})),a}static generateDownloadableFile(t){const e=JSON.stringify(t,null,2);return new Blob([e],{type:"application/json"})}static downloadSkeleton(t,e){const a=`${t.meta.name.replace(/[^a-z0-9]/gi,"-").toLowerCase()}-skeleton.json`,i=this.generateDownloadableFile(t),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=e||a,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}static toAppHaxFormat(t,e={}){return{site:{name:e.siteName||t.site.name,description:e.siteDescription||t.site.description,theme:e.theme||t.site.theme},build:{...t.build,items:t.build.items.map((t=>({...t,metadata:{...t.metadata,created:(new Date).toISOString(),updated:(new Date).toISOString()}})))},theme:{...t.theme,...e.color?{color:e.color}:{},...e.icon?{icon:e.icon}:{},...e.themeSettings}}}static generateFilesFromSkeleton(t,e={}){const a={};return t.structure.forEach((t=>{const e=`pages/${t.slug}/index.html`;a[e]=t.content||""})),t.files&&t.files.length>0&&t.files.forEach((t=>{a[`files/${t}`]=`[SKELETON_FILE_REFERENCE:${t}]`})),a}static rewriteSkeletonUuids(t){const e=new Map;t.structure.forEach((t=>{t.id&&e.set(t.id,a())}));const i=t.structure.map((t=>{const a={...t};return t.id&&(a.id=e.get(t.id)),t.parent&&e.has(t.parent)&&(a.parent=e.get(t.parent)),a})),s={...t.theme};if(s.settings&&s.settings.regions){const t={...s.settings.regions};Object.keys(t).forEach((a=>{const i=t[a];i&&"object"==typeof i&&Object.keys(i).forEach((t=>{const a=i[t];"string"==typeof a&&e.has(a)?i[t]=e.get(a):Array.isArray(a)&&(i[t]=a.map((t=>"string"==typeof t&&e.has(t)?e.get(t):t)))}))})),s.settings.regions=t}return{...t,structure:i,theme:s,meta:{...t.meta,created:(new Date).toISOString(),sourceUuids:"rewritten"}}}}export default SiteSkeletonGenerator;