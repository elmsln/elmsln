exports.createBodyReader=function createBodyReader(e){return{readXmlElement:function(t){return new BodyReader(e).readXmlElement(t)},readXmlElements:function(t){return new BodyReader(e).readXmlElements(t)}}},exports._readNumberingProperties=readNumberingProperties;var e=require("dingbat-to-unicode"),t=require("underscore"),r=require("../documents"),n=require("../results").Result,a=require("../results").warning,i=require("./uris");function BodyReader(n){var s=[],o=[],d=n.relationships,m=n.contentTypes,f=n.docxFile,c=n.files,p=n.numbering,w=n.styles;function readXmlElements(e){return combineResults(e.map(readXmlElement))}function readXmlElement(e){if("element"===e.type){var t=h[e.name];if(t)return t(e);if(!Object.prototype.hasOwnProperty.call(u,e.name))return emptyResultWithMessages([a("An unrecognised element was ignored: "+e.name)])}return emptyResult()}function readParagraphIndent(e){return{start:e.attributes["w:start"]||e.attributes["w:left"],end:e.attributes["w:end"]||e.attributes["w:right"],firstLine:e.attributes["w:firstLine"],hanging:e.attributes["w:hanging"]}}function readUnderline(e){if(e){var t=e.attributes["w:val"];return"false"!==t&&"0"!==t&&"none"!==t}return!1}function readBooleanElement(e){if(e){var t=e.attributes["w:val"];return"false"!==t&&"0"!==t}return!1}function readStyle(e,t,r,n){var i=[],l=e.first(t),u=null,s=null;if(l&&(u=l.attributes["w:val"])){var o=n(u);o?s=o.name:i.push(function undefinedStyleWarning(e,t){return a(e+" style with ID "+t+" was referenced but not defined in the document")}(r,u))}return elementResultWithMessages({styleId:u,name:s},i)}var g={type:"unknown"};function noteReferenceReader(e){return function(t){var n=t.attributes["w:id"];return elementResult(new r.NoteReference({noteType:e,noteId:n}))}}function readChildElements(e){return readXmlElements(e.children)}var h={"w:p":function(e){return readXmlElements(e.children).map((function(e){var n=t.find(e,isParagraphProperties);return new r.Paragraph(e.filter(negate(isParagraphProperties)),n)})).insertExtra()},"w:pPr":function(e){return function readParagraphStyle(e){return readStyle(e,"w:pStyle","Paragraph",w.findParagraphStyleById)}(e).map((function(t){return{type:"paragraphProperties",styleId:t.styleId,styleName:t.name,alignment:e.firstOrEmpty("w:jc").attributes["w:val"],numbering:readNumberingProperties(t.styleId,e.firstOrEmpty("w:numPr"),p),indent:readParagraphIndent(e.firstOrEmpty("w:ind"))}}))},"w:r":function(e){return readXmlElements(e.children).map((function(e){var n=t.find(e,isRunProperties);e=e.filter(negate(isRunProperties));var a=function currentHyperlinkOptions(){var e=t.last(s.filter((function(e){return"hyperlink"===e.type})));return e?e.options:null}();return null!==a&&(e=[new r.Hyperlink(e,a)]),new r.Run(e,n)}))},"w:rPr":function readRunProperties(e){return function readRunStyle(e){return readStyle(e,"w:rStyle","Run",w.findCharacterStyleById)}(e).map((function(t){var r=e.firstOrEmpty("w:sz").attributes["w:val"],n=/^[0-9]+$/.test(r)?parseInt(r,10)/2:null;return{type:"runProperties",styleId:t.styleId,styleName:t.name,verticalAlignment:e.firstOrEmpty("w:vertAlign").attributes["w:val"],font:e.firstOrEmpty("w:rFonts").attributes["w:ascii"],fontSize:n,isBold:readBooleanElement(e.first("w:b")),isUnderline:readUnderline(e.first("w:u")),isItalic:readBooleanElement(e.first("w:i")),isStrikethrough:readBooleanElement(e.first("w:strike")),isAllCaps:readBooleanElement(e.first("w:caps")),isSmallCaps:readBooleanElement(e.first("w:smallCaps"))}}))},"w:fldChar":function readFldChar(e){var t=e.attributes["w:fldCharType"];if("begin"===t)s.push(g),o=[];else if("end"===t)s.pop();else if("separate"===t){var r=function parseHyperlinkFieldCode(e){var t=/\s*HYPERLINK "(.*)"/.exec(e);if(t)return{href:t[1]};var r=/\s*HYPERLINK\s+\\l\s+"(.*)"/.exec(e);if(r)return{anchor:r[1]};return null}(o.join("")),n=null===r?g:{type:"hyperlink",options:r};s.pop(),s.push(n)}return emptyResult()},"w:instrText":function readInstrText(e){return o.push(e.text()),emptyResult()},"w:t":function(e){return elementResult(new r.Text(e.text()))},"w:tab":function(e){return elementResult(new r.Tab)},"w:noBreakHyphen":function(){return elementResult(new r.Text("‑"))},"w:softHyphen":function(e){return elementResult(new r.Text("­"))},"w:sym":function readSymbol(t){var n=t.attributes["w:font"],i=t.attributes["w:char"],l=e.hex(n,i);return null==l&&/^F0..$/.test(i)&&(l=e.hex(n,i.substring(2))),null==l?emptyResultWithMessages([a("A w:sym element with an unsupported character was ignored: char "+i+" in font "+n)]):elementResult(new r.Text(l.string))},"w:hyperlink":function(e){var n=e.attributes["r:id"],a=e.attributes["w:anchor"];return readXmlElements(e.children).map((function(l){function create(n){var a=e.attributes["w:tgtFrame"]||null;return new r.Hyperlink(l,t.extend({targetFrame:a},n))}if(n){var u=d.findTargetByRelationshipId(n);return a&&(u=i.replaceFragment(u,a)),create({href:u})}return a?create({anchor:a}):l}))},"w:tbl":function readTable(e){var t=function readTableProperties(e){return function readTableStyle(e){return readStyle(e,"w:tblStyle","Table",w.findTableStyleById)}(e).map((function(e){return{styleId:e.styleId,styleName:e.name}}))}(e.firstOrEmpty("w:tblPr"));return readXmlElements(e.children).flatMap(calculateRowSpans).flatMap((function(e){return t.map((function(t){return r.Table(e,t)}))}))},"w:tr":function readTableRow(e){var t=!!e.firstOrEmpty("w:trPr").first("w:tblHeader");return readXmlElements(e.children).map((function(e){return r.TableRow(e,{isHeader:t})}))},"w:tc":function readTableCell(e){return readXmlElements(e.children).map((function(t){var n=e.firstOrEmpty("w:tcPr"),a=n.firstOrEmpty("w:gridSpan").attributes["w:val"],i=a?parseInt(a,10):1,l=r.TableCell(t,{colSpan:i});return l._vMerge=function readVMerge(e){var t=e.first("w:vMerge");if(t){var r=t.attributes["w:val"];return"continue"===r||!r}return null}(n),l}))},"w:footnoteReference":noteReferenceReader("footnote"),"w:endnoteReference":noteReferenceReader("endnote"),"w:commentReference":function readCommentReference(e){return elementResult(r.commentReference({commentId:e.attributes["w:id"]}))},"w:br":function(e){var t=e.attributes["w:type"];return null==t||"textWrapping"===t?elementResult(r.lineBreak):"page"===t?elementResult(r.pageBreak):"column"===t?elementResult(r.columnBreak):emptyResultWithMessages([a("Unsupported break type: "+t)])},"w:bookmarkStart":function(e){var t=e.attributes["w:name"];return"_GoBack"===t?emptyResult():elementResult(new r.BookmarkStart({name:t}))},"mc:AlternateContent":function(e){return readChildElements(e.first("mc:Fallback"))},"w:sdt":function(e){return readXmlElements(e.firstOrEmpty("w:sdtContent").children)},"w:ins":readChildElements,"w:object":readChildElements,"w:smartTag":readChildElements,"w:drawing":readChildElements,"w:pict":function(e){return readChildElements(e).toExtra()},"v:roundrect":readChildElements,"v:shape":readChildElements,"v:textbox":readChildElements,"w:txbxContent":readChildElements,"wp:inline":readDrawingElement,"wp:anchor":readDrawingElement,"v:imagedata":function readImageData(e){var t=e.attributes["r:id"];return t?readImage(findEmbeddedImageFile(t),e.attributes["o:title"]):emptyResultWithMessages([a("A v:imagedata element without a relationship ID was ignored")])},"v:group":readChildElements,"v:rect":readChildElements};return{readXmlElement,readXmlElements};function calculateRowSpans(e){if(t.any(e,(function(e){return e.type!==r.types.tableRow})))return elementResultWithMessages(e,[a("unexpected non-row element in table, cell merging may be incorrect")]);if(t.any(e,(function(e){return t.any(e.children,(function(e){return e.type!==r.types.tableCell}))})))return elementResultWithMessages(e,[a("unexpected non-cell element in table row, cell merging may be incorrect")]);var n={};return e.forEach((function(e){var t=0;e.children.forEach((function(e){e._vMerge&&n[t]?n[t].rowSpan++:(n[t]=e,e._vMerge=!1),t+=e.colSpan}))})),e.forEach((function(e){e.children=e.children.filter((function(e){return!e._vMerge})),e.children.forEach((function(e){delete e._vMerge}))})),elementResult(e)}function readDrawingElement(e){return combineResults(e.getElementsByTagName("a:graphic").getElementsByTagName("a:graphicData").getElementsByTagName("pic:pic").getElementsByTagName("pic:blipFill").getElementsByTagName("a:blip").map(readBlip.bind(null,e)))}function readBlip(e,t){var r=e.first("wp:docPr").attributes,n=function isBlank(e){return null==e||/^\s*$/.test(e)}(r.descr)?r.title:r.descr;return readImage(function findBlipImageFile(e){var t=e.attributes["r:embed"],r=e.attributes["r:link"];if(t)return findEmbeddedImageFile(t);var n=d.findTargetByRelationshipId(r);return{path:n,read:c.read.bind(c,n)}}(t),n)}function findEmbeddedImageFile(e){var t=i.uriToZipEntryName("word",d.findTargetByRelationshipId(e));return{path:t,read:f.read.bind(f,t)}}function readImage(e,t){var n=m.findContentType(e.path);return elementResultWithMessages(r.Image({readImage:e.read,altText:t,contentType:n}),l[n]?[]:a("Image of type "+n+" is unlikely to display in web browsers"))}}function readNumberingProperties(e,t,r){if(null!=e){var n=r.findLevelByParagraphStyleId(e);if(null!=n)return n}var a=t.firstOrEmpty("w:ilvl").attributes["w:val"],i=t.firstOrEmpty("w:numId").attributes["w:val"];return void 0===a||void 0===i?null:r.findLevel(i,a)}var l={"image/png":!0,"image/gif":!0,"image/jpeg":!0,"image/svg+xml":!0,"image/tiff":!0},u={"office-word:wrap":!0,"v:shadow":!0,"v:shapetype":!0,"w:annotationRef":!0,"w:bookmarkEnd":!0,"w:sectPr":!0,"w:proofErr":!0,"w:lastRenderedPageBreak":!0,"w:commentRangeStart":!0,"w:commentRangeEnd":!0,"w:del":!0,"w:footnoteRef":!0,"w:endnoteRef":!0,"w:tblPr":!0,"w:tblGrid":!0,"w:trPr":!0,"w:tcPr":!0};function isParagraphProperties(e){return"paragraphProperties"===e.type}function isRunProperties(e){return"runProperties"===e.type}function negate(e){return function(t){return!e(t)}}function emptyResultWithMessages(e){return new ReadResult(null,null,e)}function emptyResult(){return new ReadResult(null)}function elementResult(e){return new ReadResult(e)}function elementResultWithMessages(e,t){return new ReadResult(e,null,t)}function ReadResult(e,t,r){this.value=e||[],this.extra=t,this._result=new n({element:this.value,extra:t},r),this.messages=this._result.messages}function combineResults(e){var r=n.combine(t.pluck(e,"_result"));return new ReadResult(t.flatten(t.pluck(r.value,"element")),t.filter(t.flatten(t.pluck(r.value,"extra")),identity),r.messages)}function joinElements(e,r){return t.flatten([e,r])}function identity(e){return e}ReadResult.prototype.toExtra=function(){return new ReadResult(null,joinElements(this.extra,this.value),this.messages)},ReadResult.prototype.insertExtra=function(){var e=this.extra;return e&&e.length?new ReadResult(joinElements(this.value,e),null,this.messages):this},ReadResult.prototype.map=function(e){var t=this._result.map((function(t){return e(t.element)}));return new ReadResult(t.value,this.extra,t.messages)},ReadResult.prototype.flatMap=function(e){var t=this._result.flatMap((function(t){return e(t.element)._result}));return new ReadResult(t.value.element,joinElements(this.extra,t.value.extra),t.messages)};