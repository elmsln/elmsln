import{MicroFrontendRegistry as t}from"../../../../micro-frontend-registry/micro-frontend-registry.js";import{HAXStore as e}from"../../../../hax-body/lib/hax-store.js";import{store as o}from"../haxcms-site-store.js";import{toJS as a}from"../../../../../mobx/dist/mobx.esm.js";import{b64toBlob as i}from"../../../../utils/utils.js";export function createExportSiteProgram(t){return async(e,o)=>{let a=[];return[{title:"Export site as HTML",icon:"hax:file-html",format:"html",description:"Download entire site as consolidated HTML"},{title:"Export site as Markdown",icon:"hax:format-textblock",format:"markdown",description:"Download entire site as Markdown files"},{title:"Export site as DOCX",icon:"hax:file-docx",format:"docx",description:"Download entire site as Word document"},{title:"Export site as PDF",icon:"lrn:pdf",format:"pdf",description:"Download entire site as PDF"},{title:"Export site as EPUB",icon:"hax:file-ebook",format:"epub",description:"Download site as EPUB book"},{title:"Download site archive",icon:"icons:archive",format:"zip",description:"Download complete site as ZIP file"},{title:"Export site skeleton",icon:"icons:description",format:"skeleton",description:"Export as reusable site template for creating similar sites"}].forEach((o=>{(""===e||o.title.toLowerCase().includes(e.toLowerCase())||o.format.includes(e.toLowerCase()))&&a.push({title:o.title,icon:o.icon,tags:["export","site",o.format],more:o.description,value:{target:t,method:"exportSiteAs",args:[o.format]},eventName:"super-daemon-element-method",path:`CMS/export/site/${o.format}`,context:["CMS"]})})),a}}export async function exportSiteAs(t){try{const i=a(o.manifest);if(!i||!i.metadata)return void e.toast("Site manifest not available for export",3e3,"fit-bottom");const s=i.title||"site",r=globalThis.document.querySelector("base"),n=r&&r.href||globalThis.location.origin;switch(t){case"html":await this._exportSiteAsHTML(i,s,n);break;case"markdown":await this._exportSiteAsMarkdown(i,s,n);break;case"docx":await this._exportSiteAsDOCX(i,s,n);break;case"pdf":await this._exportSiteAsPDF(i,s,n);break;case"epub":await this._exportSiteAsEPUB(i,s,n);break;case"zip":await this._downloadSiteArchive();break;case"skeleton":await this._exportSiteAsSkeleton(i,s,n);break;default:e.toast(`Export format "${t}" not supported`,3e3,"fit-bottom")}}catch(t){console.error("Site export error:",t),e.toast(`Site export failed: ${t.message}`,3e3,"fit-bottom")}}export async function _exportSiteAsHTML(o,a,i){try{const s=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:i+"/site.json",id:o.id,title:o.title,author:o.author,description:o.description,license:o.license,metadata:o.metadata,items:o.items},ancestor:null,link:i,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:i,format:"json"});if(200!==s.status||!s.data)throw new Error("Failed to export site as HTML");this._downloadFile(s.data,`${a}.html`,"text/html"),e.toast("Site HTML downloaded successfully",3e3,"fit-bottom")}catch(t){console.error("Site HTML export error:",t),e.toast("Site HTML export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsMarkdown(o,a,i){try{const s=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:i+"/site.json",id:o.id,title:o.title,author:o.author,description:o.description,license:o.license,metadata:o.metadata,items:o.items},ancestor:null,link:i,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:i,format:"json"});if(200!==s.status||!s.data)throw new Error("Failed to get site HTML for Markdown conversion");{const o=await t.call("@core/htmlToMd",{html:s.data});if(200!==o.status||!o.data)throw new Error("Failed to convert site HTML to Markdown");this._downloadFile(o.data,`${a}.md`,"text/markdown"),e.toast("Site Markdown downloaded successfully",3e3,"fit-bottom")}}catch(t){console.error("Site Markdown export error:",t),e.toast("Site Markdown export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsDOCX(o,a,s){try{const r=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:s+"/site.json",id:o.id,title:o.title,author:o.author,description:o.description,license:o.license,metadata:o.metadata,items:o.items},ancestor:null,link:s,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:s,format:"json"});if(200!==r.status||!r.data)throw new Error("Failed to get site HTML for DOCX conversion");{const o=await t.call("@core/htmlToDocx",{html:r.data});if(200!==o.status||!o.data)throw new Error("Failed to convert site HTML to DOCX");{const t=i(o.data,"application/vnd.openxmlformats-officedocument.wordprocessingml.document");this._downloadBlob(t,`${a}.docx`),e.toast("Site DOCX downloaded successfully",3e3,"fit-bottom")}}}catch(t){console.error("Site DOCX export error:",t),e.toast("Site DOCX export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsPDF(o,a,s){try{const r=await t.call("@haxcms/siteToHtml",{type:"site",site:{file:s+"/site.json",id:o.id,title:o.title,author:o.author,description:o.description,license:o.license,metadata:o.metadata,items:o.items},ancestor:null,link:s,magic:globalThis.__appCDN||"https://cdn.hax.cloud/cdn/",base:s,format:"json"});if(200!==r.status||!r.data)throw new Error("Failed to get site HTML for PDF conversion");{const o=await t.call("@core/htmlToPdf",{base:s,html:r.data});if(200!==o.status||!o.data)throw new Error("Failed to convert site HTML to PDF");{const t=i(o.data,"application/pdf");this._downloadBlob(t,`${a}.pdf`),e.toast("Site PDF downloaded successfully",3e3,"fit-bottom")}}}catch(t){console.error("Site PDF export error:",t),e.toast("Site PDF export service not available",3e3,"fit-bottom")}}export async function _exportSiteAsEPUB(o,a,i){try{const o=await t.call("@haxcms/siteToEpub",{type:"link",site:`${i}/site.json`,ancestor:null});if(200!==o.status||!o.data)throw new Error("Failed to export site as EPUB");{const t=new Blob([o.data],{type:"application/epub+zip"});this._downloadBlob(t,`${a}.epub`),e.toast("Site EPUB downloaded successfully",3e3,"fit-bottom")}}catch(t){console.error("Site EPUB export error:",t),e.toast("Site EPUB export service not available",3e3,"fit-bottom")}}export async function _downloadSiteArchive(){try{if(!globalThis.HAXCMS||!globalThis.HAXCMS.siteName)throw new Error("Site download not available");{const t=`${globalThis.location.origin}${globalThis.location.pathname}?download-site=true`,o=globalThis.document.createElement("a");o.href=t,o.download=`${globalThis.HAXCMS.siteName}.zip`,o.target="_blank",globalThis.document.body.appendChild(o),o.click(),globalThis.document.body.removeChild(o),e.toast("Site archive download initiated",3e3,"fit-bottom")}}catch(t){console.error("Site archive download error:",t),e.toast("Site archive download not available",3e3,"fit-bottom")}}export function _downloadFile(t,e,o="text/plain"){const a=new Blob([t],{type:o});this._downloadBlob(a,e)}export function _downloadBlob(t,e){const o=globalThis.document.createElement("a");o.href=globalThis.URL.createObjectURL(t),o.download=e,o.target="_blank",globalThis.document.body.appendChild(o),o.click(),globalThis.document.body.removeChild(o),globalThis.URL.revokeObjectURL(o.href)}export async function _exportSiteAsSkeleton(t,o,a){try{e.toast("Generating site skeleton...",3e3,"fit-bottom");const{SiteSkeletonGenerator:t}=await import("./site-skeleton-generator.js"),o=await t.generateFromCurrentSite(),a=JSON.stringify(o,null,2),i=`${o.meta.name.replace(/[^a-z0-9]/gi,"-").toLowerCase()}-skeleton.json`;this._downloadFile(a,i,"application/json"),e.toast(`Site skeleton exported successfully! Pages: ${o.structure.length}, Files: ${o.files.length}`,5e3,"fit-bottom"),console.log("Skeleton generated:",{name:o.meta.name,pages:o.structure.length,files:o.files.length,theme:o.theme.element})}catch(t){console.error("Skeleton export failed:",t),e.toast(`Skeleton export failed: ${t.message}`,5e3,"fit-bottom")}}