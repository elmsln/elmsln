import"../../simple-icon/lib/simple-icon-button-lite.js";function pad2(e){return(e|=0)<10?`0${e}`:`${Math.min(e,99)}`}function inlineWorker(){function fetchAndInstantiateFallback(e,t){return new Promise(((n,i)=>{const s=new XMLHttpRequest;s.open("GET",e),s.responseType="arraybuffer",s.onload=()=>{n(WebAssembly.instantiate(s.response,t))},s.onerror=i,s.send()}))}let e=null,t=5242880;function sbrk(e){const n=t;return t+=e,n}function exit(e){postMessage({type:"internal-error",data:e})}let n=null,i=null,s=null;onmessage=t=>{const r=t.data;switch(r.type){case"init":const{wasmURL:t,shimURL:a}=r.data;Promise.resolve().then((()=>(self.WebAssembly&&!function testSafariWebAssemblyBug(){const e=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),t=new WebAssembly.Module(e);return 0!==new WebAssembly.Instance(t,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(a),e=new WebAssembly.Memory({initial:256,maximum:256}),{memory:e,pow:Math.pow,exit,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk}))).then((e=>function fetchAndInstantiate(e,t){if(!WebAssembly.instantiateStreaming)return fetchAndInstantiateFallback(e,t);const n=fetch(e,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(n,t).catch((n=>{if(n.message&&n.message.indexOf("Argument 0 must be provided and must be a Response")>0)return fetchAndInstantiateFallback(e,t);throw n}))}(t,{env:e}))).then((e=>{n=e.instance.exports,postMessage({type:"init",data:null})})).catch((e=>{postMessage({type:"init-error",data:e.toString()})}));break;case"start":if(!function vmsg_init(t){if(i=n.vmsg_init(t),!i)return!1;const r=new Uint32Array(e.buffer,i,1)[0];return s=new Float32Array(e.buffer,r),!0}(r.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(!function vmsg_encode(e){return s.set(e),n.vmsg_encode(i,e.length)>=0}(r.data))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const o=function vmsg_flush(){if(n.vmsg_flush(i)<0)return null;const t=new Uint32Array(e.buffer,i+4,1)[0],r=new Uint32Array(e.buffer,i+8,1)[0],a=new Uint8Array(e.buffer,t,r),o=new Blob([a],{type:"audio/mpeg"});return n.vmsg_free(i),i=null,s=null,o}();if(!o)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:o})}}}export class Recorder{constructor(e={},t=null){this.wasmURL=new URL(e.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(e.shimURL||"/static/js/wasm-polyfill.js",location).href,this.onStop=t,this.pitch=e.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&this.worker.terminate(),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}initAudio(){return(globalThis.navigator.mediaDevices&&globalThis.navigator.mediaDevices.getUserMedia?function(e){return globalThis.navigator.mediaDevices.getUserMedia(e)}:function(e){const t=globalThis.navigator.webkitGetUserMedia||globalThis.navigator.mozGetUserMedia;return t?new Promise((function(n,i){t.call(navigator,e,n,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then((e=>{this.stream=e;const t=this.audioCtx=new(globalThis.AudioContext||globalThis.webkitAudioContext),n=t.createMediaStreamSource(e),i=this.gainNode=(t.createGain||t.createGainNode).call(t);i.gain.value=1,n.connect(i);const s=this.pitchFX=new Jungle(t);s.setPitchOffset(this.pitch);const r=this.encNode=(t.createScriptProcessor||t.createJavaScriptNode).call(t,0,1,1);s.output.connect(r),i.connect(0===this.pitch?r:s.input)}))}initWorker(){if(!this.stream)throw new Error("missing audio initialization");const e=new Blob(["(",inlineWorker.toString(),")()"],{type:"application/javascript"}),t=this.workerURL=URL.createObjectURL(e),n=this.worker=new Worker(t),{wasmURL:i,shimURL:s}=this;return n.postMessage({type:"init",data:{wasmURL:i,shimURL:s}}),new Promise(((e,t)=>{n.onmessage=n=>{const i=n.data;switch(i.type){case"init":e();break;case"init-error":t(new Error(i.data));break;case"error":case"internal-error":console.error("Worker error:",i.data),this.reject&&this.reject(i.data);break;case"stop":this.blob=i.data,this.blobURL=URL.createObjectURL(i.data),this.onStop&&this.onStop(),this.resolve&&this.resolve(this.blob)}}}))}init(){return this.initAudio().then(this.initWorker.bind(this))}startRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:t})},this.encNode.connect(this.audioCtx.destination)}stopRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.stopTracks(),this.worker.postMessage({type:"stop",data:null}),new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach((e=>e.stop()))}}export class Form{constructor(e={},t=globalThis.document.body,n,i){this.recorder=new Recorder(e,this.onStop.bind(this)),this.resolve=n,this.reject=i,this.target=t,this.renderArea=null,this.recordBtn=null,this.stopBtn=null,this.timer=null,this.audio=null,this.saveBtn=null,this.previewBtn=null,this.tid=0,this.playing=!1,this.hasRecording=!1,this.start=0,Object.seal(this),this.recorder.initAudio().then((()=>this.drawInit())).then((()=>this.recorder.initWorker())).then((()=>this.drawAll())).catch((e=>this.drawError(e)))}drawInit(){this.target&&this.target.querySelector(".vmsg-popup")&&this.target.querySelector(".vmsg-popup").remove();const e=this.renderArea=globalThis.document.createElement("div");e.className="vmsg-popup",e.style.cssText="\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      text-align: center;\n      font-family: var(--ddd-font-navigation, sans-serif);\n    ",e.addEventListener("click",(e=>e.stopPropagation()));const t=globalThis.document.createElement("div");t.className="vmsg-progress";for(let e=0;e<3;e++){const e=globalThis.document.createElement("div");e.className="vmsg-progress-dot",t.appendChild(e)}e.appendChild(t),this.target.appendChild(e)}drawTime(e){const t=Math.round(e/1e3);this.timer.textContent=pad2(t/60)+":"+pad2(t%60)}drawAll(){this.drawInit(),this.clearAll();const e=this.timer=globalThis.document.createElement("div");e.className="vmsg-timer",e.style.cssText="\n      padding: var(--ddd-spacing-1, 4px);\n      font-family: var(--ddd-font-navigation, sans-serif);\n      font-size: var(--ddd-font-size-3xs, 11px);\n      min-width: 40px;\n      text-align: center;\n    ",this.drawTime(0),this.target.querySelector(".vmsg-popup").appendChild(e);const t=globalThis.document.createElement("div");t.className="vmsg-record-row",t.style.cssText="\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      gap: var(--ddd-spacing-1, 4px);\n      margin: var(--ddd-spacing-1, 4px) 0;\n    ",this.renderArea.appendChild(t);const n=this.audio=new Audio,i=this.recordBtn=globalThis.document.createElement("simple-icon-button-lite");i.className="vmsg-button vmsg-record-button",i.icon=this.hasRecording?"refresh":"av:fiber-smart-record",i.innerHTML=""+(this.hasRecording?"Rerecord":"Record"),i.style.cssText="\n      border: none;\n      border-radius: var(--ddd-radius-sm, 4px);\n      padding: var(--ddd-spacing-1, 4px) var(--ddd-spacing-2, 8px);\n      margin: var(--ddd-spacing-1, 4px);\n      font-family: var(--ddd-font-navigation, sans-serif);\n      font-size: var(--ddd-font-size-4xs, 10px);\n      background-color: var(--ddd-theme-default-error, #d32f2f);\n      color: white;\n      cursor: pointer;\n      text-align: center;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      transition: background-color 0.2s ease;\n    ",i.addEventListener("click",(()=>this.startRecording())),t.appendChild(i);const s=this.stopBtn=globalThis.document.createElement("simple-icon-button-lite");s.className="vmsg-button vmsg-stop-button",s.style.display="none",s.icon="av:stop",s.innerHTML="Stop",s.style.cssText+="\n      border: none;\n      border-radius: var(--ddd-radius-sm, 4px);\n      padding: var(--ddd-spacing-1, 4px) var(--ddd-spacing-2, 8px);\n      margin: var(--ddd-spacing-1, 4px);\n      font-family: var(--ddd-font-navigation, sans-serif);\n      font-size: var(--ddd-font-size-4xs, 10px);\n      background-color: var(--ddd-theme-default-error, #d32f2f);\n      color: white;\n      cursor: pointer;\n      text-align: center;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      transition: background-color 0.2s ease;\n    ",s.addEventListener("click",(()=>this.stopRecording())),t.appendChild(s);const r=this.previewBtn=globalThis.document.createElement("simple-icon-button-lite");r.className="vmsg-button vmsg-record-button",r.style.display="none",r.icon=this.playing?"av:pause":"av:play-arrow",r.innerHTML=""+(this.playing?"Pause":"Preview"),r.style.cssText+="\n      border: none;\n      border-radius: var(--ddd-radius-sm, 4px);\n      padding: var(--ddd-spacing-1, 4px) var(--ddd-spacing-2, 8px);\n      margin: var(--ddd-spacing-1, 4px);\n      font-family: var(--ddd-font-navigation, sans-serif);\n      font-size: var(--ddd-font-size-4xs, 10px);\n      background-color: var(--ddd-theme-default-keystoneYellow, #ffd100);\n      color: var(--ddd-theme-default-coalyGray, #444);\n      cursor: pointer;\n      text-align: center;\n      display: none;\n      align-items: center;\n      justify-content: center;\n      transition: background-color 0.2s ease;\n    ",r.addEventListener("click",(()=>{this.playing=!this.playing,n.paused?this.recorder.blobURL&&(n.src=this.recorder.blobURL):(this.playing=!1,n.pause()),r.icon=this.playing?"av:pause":"av:play-arrow",r.innerHTML=""+(this.playing?"Pause":"Preview")})),t.appendChild(r);const a=this.saveBtn=globalThis.document.createElement("simple-icon-button-lite");a.className="vmsg-button vmsg-save-button",a.icon="icons:save",a.innerHTML="Save",a.style.cssText="\n      border: none;\n      border-radius: var(--ddd-radius-sm, 4px);\n      padding: var(--ddd-spacing-1, 4px) var(--ddd-spacing-2, 8px);\n      margin: var(--ddd-spacing-1, 4px);\n      font-family: var(--ddd-font-navigation, sans-serif);\n      font-size: var(--ddd-font-size-4xs, 10px);\n      background-color: var(--ddd-theme-default-success, #4caf50);\n      color: white;\n      cursor: pointer;\n      text-align: center;\n      display: none;\n      align-items: center;\n      height: 40px;\n      justify-content: center;\n      transition: background-color 0.2s ease;\n    ",a.addEventListener("click",(()=>this.close(this.recorder.blob))),t.appendChild(a),this.target.dispatchEvent(new CustomEvent("vmsg-ready",{detail:{value:!0}}))}drawError(e){console.error(e),this.drawInit(),this.clearAll();const t=globalThis.document.createElement("div");t.className="vmsg-error",t.textContent=e.toString(),this.renderArea.appendChild(t)}clearAll(){this.renderArea&&(this.renderArea.innerHTML="")}close(e){this.audio&&this.audio.pause(),this.tid&&clearTimeout(this.tid),this.recorder.close(),e?this.resolve(e):this.reject(new Error("No record made"))}onStop(){this.recordBtn.style.display="",this.recordBtn.icon=this.hasRecording?"refresh":"av:fiber-smart-record",this.recordBtn.innerHTML=""+(this.hasRecording?"Rerecord":"Record"),this.stopBtn.style.display="none",this.previewBtn.style.display="",this.stopBtn.disabled=!1,this.saveBtn.disabled=!1,this.saveBtn.style.display=""}startRecording(){this.audio.pause(),this.start=Date.now(),this.updateTime(),this.hasRecording=!1,this.recordBtn.style.display="none",this.previewBtn.style.display="none",this.stopBtn.style.display="",this.saveBtn.style.display="none",this.recorder.startRecording()}stopRecording(){clearTimeout(this.tid),this.tid=0,this.hasRecording=!0,this.stopBtn.disabled=!0,this.recorder.stopRecording()}updateTime(){this.drawTime(Date.now()-this.start),this.tid=setTimeout((()=>this.updateTime()),300)}}let e=!1;export function record(t,n){return new Promise(((i,s)=>{if(e)throw new Error("Record form is already opened");e=!0,new Form(t,n,i,s)})).then((t=>(e=!1,t)),(t=>{throw e=!1,t}))}export default{Recorder,Form,record};const t=.1,n=.05,i=.1;function createDelayTimeBuffer(e,t,n,i){for(var s=t*e.sampleRate,r=s+(t-2*n)*e.sampleRate,a=e.createBuffer(1,r,e.sampleRate),o=a.getChannelData(0),c=0;c<s;++c)o[c]=i?(s-c)/r:c/s;for(c=s;c<r;++c)o[c]=0;return a}function Jungle(e){this.context=e;var s=(e.createGain||e.createGainNode).call(e),r=(e.createGain||e.createGainNode).call(e);this.input=s,this.output=r;var a=e.createBufferSource(),o=e.createBufferSource(),c=e.createBufferSource(),d=e.createBufferSource();this.shiftDownBuffer=createDelayTimeBuffer(e,i,n,!1),this.shiftUpBuffer=createDelayTimeBuffer(e,i,n,!0),a.buffer=this.shiftDownBuffer,o.buffer=this.shiftDownBuffer,c.buffer=this.shiftUpBuffer,d.buffer=this.shiftUpBuffer,a.loop=!0,o.loop=!0,c.loop=!0,d.loop=!0;var l=(e.createGain||e.createGainNode).call(e),h=(e.createGain||e.createGainNode).call(e),u=(e.createGain||e.createGainNode).call(e);u.gain.value=0;var p=(e.createGain||e.createGainNode).call(e);p.gain.value=0,a.connect(l),o.connect(h),c.connect(u),d.connect(p);var m=(e.createGain||e.createGainNode).call(e),g=(e.createGain||e.createGainNode).call(e),f=(e.createDelay||e.createDelayNode).call(e),v=(e.createDelay||e.createDelayNode).call(e);l.connect(m),h.connect(g),u.connect(m),p.connect(g),m.connect(f.delayTime),g.connect(v.delayTime);var b=e.createBufferSource(),y=e.createBufferSource(),w=function createFadeBuffer(e,t,n){for(var i=t*e.sampleRate,s=i+(t-2*n)*e.sampleRate,r=e.createBuffer(1,s,e.sampleRate),a=r.getChannelData(0),o=n*e.sampleRate,c=o,d=i-o,l=0;l<i;++l){var h;h=l<c?Math.sqrt(l/o):l>=d?Math.sqrt(1-(l-d)/o):1,a[l]=h}for(l=i;l<s;++l)a[l]=0;return r}(e,i,n);b.buffer=w,y.buffer=w,b.loop=!0,y.loop=!0;var x=(e.createGain||e.createGainNode).call(e),R=(e.createGain||e.createGainNode).call(e);x.gain.value=0,R.gain.value=0,b.connect(x.gain),y.connect(R.gain),s.connect(f),s.connect(v),f.connect(x),v.connect(R),x.connect(r),R.connect(r);var k=e.currentTime+.05,T=k+i-n;a.start(k),o.start(T),c.start(k),d.start(T),b.start(k),y.start(T),this.mod1=a,this.mod2=o,this.mod1Gain=l,this.mod2Gain=h,this.mod3Gain=u,this.mod4Gain=p,this.modGain1=m,this.modGain2=g,this.fade1=b,this.fade2=y,this.mix1=x,this.mix2=R,this.delay1=f,this.delay2=v,this.setDelay(t)}Jungle.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},Jungle.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(t*Math.abs(e))};