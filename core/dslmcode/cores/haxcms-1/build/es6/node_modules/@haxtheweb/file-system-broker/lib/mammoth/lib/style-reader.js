var e=require("underscore"),r=require("lop"),t=require("./styles/document-matchers"),u=require("./styles/html-paths"),n=require("./styles/parser/tokeniser").tokenise,s=require("./results");function documentMatcherRule(){var u=r.rules.sequence,identifierToConstant=function(e,t){return r.rules.then(r.rules.token("identifier",e),(function(){return t}))},n=identifierToConstant("p",t.paragraph),s=identifierToConstant("r",t.run),l=r.rules.firstOf("p or r or table",n,s),o=r.rules.then(i,(function(e){return{styleId:e}})),p=r.rules.firstOf("style name matcher",r.rules.then(r.rules.sequence(r.rules.tokenOfType("equals"),r.rules.sequence.cut(),r.rules.sequence.capture(c)).head(),(function(e){return{styleName:t.equalTo(e)}})),r.rules.then(r.rules.sequence(r.rules.tokenOfType("startsWith"),r.rules.sequence.cut(),r.rules.sequence.capture(c)).head(),(function(e){return{styleName:t.startsWith(e)}}))),f=r.rules.sequence(r.rules.tokenOfType("open-square-bracket"),r.rules.sequence.cut(),r.rules.token("identifier","style-name"),r.rules.sequence.capture(p),r.rules.tokenOfType("close-square-bracket")).head(),d=r.rules.firstOf("list type",identifierToConstant("ordered-list",{isOrdered:!0}),identifierToConstant("unordered-list",{isOrdered:!1})),h=u(r.rules.tokenOfType("colon"),u.capture(d),u.cut(),r.rules.tokenOfType("open-paren"),u.capture(a),r.rules.tokenOfType("close-paren")).map((function(e,r){return{list:{isOrdered:e.isOrdered,levelIndex:r-1}}}));function createMatcherSuffixesRule(t){var u=r.rules.firstOf.apply(r.rules.firstOf,["matcher suffix"].concat(t)),n=r.rules.zeroOrMore(u);return r.rules.then(n,(function(r){var t={};return r.forEach((function(r){e.extend(t,r)})),t}))}var k=u(u.capture(l),u.capture(createMatcherSuffixesRule([o,f,h]))).map((function(e,r){return e(r)})),m=u(r.rules.token("identifier","table"),u.capture(createMatcherSuffixesRule([o,f]))).map((function(e){return t.table(e)})),O=identifierToConstant("b",t.bold),y=identifierToConstant("i",t.italic),q=identifierToConstant("u",t.underline),T=identifierToConstant("strike",t.strikethrough),g=identifierToConstant("all-caps",t.allCaps),b=identifierToConstant("small-caps",t.smallCaps),v=identifierToConstant("comment-reference",t.commentReference),S=u(r.rules.token("identifier","br"),u.cut(),r.rules.tokenOfType("open-square-bracket"),r.rules.token("identifier","type"),r.rules.tokenOfType("equals"),u.capture(c),r.rules.tokenOfType("close-square-bracket")).map((function(e){switch(e){case"line":return t.lineBreak;case"page":return t.pageBreak;case"column":return t.columnBreak}}));return r.rules.firstOf("element type",k,m,O,y,q,T,g,b,v,S)}function htmlPathRule(){var e=r.rules.sequence.capture,t=r.rules.tokenOfType("whitespace"),n=r.rules.then(r.rules.optional(r.rules.sequence(r.rules.tokenOfType("colon"),r.rules.token("identifier","fresh"))),(function(e){return e.map((function(){return!0})).valueOrElse(!1)})),s=r.rules.then(r.rules.optional(r.rules.sequence(r.rules.tokenOfType("colon"),r.rules.token("identifier","separator"),r.rules.tokenOfType("open-paren"),e(c),r.rules.tokenOfType("close-paren")).head()),(function(e){return e.valueOrElse("")})),a=r.rules.oneOrMoreWithSeparator(l,r.rules.tokenOfType("choice")),o=r.rules.sequence(e(a),e(r.rules.zeroOrMore(i)),e(n),e(s)).map((function(e,r,t,n){var s={},l={};return r.length>0&&(s.class=r.join(" ")),t&&(l.fresh=!0),n&&(l.separator=n),u.element(e,s,l)}));return r.rules.firstOf("html path",r.rules.then(r.rules.tokenOfType("bang"),(function(){return u.ignore})),r.rules.then(r.rules.zeroOrMoreWithSeparator(o,r.rules.sequence(t,r.rules.tokenOfType("gt"),t)),u.elements))}exports.readHtmlPath=function readHtmlPath(e){return parseString(htmlPathRule(),e)},exports.readDocumentMatcher=function readDocumentMatcher(e){return parseString(documentMatcherRule(),e)},exports.readStyle=function readStyle(e){return parseString(p,e)};var l=r.rules.then(r.rules.tokenOfType("identifier"),decodeEscapeSequences),a=r.rules.tokenOfType("integer"),c=r.rules.then(r.rules.tokenOfType("string"),decodeEscapeSequences),o={n:"\n",r:"\r",t:"\t"};function decodeEscapeSequences(e){return e.replace(/\\(.)/g,(function(e,r){return o[r]||r}))}var i=r.rules.sequence(r.rules.tokenOfType("dot"),r.rules.sequence.cut(),r.rules.sequence.capture(l)).head();function parseString(e,t){var u=n(t),l=r.Parser().parseTokens(e,u);return l.isSuccess()?s.success(l.value()):new s.Result(null,[s.warning(describeFailure(t,l))])}function describeFailure(e,r){return"Did not understand this style mapping, so ignored it: "+e+"\n"+r.errors().map(describeError).join("\n")}function describeError(e){return"Error was at character number "+e.characterNumber()+": Expected "+e.expected+" but got "+e.actual}var p=function createStyleRule(){return r.rules.sequence(r.rules.sequence.capture(documentMatcherRule()),r.rules.tokenOfType("whitespace"),r.rules.tokenOfType("arrow"),r.rules.sequence.capture(r.rules.optional(r.rules.sequence(r.rules.tokenOfType("whitespace"),r.rules.sequence.capture(htmlPathRule())).head())),r.rules.tokenOfType("end")).map((function(e,r){return{from:e,to:r.valueOrElse(u.empty)}}))}();