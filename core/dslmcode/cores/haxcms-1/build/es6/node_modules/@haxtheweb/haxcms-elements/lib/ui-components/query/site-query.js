/**
 * Copyright 2019 The Pennsylvania State University
 * @license Apache-2.0, see License.md for full text.
 */
import{LitElement as t}from"../../../../../lit/index.js";import{store as e}from"../../core/haxcms-site-store.js";import{objectValFromStringPos as r}from"../../../../utils/utils.js";import{autorun as i,toJS as s}from"../../../../../mobx/dist/mobx.esm.js";Object.byString=function(t,e){return r(t,e)};class SiteQuery extends t{static get tag(){return"site-query"}static get properties(){return{routerManifest:{type:Object},activeId:{type:String,attribute:"active-id"},result:{type:Array},conditions:{type:Object},sort:{type:Object},forceRebuild:{type:Boolean,attribute:"force-rebuild"},limit:{type:Number},startIndex:{type:Number,attribute:"start-index"},random:{type:Boolean},entity:{type:String}}}constructor(){super(),this.entity="node",this.conditions={},this.random=!1,this.sort={order:"ASC"},this.forceRebuild=!1,this.limit=0,this.startIndex=0}updated(t){t.forEach(((t,e)=>{if(["result","conditions","sort","forceRebuild"].includes(e)){let t=`${e.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g,"$1-$2").toLowerCase()}-changed`;this.dispatchEvent(new CustomEvent(t,{detail:{value:this[e]}}))}["entity","conditions","sort","routerManifest","activeId","limit","startIndex","random","forceRebuild"].includes(e)&&(this.result=[...this._computeResult(this.entity,this.conditions,this.sort,this.routerManifest,this.activeId,this.limit,this.startIndex,this.random,this.forceRebuild)])}))}_computeResult(t,e,r,i,n,o,a,c,b){if(i&&i.items){var u=[...s(i.items)];for(var d in u)u[d].metadata=s(u[d].metadata);if("node"!==t){var l=[];for(var d in u)if(void 0!==Object.byString(u[d],t)){let e,r=Object.byString(u[d],t);if(e="object"==typeof r||"array"==typeof r?Object.assign([],Object.byString(u[d],t)):r,"object"==typeof e||"array"==typeof e)for(var d in e)if("object"==typeof e[d]||"array"==typeof e[d])e[d]._node=Object.assign({},u[d]),l.push(e[d]);else{let t={_node:Object.assign({},u[d]),value:e[d]};l.push(t)}else{let t={_node:Object.assign({},u[d]),value:e};l.push(t)}}u=Object.assign([],l)}if(e&&u)for(var d in e){null===e[d]?e[d]={value:[e[d]],operator:"="}:"object"!=typeof e[d]&&(e[d]={value:e[d],operator:"="});var y=e[d].value;"$activeId"===e[d].value?y=n:"$firstId"===e[d].value&&(y=u[0].id),u=u.filter((t=>{switch(e[d].operator){case"includes":try{const includesAll=(t,e)=>e.every((e=>t.includes(e)));if("object"==typeof Object.byString(t,d)){if(includesAll(Array.from(Object.byString(t,d)),y))return!0}else if(includesAll(Array.from(Object.byString(t,d).replaceAll(", ",",").split(",")),y))return!0}catch(t){console.warn(t)}return!1;case">":return Object.byString(t,d)>y;case"<":return Object.byString(t,d)<y;case"!=":return"object"==typeof y&&!y.includes(Object.byString(t,d))||("string"==typeof y&&Object.byString(t,d)!==y||("boolean"==typeof y&&Object.byString(t,d),!1));default:return!("object"==typeof y&&!y.includes(Object.byString(t,d)))&&(("string"!=typeof y||Object.byString(t,d)===y)&&("boolean"==typeof y&&Object.byString(t,d),!0))}}))}if(r)for(var d in r)u.sort(((t,e)=>"ASC"===r[d]?Object.byString(t,d)<Object.byString(e,d)?-1:Object.byString(t,d)>Object.byString(e,d)?1:0:Object.byString(t,d)>Object.byString(e,d)?-1:Object.byString(t,d)<Object.byString(e,d)?1:0));if(c&&u.sort(((t,e)=>Math.random()<Math.random()?-1:Math.random()>Math.random()?1:0)),0!==a&&u.length>a)for(;a>0;)u.shift(),a--;else if(u.length<a)return[];if(0!==o&&o>0)for(;u.length>o;)u.pop();return u}return[]}connectedCallback(){super.connectedCallback(),this.__disposer=i((()=>{this.routerManifest=Object.assign({},s(e.routerManifest))})),this.__disposer2=i((()=>{this.activeId=s(e.activeId)}))}disconnectedCallback(){this.__disposer(),this.__disposer2(),super.disconnectedCallback()}}customElements.define(SiteQuery.tag,SiteQuery);export{SiteQuery};