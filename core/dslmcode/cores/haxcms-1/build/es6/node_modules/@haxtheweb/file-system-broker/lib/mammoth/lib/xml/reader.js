var e=require("../promises"),r=require("sax"),n=require("underscore"),t=require("./nodes"),i=t.Element;exports.readString=function readString(o,u){u=u||{};var c=!1,a=r.parser(!0,{xmlns:!0,position:!1}),s={children:[]},p=s,l=[],f=e.defer();function mapName(e){if(e.uri){var r=u[e.uri];return(r?r+":":"{"+e.uri+"}")+e.local}return e.local}return a.onopentag=function(e){var r=function mapObject(e,r,t){return n.reduce(e,(function(n,i,o){return n[t(i,o,e)]=r(i,o,e),n}),{})}(e.attributes,(function(e){return e.value}),mapName),t=new i(mapName(e),r);p.children.push(t),l.push(p),p=t},a.onclosetag=function(e){p=l.pop()},a.ontext=function(e){p!==s&&p.children.push(t.text(e))},a.onend=function(){c||(c=!0,f.resolve(s.children[0]))},a.onerror=function(e){c||(c=!0,f.reject(e))},a.write(o).close(),f.promise};