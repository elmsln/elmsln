import{LitElement as e,html as t,css as a}from"../../../../lit/index.js";import{encapScript as i,findTagsInHTML as o,wipeSlot as s,varExists as n,localStorageSet as l,nodeToHaxElement as r,haxElementToNode as d}from"../../../utils/utils.js";import{autorun as h,toJS as m}from"../../../../mobx/dist/mobx.esm.js";import{store as c,HAXcmsStore as p}from"./haxcms-site-store.js";import"./haxcms-site-router.js";import"../../../simple-progress/simple-progress.js";import{I18NMixin as g}from"../../../i18n-manager/lib/I18NMixin.js";import"../../../replace-tag/replace-tag.js";function darkToggle(e){e.matches?c.darkMode=!0:c.darkMode=!1}class HAXCMSSiteBuilder extends(g(e)){static get styles(){return[a`
        :host {
          display: block;
          position: relative;
        }
        :host([is-logged-in]) {
          max-height: calc(100vh - 56px);
        }
        :host #slot {
          opacity: 0.2;
          visibility: hidden;
        }
        :host([theme-loaded]) #slot {
          opacity: 1;
          visibility: visible;
        }
        simple-progress {
          display: block;
          width: 100%;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background-color: transparent;
          z-index: 1000;
          --simple-progress-active-color: var(
            --haxcms-color,
            rgba(255, 255, 255, 0.5)
          );
        }
        simple-progress[disabled] {
          display: none;
        }
      `]}static get tag(){return"haxcms-site-builder"}render(){return t`
      <site-ai-chat></site-ai-chat>
      <haxcms-site-router base-uri="${this.baseURI}"></haxcms-site-router>
      <simple-progress .disabled="${!this.loading}"></simple-progress>
      <div id="slot"><slot></slot></div>
      <slot name="haxcms-site-editor-ui-prefix-avatar"></slot>
      <slot name="haxcms-site-editor-ui-prefix-buttons"></slot>
      <slot name="haxcms-site-editor-ui-suffix-buttons"></slot>
      <slot name="haxcms-site-editor-ui-main-menu"></slot>
      <slot name="haxcms-site-editor-ui-topbar-character-button"></slot>
    `}async htmlToHaxElements(e){let t=[],a=globalThis.document.createElement("div");if(a.innerHTML=e,a.children){const e=a.children;for(let a=0;a<e.length;a++)void 0!==e[a].tagName&&t.push(await r(e[a],null))}return t}async getStyleGuideTemplates(e,t=null){try{const a=t||await c.loadStyleGuideContent();if(!a)return[];const i=await this.htmlToHaxElements(a),o=[];for(const t of i)if(t&&"page-template"===t.tag&&t.content){const a=await this.htmlToHaxElements(t.content);if(a&&a.length>0&&a[0].tag===e){const e=t.properties&&t.properties.id,a=t.properties&&t.properties.name;e&&a&&o.push({value:e,text:a})}}return o}catch(e){return console.warn("Failed to get style guide templates:",e),[]}}_updateManifest(e){this.manifest={...e}}_updateLoading(e){this.loading=e.detail.value}hashCode(e){return e.split("").reduce(((e,t)=>0|(e=(e<<5)-e+t.charCodeAt(0))),0)}nodeNormalizeIDs(e){if(e.tagName&&null==e.getAttribute("id")&&["H1","H2","H3","H4","H5","H6"].includes(e.tagName))if(e.getAttribute("resource"))e.setAttribute("id",e.getAttribute("resource"));else{let t=e.tagName.toLowerCase()+"-"+this.hashCode(e.innerText);e.setAttribute("id",t)}}_updateActiveItemContent(e){if(e){let t=globalThis.document.createElement("div");t.innerHTML=e;for(const e of t.childNodes)this.nodeNormalizeIDs(e);e=t.innerHTML,this.__pageContent=e,this._activeItemContentChanged(this.__pageContent,m(c.activeItem))}else c.cmsSiteEditorBackend.instance&&c.cmsSiteEditorBackend.instance.updateActiveItemContent&&c.cmsSiteEditorBackend.instance.updateActiveItemContent()}display404Error(){if(c.themeElement){let e=globalThis.document.createDocumentFragment(),t=globalThis.document.createElement("p");t.innerHTML=`<strong>${c.getInternalRoute()}</strong> ${this.t.couldNotBeLocated}. ${this.t.hereAreSomePossibleRemedies}\n      <ul>\n        <li><a href="x/search?search=${c.getInternalRoute()}">${this.t.useSearchToLocateTheContentYouAreLookingFor}</a></li>\n        <li><a href="./">${this.t.goToTheHomePage}</a></li>\n        <li>${this.t.navigateToAnotherPageInTheMenu}</li>\n      </ul>`,e.appendChild(t),s(c.themeElement,"*"),c.themeElement.appendChild(e)}}renderInternalRoute(){if(c.themeElement){let e=globalThis.document.createDocumentFragment();c.activeItem.component&&import(`../ui-components/routes/${c.activeItem.component}.js`).then((()=>{let t=globalThis.document.createElement(c.activeItem.component);e.appendChild(t),s(c.themeElement,"*"),c.themeElement.appendChild(e)}))}}async loadPageData(){if(this.activeItemLocation&&!this.loading){this.loading=!0;let e=`${this.outlineLocation}${this.activeItemLocation}`;this._timeStamp&&(-1!=e.indexOf("?")?e+=`&${this._timeStamp}`:e+=`?${this._timeStamp}`),"hax-internal-route.html"===this.activeItemLocation?(this.renderInternalRoute(),this.loading=!1):await fetch(e).then((e=>{if(e.ok)return e.text();this.display404Error()})).then((e=>{this._updateActiveItemContent(e),this.loading=!1})).catch((e=>{this.lastErrorChanged(e)}))}}async loadJOSData(){if(this.file){this.loading=!0;let e=`${this.outlineLocation}${this.file}`;try{let e=JSON.parse(this.file);this._updateManifest(e),this.loading=!1}catch(t){this._timeStamp&&""!=this._timeStamp&&(-1!=e.indexOf("?")?e+=`&${this._timeStamp}`:e+=`?${this._timeStamp}`);await fetch(e,{cache:"no-cache"}).then((e=>{if(e.ok)return e.json()})).then((e=>{this._updateManifest(e),this.loading=!1})).catch((e=>{this.lastErrorChanged(e)}))}}}updated(e){super.updated&&super.updated(e);let t=!1,a=!1;e.forEach(((e,i)=>{["outlineLocation","activeItemLocation"].includes(i)&&""!=this[i]&&(a=!0),["outlineLocation","file"].includes(i)&&""!=this[i]&&(t=!0),"_timeStamp"==i&&this[i]&&(t=!0,a=!0),"themeData"==i?this._themeChanged(this[i],e):"themeName"==i?this._themeNameChanged(this[i],e):"outlineLocation"==i?this.dispatchEvent(new CustomEvent("outline-location-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[i]})):"manifest"==i&&(this.dispatchEvent(new CustomEvent("manifest-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[i]})),this._manifestChanged(this[i],e))})),t&&this.__ready&&this.loadJOSData(),a&&this.__ready&&this.loadPageData()}static get properties(){return{...super.properties,t:{type:Object},activeItemLocation:{type:String,attribute:"active-item-location"},disableFeatures:{type:String,reflect:!0,attribute:"disable-features"},_timeStamp:{type:String},isLoggedIn:{type:Boolean,reflect:!0,attribute:"is-logged-in"},queryParams:{type:Object},loading:{type:Boolean,reflect:!0},outlineLocation:{type:String,attribute:"outline-location"},manifest:{type:Object},themeData:{type:Object},themeName:{type:String},__imported:{type:Object},themeLoaded:{type:Boolean,reflect:!0,attribute:"theme-loaded"},file:{type:String},baseURI:{type:String,attribute:"base-uri"}}}_themeNameChanged(e,t){e&&(c.themeElement&&e!=t&&c.themeElement.tagName.toLowerCase()!=e&&c.themeElement.remove(),s(this,"*"),c.themeElement=globalThis.document.createElement(e),c.themeElement.classList.add("haxcms-theme-element"),this.appendChild(c.themeElement))}lastErrorChanged(e){e&&(console.error(e),e.detail&&e.detail.value?(globalThis&&globalThis.location&&globalThis.appSettings&&globalThis.appSettings.reloadOnError&&globalThis.location.reload(),c.toast(e.detail.value.status+" "+e.detail.value.statusText,5e3,{fire:!0})):globalThis&&globalThis.location&&globalThis.appSettings&&globalThis.appSettings.reloadOnError&&globalThis.location.reload())}constructor(){for(var e in super(),this.__pageContent="",this.windowControllers=new AbortController,this.t={...super.t,pageNotFound:"Page not found",navigateToAnotherPageInTheMenu:"Navigate to another page in the menu",couldNotBeLocated:"could not be located",hereAreSomePossibleRemedies:"Here are some possible remedies:",useSearchToLocateTheContentYouAreLookingFor:"Use Search to locate the content you are looking for",goToTheHomePage:"Go to the home page"},this.registerLocalization({context:this,namespace:"haxcms",localesPath:new URL("../../locales/haxcms.es.json",import.meta.url).href.replace("/haxcms.es.json","/")}),this._timeStamp=Math.floor(Date.now()/1e3),this.disableFeatures="",this.isLoggedIn=!1,this.__disposer=[],this.queryParams={},this.loading=!1,this.__imported={},this.themeLoaded=!1,this.outlineLocation="",this.activeItemLocation="",p.storePieces.siteBuilder=this,this.children)if(this.children[e].tagName&&this.children[e].getAttribute("slot")){const t=this.children[e].cloneNode(!0);let a=t.getAttribute("slot");switch(a){case"haxcms-site-editor-ui-prefix-avatar":case"haxcms-site-editor-ui-prefix-buttons":case"haxcms-site-editor-ui-suffix-buttons":case"haxcms-site-editor-ui-main-menu":case"haxcms-site-editor-ui-topbar-character-button":c.setupSlots[a].push(t)}}globalThis.addEventListener("hax-store-ready",this.storeReady.bind(this),{signal:this.windowControllers.signal}),globalThis.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this),{signal:this.windowControllers.signal}),globalThis.addEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this),{signal:this.windowControllers.signal}),globalThis.matchMedia("(prefers-color-scheme: dark)").matches&&(c.darkMode=!0),globalThis.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",darkToggle,{signal:this.windowControllers.signal}),h((()=>{l("app-hax-darkMode",m(c.darkMode)),m(c.darkMode)?globalThis.document.body.classList.add("dark-mode"):globalThis.document.body.classList.remove("dark-mode")})),h((()=>{this.isLoggedIn=m(c.isLoggedIn);const e=Math.floor(Date.now()/1e3);this.isLoggedIn&&!this.loggedInTime&&(this.loggedInTime=e,this._timeStamp=this.loggedInTime)}))}displayConsoleWarning(){setTimeout((()=>{console.warn("%câš ï¸STOPâš ï¸","color: white; font-weight: bold; font-size: 5em;font-family: arial; background-color: darkred; border: 5px solid white; border: 5px solid white;"),console.warn('%cThis is a browser feature intended for developers. If someone told you to copy and paste something here to enable a hidden feature or "hack" someone\'s account, it is a scam and will give them access to your account.',"font-size: 1.5em; font-family: arial; color: white; background-color: darkred; ")}),3500)}displayConsoleLearnMore(){setTimeout((()=>{console.log("%cðŸ‘©â€ðŸ’»HAXcmsðŸ§‘â€ðŸ’»","color: white; font-weight: bold; padding: 10px; font-size: 5em;font-family: arial; background-color: black; border: 5px solid white; border: 5px solid white; font-style: italic;"),console.log("%cThis site was created using HAXcms.\nLearn more about HAXcms at https://hax.psu.edu/.","color: white; background-color: black; font-size: 1.5em; font-family: arial; padding: 10px;")}),3e3)}firstUpdated(e){super.firstUpdated&&super.firstUpdated(e),this.displayConsoleLearnMore(),this.__ready=!0,c.appReady=!0,globalThis.dispatchEvent(new CustomEvent("haxcms-ready",{bubbles:!0,composed:!0,cancelable:!1,detail:this})),import("./haxcms-editor-builder.js").then((e=>{import("./haxcms-toast.js"),this.editorBuilder=globalThis.document.createElement("haxcms-editor-builder"),this.parentNode?this.parentNode.insertBefore(this.editorBuilder,this):globalThis.document.body.appendChild(this.editorBuilder),"published"!==p.getApplicationContext()?this._timeStamp=Math.floor(Date.now()/1e3):this._timeStamp=""})).catch((e=>{console.warn(e)})),globalThis.dispatchEvent(new Event("resize")),setTimeout((()=>{h((e=>{if(this.themeData=m(c.themeData),this.themeData){const e=new URLSearchParams(globalThis.location.search),t=e.get("format");if(null!=t)switch(t){case"print-page":this.themeData.element="haxcms-print-theme";break;case"json":import("./themes/haxcms-json-theme.js"),this.themeData.element="haxcms-json-theme"}const a=e.get("disable-features");null!=a&&(this.disableFeatures=a)}this.themeData&&this.themeData.element!==this.themeName&&null!=this.themeData.element&&(this.themeName=this.themeData.element),this.__disposer.push(e)})),h((e=>{const t=m(c.activeItem);t&&this.__pageContent&&this._activeItemContentChanged(this.__pageContent,t),t&&t.location&&(this.activeItemLocation=t.location,this.loadPageData()),this.__disposer.push(e)}))}),0)}disconnectedCallback(){for(var e in this.__disposer)this.__disposer[e].dispose();this.windowControllers.abort(),super.disconnectedCallback()}storeReady(e){c.cmsSiteEditor&&c.cmsSiteEditor.instance&&globalThis.HaxStore.requestAvailability().activeHaxBody&&c.activeItemContent&&globalThis.HaxStore.requestAvailability().activeHaxBody.importContent(c.activeItemContent)}replaceTagReplacement(e){for(var t=/\<(\w+?\-\w*.*)\s*?\>/gim,a=t.exec(e);null!=a;){let i=a[1].replace("<","").replace(">","");i.indexOf(" ")&&(i=i.split(" ")[0]),-1!=i.indexOf("-")&&(e=(e=e.replace("<"+i,'<replace-tag with="'+i+'" ')).replace("</"+i+">","</replace-tag>")),a=t.exec(e)}return e}async _activeItemContentChanged(e,t){var a=e;if(null!==a&&t&&t.metadata){const e=this.manifest&&this.manifest.metadata&&this.manifest.metadata.platform,l=e&&!1===e.pageBreak;if(a=`<page-break\n      break-type="site"\n      title="${t.title}"\n      parent="${t.parent}"\n      item-id="${t.id}"\n      slug="${t.slug}"\n      description="${t.description}"\n      order="${t.order}"\n      ${t.metadata.pageType?`page-type="${t.metadata.pageType}"`:""}\n      ${t.metadata.tags?`tags="${t.metadata.tags}"`:""}\n      ${t.metadata.hideInMenu?'hide-in-menu="hide-in-menu"':""}\n      ${t.metadata.relatedItems?`related-items="${t.metadata.relatedItems}"`:""}\n      ${t.metadata.image?`image="${t.metadata.image}"`:""}\n      ${t.metadata.icon?`icon="${t.metadata.icon}"`:""}\n      ${t.metadata.accentColor?`accent-color="${t.metadata.accentColor}"`:""}\n      ${t.metadata.theme&&t.metadata.theme.key?`developer-theme="${t.metadata.theme.key}"`:""}\n      ${t.metadata.linkUrl?`link-url="${t.metadata.linkUrl}"`:""}\n      ${t.metadata.linkTarget?`link-target="${t.metadata.linkTarget}"`:""}\n      ${t.metadata.locked?'locked="locked"':""}\n      ${l?'platform-hidden="platform-hidden"':""}\n      ${!1===t.metadata.published?"":'published="published"'} ></page-break>${a}`,t.metadata.linkUrl){const e=t.metadata.linkTarget||"_self",i=`\n          <p><a href="${t.metadata.linkUrl}" target="${e}" rel="noopener noreferrer">${t.metadata.linkUrl}</a></p>\n          <p><small>If the redirect doesn't work, please click the link above.</small></p>\n        `;a+=i}a=i(a),s(c.themeElement,"*"),c.activeItemContent=a,setTimeout((()=>{if(0===c.themeElement.childNodes.length){let e=document.createRange().createContextualFragment(this.replaceTagReplacement(a));c.themeElement.appendChild(e),this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:a}))}if(!globalThis.WCAutoload&&n(this.manifest,"metadata.node.dynamicElementLoader")){let t=o(a);const i=new URL("../../locales/haxcms.es.json",import.meta.url).href+"/../";for(var e in t){const a=t[e];this.manifest.metadata.node.dynamicElementLoader[a]&&!globalThis.customElements.get(a)&&import(`${i}../../../../${this.manifest.metadata.node.dynamicElementLoader[a]}`).then((e=>{})).catch((e=>{console.warn(e)}))}}else globalThis.WCAutoload&&setTimeout((()=>{globalThis.WCAutoload.process()}),0)}),5)}}_triggerUpdatedData(e){this.isLoggedIn?this._timeStamp=Math.floor(Date.now()/1e3):this._timeStamp=""}_triggerUpdatedNode(e){this.loadPageData()}_manifestChanged(e,t){e&&e.metadata&&e.items&&c.loadManifest(e,this)}_themeChanged(e,t){if(e){this.themeLoaded=!1;let t=e;if(void 0!==this.__imported[t.element])this.themeLoaded=!0;else if(globalThis.WCAutoload)this.__imported[t.element]=t.element,this.themeLoaded=!0,setTimeout((()=>{globalThis.WCAutoload.process(),globalThis.dispatchEvent(new CustomEvent("haxcms-theme-ready",{bubbles:!0,composed:!0,cancelable:!1,detail:this}))}),5);else try{import(new URL("./../../../../../"+e.path,import.meta.url).href).then((e=>{this.__imported[t.element]=t.element,this.themeLoaded=!0}))}catch(e){this.themeLoaded=!0}}}async addStyleGuideTemplateSelector(e,t){try{const a=await this.getStyleGuideTemplates(t);if(a&&a.length>0){const t={attribute:"data-haxsg-id",title:"Template",description:"Choose a predefined style template for this element",inputMethod:"select",icon:"icons:style",options:{"":"Custom"}};for(const e of a)t.options[e.value]=e.text;e.settings||(e.settings={}),e.settings.configure||(e.settings.configure=[]),e.settings.configure.unshift(t)}}catch(e){console.warn("Failed to add template selector to HAX properties:",e)}return e}}globalThis.HAXme=function(e=null){null==e&&(e="demo",globalThis.appSettings={login:"dist/dev/login.json",logout:"dist/dev/logout.json",saveNodePath:"dist/dev/saveNode.json",saveManifestPath:"dist/dev/saveManifestPath.json",createNodePath:"dist/dev/saveNode.json",deleteNodePath:"dist/dev/saveNode.json",saveOutlinePath:"dist/dev/saveNode.json",getSiteFieldsPath:"dist/dev/getSiteFieldsPath.json",getFormToken:"adskjadshjudfu823u823u8fu8fij",appStore:{url:"dist/dev/appstore.json"},jwt:"made-up-thing",themes:{"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@haxtheweb/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"}}}),"demo"==e&&(globalThis.HAXCMSContext="demo"),globalThis.document.body&&(globalThis.document.body.querySelector("haxcms-editor-builder").__appliedContext=!1,globalThis.document.body.querySelector("haxcms-editor-builder").applyContext(e))},globalThis.customElements.define(HAXCMSSiteBuilder.tag,HAXCMSSiteBuilder);export{HAXCMSSiteBuilder};