var e=require("assert"),n=require("../lib/promises"),t=require("../lib/documents"),a=require("../lib/document-to-html"),r=a.DocumentConverter,o=a.commentAuthorLabel,l=require("./test")(module),u=require("../lib/styles/html-paths"),i=require("../lib/xml"),c=require("../lib/results"),s=require("../lib/styles/document-matchers"),m=require("../lib/html");function paragraphOfText(e,n,a){var r=runOfText(e);return new t.Paragraph([r],{styleId:n,styleName:a})}function runOfText(e,n){var a=new t.Text(e);return new t.Run([a],n)}l("should empty document to empty string",(function(){var n=new t.Document([]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"")}))})),l("should convert document containing one paragraph to single p element",(function(){var n=new t.Document([paragraphOfText("Hello.")]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<p>Hello.</p>")}))})),l("ignores empty paragraphs",(function(){var n=new t.Document([paragraphOfText("")]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"")}))})),l("text is HTML-escaped",(function(){var n=new t.Document([paragraphOfText("1 < 2")]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<p>1 &lt; 2</p>")}))})),l("should convert document containing multiple paragraphs to multiple p elements",(function(){var n=new t.Document([paragraphOfText("Hello."),paragraphOfText("Goodbye.")]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<p>Hello.</p><p>Goodbye.</p>")}))})),l("uses style mappings to pick HTML element for docx paragraph",(function(){var n=new t.Document([paragraphOfText("Hello.","Heading1","Heading 1")]);return new r({styleMap:[{from:s.paragraph({styleName:s.equalTo("Heading 1")}),to:u.topLevelElement("h1")}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<h1>Hello.</h1>")}))})),l("mappings for style names are case insensitive",(function(){var n=new t.Document([paragraphOfText("Hello.","Heading1","heading 1")]);return new r({styleMap:[{from:s.paragraph({styleName:s.equalTo("Heading 1")}),to:u.topLevelElement("h1")}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<h1>Hello.</h1>")}))})),l("can use non-default HTML element for unstyled paragraphs",(function(){var n=new t.Document([paragraphOfText("Hello.")]);return new r({styleMap:[{from:s.paragraph(),to:u.topLevelElement("h1")}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<h1>Hello.</h1>")}))})),l("warning is emitted if paragraph style is unrecognised",(function(){var n=new t.Document([paragraphOfText("Hello.","Heading1","Heading 1")]);return(new r).convertToHtml(n).then((function(n){e.deepEqual(n.messages,[c.warning("Unrecognised paragraph style: 'Heading 1' (Style ID: Heading1)")])}))})),l("can use stacked styles to generate nested HTML elements",(function(){var n=new t.Document([paragraphOfText("Hello.")]);return new r({styleMap:[{from:s.paragraph(),to:u.elements(["h1","span"])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<h1><span>Hello.</span></h1>")}))})),l("bold runs are wrapped in <strong> tags by default",(function(){var n=runOfText("Hello.",{isBold:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<strong>Hello.</strong>")}))})),l("bold runs can be configured with style mapping",(function(){var n=runOfText("Hello.",{isBold:!0});return new r({styleMap:[{from:s.bold,to:u.elements([u.element("em")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<em>Hello.</em>")}))})),l("bold runs can exist inside other tags",(function(){var n=new t.Paragraph([runOfText("Hello.",{isBold:!0})]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<p><strong>Hello.</strong></p>")}))})),l("consecutive bold runs are wrapped in a single <strong> element",(function(){var n=new t.Paragraph([runOfText("Hello",{isBold:!0}),runOfText(".",{isBold:!0})]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<p><strong>Hello.</strong></p>")}))})),l("underline runs are ignored by default",(function(){var n=runOfText("Hello.",{isUnderline:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"Hello.")}))})),l("underline runs can be mapped using style mapping",(function(){var n=runOfText("Hello.",{isUnderline:!0});return new r({styleMap:[{from:s.underline,to:u.elements([u.element("u")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<u>Hello.</u>")}))})),l("style mapping for underline runs does not close parent elements",(function(){var n=runOfText("Hello.",{isUnderline:!0,isBold:!0});return new r({styleMap:[{from:s.underline,to:u.elements([u.element("u")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<strong><u>Hello.</u></strong>")}))})),l("strikethrough runs are wrapped in <s> tags by default",(function(){var n=runOfText("Hello.",{isStrikethrough:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<s>Hello.</s>")}))})),l("strikethrough runs can be configured with style mapping",(function(){var n=runOfText("Hello.",{isStrikethrough:!0});return new r({styleMap:[{from:s.strikethrough,to:u.elements([u.element("del")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<del>Hello.</del>")}))})),l("italic runs are wrapped in <em> tags",(function(){var n=runOfText("Hello.",{isItalic:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<em>Hello.</em>")}))})),l("italic runs can be configured with style mapping",(function(){var n=runOfText("Hello.",{isItalic:!0});return new r({styleMap:[{from:s.italic,to:u.elements([u.element("strong")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<strong>Hello.</strong>")}))})),l("run can be both bold and italic",(function(){var n=runOfText("Hello.",{isBold:!0,isItalic:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<strong><em>Hello.</em></strong>")}))})),l("superscript runs are wrapped in <sup> tags",(function(){var n=runOfText("Hello.",{verticalAlignment:t.verticalAlignment.superscript});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<sup>Hello.</sup>")}))})),l("subscript runs are wrapped in <sub> tags",(function(){var n=runOfText("Hello.",{verticalAlignment:t.verticalAlignment.subscript});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<sub>Hello.</sub>")}))})),l("all caps runs are ignored by default",(function(){var n=runOfText("Hello.",{isAllCaps:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"Hello.")}))})),l("all caps runs can be configured with style mapping",(function(){var n=runOfText("Hello.",{isAllCaps:!0});return new r({styleMap:[{from:s.allCaps,to:u.elements([u.element("span")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<span>Hello.</span>")}))})),l("small caps runs are ignored by default",(function(){var n=runOfText("Hello.",{isSmallCaps:!0});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"Hello.")}))})),l("small caps runs can be configured with style mapping",(function(){var n=runOfText("Hello.",{isSmallCaps:!0});return new r({styleMap:[{from:s.smallCaps,to:u.elements([u.element("span")])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<span>Hello.</span>")}))})),l("run styles are converted to HTML if mapping exists",(function(){var n=runOfText("Hello.",{styleId:"Heading1Char",styleName:"Heading 1 Char"});return new r({styleMap:[{from:s.run({styleName:s.equalTo("Heading 1 Char")}),to:u.elements(["strong"])}]}).convertToHtml(n).then((function(n){e.equal(n.value,"<strong>Hello.</strong>")}))})),l("warning is emitted if run style is unrecognised",(function(){var n=runOfText("Hello.",{styleId:"Heading1Char",styleName:"Heading 1 Char"});return(new r).convertToHtml(n).then((function(n){e.deepEqual(n.messages,[c.warning("Unrecognised run style: 'Heading 1 Char' (Style ID: Heading1Char)")])}))})),l("docx hyperlink is converted to <a>",(function(){var n=new t.Hyperlink([runOfText("Hello.")],{href:"http://www.example.com"});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,'<a href="http://www.example.com">Hello.</a>')}))})),l("docx hyperlink can be collapsed",(function(){var n=new t.Document([new t.Hyperlink([runOfText("Hello ")],{href:"http://www.example.com"}),new t.Hyperlink([runOfText("world")],{href:"http://www.example.com"})]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,'<a href="http://www.example.com">Hello world</a>')}))})),l("docx hyperlink with anchor is converted to <a>",(function(){var n=new t.Hyperlink([runOfText("Hello.")],{anchor:"_Peter"});return new r({idPrefix:"doc-42-"}).convertToHtml(n).then((function(n){e.equal(n.value,'<a href="#doc-42-_Peter">Hello.</a>')}))})),l("hyperlink target frame is used as anchor target",(function(){var n=new t.Hyperlink([runOfText("Hello.")],{anchor:"start",targetFrame:"_blank"});return(new r).convertToHtml(n).then((function(n){e.equal(n.value,'<a href="#start" target="_blank">Hello.</a>')}))})),l("bookmarks are converted to anchors",(function(){var n=new t.BookmarkStart({name:"_Peter"}),a=new r({idPrefix:"doc-42-"}),o=new t.Document([n]);return a.convertToHtml(o).then((function(n){e.equal(n.value,'<a id="doc-42-_Peter"></a>')}))})),l("docx tab is converted to tab in HTML",(function(){var n=new t.Tab;return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"\t")}))})),l("docx table is converted to table in HTML",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([paragraphOfText("Top left")]),new t.TableCell([paragraphOfText("Top right")])]),new t.TableRow([new t.TableCell([paragraphOfText("Bottom left")]),new t.TableCell([paragraphOfText("Bottom right")])])]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<table><tr><td><p>Top left</p></td><td><p>Top right</p></td></tr><tr><td><p>Bottom left</p></td><td><p>Bottom right</p></td></tr></table>")}))})),l("table style mappings can be used to map tables",(function(){var n=new t.Table([],{styleName:"Normal Table"});return new r({styleMap:[{from:s.table({styleName:s.equalTo("Normal Table")}),to:u.topLevelElement("table",{class:"normal-table"})}]}).convertToHtml(n).then((function(n){e.equal(n.value,'<table class="normal-table"></table>')}))})),l("header rows are wrapped in thead",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([])],{isHeader:!0}),new t.TableRow([new t.TableCell([])],{isHeader:!0}),new t.TableRow([new t.TableCell([])],{isHeader:!1})]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<table><thead><tr><th></th></tr><tr><th></th></tr></thead><tbody><tr><td></td></tr></tbody></table>")}))})),l("tbody is omitted if all rows are headers",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([])],{isHeader:!0})]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<table><thead><tr><th></th></tr></thead></table>")}))})),l("unexpected table children do not cause error",(function(){var n=new t.Table([new t.tab]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<table>\t</table>")}))})),l("empty cells are preserved in table",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([paragraphOfText("")]),new t.TableCell([paragraphOfText("Top right")])])]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<table><tr><td></td><td><p>Top right</p></td></tr></table>")}))})),l("empty rows are preserved in table",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([paragraphOfText("Row 1")])]),new t.TableRow([])]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,"<table><tr><td><p>Row 1</p></td></tr><tr></tr></table>")}))})),l("table cells are written with colSpan if not equal to one",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([paragraphOfText("Top left")],{colSpan:2}),new t.TableCell([paragraphOfText("Top right")])])]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,'<table><tr><td colspan="2"><p>Top left</p></td><td><p>Top right</p></td></tr></table>')}))})),l("table cells are written with rowSpan if not equal to one",(function(){var n=new t.Table([new t.TableRow([new t.TableCell([],{rowSpan:2})])]);return(new r).convertToHtml(n).then((function(n){e.equal(n.value,'<table><tr><td rowspan="2"></td></tr></table>')}))})),l("line break is converted to <br>",(function(){return(new r).convertToHtml(t.lineBreak).then((function(n){e.equal(n.value,"<br />")}))})),l("breaks that are not line breaks are ignored",(function(){return(new r).convertToHtml(t.pageBreak).then((function(n){e.equal(n.value,"")}))})),l("breaks can be mapped using style mappings",(function(){return new r({styleMap:[{from:s.pageBreak,to:u.topLevelElement("hr")}]}).convertToHtml(t.pageBreak).then((function(n){e.equal(n.value,"<hr />")}))})),l("footnote reference is converted to superscript intra-page link",(function(){var n=new t.NoteReference({noteType:"footnote",noteId:"4"});return new r({idPrefix:"doc-42-"}).convertToHtml(n).then((function(n){e.equal(n.value,'<sup><a href="#doc-42-footnote-4" id="doc-42-footnote-ref-4">[1]</a></sup>')}))})),l("footnotes are included after the main body",(function(){var n=new t.NoteReference({noteType:"footnote",noteId:"4"}),a=new t.Document([new t.Paragraph([runOfText("Knock knock"),new t.Run([n])])],{notes:new t.Notes({4:new t.Note({noteType:"footnote",noteId:"4",body:[paragraphOfText("Who's there?")]})})});return new r({idPrefix:"doc-42-"}).convertToHtml(a).then((function(n){e.equal(n.value,'<p>Knock knock<sup><a href="#doc-42-footnote-4" id="doc-42-footnote-ref-4">[1]</a></sup></p><ol><li id="doc-42-footnote-4"><p>Who\'s there? <a href="#doc-42-footnote-ref-4">↑</a></p></li></ol>')}))})),l("comments are ignored by default",(function(){var n=t.commentReference({commentId:"4"}),a=t.comment({commentId:"4",body:[paragraphOfText("Who's there?")]}),o=t.document([t.paragraph([runOfText("Knock knock"),t.run([n])])],{comments:[a]});return new r({}).convertToHtml(o).then((function(n){e.equal(n.value,"<p>Knock knock</p>"),e.deepEqual(n.messages,[])}))})),l("comment references are linked to comment after main body",(function(){var n=t.commentReference({commentId:"4"}),a=t.comment({commentId:"4",body:[paragraphOfText("Who's there?")],authorName:"The Piemaker",authorInitials:"TP"}),o=t.document([t.paragraph([runOfText("Knock knock"),t.run([n])])],{comments:[a]});return new r({idPrefix:"doc-42-",styleMap:[{from:s.commentReference,to:u.element("sup")}]}).convertToHtml(o).then((function(n){e.equal(n.value,'<p>Knock knock<sup><a href="#doc-42-comment-4" id="doc-42-comment-ref-4">[TP1]</a></sup></p><dl><dt id="doc-42-comment-4">Comment [TP1]</dt><dd><p>Who\'s there? <a href="#doc-42-comment-ref-4">↑</a></p></dd></dl>'),e.deepEqual(n.messages,[])}))})),l("images are written with data URIs",(function(){var a=new Buffer("Not an image at all!"),o=new t.Image({readImage:function(e){return n.when(a.toString(e))},contentType:"image/png"});return(new r).convertToHtml(o).then((function(n){e.equal(n.value,'<img src="data:image/png;base64,'+a.toString("base64")+'" />')}))})),l("images have alt attribute if available",(function(){var a=new Buffer("Not an image at all!"),o=new t.Image({readImage:function(){return n.when(a)},altText:"It's a hat"});return(new r).convertToHtml(o).then((function(e){return i.readString(e.value)})).then((function(n){e.equal(n.attributes.alt,"It's a hat")}))})),l("can add custom handler for images",(function(){var a=new Buffer("Not an image at all!"),o=new t.Image({readImage:function(e){return n.when(a.toString(e))},contentType:"image/png"});return new r({convertImage:function(e,n){return e.read("utf8").then((function(e){return[m.freshElement("img",{alt:e})]}))}}).convertToHtml(o).then((function(n){e.equal(n.value,'<img alt="Not an image at all!" />')}))})),l("when custom image handler throws error then error is stored in error message",(function(){var a=new Error("Failed to convert image"),o=new t.Image({readImage:function(e){return n.when((new Buffer).toString(e))},contentType:"image/png"});return new r({convertImage:function(e,n){throw a}}).convertToHtml(o).then((function(n){e.equal(n.value,""),e.equal(n.messages.length,1);var t=n.messages[0];e.equal("error",t.type),e.equal("Failed to convert image",t.message),e.equal(a,t.error)}))})),l("long documents do not cause stack overflow",(function(){for(var n=[],a=0;a<1e3;a++)n.push(paragraphOfText("Hello."));var o=new t.Document(n);return(new r).convertToHtml(o).then((function(n){e.equal(n.value.indexOf("<p>Hello.</p>"),0)}))})),l("when initials are not blank then comment author label is initials",(function(){e.equal(o({authorInitials:"TP"}),"TP")})),l("when initials are blank then comment author label is blank",(function(){e.equal(o({authorInitials:""}),""),e.equal(o({authorInitials:void 0}),""),e.equal(o({authorInitials:null}),"")}));