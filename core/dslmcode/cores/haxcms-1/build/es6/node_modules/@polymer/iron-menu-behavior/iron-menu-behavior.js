/**
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
import"../polymer/polymer-legacy.js";import{IronA11yKeysBehavior}from"../iron-a11y-keys-behavior/iron-a11y-keys-behavior.js";import{IronMultiSelectableBehavior,IronMultiSelectableBehaviorImpl}from"../iron-selector/iron-multi-selectable.js";import{IronSelectableBehavior}from"../iron-selector/iron-selectable.js";import{dom}from"../polymer/lib/legacy/polymer.dom.js";export const IronMenuBehaviorImpl={properties:{focusedItem:{observer:"_focusedItemChanged",readOnly:!0,type:Object},attrForItemTitle:{type:String},disabled:{type:Boolean,value:!1,observer:"_disabledChanged"}},_MODIFIER_KEYS:["Alt","AltGraph","CapsLock","Control","Fn","FnLock","Hyper","Meta","NumLock","OS","ScrollLock","Shift","Super","Symbol","SymbolLock"],_SEARCH_RESET_TIMEOUT_MS:1e3,_previousTabIndex:0,hostAttributes:{role:"menu"},observers:["_updateMultiselectable(multi)"],listeners:{focus:"_onFocus",keydown:"_onKeydown","iron-items-changed":"_onIronItemsChanged"},keyBindings:{up:"_onUpKey",down:"_onDownKey",esc:"_onEscKey","shift+tab:keydown":"_onShiftTabDown"},attached:function(){this._resetTabindices()},select:function(value){this._defaultFocusAsync&&(this.cancelAsync(this._defaultFocusAsync),this._defaultFocusAsync=null);var item=this._valueToItem(value);item&&item.hasAttribute("disabled")||(this._setFocusedItem(item),IronMultiSelectableBehaviorImpl.select.apply(this,arguments))},_resetTabindices:function(){var firstSelectedItem=this.multi?this.selectedItems&&this.selectedItems[0]:this.selectedItem;this.items.forEach((function(item){item.setAttribute("tabindex",item===firstSelectedItem?"0":"-1"),item.setAttribute("aria-selected",this._selection.isSelected(item))}),this)},_updateMultiselectable:function(multi){multi?this.setAttribute("aria-multiselectable","true"):this.removeAttribute("aria-multiselectable")},_focusWithKeyboardEvent:function(event){if(-1===this._MODIFIER_KEYS.indexOf(event.key)){this.cancelDebouncer("_clearSearchText");for(var item,searchText=this._searchText||"",searchLength=(searchText+=(event.key&&1==event.key.length?event.key:String.fromCharCode(event.keyCode)).toLocaleLowerCase()).length,i=0;item=this.items[i];i++)if(!item.hasAttribute("disabled")){var attr=this.attrForItemTitle||"textContent",title=(item[attr]||item.getAttribute(attr)||"").trim();if(!(title.length<searchLength)&&title.slice(0,searchLength).toLocaleLowerCase()==searchText){this._setFocusedItem(item);break}}this._searchText=searchText,this.debounce("_clearSearchText",this._clearSearchText,this._SEARCH_RESET_TIMEOUT_MS)}},_clearSearchText:function(){this._searchText=""},_focusPrevious:function(){for(var length=this.items.length,curFocusIndex=Number(this.indexOf(this.focusedItem)),i=1;i<length+1;i++){var item=this.items[(curFocusIndex-i+length)%length];if(!item.hasAttribute("disabled")){var owner=dom(item).getOwnerRoot()||document;if(this._setFocusedItem(item),dom(owner).activeElement==item)return}}},_focusNext:function(){for(var length=this.items.length,curFocusIndex=Number(this.indexOf(this.focusedItem)),i=1;i<length+1;i++){var item=this.items[(curFocusIndex+i)%length];if(!item.hasAttribute("disabled")){var owner=dom(item).getOwnerRoot()||document;if(this._setFocusedItem(item),dom(owner).activeElement==item)return}}},_applySelection:function(item,isSelected){isSelected?item.setAttribute("aria-selected","true"):item.setAttribute("aria-selected","false"),IronSelectableBehavior._applySelection.apply(this,arguments)},_focusedItemChanged:function(focusedItem,old){old&&old.setAttribute("tabindex","-1"),!focusedItem||focusedItem.hasAttribute("disabled")||this.disabled||(focusedItem.setAttribute("tabindex","0"),focusedItem.focus())},_onIronItemsChanged:function(event){event.detail.addedNodes.length&&this._resetTabindices()},_onShiftTabDown:function(event){var oldTabIndex=this.getAttribute("tabindex");IronMenuBehaviorImpl._shiftTabPressed=!0,this._setFocusedItem(null),this.setAttribute("tabindex","-1"),this.async((function(){this.setAttribute("tabindex",oldTabIndex),IronMenuBehaviorImpl._shiftTabPressed=!1}),1)},_onFocus:function(event){if(!IronMenuBehaviorImpl._shiftTabPressed){var rootTarget=dom(event).rootTarget;(rootTarget===this||void 0===rootTarget.tabIndex||this.isLightDescendant(rootTarget))&&(this._defaultFocusAsync=this.async((function(){var firstSelectedItem=this.multi?this.selectedItems&&this.selectedItems[0]:this.selectedItem;this._setFocusedItem(null),firstSelectedItem?this._setFocusedItem(firstSelectedItem):this.items[0]&&this._focusNext()})))}},_onUpKey:function(event){this._focusPrevious(),event.detail.keyboardEvent.preventDefault()},_onDownKey:function(event){this._focusNext(),event.detail.keyboardEvent.preventDefault()},_onEscKey:function(event){var focusedItem=this.focusedItem;focusedItem&&focusedItem.blur()},_onKeydown:function(event){this.keyboardEventMatchesKeys(event,"up down esc")||this._focusWithKeyboardEvent(event),event.stopPropagation()},_activateHandler:function(event){IronSelectableBehavior._activateHandler.call(this,event),event.stopPropagation()},_disabledChanged:function(disabled){disabled?(this._previousTabIndex=this.hasAttribute("tabindex")?this.tabIndex:0,this.removeAttribute("tabindex")):this.hasAttribute("tabindex")||this.setAttribute("tabindex",this._previousTabIndex)}};IronMenuBehaviorImpl._shiftTabPressed=!1;export const IronMenuBehavior=[IronMultiSelectableBehavior,IronA11yKeysBehavior,IronMenuBehaviorImpl];