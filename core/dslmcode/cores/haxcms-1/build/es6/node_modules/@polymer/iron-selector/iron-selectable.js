/**
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at
http://polymer.github.io/LICENSE.txt The complete set of authors may be found at
http://polymer.github.io/AUTHORS.txt The complete set of contributors may be
found at http://polymer.github.io/CONTRIBUTORS.txt Code distributed by Google as
part of the polymer project is also subject to an additional IP rights grant
found at http://polymer.github.io/PATENTS.txt
*/
import"../polymer/polymer-legacy.js";import{dom}from"../polymer/lib/legacy/polymer.dom.js";import{dashToCamelCase}from"../polymer/lib/utils/case-map.js";import{IronSelection}from"./iron-selection.js";export const IronSelectableBehavior={properties:{attrForSelected:{type:String,value:null},selected:{type:String,notify:!0},selectedItem:{type:Object,readOnly:!0,notify:!0},activateEvent:{type:String,value:"tap",observer:"_activateEventChanged"},selectable:String,selectedClass:{type:String,value:"iron-selected"},selectedAttribute:{type:String,value:null},fallbackSelection:{type:String,value:null},items:{type:Array,readOnly:!0,notify:!0,value:function(){return[]}},_excludedLocalNames:{type:Object,value:function(){return{template:1,"dom-bind":1,"dom-if":1,"dom-repeat":1}}}},observers:["_updateAttrForSelected(attrForSelected)","_updateSelected(selected)","_checkFallback(fallbackSelection)"],created:function(){this._bindFilterItem=this._filterItem.bind(this),this._selection=new IronSelection(this._applySelection.bind(this))},attached:function(){this._observer=this._observeItems(this),this._addListener(this.activateEvent)},detached:function(){this._observer&&dom(this).unobserveNodes(this._observer),this._removeListener(this.activateEvent)},indexOf:function(item){return this.items?this.items.indexOf(item):-1},select:function(value){this.selected=value},selectPrevious:function(){var length=this.items.length,index=length-1;void 0!==this.selected&&(index=(Number(this._valueToIndex(this.selected))-1+length)%length),this.selected=this._indexToValue(index)},selectNext:function(){var index=0;void 0!==this.selected&&(index=(Number(this._valueToIndex(this.selected))+1)%this.items.length),this.selected=this._indexToValue(index)},selectIndex:function(index){this.select(this._indexToValue(index))},forceSynchronousItemUpdate:function(){this._observer&&"function"==typeof this._observer.flush?this._observer.flush():this._updateItems()},get _shouldUpdateSelection(){return null!=this.selected},_checkFallback:function(){this._updateSelected()},_addListener:function(eventName){this.listen(this,eventName,"_activateHandler")},_removeListener:function(eventName){this.unlisten(this,eventName,"_activateHandler")},_activateEventChanged:function(eventName,old){this._removeListener(old),this._addListener(eventName)},_updateItems:function(){var nodes=dom(this).queryDistributedElements(this.selectable||"*");nodes=Array.prototype.filter.call(nodes,this._bindFilterItem),this._setItems(nodes)},_updateAttrForSelected:function(){this.selectedItem&&(this.selected=this._valueForItem(this.selectedItem))},_updateSelected:function(){this._selectSelected(this.selected)},_selectSelected:function(selected){if(this.items){var item=this._valueToItem(this.selected);item?this._selection.select(item):this._selection.clear(),this.fallbackSelection&&this.items.length&&void 0===this._selection.get()&&(this.selected=this.fallbackSelection)}},_filterItem:function(node){return!this._excludedLocalNames[node.localName]},_valueToItem:function(value){return null==value?null:this.items[this._valueToIndex(value)]},_valueToIndex:function(value){if(!this.attrForSelected)return Number(value);for(var item,i=0;item=this.items[i];i++)if(this._valueForItem(item)==value)return i},_indexToValue:function(index){if(!this.attrForSelected)return index;var item=this.items[index];return item?this._valueForItem(item):void 0},_valueForItem:function(item){if(!item)return null;if(!this.attrForSelected){var i=this.indexOf(item);return-1===i?null:i}var propValue=item[dashToCamelCase(this.attrForSelected)];return null!=propValue?propValue:item.getAttribute(this.attrForSelected)},_applySelection:function(item,isSelected){this.selectedClass&&this.toggleClass(this.selectedClass,isSelected,item),this.selectedAttribute&&this.toggleAttribute(this.selectedAttribute,isSelected,item),this._selectionChange(),this.fire("iron-"+(isSelected?"select":"deselect"),{item})},_selectionChange:function(){this._setSelectedItem(this._selection.get())},_observeItems:function(node){return dom(node).observeNodes((function(mutation){this._updateItems(),this._updateSelected(),this.fire("iron-items-changed",mutation,{bubbles:!1,cancelable:!1})}))},_activateHandler:function(e){for(var t=e.target,items=this.items;t&&t!=this;){var i=items.indexOf(t);if(i>=0){var value=this._indexToValue(i);return void this._itemActivate(value,t)}t=t.parentNode}},_itemActivate:function(value,item){this.fire("iron-activate",{selected:value,item},{cancelable:!0}).defaultPrevented||this.select(value)}};