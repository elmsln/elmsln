import{SlTreeItem as e}from"./chunk.25E2J7HG.js";import{tree_styles_default as t}from"./chunk.ZUGTGVV2.js";import{clamp as s}from"./chunk.HF7GESMZ.js";import{LocalizeController as n}from"./chunk.2A3352EO.js";import{watch as l}from"./chunk.C7FWPEOY.js";import{ShoelaceElement as o}from"./chunk.Z7XDKKOD.js";import{__decorateClass as i}from"./chunk.6M63UXML.js";import{html as r}from"../../../../lit/index.js";import{property as a,query as c}from"../../../../lit/decorators.js";function syncCheckboxes(t,s=!1){function syncParentItem(e){const t=e.getChildrenItems({includeDisabled:!1});if(t.length){const s=t.every((e=>e.selected)),n=t.every((e=>!e.selected&&!e.indeterminate));e.selected=s,e.indeterminate=!s&&!n}}!function syncDescendants(e){for(const t of e.getChildrenItems())t.selected=s?e.selected||t.selected:!t.disabled&&e.selected,syncDescendants(t);s&&syncParentItem(e)}(t),function syncAncestors(t){const s=t.parentElement;e.isTreeItem(s)&&(syncParentItem(s),syncAncestors(s))}(t)}var d=class extends o{constructor(){super(),this.selection="single",this.localize=new n(this),this.clickTarget=null,this.initTreeItem=e=>{e.selectable="multiple"===this.selection,["expand","collapse"].filter((e=>!!this.querySelector(`[slot="${e}-icon"]`))).forEach((t=>{const s=e.querySelector(`[slot="${t}-icon"]`);null===s?e.append(this.getExpandButtonIcon(t)):s.hasAttribute("data-default")&&s.replaceWith(this.getExpandButtonIcon(t))}))},this.handleTreeChanged=t=>{for(const s of t){const t=[...s.addedNodes].filter(e.isTreeItem),n=[...s.removedNodes].filter(e.isTreeItem);t.forEach(this.initTreeItem),this.lastFocusedItem&&n.includes(this.lastFocusedItem)&&(this.lastFocusedItem=null)}},this.handleFocusOut=e=>{const t=e.relatedTarget;t&&this.contains(t)||(this.tabIndex=0)},this.handleFocusIn=t=>{const s=t.target;t.target===this&&this.focusItem(this.lastFocusedItem||this.getAllTreeItems()[0]),e.isTreeItem(s)&&!s.disabled&&(this.lastFocusedItem&&(this.lastFocusedItem.tabIndex=-1),this.lastFocusedItem=s,this.tabIndex=-1,s.tabIndex=0)},this.addEventListener("focusin",this.handleFocusIn),this.addEventListener("focusout",this.handleFocusOut),this.addEventListener("sl-lazy-change",this.handleSlotChange)}async connectedCallback(){super.connectedCallback(),this.setAttribute("role","tree"),this.setAttribute("tabindex","0"),await this.updateComplete,this.mutationObserver=new MutationObserver(this.handleTreeChanged),this.mutationObserver.observe(this,{childList:!0,subtree:!0})}disconnectedCallback(){super.disconnectedCallback(),this.mutationObserver.disconnect()}getExpandButtonIcon(e){const t=("expand"===e?this.expandedIconSlot:this.collapsedIconSlot).assignedElements({flatten:!0})[0];if(t){const s=t.cloneNode(!0);return[s,...s.querySelectorAll("[id]")].forEach((e=>e.removeAttribute("id"))),s.setAttribute("data-default",""),s.slot=`${e}-icon`,s}return null}selectItem(e){const t=[...this.selectedItems];if("multiple"===this.selection)e.selected=!e.selected,e.lazy&&(e.expanded=!0),syncCheckboxes(e);else if("single"===this.selection||e.isLeaf){const t=this.getAllTreeItems();for(const s of t)s.selected=s===e}else"leaf"===this.selection&&(e.expanded=!e.expanded);const s=this.selectedItems;(t.length!==s.length||s.some((e=>!t.includes(e))))&&Promise.all(s.map((e=>e.updateComplete))).then((()=>{this.emit("sl-selection-change",{detail:{selection:s}})}))}getAllTreeItems(){return[...this.querySelectorAll("sl-tree-item")]}focusItem(e){null==e||e.focus()}handleKeyDown(e){if(!["ArrowDown","ArrowUp","ArrowRight","ArrowLeft","Home","End","Enter"," "].includes(e.key))return;if(e.composedPath().some((e=>{var t;return["input","textarea"].includes(null==(t=null==e?void 0:e.tagName)?void 0:t.toLowerCase())})))return;const t=this.getFocusableItems(),n="ltr"===this.localize.dir(),l="rtl"===this.localize.dir();if(t.length>0){e.preventDefault();const o=t.findIndex((e=>e.matches(":focus"))),i=t[o],focusItemAt=e=>{const n=t[s(e,0,t.length-1)];this.focusItem(n)},toggleExpand=e=>{i.expanded=e};"ArrowDown"===e.key?focusItemAt(o+1):"ArrowUp"===e.key?focusItemAt(o-1):n&&"ArrowRight"===e.key||l&&"ArrowLeft"===e.key?!i||i.disabled||i.expanded||i.isLeaf&&!i.lazy?focusItemAt(o+1):toggleExpand(!0):n&&"ArrowLeft"===e.key||l&&"ArrowRight"===e.key?!i||i.disabled||i.isLeaf||!i.expanded?focusItemAt(o-1):toggleExpand(!1):"Home"===e.key?focusItemAt(0):"End"===e.key?focusItemAt(t.length-1):"Enter"!==e.key&&" "!==e.key||i.disabled||this.selectItem(i)}}handleClick(e){const t=e.target,s=t.closest("sl-tree-item"),n=e.composedPath().some((e=>{var t;return null==(t=null==e?void 0:e.classList)?void 0:t.contains("tree-item__expand-button")}));s&&!s.disabled&&t===this.clickTarget&&(n?s.expanded=!s.expanded:this.selectItem(s))}handleMouseDown(e){this.clickTarget=e.target}handleSlotChange(){this.getAllTreeItems().forEach(this.initTreeItem)}async handleSelectionChange(){const e="multiple"===this.selection,t=this.getAllTreeItems();this.setAttribute("aria-multiselectable",e?"true":"false");for(const s of t)s.selectable=e;e&&(await this.updateComplete,[...this.querySelectorAll(":scope > sl-tree-item")].forEach((e=>syncCheckboxes(e,!0))))}get selectedItems(){return this.getAllTreeItems().filter((e=>e.selected))}getFocusableItems(){const e=this.getAllTreeItems(),t=new Set;return e.filter((e=>{var s;if(e.disabled)return!1;const n=null==(s=e.parentElement)?void 0:s.closest("[role=treeitem]");return n&&(!n.expanded||n.loading||t.has(n))&&t.add(e),!t.has(e)}))}render(){return r`
      <div
        part="base"
        class="tree"
        @click=${this.handleClick}
        @keydown=${this.handleKeyDown}
        @mousedown=${this.handleMouseDown}
      >
        <slot @slotchange=${this.handleSlotChange}></slot>
        <span hidden aria-hidden="true"><slot name="expand-icon"></slot></span>
        <span hidden aria-hidden="true"><slot name="collapse-icon"></slot></span>
      </div>
    `}};d.styles=t,i([c("slot:not([name])")],d.prototype,"defaultSlot",2),i([c("slot[name=expand-icon]")],d.prototype,"expandedIconSlot",2),i([c("slot[name=collapse-icon]")],d.prototype,"collapsedIconSlot",2),i([a()],d.prototype,"selection",2),i([l("selection")],d.prototype,"handleSelectionChange",1);export{d as SlTree};