{"version":3,"file":"animate.js","sources":["src/animate.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2021 Google LLC\n * SPDX-License-Identifier: BSD-3-Clause\n */\nimport {ReactiveControllerHost} from 'lit';\nimport {nothing, AttributePart} from 'lit/html.js';\nimport {directive, PartInfo, PartType} from 'lit/directive.js';\nimport {AsyncDirective} from 'lit/async-directive.js';\nimport {controllerMap} from './animate-controller.js';\nexport {AnimateController} from './animate-controller.js';\n\nexport type CSSValues = {\n  [index: string]: string | number;\n};\n\nexport type CSSPropertiesList = string[];\n\n// zIndex for \"in\" animations\nlet z = 0;\n\nconst disconnectedProps = new Map<unknown, CSSValues>();\nconst renderedHosts = new WeakSet<ReactiveControllerHost>();\n\nexport type Options = {\n  // Options used for the animation\n  keyframeOptions?: KeyframeAnimationOptions;\n  // List of css properties to animate\n  properties?: CSSPropertiesList;\n  // if `true`, the `animate` is disabled\n  disabled?: boolean;\n  // Callback run to produce a value which is dirty checked to determine if animation should run.\n  guard?: () => unknown;\n  // Id for this `animate`; used to link to other `animate`s via e.g. `inId`\n  id?: unknown;\n  // Set to the `animate` id to map to when rendering \"in\"\n  inId?: unknown;\n  // Keyframes to use when animating \"in\"\n  in?: Keyframe[];\n  // Keyframes to use when animating \"out\"\n  out?: Keyframe[];\n  // Set to true to match DOM position when animating \"out\"\n  stabilizeOut?: boolean;\n  // Skips animation when initially rendering\n  skipInitial?: boolean;\n  // Callback run when the `animate` animation starts\n  onStart?: (animate: Animate) => void;\n  // Callback run when the animation is complete\n  onComplete?: (animate: Animate) => void;\n  // Callback run to modify frames used to animate\n  onFrames?: (animate: Animate) => Keyframe[] | undefined;\n};\n\nexport const animationFrame = () =>\n  new Promise((resolve) => requestAnimationFrame(resolve));\n\n// Presets for animating \"in\" and \"out\" of the DOM.\nexport const flyBelow = [{transform: 'translateY(100%) scale(0)', opacity: 0}];\nexport const flyAbove = [{transform: 'translateY(-100%) scale(0)', opacity: 0}];\nexport const flyLeft = [{transform: 'translateX(-100%) scale(0)', opacity: 0}];\nexport const flyRight = [{transform: 'translateX(100%) scale(0)', opacity: 0}];\nexport const none = [{}];\nexport const fadeOut = [{opacity: 0}];\nexport const fade = fadeOut;\nexport const fadeIn = [{opacity: 0}, {opacity: 1}];\nexport const fadeInSlow = [\n  {opacity: 0},\n  {opacity: 0.25, offset: 0.75},\n  {opacity: 1},\n];\n\nconst diffOp = (a: number, b: number) => {\n  const v = a - b;\n  return v === 0 ? undefined : v;\n};\nconst quotientOp = (a: number, b: number) => {\n  const v = a / b;\n  return v === 1 ? undefined : v;\n};\n\n// Computes a transform given a before and after input for given properties.\nexport const transformProps: {\n  [p: string]: (\n    a: number,\n    b: number\n  ) => {\n    value?: number;\n    transform?: string;\n    overrideFrom?: {[k: string]: string};\n  };\n} = {\n  left: (a: number, b: number) => {\n    const value = diffOp(a, b);\n    const transform =\n      value == null || isNaN(value) ? undefined : `translateX(${value}px)`;\n    return {value, transform};\n  },\n  top: (a: number, b: number) => {\n    const value = diffOp(a, b);\n    const transform =\n      value == null || isNaN(value) ? undefined : `translateY(${value}px)`;\n    return {value, transform};\n  },\n  width: (a: number, b: number) => {\n    let override: {} | undefined = undefined;\n    // 'To' values of 0 would cause `value` to be Infinity. Instead we override\n    // `b` to be 1 and add 1px as an override of width.\n    if (b === 0) {\n      b = 1;\n      override = {width: '1px'};\n    }\n    const value = quotientOp(a, b);\n    const transform =\n      value == null || isNaN(value) ? undefined : `scaleX(${value})`;\n    return {value, overrideFrom: override, transform};\n  },\n  height: (a: number, b: number) => {\n    let override: {} | undefined = undefined;\n    // 'To' values of 0 would cause `value` to be Infinity. Instead we override\n    // `b` to be 1 and add 1px as an override of height.\n    if (b === 0) {\n      b = 1;\n      override = {height: '1px'};\n    }\n    const value = quotientOp(a, b);\n    const transform =\n      value == null || isNaN(value) ? undefined : `scaleY(${value})`;\n    return {value, overrideFrom: override, transform};\n  },\n};\n\nexport const defaultKeyframeOptions: KeyframeAnimationOptions = {\n  duration: 333,\n  easing: `ease-in-out`,\n};\n\nexport const defaultCssProperties: CSSPropertiesList = [\n  'left',\n  'top',\n  'width',\n  'height',\n  'opacity',\n  'color',\n  'background',\n];\n\n// Dirty checks the value received from the `guard` option.\nconst isDirty = (value: unknown, previous: unknown) => {\n  if (Array.isArray(value)) {\n    // Dirty-check arrays by item\n    if (\n      Array.isArray(previous) &&\n      previous.length === value.length &&\n      value.every((v, i) => v === (previous as Array<unknown>)[i])\n    ) {\n      return false;\n    }\n  } else if (previous === value) {\n    // Dirty-check non-arrays by identity\n    return false;\n  }\n  return true;\n};\n\n// Mapping of node on which the `animate` directive is used to the `animate` directive.\n// Used to get the ancestor `animate` animations (which are used to modify\n// `animate` transforms), done by ascending the DOM.\nconst nodeToAnimateMap = new WeakMap<Node, Animate>();\n\n/**\n * `animate` directive class. Animates a node's position between renders.\n */\nexport class Animate extends AsyncDirective {\n  private _hostHasUpdated = false;\n  private _host?: ReactiveControllerHost;\n  private _fromValues?: CSSValues;\n  private _parentNode: Element | null = null;\n  private _nextSibling: Node | null = null;\n  private _shouldAnimate = true;\n  private _previousValue: unknown;\n  private _styles?: string | undefined | null;\n  element!: HTMLElement;\n\n  shouldLog = false;\n  animatingProperties?: CSSValues;\n  frames?: Keyframe[];\n  webAnimation?: Animation;\n  options!: Options;\n  optionsOrCallback?: (() => Options) | Options;\n\n  finished!: Promise<void>;\n  private _resolveFinished?: () => void;\n\n  constructor(part: PartInfo) {\n    super(part);\n    if (part.type === PartType.CHILD) {\n      throw new Error(\n        'The `animate` directive must be used in attribute position.'\n      );\n    }\n    this.createFinished();\n  }\n\n  createFinished() {\n    this.resolveFinished?.();\n    this.finished = new Promise((r) => {\n      this._resolveFinished = r;\n    });\n  }\n\n  async resolveFinished() {\n    this._resolveFinished?.();\n    this._resolveFinished = undefined;\n  }\n\n  render(_options?: (() => Options) | Options) {\n    return nothing;\n  }\n\n  getController() {\n    return controllerMap.get(this._host!);\n  }\n\n  isDisabled() {\n    return this.options.disabled || this.getController()?.disabled;\n  }\n\n  override update(part: AttributePart, [options]: Parameters<this['render']>) {\n    const firstUpdate = this._host === undefined;\n    if (firstUpdate) {\n      this._host = part.options?.host as ReactiveControllerHost;\n      this._host.addController(this);\n      this._host.updateComplete.then((_) => (this._hostHasUpdated = true));\n      this.element = part.element;\n      nodeToAnimateMap.set(this.element, this);\n    }\n    this.optionsOrCallback = options;\n    if (firstUpdate || typeof options !== 'function') {\n      this._setOptions(options as Options);\n    }\n    return this.render(options);\n  }\n\n  // TODO(sorvell): instead of a function/object, just use an object that the\n  // user can mutate and create accessors for the data that do lookups as needed.\n  // We're doing this every hostUpdate anyway and these lookups are fast.\n  private _setOptions(options?: Options) {\n    options = options ?? {};\n    // Mixin controller options.\n    const controller = this.getController();\n    if (controller !== undefined) {\n      options = {\n        ...controller.defaultOptions,\n        ...options,\n      };\n      options.keyframeOptions = {\n        ...controller.defaultOptions.keyframeOptions,\n        ...options.keyframeOptions,\n      };\n    }\n    // Ensure there are some properties to animation and some animation options.\n    options!.properties ??= defaultCssProperties;\n    this.options = options;\n  }\n\n  // Measures and returns metrics for the element's bounding box and styling\n  private _measure() {\n    const props: CSSValues = {};\n    const bounds = this.element.getBoundingClientRect();\n    const computedStyle = getComputedStyle(this.element);\n    this.options.properties!.forEach((p) => {\n      const v =\n        bounds[p as keyof typeof bounds] ??\n        (!transformProps[p as keyof typeof transformProps]\n          ? computedStyle[p as keyof CSSStyleDeclaration]\n          : undefined);\n      const asNum = Number(v);\n      props[p] = isNaN(asNum) ? String(v) : asNum;\n    });\n    return props;\n  }\n\n  // Returns true if a `animate` should be started.\n  private _canStart() {\n    let dirty = true,\n      value = undefined;\n    if (this.options.guard) {\n      value = this.options.guard();\n      dirty = isDirty(value, this._previousValue);\n    }\n    this._shouldAnimate =\n      this._hostHasUpdated &&\n      !this.isDisabled() &&\n      !this.isAnimating() &&\n      dirty &&\n      this.element.isConnected;\n    if (this._shouldAnimate) {\n      // Copy the value if it's an array so that if it's mutated we don't forget\n      // what the previous values were.\n      this._previousValue = Array.isArray(value) ? Array.from(value) : value;\n    }\n    return this._shouldAnimate;\n  }\n\n  hostUpdate() {\n    // TODO(sorvell): If options will change that will affect measuring,\n    // then the user must pass a callback which can be called at update time.\n    if (typeof this.optionsOrCallback === 'function') {\n      this._setOptions(this.optionsOrCallback());\n    }\n    if (this._canStart()) {\n      this._fromValues = this._measure();\n      // Record parent and nextSibling used to re-attach node when animating \"out\"\n      this._parentNode =\n        this._parentNode ?? (this.element.parentNode as Element);\n      this._nextSibling = this.element.nextSibling;\n    }\n  }\n\n  async hostUpdated() {\n    if (\n      !this._shouldAnimate ||\n      !this.element.isConnected ||\n      (this.options.skipInitial && !this.isHostRendered)\n    ) {\n      return;\n    }\n    this.prepare();\n    // Wait for rendering so any sub-elements have a chance to render.\n    await animationFrame;\n    let frames: Keyframe[] | undefined;\n    const ancestors = this._getAncestors();\n    // These inherit from ancestors. This allows easier synchronization of\n    // child `animate`s within ancestor `animate`s.\n    const animationOptions = this._calculateKeyframeOptions(\n      this.options.keyframeOptions,\n      ancestors\n    );\n    const toValues = this._measure();\n    // Normal or inverse scale\n    if (this._fromValues !== undefined) {\n      const {from, to} = this._applyAncestorAdjustments(\n        this._fromValues,\n        toValues,\n        ancestors\n      );\n      this.log('measured', [this._fromValues, toValues, from, to]);\n      frames = this.calculateKeyframes(from, to);\n      // \"In\" `animate`.\n    } else {\n      const disconnected = disconnectedProps.get(this.options.inId);\n      if (disconnected) {\n        // use disconnected data only once.\n        disconnectedProps.delete(this.options.inId);\n        const {from, to} = this._applyAncestorAdjustments(\n          disconnected!,\n          toValues,\n          ancestors\n        );\n        frames = this.calculateKeyframes(from, to);\n        // \"merge\" with \"in\" frames\n        frames = this.options.in\n          ? [\n              {...this.options.in[0], ...frames![0]},\n              ...this.options.in.slice(1),\n              frames![1],\n            ]\n          : frames;\n        // adjust z so always on top...\n        z++;\n        frames!.forEach((f) => (f['zIndex'] = z));\n      } else if (this.options.in) {\n        frames = [...this.options.in, {}];\n      }\n    }\n    noAwait(this.animate(frames, animationOptions));\n  }\n\n  resetStyles() {\n    if (this._styles !== undefined) {\n      this.element.setAttribute('style', this._styles ?? '');\n      this._styles = undefined;\n    }\n  }\n\n  commitStyles() {\n    this._styles = this.element.getAttribute('style');\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (this.webAnimation as any)?.commitStyles();\n    this.webAnimation?.cancel();\n  }\n\n  override reconnected() {}\n\n  // Experimental animate out functionality.\n  override async disconnected() {\n    if (!this._shouldAnimate) {\n      return;\n    }\n    if (this.options.id !== undefined) {\n      disconnectedProps.set(this.options.id, this._fromValues!);\n    }\n    if (this.options.out === undefined) {\n      return;\n    }\n    this.prepare();\n    await animationFrame();\n    if (this._parentNode?.isConnected) {\n      // put element back in DOM\n      const ref =\n        this._nextSibling && this._nextSibling.parentNode === this._parentNode\n          ? this._nextSibling\n          : null;\n      this._parentNode.insertBefore(this.element, ref);\n      // Optionally move element back to its position before it was detached.\n      if (this.options.stabilizeOut) {\n        // Measure current position after re-attaching.\n        const shifted = this._measure();\n        this.log('stabilizing out');\n        // TODO(sorvell): these nudges could conflict with existing styling\n        // or animation but setting left/top should be rare, especially via\n        // animation.\n        const left =\n          (this._fromValues!['left'] as number) - (shifted['left'] as number);\n        const top =\n          (this._fromValues!['top'] as number) - (shifted['top'] as number);\n        const isStatic = getComputedStyle(this.element).position === 'static';\n        if (isStatic && (left !== 0 || top !== 0)) {\n          this.element.style.position = 'relative';\n        }\n        if (left !== 0) {\n          this.element.style.left = left + 'px';\n        }\n        if (top !== 0) {\n          this.element.style.top = top + 'px';\n        }\n      }\n    }\n    // These inherit from ancestors. This allows easier synchronization of\n    // child `animate`s within ancestor `animate`s.\n    const keyframeOptions = this._calculateKeyframeOptions(\n      this.options.keyframeOptions\n    );\n    await this.animate(this.options.out, keyframeOptions);\n    this.element.remove();\n  }\n\n  prepare() {\n    this.createFinished();\n  }\n\n  start() {\n    this.options.onStart?.(this);\n  }\n\n  didFinish(didAnimate: boolean) {\n    if (didAnimate) {\n      this.options.onComplete?.(this);\n    }\n    this._fromValues = undefined;\n    this.animatingProperties = undefined;\n    this.frames = undefined;\n    this.resolveFinished();\n  }\n\n  private _getAncestors() {\n    const ancestors = [];\n    for (\n      let p: Node | null | undefined = this.element.parentNode;\n      p;\n      p = p?.parentNode\n    ) {\n      const a = nodeToAnimateMap.get(p!);\n      if (a && !a.isDisabled() && a) {\n        ancestors.push(a);\n      }\n    }\n    return ancestors;\n  }\n\n  protected get isHostRendered() {\n    const hostRendered = renderedHosts.has(this._host!);\n    if (!hostRendered) {\n      this._host!.updateComplete.then(() => {\n        renderedHosts.add(this._host!);\n      });\n    }\n    return hostRendered;\n  }\n\n  private _calculateKeyframeOptions(\n    options: KeyframeAnimationOptions | undefined,\n    ancestors: Animate[] = this._getAncestors()\n  ) {\n    // merges this `animate`'s options over ancestor options over defaults\n    const keyframeOptions = {...defaultKeyframeOptions};\n    ancestors.forEach((a) =>\n      Object.assign(keyframeOptions, a.options.keyframeOptions)\n    );\n    Object.assign(keyframeOptions, options);\n    return keyframeOptions;\n  }\n\n  // Adjust position based on ancestor scaling.\n  private _applyAncestorAdjustments(\n    from: CSSValues,\n    to: CSSValues,\n    ancestors: Animate[]\n  ) {\n    from = {...from};\n    to = {...to};\n    const ancestorProps = ancestors\n      .map((a) => a.animatingProperties)\n      .filter((a) => a !== undefined) as CSSValues[];\n    let dScaleX = 1;\n    let dScaleY = 1;\n    if (ancestorProps.length > 0) {\n      // gather scaling data for ancestors\n      ancestorProps.forEach((a) => {\n        if (a['width']) {\n          dScaleX = dScaleX / (a['width'] as number);\n        }\n        if (a['height']) {\n          dScaleY = dScaleY / (a['height'] as number);\n        }\n      });\n      // Move position by ancestor scaling amount.\n      if (from['left'] !== undefined && to['left'] !== undefined) {\n        from['left'] = dScaleX * (from['left'] as number);\n        to['left'] = dScaleX * (to['left'] as number);\n      }\n      if (from['top'] !== undefined && to['top'] !== undefined) {\n        from['top'] = dScaleY * (from['top'] as number);\n        to['top'] = dScaleY * (to['top'] as number);\n      }\n    }\n    return {from, to};\n  }\n\n  protected calculateKeyframes(from: CSSValues, to: CSSValues, center = false) {\n    const fromFrame: Keyframe = {};\n    const toFrame: Keyframe = {};\n    let hasFrames = false;\n    const props: CSSValues = {};\n    for (const p in to) {\n      const f = from[p],\n        t = to[p];\n      if (p in transformProps) {\n        const tp = transformProps[p as keyof typeof transformProps];\n        if (f === undefined || t === undefined) {\n          continue;\n        }\n        const op = tp(f as number, t as number);\n        if (op.transform !== undefined) {\n          props[p] = op.value!;\n          hasFrames = true;\n          fromFrame['transform'] = `${fromFrame['transform'] ?? ''} ${\n            op['transform']\n          }`;\n          if (op.overrideFrom !== undefined) {\n            Object.assign(fromFrame, op.overrideFrom);\n          }\n        }\n      } else if (f !== t && f !== undefined && t !== undefined) {\n        hasFrames = true;\n        fromFrame[p] = f;\n        toFrame[p] = t;\n      }\n    }\n    fromFrame['transformOrigin'] = toFrame['transformOrigin'] = center\n      ? 'center center'\n      : 'top left';\n    this.animatingProperties = props;\n    return hasFrames ? [fromFrame, toFrame] : undefined;\n  }\n\n  protected async animate(\n    frames: Keyframe[] | undefined,\n    options = this.options.keyframeOptions\n  ) {\n    this.start();\n    this.frames = frames;\n    let didAnimate = false;\n    if (!this.isAnimating() && !this.isDisabled()) {\n      if (this.options.onFrames) {\n        this.frames = frames = this.options.onFrames(this);\n        this.log('modified frames', frames);\n      }\n      if (frames !== undefined) {\n        this.log('animate', [frames, options]);\n        didAnimate = true;\n        this.webAnimation = this.element.animate(frames, options);\n        const controller = this.getController();\n        noAwait(controller?.add(this));\n        try {\n          await this.webAnimation.finished;\n        } catch (e) {\n          // cancelled.\n        }\n        controller?.remove(this);\n      }\n    }\n    this.didFinish(didAnimate);\n    return didAnimate;\n  }\n\n  protected isAnimating() {\n    return (\n      this.webAnimation?.playState === 'running' || this.webAnimation?.pending\n    );\n  }\n\n  log(message: string, data?: unknown) {\n    if (this.shouldLog && !this.isDisabled()) {\n      console.log(message, this.options.id, data);\n    }\n  }\n}\n\n/**\n * Used in an async function to mark a promise that we're deliberately not\n * awaiting.\n */\nfunction noAwait(_p: null | undefined | Promise<unknown>) {}\n\n/**\n * The `animate` directive animates a node's layout between renders.\n * It will perform a \"tweening\" animation between the two states based on\n * the options given. In addition, elements can animate when they initially\n * render to DOM and when they are removed.\n *\n * Options include:\n * * animationOptions:  configure animation via standard KeyframeAnimationOptions\n * * properties: list of properties to animate, defaults to\n * ['left', 'top','width', 'height', 'opacity', 'color', 'background']\n * * disabled: disables animation\n * * guard: function producing values that must change for the `animate` to run\n * * in: keyframes to use when animating in\n * * out: keyframes to use when animating out\n * * skipInitial: skip animating in the first time\n * * id: used to link to other `animate`s via `inId`\n * * inId: id of the `animate` to render from when animating in\n * * onStart: run when the `animate` starts\n * * onComplete: run when the `animate` completes\n * * onFrames: run when the frames are produces, use to modify frames\n */\nexport const animate = directive(Animate);\n"],"names":["z","disconnectedProps","Map","renderedHosts","WeakSet","animationFrame","Promise","resolve","requestAnimationFrame","flyBelow","transform","opacity","flyAbove","flyLeft","flyRight","none","fadeOut","fade","fadeIn","fadeInSlow","offset","diffOp","a","b","v","undefined","quotientOp","transformProps","left","value","isNaN","top","width","override","overrideFrom","height","defaultKeyframeOptions","duration","easing","defaultCssProperties","nodeToAnimateMap","WeakMap","Animate","AsyncDirective","constructor","part","super","this","_hostHasUpdated","_parentNode","_nextSibling","_shouldAnimate","shouldLog","type","PartType","CHILD","Error","createFinished","resolveFinished","finished","r","_resolveFinished","render","_options","nothing","getController","controllerMap","get","_host","isDisabled","options","disabled","update","firstUpdate","host","addController","updateComplete","then","_","element","set","optionsOrCallback","_setOptions","controller","defaultOptions","keyframeOptions","properties","_measure","props","bounds","getBoundingClientRect","computedStyle","getComputedStyle","forEach","p","asNum","Number","String","_canStart","dirty","guard","previous","Array","isArray","length","every","i","isDirty","_previousValue","isAnimating","isConnected","from","hostUpdate","_fromValues","parentNode","nextSibling","hostUpdated","skipInitial","isHostRendered","frames","prepare","ancestors","_getAncestors","animationOptions","_calculateKeyframeOptions","toValues","to","_applyAncestorAdjustments","log","calculateKeyframes","disconnected","inId","delete","in","slice","f","animate","resetStyles","_styles","setAttribute","commitStyles","getAttribute","webAnimation","cancel","reconnected","id","out","ref","insertBefore","stabilizeOut","shifted","position","style","remove","start","onStart","didFinish","didAnimate","onComplete","animatingProperties","push","hostRendered","has","add","Object","assign","ancestorProps","map","filter","dScaleX","dScaleY","center","fromFrame","toFrame","hasFrames","t","tp","op","onFrames","e","playState","pending","message","data","console","directive"],"mappings":"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"}