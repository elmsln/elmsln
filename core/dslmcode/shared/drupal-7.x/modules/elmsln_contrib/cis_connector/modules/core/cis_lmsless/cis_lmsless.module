<?php
/**
 * @file
 * Code for CIS LMSless to place branding on page and create experience.
 */

include_once 'cis_lmsless.features.inc';

/**
 * Implements hook_permission().
 */
function cis_lmsless_permission() {
  return array(
    'view lmsless bar' =>  array(
      'title' => t('View LMSless bar'),
      'description' => t('Provides context as to what system you are in and quick links.'),
    ),
    'view lmsless administration links' =>  array(
      'title' => t('View links to administrative tools'),
      'description' => t('Show the links to other administrative tools in network flyout.'),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function cis_lmsless_block_info() {
  $blocks['cis_lmsless_user'] = array(
    'info' => t('CIS LMSless user'),
    'cache' => DRUPAL_CACHE_PER_USER,
  );
  $blocks['cis_lmsless_network'] = array(
    'info' => t('CIS LMSless network'),
    'cache' => DRUPAL_CACHE_PER_USER,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function cis_lmsless_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'cis_lmsless_user':
      $vars = _cis_lmsless_assemble_user();
      $block['subject'] = t('User');
      $block['content'] = theme('cis_lmsless_user', $vars);
    break;
    case 'cis_lmsless_network':
      $vars = _cis_lmsless_assemble_network();
      $block['subject'] = t('Network');
      $block['content'] = theme('cis_lmsless_network', $vars);
    break;
  }
  return $block;
}

/**
 * Implements hook_page_build().
 */
function cis_lmsless_page_build(&$page) {
  // make sure they have access to view this
  if (user_access('view lmsless bar') && !path_is_admin(current_path())) {
    $page['page_top']['cis_lmsless'] = array(
      '#weight' => -10,
      '#markup' => _cis_lmsless_assemble(),
    );
  }
}

/**
 * Implements hook_admin_paths_alter().
 */
function cis_lmsless_admin_paths_alter(&$paths) {
  // Do not treat user pages (i.e. edit) as needing administrative theme.
  $paths['user/*'] = FALSE;
}

/**
 * Callback to assemble user block variables
 */
function _cis_lmsless_assemble_user() {
  // ensure this doesn't load when it doesn't have to
  $vars = &drupal_static(__FUNCTION__);
  if (!isset($vars)) {
    $vars = _cis_lmsless_theme_vars();
    // build in section context if we have one we can pull
    if ($section = _cis_connector_section_context()) {
      $vars['section'] = $section;
      // do a full load so we can get at the title
      // which could be in better form for interface presentation
      if (module_exists('cis_section')) {
        if ($nid = _cis_section_load_section_by_id($section)) {
          $tmpnode = node_load($nid);
          $vars['section_title'] = filter_xss($tmpnode->title);
        }
      }
    }
    // pull in the instructor contact info block
    $vars['contact_block'] = cis_service_connection_block_instructor_contact();
    // pull list of resources as an array
    if (!empty($section)) {
      $query = array('field_access_string' => $section, 'archived' => 0);
      // request the section of the user
      $cis_section_item = _cis_connection_query($query, 'field_collection_item');
    }
    else {
      $cis_section_item = array();
    }
    // make sure it got data
    $resources = array();
    if (!empty($cis_section_item) && !empty($cis_section_item['list'])) {
      $list = '';
      if (isset($cis_section_item['list'][0]['field_resources'])) {
        foreach ($cis_section_item['list'][0]['field_resources'] as $reid) {
          $resource = _cis_connection_object($reid['id'], $reid['resource']);
          $resources[$resource['field_machine_name']] = array(
            'title' => check_plain($resource['title']),
            'body' => check_markup($resource['body']['value'], $resource['body']['format'])
          );
          // check for tech support resource
          if (strpos($resource['field_machine_name'], 'tech_support') === 0 || strpos($resource['field_machine_name'], 'techsupport') === 0) {
            $vars['tech_support'] = $resources[$resource['field_machine_name']];
          }
        }
      }
    }
    $vars['resources'] = $resources;
    // throw in username
    $vars['username'] = (isset($GLOBALS['user']->name) ? check_plain($GLOBALS['user']->name) : '');
    $elmsln_global_profile = variable_get('elmsln_global_profile', 'cpr');
    $uri = 'elmslnauthority://' . $elmsln_global_profile . '/users/photos/' . $vars['username'] .'.jpg';
    // load in the user picture if it exists
    if (file_exists(_elmsln_core_realpath($uri))) {
      $image = theme('image', array(
        'path' => $uri,
        'alt' => t('Picture of @name', array('@name' => $vars['username'])),
        'width' => '64px',
        'height' => '64px',
        'attributes' => array(
          'class' => array('circle', 'cis-lmsless-avatar-big', 'ferpa-protect'),
        ),
      ));
      $image = str_replace('files/users', 'files/styles/foundation_access_profile/public/users', $image);
      $vars['userpicturebig'] = $image;
    }
    // support user banner
    $uri = 'elmslnauthority://' . $elmsln_global_profile . '/users/banners/' . $vars['username'] .'.jpg';
    // load in the user picture if it exists
    if (file_exists(_elmsln_core_realpath($uri))) {
      $image = theme('image', array(
        'path' => $uri,
        'alt' => '',
        'width' => '280px',
        'height' => '210px',
        'attributes' => array(
          'class' => array('background', 'ferpa-protect'),
        ),
      ));
      $image = str_replace('files/users', 'files/styles/foundation_access_user_bg/public/users', $image);
      $vars['userbackground'] = $image;
    }
    else {
      // load libraries to get materialize path
      $libraries = libraries_get_libraries();
      // @todo read off profile value from distributed profile in the future
      if (isset($libraries['materialize'])) {
        $vars['userbackground'] = '<img class="background" src="' .  base_path() . $libraries['materialize'] . '/images/office.jpg" alt="">';
      }
    }
    // set a login link if we don't have a user name
    if ($vars['username'] == '') {
      $vars['userlink'] = l('<i class="material-icons black-text">power_settings_new</i>' . t('Login'), 'user', array('html' => TRUE, 'attributes' => array('class' => array('account-logout', 'waves-effect', $vars['lmsless_classes'][$vars['distro']]['color'], 'waves-light', 'btn-flat'))));
    }
    else {
      $vars['userlink'] = l('<i class="material-icons black-text">power_settings_new</i>' . t('Log out'), 'user/logout', array('html' => TRUE, 'attributes' => array('data-elmsln-hover' => $vars['lmsless_classes'][$vars['distro']]['color'] . ' ' . $vars['lmsless_classes'][$vars['distro']]['light'], 'class' => array('account-logout', 'waves-effect', 'waves-' . $vars['lmsless_classes'][$vars['distro']]['color'], 'waves-light', 'btn-flat'))));
      $vars['userprofile'] = l('<i class="material-icons black-text">account_circle</i>' . t('Profile'), 'user/' . $GLOBALS['user']->uid, array('html' => TRUE, 'attributes' => array('data-prefetch-hover' => 'true', 'data-elmsln-hover' => $vars['lmsless_classes'][$vars['distro']]['color'] . ' ' . $vars['lmsless_classes'][$vars['distro']]['light'], 'class' => array('waves-effect', 'waves-' . $vars['lmsless_classes'][$vars['distro']]['color'], 'waves-light', 'btn-flat'))));
    }
    if (_cis_connector_role_groupings(array('staff','teacher')) || isset($_SESSION['masquerading'])) {
      // account for systems without sections (like authorities)
      if ($section) {
        // ensure they can see the section switcher link
        if (user_access('switch section context')) {
          // support for the FERPA filter block
          $vars['ferpa_flter'] = '<a href="#block-cis-service-connection-ferpa-filter-nav-modal" class="elmsln-modal-trigger waves-effect waves-' . $vars['lmsless_classes'][$vars['distro']]['color'] . ' waves-light btn-flat" data-elmsln-hover="' . $vars['lmsless_classes'][$vars['distro']]['color'] . ' ' . $vars['lmsless_classes'][$vars['distro']]['light'] . '"><i class="material-icons black-text">visibility</i>' . t('Privacy settings') . '</a>';

          $vars['user_section'] = '<a href="#block-cis-service-connection-section-context-changer-nav-modal" class="elmsln-modal-trigger waves-effect waves-' . $vars['lmsless_classes'][$vars['distro']]['color'] . ' waves-light btn-flat" data-elmsln-hover="' . $vars['lmsless_classes'][$vars['distro']]['color'] . ' ' . $vars['lmsless_classes'][$vars['distro']]['light'] . '"><i class="material-icons black-text">perm_identity</i>' . t('Change section') . '</a>';
        }
      }
      // render differently if the user is already masquerading
      if (isset($_SESSION['masquerading'])) {
        $vars['masquerade'] = l('<i class="material-icons black-text">supervisor_account</i>' . t('revert (@name)', array('@name' => $GLOBALS['user']->name)), 'masquerade/unswitch', array('attributes' => array('data-elmsln-hover' => $vars['lmsless_classes'][$vars['distro']]['color'] . ' ' . $vars['lmsless_classes'][$vars['distro']]['light'], 'class' => array('waves-effect', 'waves-' . $vars['lmsless_classes'][$vars['distro']]['color'], 'waves-light', 'btn-flat')), 'html' => TRUE, 'query' => array('token' => drupal_get_token('masquerade/unswitch'))));
      }
      else {
        $vars['masquerade'] = '<a href="#block-masquerade-masquerade-nav-modal" class="elmsln-modal-trigger waves-effect waves-' . $vars['lmsless_classes'][$vars['distro']]['color'] . ' waves-light btn-flat" data-elmsln-hover="' . $vars['lmsless_classes'][$vars['distro']]['color'] . ' ' . $vars['lmsless_classes'][$vars['distro']]['light'] . '"><i class="material-icons black-text">supervisor_account</i>' . t('impersonate account') . '</a>';
      }
      // calculate roles
      $tmproles = $GLOBALS['user']->roles;
      unset($tmproles[1]);
      unset($tmproles[2]);
      // figure out how to present roles, don't assume there are roles
      if (!empty($tmproles)) {
        sort($tmproles);
        $vars['user_roles'] = filter_xss(implode(', ', $tmproles));
      }
    }
    drupal_alter('cis_lmsless_theme_vars', $vars);
  }
  return $vars;
}

/**
 * Callback to assemble network block variables
 */
function _cis_lmsless_assemble_network() {
  // ensure this doesn't load when it doesn't have to
  $vars = &drupal_static(__FUNCTION__);
  if (!isset($vars)) {
    $vars = _cis_lmsless_theme_vars();
    $vars['site_name'] = variable_get('site_name', t('Service'));
    $distro = elmsln_core_get_profile_key();
    $reg = _cis_connector_build_registry();
    // make sure this is in the registry
    if (isset($reg[$distro])) {
      $tmp = explode('.', $reg[$distro]['address']);
      $machine_name = $tmp[0];
      $title = (isset($reg[$distro]['default_title']) ? $reg[$distro]['default_title'] : '');
    }
    else {
      $machine_name = $distro;
      $title = $distro;
    }
    // account for the current service being worked on but not actually
    // being actively used in the section in question
    $current_url = $GLOBALS['base_url'] . '/';
    $course_context = _cis_connector_course_context();
    if (_cis_connector_system_type() == 'authority') {
      $current_url .= $course_context;
    }
    $vars['active'] = array(
      'title' => $title,
      'url' => url($current_url),
      'machine_name' => $machine_name,
      'distro' => $vars['distro'],
      'weight' => $reg[$distro]['weight'],
      'icon' => $reg[$distro]['icon'],
    );
    // bring along anything custom added, then mix in on-demand items
    if (isset($vars['services'])) {
      $list = $vars['services'];
    }
    // request a list of all other services that this section uses
    if ($services = _cis_connector_transaction('other_services')) {
      foreach ($services as $service) {
        // ensure we don't get two of these to display
        $list[$reg[$service['field_distribution']]['group']][$service['field_machine_name']] = array(
          'title' => $service['title'],
          'url' => url(_cis_connector_format_address($reg[$service['field_distribution']], '/' . $course_context, 'front')),
          'machine_name' => $service['field_machine_name'],
          'distro' => $service['field_distribution'],
          'weight' => $reg[$service['field_distribution']]['weight'],
          'icon' => $reg[$service['field_distribution']]['icon'],
        );
      }
    }
    // allow theme to override this if set
    $theme_override = theme_get_setting('foundation_access_system_label');
    if (!empty($theme_override)) {
      $vars['active']['title'] = $theme_override;
    }
    // add in links to the Authority systems if permission exists
    // @ignore druplart_conditional_assignment
    if (user_access('view lmsless administration links') && is_array($reg)) {
      foreach ($reg as $key => $value) {
        $addr = explode('.', $value['address']);
        if ($value['type'] != 'service') {
          // LRSs are outside network scope and don't have a context
          // neither does piwik if we see that
          $tmppath = '/';
          if (strpos($key, '_') !== 0 && $value['type'] != 'custom' && $value['type'] != 'external') {
            $tmppath .= $course_context;
            $url = url(_cis_connector_format_address($reg[$key], $tmppath, 'front'));
          }
          else {
            $url = $reg[$key]['address'];
          }
          $distrocolor = $key;
          if (!isset($vars['lmsless_classes'][$key])) {
            $distrocolor = '_default_';
          }
          $list[$value['group']][$addr[0]] = array(
            'title' => $reg[$key]['default_title'],
            'url' => $url,
            'machine_name' => $addr[0],
            'distro' => $distrocolor,
            'weight' => $value['weight'],
            'icon' => $value['icon'],
          );
        }
      }

      // service creation stuff inline
      // @todo visualize this in a way that lets us quick trigger add services directly from here based on ones missing
      if (!empty($course_context) && _cis_connector_role_grouping('staff')) {
        $vars['service_option_link'] = _cis_connector_format_address($reg['cis'],  '/' . $course_context, 'front') . '/service-instances';
      }
    }
    if (!empty($list)) {
      // consistent ordering of the network flyout based on certain items we always want at the top and bottom
      uksort($list, function($a, $b) {
        switch ($a) {
          case 'Network':
            return -1;
          break;
          case 'Media':
            if ($b != 'Network') {
              return 1;
            }
            return -1;
          break;
          default:
            if (in_array($b, array('Network', 'Media'))) {
              return 1;
            }
            elseif (in_array($b, array('Administrative', 'Experimental'))) {
              return -1;
            }
            else {
              return strcmp($a, $b);
            }
          break;
          case 'Administrative':
            if ($b == 'Experimental') {
              return -1;
            }
            else {
              return 1;
            }
          break;
          case 'Experimental':
            return 1;
          break;
        }
      });
      // sort by title so that network icons are in alphabetical order
      foreach ($list as &$order) {
        usort($order, function($a, $b) {
          if ($a['weight'] == $b['weight']) {
            return strcmp($a['title'], $b['title']);
          }
          else {
            return strcmp($a['weight'], $b['weight']);
          }
        });
      }
      $vars['services'] = $list;
    }
  }
  return $vars;
}

/**
 * Callback to assemble the bar
 */
function _cis_lmsless_assemble() {
  // assemble variables for theming
  $vars = _cis_lmsless_theme_vars();
  drupal_add_css(drupal_get_path('module', 'cis_lmsless') . '/css/cis_lmsless.css');
  return theme('cis_lmsless_bar', $vars);
}

/**
 * Implementation of hook_form_FORM_ID_alter().
 */
function cis_lmsless_form_masquerade_block_1_alter(&$form, &$form_state, $form_id) {
  $section = _cis_connector_section_context();
  // rename buttons
  $form['submit'] = array(
    '#value' => t('Emulate'),
    '#type' => 'submit',
    '#weight' => 10,
  );
  $form['elmsln_view_user'] = array(
    '#value' => t('View'),
    '#type' => 'button',
    '#suffix' => '</div>',
    '#weight' => 11,
  );
  // push on additional validation handler
  array_unshift($form['#validate'], 'cis_lmsless_form_masquerade_block_1_submit');
  $form['masquerade_user_field']['#title'] = t('Account name');
  // don't do these for the master section as it makes no sense
  if ($section && !_cis_connector_is_master($section)) {
    $form['masquerade_user_field']['#type'] = 'select';
    $field_conditions = array();
    // don't assume there is a section context when masquerade is enabled
    if (module_exists('cis_section') && $gid = _cis_section_load_section_by_id($section)) {
      $field_conditions = array('og_user_node' => array('target_id', array($gid), 'IN'));
    }
    // pull together the users
    $users = _cis_connector_assemble_entity_list('user', 'user', 'name', 'name', $field_conditions);
    $form['masquerade_user_field']['#options'] = $users;
    unset($form['masquerade_user_field']['#size']);
    unset($form['masquerade_user_field']['#autocomplete_path']);
  }
}

/**
 * Submit handler callback for our view user button
 */
function cis_lmsless_form_masquerade_block_1_submit($form, $form_state) {
  // allow for going to user profile instead of masquerade
  if ($form_state['triggering_element']['#value'] == 'View') {
    // try to load the account; other things validated that they could and the worse
    // case here is they get directed to an access denied
    if ($tmp = user_load_by_name($form_state['values']['masquerade_user_field'])) {
      // user path which will resolve to the pathauto path
      drupal_goto('user/' . $tmp->uid);
    }
  }
}

/**
 * Callback to return common theme variables when styling CIS theme components
 * @return array array of variables to pass to the theme
 */
function _cis_lmsless_theme_vars() {
  // ensure this doesn't load when it doesn't have to
  $vars = &drupal_static(__FUNCTION__);
  if (!isset($vars)) {
    $lmsless_classes = _cis_lmsless_get_distro_classes();
    $vars = array(
      'front_page' => variable_get('site_frontpage','node'),
      'site_name' => variable_get('site_name', t('Service')),
      'slogan' => variable_get('site_slogan', ''),
      'distro' => elmsln_core_get_profile_key(),
      'lmsless_classes' => $lmsless_classes,
    );
    // push this into variables on the page for usage
    drupal_add_js(array('cis_lmsless' => $lmsless_classes, 'distro' => elmsln_core_get_profile_key()), array('type' => 'setting'));
    // build in section context if we have one we can pull
    if ($section = _cis_connector_section_context()) {
      $vars['section'] = $section;
      // do a full load so we can get at the title
      // which could be in better form for interface presentation
      if (module_exists('cis_section')) {
        if ($nid = _cis_section_load_section_by_id($section)) {
          $tmpnode = node_load($nid);
          $vars['section_title'] = filter_xss($tmpnode->title);
        }
      }
    }
    // pull in the instructor contact info block
    $vars['contact_block'] = cis_service_connection_block_instructor_contact();
    // pull list of resources as an array
    if (!empty($section)) {
      $query = array('field_access_string' => $section, 'archived' => 0);
      // request the section of the user
      $cis_section_item = _cis_connection_query($query, 'field_collection_item');
    }
    else {
      $cis_section_item = array();
    }
    // make sure it got data
    $resources = array();
    if (!empty($cis_section_item) && !empty($cis_section_item['list'])) {
      $list = '';
      if (isset($cis_section_item['list'][0]['field_resources'])) {
        foreach ($cis_section_item['list'][0]['field_resources'] as $reid) {
          $resource = _cis_connection_object($reid['id'], $reid['resource']);
          $resources[$resource['field_machine_name']] = array(
            'title' => check_plain($resource['title']),
            'body' => check_markup($resource['body']['value'], $resource['body']['format'])
          );
          // check for tech support resource
          if (strpos($resource['field_machine_name'], 'tech_support') === 0 || strpos($resource['field_machine_name'], 'techsupport') === 0) {
            $vars['tech_support'] = $resources[$resource['field_machine_name']];
          }
        }
      }
    }
    $vars['resources'] = $resources;
    // throw in username
    $vars['username'] = (isset($GLOBALS['user']->name) ? check_plain($GLOBALS['user']->name) : '');
    // build the remote banner URI, this is the best solution for an image
    $elmsln_global_profile = variable_get('elmsln_global_profile', 'cpr');
    $uri = 'elmslnauthority://' . $elmsln_global_profile . '/users/photos/' . $vars['username'] .'.jpg';
    // load in the user picture if it exists
    if (file_exists(_elmsln_core_realpath($uri))) {
      $image = theme('image', array(
        'path' => $uri,
        'width' => '40px',
        'height' => '40px',
        'alt' => t('Picture of @name', array('@name' => $vars['username'])),
        'attributes' => array(
          'class' => array('circle', 'ferpa-protect'),
        ),
      ));
      $image = str_replace('files/users', 'files/styles/foundation_access_lmsless_bar/public/users', $image);
      $vars['userpicture'] = $image;
    }
    // available bar elements
    $vars['bar_elements'] = array(
      'network' => TRUE,
      'user' => TRUE,
      'help' => TRUE,
      'resources' => TRUE,
      'syllabus' => TRUE
    );
    // if authority, remove the syllabus
    if (_cis_connector_system_type() == 'authority') {
      $vars['bar_elements']['syllabus'] = FALSE;
    }
    // support people wiping help link via settings
    $help_link = variable_get('cis_help_page', 'course-help');
    if (empty($help_link)) {
      $vars['bar_elements']['help'] = FALSE;
    }
    $vars['help_link'] = url($help_link);
    // support people wiping resources link via settings
    $resources_link = variable_get('cis_resource_page', 'resources');
    if (empty($resources_link)) {
      $vars['bar_elements']['resources'] = FALSE;
    }
    $vars['resources_link'] = url($resources_link);
    // support people wiping syllabus link via settings
    $syllabus_link = variable_get('cis_syllabus_page', 'syllabus');
    if (empty($syllabus_link)) {
      $vars['bar_elements']['syllabus'] = FALSE;
    }
    $vars['syllabus_link'] = url($syllabus_link);
    // account for standard cross system menu
    if (user_access('access elmsln administration areas')) {
      $course_tools = menu_tree('menu-elmsln-settings');
      $vars['elmsln_main_menu'] = render($course_tools);
    }
    // allow other projects to alter these values
    drupal_alter('cis_lmsless_theme_vars', $vars);
  }
  return $vars;
}

/**
 * Implements hook_theme().
 */
function cis_lmsless_theme() {
  return array(
    'cis_lmsless_user' => array(
      'variables' => array(
        'section' => 'master',
        'active' => array('title' => ''),
        'tour' => url('guided_tour'),
        'username' => t('Account'),
        'userlink' => '',
        'userpicturebig' => '<div class="ferpa-protect elmsln-icon icon-user"></div>',
        'userbackground' => '<img class="background" src="http://materializecss.com/images/office.jpg" alt="">',
        'masquerade' => '',
        'ferpa_flter' => '',
        'user_roles' => '',
        'user_section' => '',
        ),
      'render element' => 'element',
      'template' => 'templates/cis-lmsless-user',
    ),
    'cis_lmsless_network' => array(
      'variables' => array(
        'front_page' => 'node',
        'site_name' => t('Service'),
        'section' => 'master',
        'active' => array('title' => ''),
        'services' => array(),
        'tour' => url('guided_tour'),
        'resources' => array(),
        'tech_support' => array(),
        ),
      'render element' => 'element',
      'template' => 'templates/cis-lmsless-network',
    ),
    'cis_lmsless_bar' => array(
      'variables' => array(
        'front_page' => 'node',
        'site_name' => t('Service'),
        'section' => 'master',
        'active' => array('title' => ''),
        'help_link' => url('course-help'),
        'resources_link' => url('resources'),
        'syllabus_link' => url('syllabus'),
        'username' => t('Account'),
        'userpicture' => '<div class="ferpa-protect elmsln-icon icon-user"></div>',
        'resources' => array(),
        'tech_support' => array(),
        'elmsln_main_menu' => '',
        'lmsless_classes' => array(),
        'bar_elements' => array('network' => TRUE, 'user' => TRUE, 'help' => TRUE, 'resources' => TRUE, 'syllabus' => TRUE),
      ),
      'render element' => 'element',
      'template' => 'templates/cis-lmsless-bar',
    ),
  );
}

/**
 * Returns a color association for a distribution / tool in the network
 */
function _cis_lmsless_get_distro_classes($distro = NULL) {
  // establish an empty series of classes
  $empty = array(
    'dark'   => 'darken-4',
    'light'  => 'lighten-4',
    'color' => 'blue',
    'text' => 'accessible-blue-text',
    'outline' => 'blue-outline',
  );
  // statically cache future calls
  $map = &drupal_static(__FUNCTION__);
  if (!isset($map)) {
    $map = array(
      '_default_' => $empty,
    );
    // allow others to modify core color associations
    drupal_alter('cis_lmsless_color', $map);
  }
  // see if we should return anything
  if (isset($distro)) {
    // if we don't know about this then return nothing
    if (isset($map[$distro])) {
      return $map[$distro];
    }
    return $empty;
  }
  // return everything
  return $map;
}
