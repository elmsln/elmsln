<?php
/**
 * @file
 * Code for the CLE Assignment feature.
 */
// default assignment color for new ones
define('CLE_ASSIGNMENT_DEFAULT_COLOR', 'aac');

include_once 'cle_assignment.features.inc';

/**
 * Implements hook_init().
 */
function cle_assignment_init() {
  if (arg(0) == 'node' && arg(2) == 'assignment_bulk') {
    $file = 'assignment_bulk';
    $path = drupal_get_path('module', 'cle_assignment') . '/';
    drupal_add_js($path . 'js/' . $file . '.js');
    drupal_add_css($path . 'css/' . $file . '.css');
  }
}

/**
 * Implements hook_page_build().
 */
function cle_assignment_page_build(&$page) {
  $node = menu_get_object();
  if ($node && $node->type == 'cle_assignment' && arg(2) != 'edit') {
    $field_conditions = array('field_assignment' => array('target_id', array($node->nid), 'IN'));
    $submission = _cis_connector_assemble_entity_list('node', 'cle_submission', 'nid', 'title', $field_conditions, array('uid' => $GLOBALS['user']->uid));
    $output = '';
    foreach ($submission as $nid => $title) {
      $output .= l($title, 'node/' . $nid, array('attributes' => array('class' => array('cle-submission__link')))) . ' ';
    }
    if (empty($output)) {
      $output = l(t('Submit assignment'),'node/add/cle-submission',
        array(
          'query' => array('field_assignment' => $node->nid),
          'attributes' => array('class' => array('cle__submission-link', 'waves-effect waves-light btn-large')),
        )
      );
    }
    $page['content']['assignment_submission'] = array(
      '#markup' => $output,
      '#weight' => 100,
    );
  }
}

/**
 * Implements hook_node_insert().
 */
function cle_assignment_node_insert($node) {
  // make sure there's an outline associated to this
  // but only if we have at least 1 to do so with
  if ($node->type == 'cle_assignment') {
    // add this assignment to the master section assignment list automatically
    if ($gid = _cis_section_load_section_by_id(CIS_SECTION_MASTER)) {
      // this case can be triggered if the dates get updated downstream in CIS
      // or if we create something ahead of the semester
      $section = node_load($gid);
      $section->field_cle_assignments['und'][] = array('target_id' => $node->nid);
      node_save($section);
    }
  }
}

/**
 * Helper function to find out if the assignment is active based on the start
 * and end dates of a date field. Keep in mind that if there is an end_date
 * specified, the due_date becomes a "start date". This is the way the date
 * field works.
 */
function _cle_assignment_is_assignment_active($assignment) {
  $active = FALSE;

  try {
    $assignment_wrapper = entity_metadata_wrapper('node', $assignment);
    $due_date = $assignment_wrapper->field_due_date->value->value();
    $end_date = $assignment_wrapper->field_due_date->value2->value();

    // if it has an end date and it's not the same as the due date.
    if ($due_date && $end_date && $due_date != $end_date) {
      // if the current time is between the due date (or start date) and 
      // end date.
      if (time() > $due_date && time() < $end_date) {
        $active = TRUE;
      }
    }
    // if it only has a start date.
    elseif ($due_date) {
      // if the current time is less than the due date.
      if (time() < $due_date) {
        $active = TRUE;
      }
    }
  }
  catch (EntityMetadataWrapperException $exc) {
    watchdog(
      'cle_assignment',
      'EntityMetadataWrapper exception in %function() @trace',
      array('%function' => __FUNCTION__, '@trace' => $exc->getTraceAsString()),
      WATCHDOG_ERROR
    );
  }

  return $active;
}

/**
 * Helper function to find out if the assignment is active based on the start
 * and end dates of a date field. Keep in mind that if there is an end_date
 * specified, the due_date becomes a "start date". This is the way the date
 * field works.
 */
function _cle_assignment_is_assignment_closed($assignment) {
  $closed = FALSE;

  try {
    $assignment_wrapper = entity_metadata_wrapper('node', $assignment);
    $due_date = $assignment_wrapper->field_due_date->value->value();
    $end_date = $assignment_wrapper->field_due_date->value2->value();

    // if it has an end date and it's not the same as the due date.
    if ($due_date && $end_date && $due_date != $end_date) {
      if (time() > $end_date) {
        $closed = TRUE;
      }
    }
    // if it only has a start date.
    elseif ($due_date) {
      // if the current time is less than the due date.
      if (time() > $due_date) {
        $closed = TRUE;
      }
    }
  }
  catch (EntityMetadataWrapperException $exc) {
    watchdog(
      'cle_assignment',
      'EntityMetadataWrapper exception in %function() @trace',
      array('%function' => __FUNCTION__, '@trace' => $exc->getTraceAsString()),
      WATCHDOG_ERROR
    );
  }

  return $closed;
}
